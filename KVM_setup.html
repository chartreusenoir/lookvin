<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æœåŠ¡å™¨ KVM è™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --code-bg: #161b22;
            --nav-bg: #161b22;
            --nav-active: #1f6feb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* ä¾§è¾¹å¯¼èˆªæ  */
        .sidebar {
            width: 300px;
            background: var(--nav-bg);
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #58a6ff;
        }
        
        .nav-list {
            list-style: none;
        }
        
        .nav-list li {
            margin-bottom: 8px;
        }
        
        .nav-list a {
            color: var(--text-color);
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .nav-list a:hover {
            background: rgba(56, 139, 253, 0.1);
            color: #58a6ff;
        }
        
        .nav-list a.active {
            background: rgba(31, 111, 235, 0.15);
            color: var(--nav-active);
            font-weight: 600;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            margin-left: 300px;
            padding: 40px 60px;
            max-width: 1400px;
        }
        
        /* Markdownæ ·å¼å¢å¼º */
        .markdown-body {
            background: transparent !important;
            color: var(--text-color) !important;
        }
        
        .markdown-body h1 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 40px;
            margin-bottom: 20px;
            color: #58a6ff;
        }
        
        .markdown-body h2 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-top: 30px;
            margin-bottom: 16px;
        }
        
        .markdown-body h3 {
            margin-top: 24px;
            margin-bottom: 12px;
        }
        
        .markdown-body pre {
            background: var(--code-bg) !important;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        
        .markdown-body code {
            background: var(--code-bg) !important;
            color: #ff7b72 !important;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .markdown-body pre code {
            color: var(--text-color) !important;
            padding: 0;
        }
        
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }
        
        .markdown-body table th,
        .markdown-body table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
        }
        
        .markdown-body table th {
            background: var(--code-bg);
        }
        
        .markdown-body blockquote {
            border-left: 4px solid #388bfd;
            padding-left: 16px;
            color: #8b949e;
        }
        
        /* æ–‡æ¡£åˆ†éš” */
        .doc-separator {
            margin: 60px 0;
            border: none;
            border-top: 3px solid var(--border-color);
        }
        
        /* å›åˆ°é¡¶éƒ¨æŒ‰é’® */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--nav-active);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, background 0.3s;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .back-to-top.visible {
            opacity: 1;
        }
        
        .back-to-top:hover {
            background: #1158c7;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-300px);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            .sidebar,
            .back-to-top {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹å¯¼èˆª -->
        <nav class="sidebar">
            <h2>ğŸ“š æ–‡æ¡£å¯¼èˆª</h2>
            <ul class="nav-list" id="nav-list">
                <!-- å¯¼èˆªé¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
            </ul>
        </nav>
        
        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <article class="markdown-body" id="content">
# å®¶åº­æœåŠ¡å™¨ KVM è™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—

## ğŸ“š æ–‡æ¡£æ¦‚è§ˆ

æœ¬æ–‡æ¡£é›†ä¸ºæ‚¨æä¾›ä»é›¶æ­å»ºåŸºäº Rocky Linux 9 + KVM çš„å®¶åº­æœåŠ¡å™¨å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…å« Python å¼€å‘ã€Web åº”ç”¨éƒ¨ç½²ã€æ—è·¯ç”±ã€NAS ç­‰åŠŸèƒ½è™šæ‹Ÿæœºçš„è¯¦ç»†é…ç½®æŒ‡å—ã€‚

### ğŸ–¥ï¸ æœåŠ¡å™¨é…ç½®

- **CPU**: AMD Ryzen 5 5600G
- **ä¸»æ¿**: MSI B550M PRO-VDH
- **å†…å­˜**: 32GB DDR4 2666MHz (16GB Ã— 2)
- **å­˜å‚¨**: è‡´æ€ TiPlus7100s 2TB NVMe SSD
- **ç³»ç»Ÿ**: Rocky Linux 9 Minimal
- **ç½‘ç»œ**: 192.168.71.200/24 (é™æ€IP)

### ğŸ¯ è™šæ‹Ÿæœºè§„åˆ’

| è™šæ‹Ÿæœº | æ“ä½œç³»ç»Ÿ | ç£ç›˜ | IPåœ°å€ | ç”¨é€” |
|--------|----------|------|--------|------|
| python-dev | Ubuntu 22.04 LTS | 80GB (qcow2) | 192.168.71.201 | Python å¼€å‘å’Œæµ‹è¯• |
| web-app | Ubuntu 22.04 LTS | 100GB (qcow2) | 192.168.71.202 | Web åº”ç”¨ç”Ÿäº§éƒ¨ç½² |
| router | OpenWrt/Rocky 9 | 20GB (qcow2) | 192.168.71.254 | é€æ˜ä»£ç†/æ—è·¯ç”± |
| nas | Rocky Linux 9 | 30GB (raw) + 500GB æ•°æ® | 192.168.71.210 | æ–‡ä»¶å…±äº«æœåŠ¡ |

### ğŸ“‚ å­˜å‚¨æ¶æ„

```
è‡´æ€ 2TB NVMe SSD
â”œâ”€ ç³»ç»Ÿåˆ†åŒº (110GB)
â”‚  â”œâ”€ / (root)
â”‚  â”œâ”€ /boot
â”‚  â””â”€ swap
â”‚
â”œâ”€ KVM å­˜å‚¨æ±  (1.2TB LVM thin pool)
â”‚  â”œâ”€ python-dev.qcow2 (80GB)
â”‚  â”œâ”€ web-app.qcow2 (100GB)
â”‚  â”œâ”€ router.qcow2 (20GB)
â”‚  â”œâ”€ nas-system.raw (30GB)
â”‚  â””â”€ é¢„ç•™ç©ºé—´ (~970GB)
â”‚
â”œâ”€ NAS æ•°æ®å· (500GB LVM)
â”‚  â””â”€ /data/nas (é€šè¿‡ virtio-fs å…±äº«ç»™ NAS VM)
â”‚
â””â”€ æœªåˆ†é…ç©ºé—´ (~50GB åº”æ€¥é¢„ç•™)
```

### ğŸŒ ç½‘ç»œæ‹“æ‰‘

```
äº’è”ç½‘
  â”‚
  â”œâ”€ ç”µä¿¡äº‘å®½å¸¦ç½‘å…³ (192.168.71.1)
  â”‚
  â””â”€ ç‰©ç†ç½‘ç»œ (192.168.71.0/24)
       â”‚
       â”œâ”€ å®¿ä¸»æœº (192.168.71.200)
       â”‚    â””â”€ br0 ç½‘æ¡¥ (Bridge æ¨¡å¼)
       â”‚         â”œâ”€ python-dev (192.168.71.201)
       â”‚         â”œâ”€ web-app (192.168.71.202)
       â”‚         â”œâ”€ nas (192.168.71.210)
       â”‚         â””â”€ router (192.168.71.254) â† å¯é€‰æ—è·¯ç”±ç½‘å…³
       â”‚
       â””â”€ å…¶ä»–å±€åŸŸç½‘è®¾å¤‡
```

---

## ğŸ“– æ–‡æ¡£å¯¼èˆª

### ğŸš€ ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç¯å¢ƒæ­å»º (å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œ)

| æ–‡æ¡£ | æè¿° | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| [01-host-init.md](#section-1) | å®¿ä¸»æœºåˆå§‹åŒ–é…ç½®&lt;br&gt;â€¢ SSH å¯†é’¥è®¤è¯&lt;br&gt;â€¢ ç³»ç»Ÿæ›´æ–°å’Œå¿…è¦è½¯ä»¶å®‰è£…&lt;br&gt;â€¢ å›½å†…é•œåƒæºé…ç½®&lt;br&gt;â€¢ é˜²ç«å¢™å’Œ SELinux é…ç½® | 20 åˆ†é’Ÿ |
| [02-kvm-setup.md](#section-2) | KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»º&lt;br&gt;â€¢ KVM/QEMU å®‰è£…&lt;br&gt;â€¢ libvirt é…ç½®&lt;br&gt;â€¢ ç½‘æ¡¥åˆ›å»º&lt;br&gt;â€¢ éªŒè¯è™šæ‹ŸåŒ–æ”¯æŒ | 30 åˆ†é’Ÿ |
| [03-storage-expansion.md](#section-3) | ç£ç›˜ç©ºé—´æ‰©å±•&lt;br&gt;â€¢ LVM thin pool åˆ›å»º (1.2TB)&lt;br&gt;â€¢ NAS æ•°æ®å·åˆ›å»º (500GB)&lt;br&gt;â€¢ KVM å­˜å‚¨æ± é…ç½®&lt;br&gt;â€¢ ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬ | 20 åˆ†é’Ÿ |
| [04-vm-management.md](#section-4) | è™šæ‹Ÿæœºåˆ›å»ºå’Œç®¡ç†&lt;br&gt;â€¢ VM åˆ›å»ºè„šæœ¬&lt;br&gt;â€¢ è‡ªåŠ¨å¯åŠ¨é…ç½®&lt;br&gt;â€¢ èµ„æºåˆ†é…ç­–ç•¥&lt;br&gt;â€¢ ç»Ÿä¸€ç®¡ç†å·¥å…· | 15 åˆ†é’Ÿ |
| [05-monitoring.md](#section-5) | ç›‘æ§æ–¹æ¡ˆéƒ¨ç½²&lt;br&gt;â€¢ Cockpit Web æ§åˆ¶å°&lt;br&gt;â€¢ è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§&lt;br&gt;â€¢ èµ„æºä½¿ç”¨è„šæœ¬&lt;br&gt;â€¢ å‘Šè­¦é…ç½® | 25 åˆ†é’Ÿ |

### ğŸ› ï¸ ç¬¬äºŒé˜¶æ®µï¼šè™šæ‹Ÿæœºé…ç½® (å¯æ ¹æ®éœ€è¦é€‰æ‹©)

| æ–‡æ¡£ | æè¿° | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| [06-vm-python-dev.md](#section-6) | Python å¼€å‘ç¯å¢ƒé…ç½®&lt;br&gt;â€¢ Ubuntu 22.04 å®‰è£…&lt;br&gt;â€¢ Python 3.11+ ç¯å¢ƒ&lt;br&gt;â€¢ pip æ¸…åæºé…ç½®&lt;br&gt;â€¢ å¸¸ç”¨å¼€å‘å·¥å…· | 40 åˆ†é’Ÿ |
| [07-vm-web-app.md](#section-7) | Web åº”ç”¨éƒ¨ç½²ç¯å¢ƒ&lt;br&gt;â€¢ Nginx + uWSGI/Gunicorn&lt;br&gt;â€¢ PostgreSQL/MySQL&lt;br&gt;â€¢ Docker ç¯å¢ƒ&lt;br&gt;â€¢ SSL è¯ä¹¦é…ç½® | 50 åˆ†é’Ÿ |
| [08-vm-router-comparison.md](#section-8) | æ—è·¯ç”±æ–¹æ¡ˆå¯¹æ¯”&lt;br&gt;â€¢ OpenWrt vs V2Ray è¯¦ç»†å¯¹æ¯”&lt;br&gt;â€¢ é€‚ç”¨åœºæ™¯åˆ†æ&lt;br&gt;â€¢ æ€§èƒ½å’Œæ˜“ç”¨æ€§è¯„ä¼°&lt;br&gt;â€¢ æ–¹æ¡ˆé€‰æ‹©å»ºè®® | é˜…è¯» 15 åˆ†é’Ÿ |
| [09-vm-router-openwrt.md](#section-9) | OpenWrt æ—è·¯ç”±é…ç½®&lt;br&gt;â€¢ OpenWrt å®‰è£…&lt;br&gt;â€¢ OpenClash æ’ä»¶é…ç½®&lt;br&gt;â€¢ Clash è®¢é˜…å¯¼å…¥&lt;br&gt;â€¢ è‡ªåŠ¨/æ‰‹åŠ¨ç½‘å…³è®¾ç½® | 60 åˆ†é’Ÿ |
| [10-vm-router-v2ray.md](#section-10) | V2Ray æ—è·¯ç”±é…ç½®&lt;br&gt;â€¢ Rocky 9 + V2Ray å®‰è£…&lt;br&gt;â€¢ é€æ˜ä»£ç†é…ç½®&lt;br&gt;â€¢ è®¢é˜…è½¬æ¢å’Œæ›´æ–°&lt;br&gt;â€¢ åˆ†æµè§„åˆ™ä¼˜åŒ– | 60 åˆ†é’Ÿ |
| [11-vm-nas.md](#section-11) | NAS æ–‡ä»¶å…±äº«æœåŠ¡&lt;br&gt;â€¢ Samba (Windows/macOS/iOS)&lt;br&gt;â€¢ NFS (Linux/é«˜æ€§èƒ½)&lt;br&gt;â€¢ virtio-fs å®¿ä¸»æœºå…±äº«&lt;br&gt;â€¢ å¤–ç½‘è®¿é—® (VPN/FRP) | 70 åˆ†é’Ÿ |

### ğŸ”§ ç¬¬ä¸‰é˜¶æ®µï¼šè¿ç»´å’Œç»´æŠ¤ (å‚è€ƒæ–‡æ¡£)

| æ–‡æ¡£ | æè¿° |
|------|------|
| [12-backup-restore.md](#section-12) | å¤‡ä»½å’Œæ¢å¤ç­–ç•¥&lt;br&gt;â€¢ è™šæ‹Ÿæœºå¿«ç…§å’Œå¤‡ä»½&lt;br&gt;â€¢ å®šæœŸå¤‡ä»½è„šæœ¬&lt;br&gt;â€¢ å¢é‡å¤‡ä»½æ–¹æ¡ˆ&lt;br&gt;â€¢ ç¾éš¾æ¢å¤æµç¨‹ |
| [13-maintenance.md](#section-13) | ç³»ç»Ÿç»´æŠ¤æŒ‡å—&lt;br&gt;â€¢ æ­£ç¡®çš„å…³æœºå’Œå¯åŠ¨æµç¨‹&lt;br&gt;â€¢ è™šæ‹Ÿæœºè‡ªåŠ¨å¯åŠ¨é…ç½®&lt;br&gt;â€¢ ç³»ç»Ÿæ›´æ–°ç­–ç•¥&lt;br&gt;â€¢ æ—¥å¸¸ç»´æŠ¤æ£€æŸ¥æ¸…å• |
| [14-troubleshooting.md](#section-14) | å¸¸è§é—®é¢˜æ’æŸ¥&lt;br&gt;â€¢ å†…å­˜æ˜¾ç¤º 27G çš„åŸå› &lt;br&gt;â€¢ è¿œç¨‹ BIOS è®¿é—®æ–¹æ¡ˆ&lt;br&gt;â€¢ ç½‘ç»œè¿é€šæ€§é—®é¢˜&lt;br&gt;â€¢ æ€§èƒ½ä¼˜åŒ–å»ºè®® |

---

## âš¡ å¿«é€Ÿå¼€å§‹

### æœ€å°åŒ–éƒ¨ç½²è·¯å¾„ï¼ˆä»…æµ‹è¯• KVM ç¯å¢ƒï¼‰

å¦‚æœæ‚¨åªæƒ³å¿«é€Ÿæµ‹è¯• KVM ç¯å¢ƒï¼ŒæŒ‰ä»¥ä¸‹æœ€å°è·¯å¾„æ“ä½œï¼š

```bash
# 1. åŸºç¡€é…ç½® (01-host-init.md)
# 2. KVM å®‰è£… (02-kvm-setup.md)
# 3. åˆ›å»ºä¸€ä¸ªæµ‹è¯•è™šæ‹ŸæœºéªŒè¯ç¯å¢ƒ
```

**é¢„è®¡æ—¶é—´**: 1 å°æ—¶

### å®Œæ•´ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

å¦‚æœè¦éƒ¨ç½²å®Œæ•´çš„å®¶åº­æœåŠ¡å™¨æ–¹æ¡ˆï¼š

```bash
# ç¬¬ä¸€å¤©ï¼šåŸºç¡€ç¯å¢ƒ (1-2 å°æ—¶)
01 â†’ 02 â†’ 03 â†’ 04 â†’ 05

# ç¬¬äºŒå¤©ï¼šæŒ‰éœ€é…ç½®è™šæ‹Ÿæœº (2-4 å°æ—¶)
06 (Python å¼€å‘) â†’ 07 (Web åº”ç”¨)

# ç¬¬ä¸‰å¤©ï¼šç½‘ç»œæœåŠ¡ (2-3 å°æ—¶)
é€‰æ‹© 09 (OpenWrt) æˆ– 10 (V2Ray) â†’ 11 (NAS)

# ç¬¬å››å¤©ï¼šå¤‡ä»½å’Œä¼˜åŒ– (1 å°æ—¶)
12 â†’ 13 â†’ 14
```

**é¢„è®¡æ—¶é—´**: åˆ† 4 å¤©å®Œæˆï¼Œæ¯å¤© 1-4 å°æ—¶

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### æ–‡æ¡£ç‰¹ç‚¹

âœ… **æ‰€æœ‰è„šæœ¬å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨** - æ— éœ€ä¿®æ”¹å³å¯åœ¨æ‚¨çš„ç¯å¢ƒä¸­è¿è¡Œ  
âœ… **å›½å†…ç½‘ç»œä¼˜åŒ–** - æ‰€æœ‰é…ç½®éƒ½åŒ…å«å›½å†…é•œåƒæºï¼Œç¡®ä¿ç¨³å®šä¸‹è½½  
âœ… **è¯¦ç»†çš„éªŒè¯æ­¥éª¤** - æ¯ä¸ªæ“ä½œåéƒ½æœ‰éªŒè¯å‘½ä»¤ï¼Œç¡®ä¿é…ç½®æ­£ç¡®  
âœ… **æ•…éšœæ’æŸ¥æŒ‡å—** - å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ  
âœ… **æ¨¡å—åŒ–è®¾è®¡** - å¯ä»¥è·³è¿‡ä¸éœ€è¦çš„è™šæ‹Ÿæœºé…ç½®

### æ³¨æ„äº‹é¡¹

âš ï¸ **æ“ä½œå‰å¤‡ä»½** - è™½ç„¶è¿™æ˜¯æ–°ç³»ç»Ÿï¼Œä½†é‡è¦æ•°æ®è¯·æå‰å¤‡ä»½  
âš ï¸ **æŒ‰é¡ºåºæ“ä½œ** - ç¬¬ä¸€é˜¶æ®µæ–‡æ¡£å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œç¬¬äºŒé˜¶æ®µå¯ä»¥é€‰æ‹©æ€§æ‰§è¡Œ  
âš ï¸ **æ£€æŸ¥ç¡¬ä»¶æ”¯æŒ** - ç¡®ä¿ CPU æ”¯æŒè™šæ‹ŸåŒ– (AMD-V æˆ– Intel VT-x)  
âš ï¸ **ç½‘ç»œé…ç½®** - ç¡®ä¿ 192.168.71.201-254 è¿™äº› IP æœªè¢«å ç”¨  
âš ï¸ **è„šæœ¬å®‰å…¨æ€§** - æ‰€æœ‰è„šæœ¬éƒ½ä¼šåœ¨æ‰§è¡Œå‰è¦æ±‚ç¡®è®¤ï¼Œé¿å…è¯¯æ“ä½œ

### è„šæœ¬ä½¿ç”¨æ–¹å¼

æ–‡æ¡£ä¸­çš„è„šæœ¬æœ‰ä¸‰ç§ç±»å‹ï¼š

1. **ç›´æ¥å‘½ä»¤** - å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œ
```bash
# ç¤ºä¾‹
dnf update -y
```

2. **é…ç½®æ–‡ä»¶** - éœ€è¦åˆ›å»ºæ–‡ä»¶åå¤åˆ¶å†…å®¹
```bash
# ç¤ºä¾‹
cat &gt; /etc/example.conf &lt;&lt;'EOF'
é…ç½®å†…å®¹
EOF
```

3. **å®Œæ•´è„šæœ¬** - å»ºè®®ä¿å­˜ä¸º .sh æ–‡ä»¶åæ‰§è¡Œ
```bash
# ç¤ºä¾‹
cat &gt; setup-script.sh &lt;&lt;'EOF'
#!/bin/bash
è„šæœ¬å†…å®¹
EOF
chmod +x setup-script.sh
./setup-script.sh
```

---

## ğŸŒŸ å›½å†…ç½‘ç»œä¼˜åŒ–

æœ¬æ–‡æ¡£é›†é’ˆå¯¹å›½å†…ç½‘ç»œç¯å¢ƒè¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼š

### è½¯ä»¶åŒ…é•œåƒæº

- **Rocky Linux**: é˜¿é‡Œäº‘ / æ¸…åå¤§å­¦é•œåƒ
- **Ubuntu**: æ¸…åå¤§å­¦ / ä¸­ç§‘å¤§é•œåƒ
- **Python pip**: æ¸…åå¤§å­¦ pypi é•œåƒ
- **Docker**: é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
- **Node.js/npm**: æ·˜å® npm é•œåƒ
- **Homebrew**: æ¸…åå¤§å­¦é•œåƒ

### ä¸‹è½½åŠ é€Ÿ

- **GitHub Release**: ä½¿ç”¨ ghproxy.com æˆ– mirror.ghproxy.com åŠ é€Ÿ
- **ISO é•œåƒ**: æä¾›å›½å†…é«˜é€Ÿä¸‹è½½é“¾æ¥
- **å®¹å™¨é•œåƒ**: é…ç½®å›½å†… Docker Hub é•œåƒ

### è™šæ‹ŸåŒ–é•œåƒä¸‹è½½

æ‰€æœ‰è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿ ISO æ–‡ä»¶éƒ½æä¾›å›½å†…é•œåƒç«™ä¸‹è½½é“¾æ¥ï¼š

- Ubuntu: mirrors.tuna.tsinghua.edu.cn
- Rocky Linux: mirrors.aliyun.com
- OpenWrt: mirrors.ustc.edu.cn

---

## ğŸ†˜ è·å–å¸®åŠ©

### å¸¸è§é—®é¢˜

å¤§éƒ¨åˆ†é—®é¢˜å¯ä»¥åœ¨ [14-troubleshooting.md](#section-14) ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚

### æ£€æŸ¥æ¸…å•

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·å…ˆæ£€æŸ¥ï¼š

1. âœ… CPU è™šæ‹ŸåŒ–æ˜¯å¦å·²åœ¨ BIOS ä¸­å¯ç”¨
2. âœ… ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
3. âœ… é˜²ç«å¢™è§„åˆ™æ˜¯å¦æ­£ç¡®
4. âœ… SELinux æ˜¯å¦æŒ‰æ–‡æ¡£é…ç½®
5. âœ… IP åœ°å€æ˜¯å¦å†²çª
6. âœ… å­˜å‚¨ç©ºé—´æ˜¯å¦å……è¶³

### ç³»ç»Ÿä¿¡æ¯æ”¶é›†

æé—®å‰è¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

```bash
# ç³»ç»Ÿä¿¡æ¯
hostnamectl

# è™šæ‹ŸåŒ–æ”¯æŒ
virt-host-validate

# ç£ç›˜ç©ºé—´
df -h
vgs
lvs

# ç½‘ç»œé…ç½®
ip addr
virsh net-list --all

# è™šæ‹ŸæœºçŠ¶æ€
virsh list --all
```

---

## ğŸ“Š ç‰ˆæœ¬å†å²

- **v1.0** (2026-02-24): åˆå§‹ç‰ˆæœ¬
  - å®Œæ•´çš„ KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»ºæŒ‡å—
  - 4 ä¸ªåŠŸèƒ½è™šæ‹Ÿæœºé…ç½®æ–¹æ¡ˆ
  - å›½å†…ç½‘ç»œç¯å¢ƒä¼˜åŒ–
  - å¤‡ä»½å’Œè¿ç»´æ–‡æ¡£

---

## ğŸ“„ è®¸å¯

æœ¬æ–‡æ¡£é›†ä¾›ä¸ªäººå­¦ä¹ å’Œä½¿ç”¨ï¼Œæ¬¢è¿åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚

---

## ğŸš¦ å¼€å§‹æ‚¨çš„æ—…ç¨‹

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬ä»ç¬¬ä¸€æ­¥å¼€å§‹ï¼š

ğŸ‘‰ **[01-host-init.md - å®¿ä¸»æœºåˆå§‹åŒ–é…ç½®](#section-1)**

ç¥æ‚¨æ­å»ºé¡ºåˆ©ï¼ğŸ‰




---



# 01 - å®¿ä¸»æœºåˆå§‹åŒ–é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨å®Œæˆ Rocky Linux 9 å®¿ä¸»æœºçš„åŸºç¡€é…ç½®ï¼ŒåŒ…æ‹¬ï¼š

- âœ… SSH å¯†é’¥è®¤è¯é…ç½®
- âœ… ç³»ç»Ÿæ›´æ–°å’Œè½¯ä»¶åŒ…ç®¡ç†
- âœ… å›½å†…é•œåƒæºé…ç½®
- âœ… é˜²ç«å¢™å’Œ SELinux é…ç½®
- âœ… å¿…è¦çš„ç³»ç»Ÿå·¥å…·å®‰è£…
- âœ… æ—¶åŒºå’Œ NTP æ—¶é—´åŒæ­¥

**é¢„è®¡è€—æ—¶**: 20 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â˜†â˜†â˜†

---

## ğŸ” æ­¥éª¤ 1: SSH å¯†é’¥è®¤è¯é…ç½®

### 1.1 åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

**Windows ç”¨æˆ·** (PowerShell):
```powershell
# æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯†é’¥
dir $env:USERPROFILE\.ssh

# å¦‚æœæ²¡æœ‰ï¼Œç”Ÿæˆæ–°å¯†é’¥
ssh-keygen -t ed25519 -C "your_email@example.com"
# æˆ–ä½¿ç”¨ RSAï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# ä¸€è·¯å›è½¦ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼Œå¯ä»¥è®¾ç½®å¯†ç æˆ–ç•™ç©º
```

**macOS/Linux ç”¨æˆ·**:
```bash
# æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯†é’¥
ls -la ~/.ssh

# å¦‚æœæ²¡æœ‰ï¼Œç”Ÿæˆæ–°å¯†é’¥
ssh-keygen -t ed25519 -C "your_email@example.com"
# æˆ–ä½¿ç”¨ RSA
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

### 1.2 å°†å…¬é’¥å¤åˆ¶åˆ°æœåŠ¡å™¨

**æ–¹æ³• A: ä½¿ç”¨ ssh-copy-id (æ¨èï¼ŒmacOS/Linux)**

```bash
# ä»¥ chris ç”¨æˆ·ç™»å½•
ssh-copy-id chris@192.168.71.200

# è¾“å…¥å¯†ç åï¼Œå…¬é’¥ä¼šè‡ªåŠ¨é…ç½®
```

**æ–¹æ³• B: æ‰‹åŠ¨å¤åˆ¶ (é€‚ç”¨äºæ‰€æœ‰ç³»ç»Ÿ)**

åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œï¼š
```bash
# Windows (PowerShell)
type $env:USERPROFILE\.ssh\id_ed25519.pub

# macOS/Linux
cat ~/.ssh/id_ed25519.pub
```

å¤åˆ¶è¾“å‡ºçš„å…¬é’¥å†…å®¹ï¼Œç„¶ååœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# SSH ç™»å½•åˆ°æœåŠ¡å™¨
ssh chris@192.168.71.200

# åˆ›å»º .ssh ç›®å½•å¹¶è®¾ç½®æƒé™
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# å°†å…¬é’¥æ·»åŠ åˆ° authorized_keys
cat &gt;&gt; ~/.ssh/authorized_keys &lt;&lt;'EOF'
[ç²˜è´´æ‚¨åˆšæ‰å¤åˆ¶çš„å…¬é’¥å†…å®¹]
EOF

# è®¾ç½®æ­£ç¡®çš„æƒé™
chmod 600 ~/.ssh/authorized_keys
```

### 1.3 æµ‹è¯• SSH å¯†é’¥ç™»å½•

```bash
# é€€å‡ºå½“å‰ä¼šè¯
exit

# é‡æ–°è¿æ¥ï¼Œåº”è¯¥ä¸éœ€è¦è¾“å…¥å¯†ç 
ssh chris@192.168.71.200

# å¦‚æœæˆåŠŸï¼Œæ‚¨åº”è¯¥ç›´æ¥ç™»å½•ï¼Œæ— éœ€å¯†ç 
```

### 1.4 ï¼ˆå¯é€‰ï¼‰ç¦ç”¨å¯†ç ç™»å½•ï¼Œä»…å…è®¸å¯†é’¥è®¤è¯

âš ï¸ **è­¦å‘Š**: åœ¨æ‰§è¡Œæ­¤æ­¥éª¤å‰ï¼Œè¯·ç¡®ä¿å¯†é’¥ç™»å½•å·²ç»æµ‹è¯•æˆåŠŸï¼

```bash
# åˆ‡æ¢åˆ° root ç”¨æˆ·
sudo su -

# å¤‡ä»½ SSH é…ç½®æ–‡ä»¶
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%F)

# ä¿®æ”¹é…ç½®
cat &gt;&gt; /etc/ssh/sshd_config.d/10-harden.conf &lt;&lt;'EOF'
# ç¦ç”¨å¯†ç è®¤è¯
PasswordAuthentication no
# ç¦ç”¨è´¨è¯¢å“åº”è®¤è¯
ChallengeResponseAuthentication no
# å¯ç”¨å…¬é’¥è®¤è¯
PubkeyAuthentication yes
# ç¦æ­¢ root ç›´æ¥ç™»å½•ï¼ˆå»ºè®®ï¼‰
PermitRootLogin no
EOF

# æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
sshd -t

# å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œé‡å¯ SSH æœåŠ¡
systemctl restart sshd

# é€€å‡º rootï¼Œä¿æŒå½“å‰ SSH è¿æ¥ä¸è¦æ–­å¼€
exit
```

### 1.5 éªŒè¯é…ç½®

**åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£**æµ‹è¯•æ–°è¿æ¥ï¼ˆä¸è¦å…³é—­å½“å‰è¿æ¥ï¼Œä»¥é˜²é…ç½®é”™è¯¯ï¼‰ï¼š

```bash
# æµ‹è¯•å¯†é’¥ç™»å½•
ssh chris@192.168.71.200

# å¦‚æœæˆåŠŸï¼Œé…ç½®å®Œæˆï¼
```

---

## ğŸ“¦ æ­¥éª¤ 2: é…ç½®å›½å†…é•œåƒæºï¼ˆæå‡ä¸‹è½½é€Ÿåº¦ï¼‰

### 2.1 å¤‡ä»½åŸæœ‰é…ç½®

```bash
# åˆ‡æ¢åˆ° root
sudo su -

# å¤‡ä»½åŸæœ‰çš„ repo é…ç½®
# æ³¨æ„ï¼šè™½ç„¶ç›®å½•åæ˜¯ yum.repos.dï¼ˆå†å²é—ç•™ï¼‰ï¼Œä½†å‘½ä»¤ä½¿ç”¨ dnf
# åœ¨ Rocky 9 ä¸­ï¼Œyum åªæ˜¯ dnf çš„è½¯é“¾æ¥
mkdir -p /etc/yum.repos.d/backup
mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/
```

### 2.2 é…ç½®é˜¿é‡Œäº‘é•œåƒæº

```bash
# åˆ›å»º Rocky Linux 9 é˜¿é‡Œäº‘é•œåƒé…ç½®
cat &gt; /etc/yum.repos.d/rocky-aliyun.repo &lt;&lt;'EOF'
[baseos]
name=Rocky Linux $releasever - BaseOS - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[appstream]
name=Rocky Linux $releasever - AppStream - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[extras]
name=Rocky Linux $releasever - Extras - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/extras/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[crb]
name=Rocky Linux $releasever - CRB - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/CRB/$basearch/os/
gpgcheck=1
enabled=0
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9
EOF
```

### 2.3 é…ç½® EPEL é•œåƒæºï¼ˆé¢å¤–è½¯ä»¶åŒ…ï¼‰

```bash
# å®‰è£… EPEL ä»“åº“
dnf install -y epel-release

# å¤‡ä»½ EPEL åŸå§‹é…ç½®
cp /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak

# ä½¿ç”¨é˜¿é‡Œäº‘ EPEL é•œåƒ
sed -i 's|^metalink=|#metalink=|g' /etc/yum.repos.d/epel.repo
sed -i 's|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|g' /etc/yum.repos.d/epel.repo
```

### 2.4 æ¸…ç†å¹¶é‡å»ºç¼“å­˜

```bash
# æ¸…ç†ç¼“å­˜
dnf clean all

# åˆ›å»ºç¼“å­˜
dnf makecache

# éªŒè¯é•œåƒæº
dnf repolist
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼š
```
repo id                    repo name
appstream                  Rocky Linux 9 - AppStream - Aliyun
baseos                     Rocky Linux 9 - BaseOS - Aliyun
epel                       Extra Packages for Enterprise Linux 9
extras                     Rocky Linux 9 - Extras - Aliyun
```

---

## ğŸ”„ æ­¥éª¤ 3: ç³»ç»Ÿæ›´æ–°

### 3.1 æ›´æ–°æ‰€æœ‰è½¯ä»¶åŒ…

```bash
# æ›´æ–°ç³»ç»Ÿï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰
dnf update -y

# æŸ¥çœ‹æ›´æ–°äº†å“ªäº›åŒ…
dnf history info last
```

### 3.2 å¦‚æœå†…æ ¸æ›´æ–°ï¼Œé‡å¯ç³»ç»Ÿ

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…æ ¸
dnf list kernel --installed

# å¦‚æœæ›´æ–°äº†å†…æ ¸ï¼Œé‡å¯ç³»ç»Ÿ
reboot

# ç­‰å¾…çº¦ 1 åˆ†é’Ÿåé‡æ–°è¿æ¥
# ssh chris@192.168.71.200

# éªŒè¯å†…æ ¸ç‰ˆæœ¬
uname -r
```

---

## ğŸ› ï¸ æ­¥éª¤ 4: å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·

### 4.1 å®‰è£…å¸¸ç”¨å·¥å…·åŒ…

```bash
sudo su -

# å®‰è£…å¼€å‘å·¥å…·å’Œå¸¸ç”¨è½¯ä»¶
dnf install -y \
    vim \
    wget \
    curl \
    git \
    htop \
    tmux \
    net-tools \
    bind-utils \
    telnet \
    traceroute \
    lsof \
    sysstat \
    iotop \
    ncdu \
    tree \
    rsync \
    bash-completion \
    policycoreutils-python-utils

# éªŒè¯å®‰è£…
which vim git htop
```

### 4.2 é…ç½® vim åŸºç¡€ç¯å¢ƒ

```bash
# ä¸º root ç”¨æˆ·é…ç½® vim
cat &gt; /root/.vimrc &lt;&lt;'EOF'
syntax on
set number
set tabstop=4
set shiftwidth=4
set expandtab
set autoindent
set smartindent
set showmatch
set hlsearch
set incsearch
set ignorecase
set smartcase
set encoding=utf-8
EOF

# ä¸º chris ç”¨æˆ·é…ç½® vim
cp /root/.vimrc /home/chris/.vimrc
chown chris:chris /home/chris/.vimrc
```

---

## â° æ­¥éª¤ 5: æ—¶åŒºå’Œæ—¶é—´åŒæ­¥é…ç½®

### 5.1 è®¾ç½®æ—¶åŒº

```bash
# æŸ¥çœ‹å½“å‰æ—¶åŒº
timedatectl

# è®¾ç½®ä¸ºä¸­å›½æ—¶åŒº
timedatectl set-timezone Asia/Shanghai

# éªŒè¯
timedatectl
date
```

### 5.2 é…ç½® NTP æ—¶é—´åŒæ­¥

```bash
# å®‰è£… chronyï¼ˆRocky 9 é»˜è®¤æ—¶é—´åŒæ­¥å·¥å…·ï¼‰
dnf install -y chrony

# å¤‡ä»½é…ç½®
cp /etc/chrony.conf /etc/chrony.conf.bak

# é…ç½®å›½å†… NTP æœåŠ¡å™¨
cat &gt; /etc/chrony.conf &lt;&lt;'EOF'
# ä½¿ç”¨é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘ NTP æœåŠ¡å™¨
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst
server ntp.tencent.com iburst
server cn.ntp.org.cn iburst

# æœ¬åœ°æ—¶é—´æº
driftfile /var/lib/chrony/drift

# å…è®¸ç³»ç»Ÿæ—¶é’Ÿå¤§å¹…è°ƒæ•´
makestep 1.0 3

# å¯ç”¨å†…æ ¸æ—¶é—´åŒæ­¥
rtcsync

# è®°å½•æ—¥å¿—
logdir /var/log/chrony
EOF

# å¯åŠ¨å¹¶å¯ç”¨ chrony æœåŠ¡
systemctl enable --now chronyd

# æŸ¥çœ‹åŒæ­¥çŠ¶æ€
chronyc sources -v
chronyc tracking
```

---

## ğŸ”¥ æ­¥éª¤ 6: é˜²ç«å¢™é…ç½®

### 6.1 æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€

```bash
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
systemctl status firewalld

# æŸ¥çœ‹å½“å‰è§„åˆ™
firewall-cmd --list-all
```

### 6.2 é…ç½®é˜²ç«å¢™è§„åˆ™

```bash
# ç¡®ä¿ SSH ç«¯å£å¼€æ”¾ï¼ˆé»˜è®¤å·²å¼€æ”¾ï¼‰
firewall-cmd --permanent --add-service=ssh

# å¼€æ”¾ Cockpit Web æ§åˆ¶å°ç«¯å£ï¼ˆåç»­ç›‘æ§éœ€è¦ï¼‰
firewall-cmd --permanent --add-service=cockpit

# å¼€æ”¾ KVM è™šæ‹Ÿæœºç®¡ç†ç«¯å£ï¼ˆå¦‚éœ€è¿œç¨‹ç®¡ç†ï¼‰
firewall-cmd --permanent --add-service=libvirt

# é‡è½½é˜²ç«å¢™è§„åˆ™
firewall-cmd --reload

# éªŒè¯è§„åˆ™
firewall-cmd --list-all
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
public (active)
  target: default
  services: cockpit dhcpv6-client libvirt ssh
  ...
```

---

## ğŸ›¡ï¸ æ­¥éª¤ 7: SELinux é…ç½®

### 7.1 æŸ¥çœ‹ SELinux çŠ¶æ€

```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
getenforce
sestatus
```

### 7.2 é…ç½® SELinux

å¯¹äº KVM è™šæ‹ŸåŒ–ç¯å¢ƒï¼Œå»ºè®®ä¿æŒ SELinux ä¸º **Permissive** æˆ– **Enforcing** æ¨¡å¼ã€‚

**é€‰é¡¹ A: ä¿æŒ Enforcingï¼ˆæ¨èï¼Œæ›´å®‰å…¨ï¼‰**

```bash
# ç¡®ä¿ SELinux å¤„äº enforcing æ¨¡å¼
setenforce 1

# æ°¸ä¹…è®¾ç½®
sed -i 's/^SELINUX=.*/SELINUX=enforcing/' /etc/selinux/config

# å®‰è£… SELinux ç®¡ç†å·¥å…·
dnf install -y policycoreutils-python-utils

# éªŒè¯
getenforce
```

**é€‰é¡¹ B: è®¾ç½®ä¸º Permissiveï¼ˆä»…è®°å½•ä¸é˜»æ­¢ï¼‰**

```bash
# è®¾ç½®ä¸º permissive æ¨¡å¼
setenforce 0

# æ°¸ä¹…è®¾ç½®
sed -i 's/^SELINUX=.*/SELINUX=permissive/' /etc/selinux/config

# éªŒè¯
getenforce
```

âš ï¸ **æ³¨æ„**: å¦‚æœæ‚¨æ˜¯ Linux æ–°æ‰‹ï¼Œå»ºè®®ä½¿ç”¨ Permissive æ¨¡å¼ï¼Œè¿™æ · SELinux ä¸ä¼šé˜»æ­¢æ“ä½œï¼Œåªä¼šè®°å½•è¿è§„ã€‚ç­‰ç†Ÿæ‚‰åå†åˆ‡æ¢åˆ° Enforcingã€‚

---

## ğŸ“Š æ­¥éª¤ 8: ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥

### 8.1 åˆ›å»ºç³»ç»Ÿä¿¡æ¯æŸ¥çœ‹è„šæœ¬

```bash
cat &gt; /usr/local/bin/sysinfo &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "         ç³»ç»Ÿä¿¡æ¯æ¦‚è§ˆ"
echo "========================================="
echo ""

echo "ä¸»æœºå: $(hostname)"
echo "ç³»ç»Ÿç‰ˆæœ¬: $(cat /etc/redhat-release)"
echo "å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
echo "è¿è¡Œæ—¶é—´: $(uptime -p)"
echo ""

echo "--- CPU ä¿¡æ¯ ---"
echo "å‹å·: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
echo "æ ¸å¿ƒæ•°: $(nproc) æ ¸å¿ƒ"
echo "è™šæ‹ŸåŒ–: $(lscpu | grep 'Virtualization' | cut -d: -f2 | xargs)"
echo ""

echo "--- å†…å­˜ä¿¡æ¯ ---"
free -h | grep -E 'Mem|Swap'
echo ""

echo "--- ç£ç›˜ä½¿ç”¨ ---"
df -h | grep -E 'Filesystem|^/dev'
echo ""

echo "--- ç½‘ç»œé…ç½® ---"
ip -br addr show | grep -E 'UP|192.168'
echo ""

echo "--- ç³»ç»Ÿè´Ÿè½½ ---"
uptime
echo ""

echo "========================================="
EOF

chmod +x /usr/local/bin/sysinfo
```

### 8.2 è¿è¡Œç³»ç»Ÿä¿¡æ¯è„šæœ¬

```bash
sysinfo
```

### 8.3 éªŒè¯è™šæ‹ŸåŒ–æ”¯æŒ

```bash
# æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–
lscpu | grep Virtualization

# AMD CPU åº”è¯¥æ˜¾ç¤º: AMD-V
# Intel CPU åº”è¯¥æ˜¾ç¤º: VT-x

# æ£€æŸ¥å†…æ ¸æ¨¡å—
lsmod | grep kvm

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œå°è¯•åŠ è½½æ¨¡å—
modprobe kvm
modprobe kvm_amd  # AMD CPU
# æˆ–
modprobe kvm_intel  # Intel CPU
```

---

## âœ… æ­¥éª¤ 9: éªŒè¯é…ç½®

### 9.1 åˆ›å»ºé…ç½®éªŒè¯è„šæœ¬

```bash
cat &gt; /root/verify-host-init.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       å®¿ä¸»æœºé…ç½®éªŒè¯"
echo "========================================="
echo ""

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

check_pass() {
    echo -e "${GREEN}âœ“${NC} $1"
}

check_fail() {
    echo -e "${RED}âœ—${NC} $1"
}

# 1. SSH å¯†é’¥é…ç½®
echo "1. æ£€æŸ¥ SSH é…ç½®..."
if grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config* 2&gt;/dev/null; then
    check_pass "SSH å¯†é’¥è®¤è¯å·²é…ç½®"
else
    check_fail "SSH å¯†ç è®¤è¯ä»ç„¶å¯ç”¨ï¼ˆå¯é€‰é¡¹ï¼‰"
fi

# 2. é•œåƒæºé…ç½®
echo "2. æ£€æŸ¥é•œåƒæº..."
if grep -q "aliyun.com" /etc/yum.repos.d/*.repo 2&gt;/dev/null; then
    check_pass "å›½å†…é•œåƒæºå·²é…ç½®"
else
    check_fail "æœªé…ç½®å›½å†…é•œåƒæº"
fi

# 3. ç³»ç»Ÿæ›´æ–°
echo "3. æ£€æŸ¥ç³»ç»Ÿæ›´æ–°..."
if dnf check-update &amp;&gt;/dev/null; then
    check_pass "ç³»ç»Ÿå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
else
    updates=$(dnf check-update 2&gt;/dev/null | grep -E '^[a-z]' | wc -l)
    if [ $updates -eq 0 ]; then
        check_pass "ç³»ç»Ÿå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    else
        check_fail "æœ‰ $updates ä¸ªè½¯ä»¶åŒ…å¯æ›´æ–°"
    fi
fi

# 4. æ—¶é—´åŒæ­¥
echo "4. æ£€æŸ¥æ—¶é—´åŒæ­¥..."
if systemctl is-active chronyd &amp;&gt;/dev/null; then
    check_pass "æ—¶é—´åŒæ­¥æœåŠ¡è¿è¡Œä¸­"
else
    check_fail "æ—¶é—´åŒæ­¥æœåŠ¡æœªè¿è¡Œ"
fi

# 5. é˜²ç«å¢™
echo "5. æ£€æŸ¥é˜²ç«å¢™..."
if systemctl is-active firewalld &amp;&gt;/dev/null; then
    check_pass "é˜²ç«å¢™è¿è¡Œä¸­"
    if firewall-cmd --list-services | grep -q cockpit; then
        check_pass "Cockpit ç«¯å£å·²å¼€æ”¾"
    else
        check_fail "Cockpit ç«¯å£æœªå¼€æ”¾"
    fi
else
    check_fail "é˜²ç«å¢™æœªè¿è¡Œ"
fi

# 6. SELinux
echo "6. æ£€æŸ¥ SELinux..."
selinux_status=$(getenforce)
if [ "$selinux_status" == "Enforcing" ] || [ "$selinux_status" == "Permissive" ]; then
    check_pass "SELinux çŠ¶æ€: $selinux_status"
else
    check_fail "SELinux çŠ¶æ€: $selinux_status"
fi

# 7. è™šæ‹ŸåŒ–æ”¯æŒ
echo "7. æ£€æŸ¥è™šæ‹ŸåŒ–æ”¯æŒ..."
if lscpu | grep -q 'AMD-V\|VT-x'; then
    virt_type=$(lscpu | grep Virtualization | cut -d: -f2 | xargs)
    check_pass "CPU è™šæ‹ŸåŒ–æ”¯æŒ: $virt_type"
else
    check_fail "CPU è™šæ‹ŸåŒ–æœªå¯ç”¨ï¼ˆéœ€åœ¨ BIOS ä¸­å¯ç”¨ï¼‰"
fi

echo ""
echo "========================================="
echo "éªŒè¯å®Œæˆï¼"
echo "========================================="
EOF

chmod +x /root/verify-host-init.sh
```

### 9.2 è¿è¡ŒéªŒè¯è„šæœ¬

```bash
/root/verify-host-init.sh
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

å®Œæˆæœ¬æ–‡æ¡£åï¼Œæ‚¨åº”è¯¥å·²ç»é…ç½®å¥½ï¼š

- [x] SSH å¯†é’¥è®¤è¯ç™»å½•
- [x] ï¼ˆå¯é€‰ï¼‰ç¦ç”¨å¯†ç ç™»å½•
- [x] å›½å†…é•œåƒæºï¼ˆé˜¿é‡Œäº‘/æ¸…åï¼‰
- [x] ç³»ç»Ÿæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- [x] å¸¸ç”¨å¼€å‘å·¥å…·å’Œç®¡ç†å·¥å…·
- [x] æ—¶åŒºè®¾ç½®ä¸º Asia/Shanghai
- [x] NTP æ—¶é—´åŒæ­¥
- [x] é˜²ç«å¢™è§„åˆ™ï¼ˆSSH + Cockpitï¼‰
- [x] SELinux é…ç½®
- [x] éªŒè¯ CPU è™šæ‹ŸåŒ–æ”¯æŒ

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: SSH å¯†é’¥ç™»å½•å¤±è´¥

**ç—‡çŠ¶**: é…ç½®å¯†é’¥åä»ç„¶è¦æ±‚è¾“å…¥å¯†ç 

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æƒé™
ls -la ~/.ssh
# .ssh ç›®å½•åº”è¯¥æ˜¯ 700
# authorized_keys åº”è¯¥æ˜¯ 600

# ä¿®å¤æƒé™
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

# æŸ¥çœ‹ SSH æ—¥å¿—
sudo tail -f /var/log/secure

# å°è¯•è¿æ¥æ—¶æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
ssh -v chris@192.168.71.200
```

### é—®é¢˜ 2: é•œåƒæºé…ç½®åä»ç„¶å¾ˆæ…¢

**ç—‡çŠ¶**: dnf ä¸‹è½½é€Ÿåº¦ä»ç„¶å¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å°è¯•æ¸…åå¤§å­¦é•œåƒæº
sed -i 's|mirrors.aliyun.com|mirrors.tuna.tsinghua.edu.cn|g' /etc/yum.repos.d/*.repo

# æ¸…ç†å¹¶é‡å»ºç¼“å­˜
dnf clean all
dnf makecache
```

### é—®é¢˜ 3: CPU è™šæ‹ŸåŒ–æœªæ£€æµ‹åˆ°

**ç—‡çŠ¶**: `lscpu | grep Virtualization` æ— è¾“å‡º

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. ç¡®è®¤ CPU æ”¯æŒè™šæ‹ŸåŒ–
cat /proc/cpuinfo | grep -E 'vmx|svm'

# vmx = Intel VT-x
# svm = AMD-V

# 2. å¦‚æœæœ‰è¾“å‡ºä½† lscpu æ²¡æœ‰ï¼Œéœ€è¦åœ¨ BIOS ä¸­å¯ç”¨è™šæ‹ŸåŒ–
# AMD: æŸ¥æ‰¾ "SVM Mode" æˆ– "AMD-V"
# Intel: æŸ¥æ‰¾ "Intel VT-x" æˆ– "Virtualization Technology"

# 3. å¯ç”¨åé‡å¯ç³»ç»ŸéªŒè¯
reboot
```

### é—®é¢˜ 4: æ—¶é—´åŒæ­¥å¤±è´¥

**ç—‡çŠ¶**: chronyc æ— æ³•åŒæ­¥æ—¶é—´

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ chronyd çŠ¶æ€
systemctl status chronyd

# æŸ¥çœ‹åŒæ­¥æº
chronyc sources

# å¦‚æœå…¨éƒ¨æ˜¾ç¤º ^?, æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --add-service=ntp --permanent
firewall-cmd --reload

# æ‰‹åŠ¨å¼ºåˆ¶åŒæ­¥
chronyc -a makestep

# æŸ¥çœ‹åŒæ­¥çŠ¶æ€
chronyc tracking
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»å®Œæˆäº†å®¿ä¸»æœºçš„åŸºç¡€é…ç½®ã€‚

ç°åœ¨æ‚¨å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ï¼š

ğŸ‘‰ **[02-kvm-setup.md - KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»º](#section-2)**

---

## ğŸ’¡ è¡¥å……è¯´æ˜

### ä¸ºä»€ä¹ˆè¦é…ç½®å›½å†…é•œåƒæºï¼Ÿ

- **ä¸‹è½½é€Ÿåº¦**: å›½å¤–æºåœ¨å›½å†…è®¿é—®é€Ÿåº¦å¾ˆæ…¢ï¼Œé…ç½®å›½å†…é•œåƒæºå¯ä»¥å°†ä¸‹è½½é€Ÿåº¦ä» 100KB/s æå‡åˆ° 10MB/s ä»¥ä¸Š
- **ç¨³å®šæ€§**: å‡å°‘å› ç½‘ç»œé—®é¢˜å¯¼è‡´çš„å®‰è£…å¤±è´¥
- **èŠ‚çœæ—¶é—´**: å¤§å¹…ç¼©çŸ­è½¯ä»¶å®‰è£…å’Œç³»ç»Ÿæ›´æ–°æ—¶é—´

### SSH å¯†é’¥ vs å¯†ç ç™»å½•

| ç‰¹æ€§ | å¯†é’¥è®¤è¯ | å¯†ç è®¤è¯ |
|------|----------|----------|
| å®‰å…¨æ€§ | â­â­â­â­â­ | â­â­â­â˜†â˜† |
| ä¾¿åˆ©æ€§ | â­â­â­â­â­ | â­â­â­â˜†â˜† |
| æŠ—æš´åŠ›ç ´è§£ | â­â­â­â­â­ | â­â­â˜†â˜†â˜† |
| é…ç½®éš¾åº¦ | â­â­â­â˜†â˜† | â­â˜†â˜†â˜†â˜† |

**å»ºè®®**: å®¶åº­æœåŠ¡å™¨å»ºè®®ä½¿ç”¨å¯†é’¥è®¤è¯ï¼Œæ›´å®‰å…¨ä¸”ä¸éœ€è¦æ¯æ¬¡è¾“å…¥å¯†ç ã€‚

### SELinux æ¨¡å¼é€‰æ‹©

- **Enforcing**: æœ€å®‰å…¨ï¼Œå¼ºåˆ¶æ‰§è¡Œç­–ç•¥ï¼Œå¯èƒ½é˜»æ­¢æŸäº›æ“ä½œ
- **Permissive**: æŠ˜ä¸­æ–¹æ¡ˆï¼Œåªè®°å½•è¿è§„ä¸é˜»æ­¢ï¼Œé€‚åˆå­¦ä¹ 
- **Disabled**: ä¸æ¨èï¼Œé™¤éç‰¹æ®Šéœ€æ±‚

**å»ºè®®**: æ–°æ‰‹ä½¿ç”¨ Permissiveï¼Œç†Ÿæ‚‰ååˆ‡æ¢åˆ° Enforcingã€‚

### YUM vs DNF

è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„ç–‘é—®ï¼š

**åœ¨ Rocky Linux 9 ä¸­**:
- **DNF** (Dandified YUM) æ˜¯çœŸæ­£çš„åŒ…ç®¡ç†å™¨
- **YUM** åªæ˜¯æŒ‡å‘ DNF çš„è½¯é“¾æ¥ï¼ˆä¸ºäº†å‘åå…¼å®¹ï¼‰
- é…ç½®ç›®å½•ä»å« `/etc/yum.repos.d/`ï¼ˆå†å²é—ç•™å‘½åï¼‰

```bash
# éªŒè¯ yum æ˜¯ dnf çš„è½¯é“¾æ¥
ls -l /usr/bin/yum
# è¾“å‡ºï¼š/usr/bin/yum -&gt; dnf-3

# ä¸¤ä¸ªå‘½ä»¤å®Œå…¨ç­‰ä»·
yum install package  # å®é™…è°ƒç”¨ dnf
dnf install package  # ç›´æ¥è°ƒç”¨ dnf
```

**ä¸ºä»€ä¹ˆç›®å½•è¿˜å« yum.repos.dï¼Ÿ**
- å†å²å…¼å®¹æ€§ï¼šé¿å…ç ´åç°æœ‰è„šæœ¬å’Œæ–‡æ¡£
- é€šç”¨çº¦å®šï¼šæ‰€æœ‰ RHEL ç³»åˆ—éƒ½ç”¨è¿™ä¸ªç›®å½•å
- å®é™…ä¸å½±å“ä½¿ç”¨ï¼šDNF ä¼šè‡ªåŠ¨è¯»å–è¯¥ç›®å½•

**æœ€ä½³å®è·µ**:
- âœ… å‘½ä»¤ä½¿ç”¨ `dnf`ï¼ˆæ›´æ˜ç¡®ï¼Œæ¨èï¼‰
- âœ… é…ç½®ç›®å½•ä»æ˜¯ `/etc/yum.repos.d/`ï¼ˆç³»ç»Ÿæ ‡å‡†ï¼‰
- âš ï¸ ä¸è¦è¢«ç›®å½•åå›°æƒ‘ï¼Œå®ƒä»¬æ˜¯åŒä¸€ä¸ªä¸œè¥¿

æœ¬æ–‡æ¡£ç»Ÿä¸€ä½¿ç”¨ `dnf` å‘½ä»¤ï¼Œä½†é…ç½®ç›®å½•ä»ç„¶æ˜¯ `yum.repos.d`ã€‚




---



# 02 - KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»º

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨åœ¨ Rocky Linux 9 ä¸Šå®‰è£…å’Œé…ç½® KVM (Kernel-based Virtual Machine) è™šæ‹ŸåŒ–ç¯å¢ƒï¼ŒåŒ…æ‹¬ï¼š

- âœ… éªŒè¯ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ
- âœ… å®‰è£… KVM/QEMU å’Œç›¸å…³å·¥å…·
- âœ… é…ç½® libvirt æœåŠ¡
- âœ… åˆ›å»ºç½‘æ¡¥ (Bridge) ç½‘ç»œ
- âœ… å®‰è£…è™šæ‹Ÿæœºç®¡ç†å·¥å…·
- âœ… éªŒè¯ KVM ç¯å¢ƒ

**å‰ç½®æ¡ä»¶**: å·²å®Œæˆ [01-host-init.md](#section-1)  
**é¢„è®¡è€—æ—¶**: 30 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†

---

## ğŸ” æ­¥éª¤ 1: éªŒè¯è™šæ‹ŸåŒ–æ”¯æŒ

### 1.1 æ£€æŸ¥ CPU è™šæ‹ŸåŒ–æ‰©å±•

```bash
# æ–¹æ³• 1: ä½¿ç”¨ lscpu
lscpu | grep Virtualization

# AMD CPU åº”è¯¥æ˜¾ç¤º: Virtualization:      AMD-V
# Intel CPU åº”è¯¥æ˜¾ç¤º: Virtualization:   VT-x

# æ–¹æ³• 2: æ£€æŸ¥ CPU flags
grep -E 'vmx|svm' /proc/cpuinfo

# vmx = Intel VT-x
# svm = AMD-V
# å¦‚æœæœ‰å¤§é‡è¾“å‡ºï¼Œè¯´æ˜è™šæ‹ŸåŒ–å·²å¯ç”¨
```

### 1.2 æ£€æŸ¥å†…æ ¸ KVM æ¨¡å—

```bash
# æ£€æŸ¥ KVM æ¨¡å—æ˜¯å¦å·²åŠ è½½
lsmod | grep kvm

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œæ‰‹åŠ¨åŠ è½½æ¨¡å—
sudo modprobe kvm
sudo modprobe kvm_amd   # å¯¹äº AMD CPU (R5 5600G)
# æˆ–
# sudo modprobe kvm_intel  # å¯¹äº Intel CPU

# å†æ¬¡æ£€æŸ¥
lsmod | grep kvm
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
kvm_amd               188416  0
kvm                  1282048  1 kvm_amd
```

### 1.3 éªŒè¯ KVM è®¾å¤‡

```bash
# æ£€æŸ¥ KVM è®¾å¤‡æ–‡ä»¶
ls -l /dev/kvm

# åº”è¯¥æ˜¾ç¤º:
# crw-rw-rw-. 1 root kvm 10, 232 xxx /dev/kvm
```

---

## ğŸ“¦ æ­¥éª¤ 2: å®‰è£… KVM å’Œè™šæ‹ŸåŒ–å·¥å…·

### 2.1 å®‰è£… KVM ç›¸å…³è½¯ä»¶åŒ…

```bash
sudo su -

# å®‰è£…è™šæ‹ŸåŒ–è½¯ä»¶åŒ…ç»„
dnf groupinstall -y "Virtualization Host"

# æˆ–è€…æ‰‹åŠ¨å®‰è£…æ ¸å¿ƒç»„ä»¶
dnf install -y \
    qemu-kvm \
    libvirt \
    libvirt-daemon-kvm \
    libvirt-daemon-config-network \
    libvirt-daemon-config-nwfilter \
    virt-install \
    virt-viewer \
    virt-manager \
    libguestfs-tools \
    libguestfs-xfs \
    python3-libvirt \
    bridge-utils \
    net-tools
```

### 2.2 éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥ QEMU ç‰ˆæœ¬
qemu-kvm --version

# æ£€æŸ¥ libvirt ç‰ˆæœ¬
libvirtd --version

# æ£€æŸ¥ virt-install
virt-install --version
```

---

## ğŸ”§ æ­¥éª¤ 3: é…ç½® libvirt æœåŠ¡

### 3.1 å¯åŠ¨ libvirt æœåŠ¡

```bash
# å¯åŠ¨ libvirtd
systemctl start libvirtd

# è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable libvirtd

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status libvirtd
```

### 3.2 é…ç½® libvirt ç”¨æˆ·ç»„

```bash
# å°† chris ç”¨æˆ·æ·»åŠ åˆ° libvirt ç»„ï¼ˆå…è®¸ç®¡ç†è™šæ‹Ÿæœºï¼‰
usermod -aG libvirt chris

# å°† chris ç”¨æˆ·æ·»åŠ åˆ° kvm ç»„
usermod -aG kvm chris

# éªŒè¯
groups chris
```

### 3.3 é…ç½® libvirt ç½‘ç»œ

```bash
# æŸ¥çœ‹é»˜è®¤ç½‘ç»œ
virsh net-list --all

# åº”è¯¥çœ‹åˆ° default ç½‘ç»œ
# å¦‚æœ default ç½‘ç»œä¸æ´»è·ƒï¼Œå¯åŠ¨å®ƒ
virsh net-start default
virsh net-autostart default

# éªŒè¯
virsh net-list --all
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
 åç§°      çŠ¶æ€    è‡ªåŠ¨å¼€å§‹  æŒä¹…
---------------------------------------
 default   æ´»åŠ¨    æ˜¯        æ˜¯
```

âš ï¸ **æ³¨æ„**: default ç½‘ç»œæ˜¯ NAT æ¨¡å¼ï¼Œæˆ‘ä»¬åç»­ä¼šåˆ›å»º Bridge æ¨¡å¼ç½‘ç»œï¼Œä½†ä¿ç•™ default ç½‘ç»œä½œä¸ºå¤‡é€‰ã€‚

---

## ğŸŒ‰ æ­¥éª¤ 4: åˆ›å»ºç½‘æ¡¥ (Bridge) ç½‘ç»œ

### 4.1 æŸ¥çœ‹å½“å‰ç½‘ç»œé…ç½®

```bash
# æŸ¥çœ‹ç½‘ç»œæ¥å£
ip addr show

# æŸ¥çœ‹å½“å‰ç½‘ç»œè¿æ¥
nmcli connection show

# è®°å½•å½“å‰ç‰©ç†ç½‘å¡åç§°ï¼ˆé€šå¸¸æ˜¯ eno1, enp1s0, eth0 ç­‰ï¼‰
# å‡è®¾æ‚¨çš„ç½‘å¡æ˜¯ enp1s0
```

### 4.2 åˆ›å»ºç½‘æ¡¥é…ç½®

âš ï¸ **é‡è¦**: ä»¥ä¸‹æ“ä½œä¼šçŸ­æš‚ä¸­æ–­ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿æ‚¨æ˜¯é€šè¿‡æœ¬åœ°æ“ä½œæˆ–æœ‰å¤‡ç”¨è¿æ¥æ–¹å¼ï¼

```bash
# è®¾ç½®å˜é‡ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
BRIDGE_NAME="br0"
PHYSICAL_INTERFACE="enp1s0"  # â† æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ç½‘å¡åç§°
HOST_IP="192.168.71.200"
GATEWAY="192.168.71.1"
DNS1="192.168.71.1"
DNS2="223.5.5.5"  # é˜¿é‡Œ DNS

# å¤‡ä»½å½“å‰ç½‘ç»œé…ç½®
cp -r /etc/NetworkManager/system-connections/ /root/network-backup-$(date +%F)

# åˆ›å»ºç½‘æ¡¥
nmcli connection add type bridge \
    con-name $BRIDGE_NAME \
    ifname $BRIDGE_NAME \
    ipv4.method manual \
    ipv4.addresses $HOST_IP/24 \
    ipv4.gateway $GATEWAY \
    ipv4.dns "$DNS1 $DNS2"

# å°†ç‰©ç†ç½‘å¡æ·»åŠ åˆ°ç½‘æ¡¥ï¼ˆä½œä¸º slaveï¼‰
nmcli connection add type bridge-slave \
    con-name ${BRIDGE_NAME}-slave \
    ifname $PHYSICAL_INTERFACE \
    master $BRIDGE_NAME

# ç¦ç”¨åŸæœ‰çš„ç‰©ç†ç½‘å¡è¿æ¥
OLD_CONNECTION=$(nmcli -g NAME,DEVICE connection show | grep "$PHYSICAL_INTERFACE" | grep -v slave | cut -d: -f1)
if [ -n "$OLD_CONNECTION" ]; then
    nmcli connection down "$OLD_CONNECTION"
    nmcli connection delete "$OLD_CONNECTION"
fi

# å¯åŠ¨ç½‘æ¡¥
nmcli connection up $BRIDGE_NAME
nmcli connection up ${BRIDGE_NAME}-slave
```

### 4.3 éªŒè¯ç½‘æ¡¥é…ç½®

```bash
# ç­‰å¾…å‡ ç§’é’Ÿè®©ç½‘ç»œç¨³å®š
sleep 5

# æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
ip addr show br0

# æ£€æŸ¥æ¡¥æ¥æ¥å£
bridge link show

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping -c 4 192.168.71.1
ping -c 4 223.5.5.5

# æ£€æŸ¥ DNS è§£æ
nslookup www.baidu.com
```

### 4.4 åˆ›å»º libvirt ç½‘æ¡¥ç½‘ç»œå®šä¹‰

```bash
# åˆ›å»ºç½‘æ¡¥ç½‘ç»œ XML å®šä¹‰
cat &gt; /tmp/br0-network.xml &lt;&lt;'EOF'
&lt;network&gt;
  &lt;name&gt;br0&lt;/name&gt;
  &lt;forward mode="bridge"/&gt;
  &lt;bridge name="br0"/&gt;
&lt;/network&gt;
EOF

# å®šä¹‰ç½‘ç»œ
virsh net-define /tmp/br0-network.xml

# å¯åŠ¨ç½‘ç»œ
virsh net-start br0

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh net-autostart br0

# éªŒè¯
virsh net-list --all
```

---

## ğŸ› ï¸ æ­¥éª¤ 5: é…ç½®é˜²ç«å¢™å’Œ SELinux

### 5.1 é…ç½®é˜²ç«å¢™

```bash
# å…è®¸ç½‘æ¡¥æµé‡é€šè¿‡
firewall-cmd --permanent --zone=public --add-interface=br0

# å…è®¸ libvirt ç›¸å…³æœåŠ¡
firewall-cmd --permanent --add-service=libvirt

# å¯ç”¨ IP è½¬å‘ï¼ˆå¦‚æœéœ€è¦è™šæ‹Ÿæœºè®¿é—®å¤–ç½‘ï¼‰
firewall-cmd --permanent --add-masquerade

# é‡è½½é˜²ç«å¢™
firewall-cmd --reload

# éªŒè¯
firewall-cmd --list-all
firewall-cmd --get-active-zones
```

### 5.2 é…ç½® SELinux

```bash
# è®¾ç½® SELinux å¸ƒå°”å€¼ï¼Œå…è®¸ libvirt ä½¿ç”¨ NFS ç­‰
setsebool -P virt_use_nfs 1
setsebool -P virt_use_samba 1

# å¦‚æœä½¿ç”¨ virtio-fs å…±äº«ç›®å½•ï¼ˆåç»­ NAS ä¼šç”¨åˆ°ï¼‰
setsebool -P virt_use_fusefs 1

# æ£€æŸ¥è®¾ç½®
getsebool -a | grep virt
```

---

## ğŸ“‚ æ­¥éª¤ 6: é…ç½®è™šæ‹Ÿæœºå­˜å‚¨ç›®å½•

### 6.1 åˆ›å»º ISO é•œåƒå­˜å‚¨ç›®å½•

```bash
# åˆ›å»ºç›®å½•
mkdir -p /kvm/iso
chmod 755 /kvm/iso

# åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜ä¸´æ—¶å­˜å‚¨ç›®å½•ï¼ˆåç»­ä¼šé…ç½® LVM å­˜å‚¨æ± ï¼‰
mkdir -p /kvm/images
chmod 711 /kvm/images

# è®¾ç½® SELinux ä¸Šä¸‹æ–‡
semanage fcontext -a -t virt_image_t '/kvm/iso(/.*)?'
semanage fcontext -a -t virt_image_t '/kvm/images(/.*)?'
restorecon -Rv /kvm
```

### 6.2 å®šä¹‰ ISO å­˜å‚¨æ± 

```bash
# å®šä¹‰ ISO å­˜å‚¨æ± 
virsh pool-define-as iso_pool dir - - - - /kvm/iso

# æ„å»ºå¹¶å¯åŠ¨
virsh pool-build iso_pool
virsh pool-start iso_pool
virsh pool-autostart iso_pool

# éªŒè¯
virsh pool-list --all
virsh pool-info iso_pool
```

---

## âœ… æ­¥éª¤ 7: éªŒè¯ KVM ç¯å¢ƒ

### 7.1 ä½¿ç”¨ virt-host-validate éªŒè¯

```bash
# å®‰è£…éªŒè¯å·¥å…·ï¼ˆé€šå¸¸å·²åŒ…å«ï¼‰
dnf install -y libvirt-client

# è¿è¡ŒéªŒè¯
virt-host-validate

# æ‚¨åº”è¯¥çœ‹åˆ°å¤§éƒ¨åˆ†é¡¹ç›®æ˜¾ç¤º PASS
# å¦‚æœæœ‰ WARN æˆ– FAILï¼ŒæŸ¥çœ‹æç¤ºä¿¡æ¯ä¿®å¤
```

é¢„æœŸè¾“å‡ºï¼š
```
  QEMU: Checking for hardware virtualization                                 : PASS
  QEMU: Checking if device /dev/kvm exists                                   : PASS
  QEMU: Checking if device /dev/kvm is accessible                            : PASS
  QEMU: Checking if device /dev/vhost-net exists                             : PASS
  QEMU: Checking if device /dev/net/tun exists                               : PASS
  QEMU: Checking for cgroup 'cpu' controller support                         : PASS
  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS
  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS
  QEMU: Checking for cgroup 'memory' controller support                      : PASS
  QEMU: Checking for cgroup 'devices' controller support                     : PASS
  QEMU: Checking for cgroup 'blkio' controller support                       : PASS
  QEMU: Checking for device assignment IOMMU support                         : WARN (No ACPI IVRS table found, IOMMU either disabled in BIOS or not supported by this hardware platform)
  LXC: Checking for Linux &gt;= 2.6.26                                          : PASS
```

âš ï¸ **æ³¨æ„**: IOMMU è­¦å‘Šå¯ä»¥å¿½ç•¥ï¼Œé™¤éæ‚¨éœ€è¦ PCI è®¾å¤‡ç›´é€šåŠŸèƒ½ã€‚

### 7.2 åˆ›å»ºå®Œæ•´éªŒè¯è„šæœ¬

```bash
cat &gt; /root/verify-kvm-setup.sh &lt;&lt;'EOF'
#!/bin/bash

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "========================================="
echo "       KVM ç¯å¢ƒéªŒè¯"
echo "========================================="
echo ""

check_pass() {
    echo -e "${GREEN}âœ“${NC} $1"
}

check_fail() {
    echo -e "${RED}âœ—${NC} $1"
}

check_warn() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# 1. CPU è™šæ‹ŸåŒ–
echo "1. æ£€æŸ¥ CPU è™šæ‹ŸåŒ–æ”¯æŒ..."
if lscpu | grep -q 'AMD-V\|VT-x'; then
    virt_type=$(lscpu | grep Virtualization | cut -d: -f2 | xargs)
    check_pass "CPU è™šæ‹ŸåŒ–: $virt_type"
else
    check_fail "CPU è™šæ‹ŸåŒ–æœªå¯ç”¨"
    exit 1
fi

# 2. KVM æ¨¡å—
echo "2. æ£€æŸ¥ KVM å†…æ ¸æ¨¡å—..."
if lsmod | grep -q kvm; then
    check_pass "KVM æ¨¡å—å·²åŠ è½½"
else
    check_fail "KVM æ¨¡å—æœªåŠ è½½"
fi

# 3. libvirt æœåŠ¡
echo "3. æ£€æŸ¥ libvirt æœåŠ¡..."
if systemctl is-active --quiet libvirtd; then
    check_pass "libvirtd æœåŠ¡è¿è¡Œä¸­"
else
    check_fail "libvirtd æœåŠ¡æœªè¿è¡Œ"
fi

# 4. ç½‘æ¡¥é…ç½®
echo "4. æ£€æŸ¥ç½‘æ¡¥é…ç½®..."
if ip link show br0 &amp;&gt;/dev/null; then
    check_pass "ç½‘æ¡¥ br0 å·²åˆ›å»º"
    if virsh net-list | grep -q br0; then
        check_pass "libvirt ç½‘æ¡¥ç½‘ç»œå·²é…ç½®"
    else
        check_warn "libvirt ç½‘æ¡¥ç½‘ç»œæœªé…ç½®"
    fi
else
    check_fail "ç½‘æ¡¥ br0 ä¸å­˜åœ¨"
fi

# 5. å­˜å‚¨æ± 
echo "5. æ£€æŸ¥å­˜å‚¨æ± ..."
pool_count=$(virsh pool-list --all | grep -c 'active\|inactive')
if [ $pool_count -gt 0 ]; then
    check_pass "å·²é…ç½® $pool_count ä¸ªå­˜å‚¨æ± "
    virsh pool-list --all | tail -n +3 | while read line; do
        echo "   - $line"
    done
else
    check_warn "æœªé…ç½®å­˜å‚¨æ± "
fi

# 6. ç½‘ç»œè¿é€šæ€§
echo "6. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."
if ping -c 1 -W 2 192.168.71.1 &amp;&gt;/dev/null; then
    check_pass "ç½‘å…³è¿é€šæ­£å¸¸"
else
    check_fail "æ— æ³•è¿æ¥åˆ°ç½‘å…³"
fi

if ping -c 1 -W 2 223.5.5.5 &amp;&gt;/dev/null; then
    check_pass "å¤–ç½‘è¿é€šæ­£å¸¸"
else
    check_fail "æ— æ³•è¿æ¥åˆ°å¤–ç½‘"
fi

# 7. é˜²ç«å¢™
echo "7. æ£€æŸ¥é˜²ç«å¢™é…ç½®..."
if firewall-cmd --get-active-zones | grep -q br0; then
    check_pass "br0 å·²æ·»åŠ åˆ°é˜²ç«å¢™"
else
    check_warn "br0 æœªæ·»åŠ åˆ°é˜²ç«å¢™"
fi

# 8. ç”¨æˆ·ç»„
echo "8. æ£€æŸ¥ç”¨æˆ·ç»„..."
if groups chris | grep -q libvirt; then
    check_pass "chris ç”¨æˆ·åœ¨ libvirt ç»„"
else
    check_warn "chris ç”¨æˆ·ä¸åœ¨ libvirt ç»„"
fi

echo ""
echo "========================================="
echo "æ‰§è¡Œ virt-host-validate å®Œæ•´éªŒè¯..."
echo "========================================="
echo ""
virt-host-validate

echo ""
echo "========================================="
echo "éªŒè¯å®Œæˆï¼"
echo "========================================="
EOF

chmod +x /root/verify-kvm-setup.sh
```

### 7.3 è¿è¡ŒéªŒè¯è„šæœ¬

```bash
/root/verify-kvm-setup.sh
```

---

## ğŸ§ª æ­¥éª¤ 8: åˆ›å»ºæµ‹è¯•è™šæ‹Ÿæœºï¼ˆå¯é€‰ï¼‰

### 8.1 ä¸‹è½½è½»é‡çº§æµ‹è¯• ISO

```bash
# ä¸‹è½½ Alpine Linux (è½»é‡çº§ï¼Œçº¦ 200MB)
cd /kvm/iso
wget https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.19/releases/x86_64/alpine-virt-3.19.1-x86_64.iso

# åˆ·æ–° ISO å­˜å‚¨æ± 
virsh pool-refresh iso_pool

# éªŒè¯ ISO
virsh vol-list iso_pool
```

### 8.2 åˆ›å»ºæµ‹è¯•è™šæ‹Ÿæœº

```bash
# åˆ›å»ºæµ‹è¯•è™šæ‹Ÿæœºï¼ˆä½¿ç”¨ä¸´æ—¶ç›®å½•å­˜å‚¨ï¼‰
virt-install \
    --name test-vm \
    --ram 512 \
    --vcpus 1 \
    --disk path=/kvm/images/test-vm.qcow2,size=5,format=qcow2 \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0,port=5900 \
    --cdrom /kvm/iso/alpine-virt-3.19.1-x86_64.iso \
    --os-variant alpinelinux3.18 \
    --noautoconsole

# æŸ¥çœ‹è™šæ‹ŸæœºçŠ¶æ€
virsh list --all

# æŸ¥çœ‹ VNC ç«¯å£
virsh vncdisplay test-vm
```

### 8.3 è¿æ¥æµ‹è¯•è™šæ‹Ÿæœº

**æ–¹æ³• A: ä½¿ç”¨ virt-viewer (å¦‚æœå®‰è£…äº†å›¾å½¢ç•Œé¢)**
```bash
virt-viewer test-vm
```

**æ–¹æ³• B: ä½¿ç”¨ VNC å®¢æˆ·ç«¯**
- åœ¨æ‚¨çš„ç”µè„‘ä¸Šå®‰è£… VNC Viewer (å¦‚ TigerVNC, RealVNC)
- è¿æ¥åˆ°: `192.168.71.200:5900`

**æ–¹æ³• C: æ§åˆ¶å°è¿æ¥ï¼ˆæ–‡æœ¬æ¨¡å¼ï¼‰**
```bash
virsh console test-vm
# æŒ‰ Ctrl+] é€€å‡ºæ§åˆ¶å°
```

### 8.4 åˆ é™¤æµ‹è¯•è™šæ‹Ÿæœº

```bash
# å…³é—­è™šæ‹Ÿæœº
virsh destroy test-vm

# åˆ é™¤è™šæ‹Ÿæœºå®šä¹‰
virsh undefine test-vm --remove-all-storage

# éªŒè¯
virsh list --all
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

å®Œæˆæœ¬æ–‡æ¡£åï¼Œæ‚¨åº”è¯¥å·²ç»é…ç½®å¥½ï¼š

- [x] CPU è™šæ‹ŸåŒ–å·²éªŒè¯å¹¶å¯ç”¨
- [x] KVM/QEMU è½¯ä»¶åŒ…å·²å®‰è£…
- [x] libvirt æœåŠ¡è¿è¡Œå¹¶è®¾ç½®è‡ªå¯åŠ¨
- [x] ç½‘æ¡¥ br0 å·²åˆ›å»ºå¹¶é…ç½®
- [x] libvirt ç½‘æ¡¥ç½‘ç»œå·²å®šä¹‰
- [x] ISO å­˜å‚¨æ± å·²åˆ›å»º
- [x] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [x] SELinux ç­–ç•¥å·²é…ç½®
- [x] chris ç”¨æˆ·å·²æ·»åŠ åˆ° libvirt ç»„
- [x] éªŒè¯è„šæœ¬æ˜¾ç¤ºæ‰€æœ‰å…³é”®é¡¹ç›®é€šè¿‡

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç½‘æ¡¥åˆ›å»ºåæ— æ³•è¿æ¥ç½‘ç»œ

**ç—‡çŠ¶**: åˆ›å»º br0 å SSH è¿æ¥æ–­å¼€æˆ–æ— æ³•è®¿é—®ç½‘ç»œ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¦‚æœé€šè¿‡æœ¬åœ°æ§åˆ¶å°è®¿é—®
# æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
nmcli connection show

# é‡å¯ç½‘æ¡¥
nmcli connection down br0
nmcli connection up br0-slave
nmcli connection up br0

# å¦‚æœä»ç„¶æ— æ³•æ¢å¤ï¼Œåˆ é™¤ç½‘æ¡¥å›é€€
nmcli connection delete br0
nmcli connection delete br0-slave

# æ¢å¤å¤‡ä»½çš„é…ç½®
cp -r /root/network-backup-&lt;æ—¥æœŸ&gt;/* /etc/NetworkManager/system-connections/
nmcli connection reload
systemctl restart NetworkManager
```

### é—®é¢˜ 2: virt-host-validate æ˜¾ç¤º FAIL

**ç—‡çŠ¶**: æŸäº›é¡¹ç›®æ˜¾ç¤º FAIL

**å¸¸è§ FAIL é¡¹ç›®åŠè§£å†³æ–¹æ¡ˆ**:

**FAIL: /dev/kvm ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®**
```bash
# åŠ è½½ KVM æ¨¡å—
modprobe kvm
modprobe kvm_amd  # æˆ– kvm_intel

# æ°¸ä¹…åŠ è½½
echo "kvm" &gt;&gt; /etc/modules-load.d/kvm.conf
echo "kvm_amd" &gt;&gt; /etc/modules-load.d/kvm.conf  # æˆ– kvm_intel
```

**FAIL: cgroup æ§åˆ¶å™¨ä¸æ”¯æŒ**
```bash
# æ£€æŸ¥ cgroup v2
mount | grep cgroup

# å¦‚æœéœ€è¦ï¼Œåœ¨ GRUB ä¸­å¯ç”¨ cgroup v1
# ç¼–è¾‘ /etc/default/grubï¼Œæ·»åŠ :
# GRUB_CMDLINE_LINUX="... systemd.unified_cgroup_hierarchy=0"
# ç„¶å:
grub2-mkconfig -o /boot/grub2/grub.cfg
reboot
```

### é—®é¢˜ 3: è™šæ‹Ÿæœºæ— æ³•è·å– IP åœ°å€

**ç—‡çŠ¶**: è™šæ‹Ÿæœºå¯åŠ¨åæ— æ³•è¿æ¥ç½‘ç»œ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘æ¡¥æ˜¯å¦å·¥ä½œ
brctl show
# æˆ–
bridge link show

# ç¡®ä¿ br0 å·²è¿æ¥åˆ°ç‰©ç†ç½‘å¡
ip link show br0

# æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --zone=public --list-all

# ç¡®ä¿ br0 åœ¨æ­£ç¡®çš„ zone
firewall-cmd --get-zone-of-interface=br0

# å¦‚æœä¸åœ¨ public zoneï¼Œæ·»åŠ å®ƒ
firewall-cmd --permanent --zone=public --add-interface=br0
firewall-cmd --reload
```

### é—®é¢˜ 4: chris ç”¨æˆ·æ— æ³•ç®¡ç†è™šæ‹Ÿæœº

**ç—‡çŠ¶**: ä½¿ç”¨ chris ç”¨æˆ·æ‰§è¡Œ virsh å‘½ä»¤æ—¶æƒé™è¢«æ‹’ç»

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®ä¿ç”¨æˆ·åœ¨æ­£ç¡®çš„ç»„
sudo usermod -aG libvirt,kvm chris

# è®©ç”¨æˆ·é‡æ–°ç™»å½•ä»¥åº”ç”¨ç»„æ›´æ”¹
# æˆ–ä½¿ç”¨ newgrp
newgrp libvirt

# æ£€æŸ¥ libvirt socket æƒé™
ls -l /var/run/libvirt/libvirt-sock

# åº”è¯¥æ˜¯:
# srwxrwx--- 1 root libvirt ... /var/run/libvirt/libvirt-sock
```

### é—®é¢˜ 5: ç½‘æ¡¥æ¨¡å¼ä¸‹è™šæ‹Ÿæœºæ— æ³•è®¿é—®å¤–ç½‘

**ç—‡çŠ¶**: è™šæ‹Ÿæœºå¯ä»¥ ping é€šç½‘å…³ä½†æ— æ³•è®¿é—®å¤–ç½‘

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥ IP è½¬å‘
cat /proc/sys/net/ipv4/ip_forward
# åº”è¯¥æ˜¯ 1

# å¦‚æœæ˜¯ 0ï¼Œå¯ç”¨å®ƒ
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
# æ°¸ä¹…å¯ç”¨
echo "net.ipv4.ip_forward = 1" &gt;&gt; /etc/sysctl.conf
sysctl -p

# 2. æ£€æŸ¥é˜²ç«å¢™ masquerade
firewall-cmd --query-masquerade
# å¦‚æœæ˜¯ noï¼Œå¯ç”¨å®ƒ
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload

# 3. æ£€æŸ¥è™šæ‹Ÿæœºçš„ç½‘å…³é…ç½®
# åœ¨è™šæ‹Ÿæœºå†…æ£€æŸ¥:
# ip route show
# ç¡®ä¿é»˜è®¤ç½‘å…³æŒ‡å‘ 192.168.71.1
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸæ­å»ºäº† KVM è™šæ‹ŸåŒ–ç¯å¢ƒã€‚

ç°åœ¨æ‚¨å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ï¼š

ğŸ‘‰ **[03-storage-expansion.md - ç£ç›˜ç©ºé—´æ‰©å±•](#section-3)**

---

## ğŸ’¡ çŸ¥è¯†è¡¥å……

### Bridge æ¨¡å¼ vs NAT æ¨¡å¼

| ç‰¹æ€§ | Bridge æ¨¡å¼ | NAT æ¨¡å¼ |
|------|-------------|----------|
| IP åœ°å€ | ä¸å®¿ä¸»æœºåŒç½‘æ®µ (192.168.71.x) | ç‹¬ç«‹ç½‘æ®µ (192.168.122.x) |
| å±€åŸŸç½‘è®¿é—® | å¯ä»¥ç›´æ¥è®¿é—®è™šæ‹Ÿæœº | éœ€è¦ç«¯å£è½¬å‘ |
| é…ç½®å¤æ‚åº¦ | â­â­â­â˜†â˜† | â­â­â˜†â˜†â˜† |
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­â­â˜† |
| é€‚ç”¨åœºæ™¯ | æœåŠ¡å™¨è™šæ‹Ÿæœºï¼ˆæ¨èï¼‰ | æµ‹è¯•å’Œå¼€å‘ |

**ä¸ºä»€ä¹ˆé€‰æ‹© Bridge æ¨¡å¼ï¼Ÿ**
- NASã€æ—è·¯ç”±ç­‰éœ€è¦å±€åŸŸç½‘è®¾å¤‡ç›´æ¥è®¿é—®
- è™šæ‹Ÿæœºå°±åƒç‰©ç†æœºä¸€æ ·å·¥ä½œåœ¨å±€åŸŸç½‘ä¸­
- ä¾¿äºç®¡ç†å’Œç›‘æ§

### KVM æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ virtio é©±åŠ¨**: ç½‘ç»œå’Œç£ç›˜éƒ½ä½¿ç”¨ virtioï¼Œæ€§èƒ½æ¥è¿‘ç‰©ç†æœº
2. **CPU ç»‘å®š**: å¯¹äºç”Ÿäº§è™šæ‹Ÿæœºï¼Œå¯ä»¥ç»‘å®šç‰¹å®š CPU æ ¸å¿ƒ
3. **å¤§é¡µå†…å­˜**: å¯¹äºå†…å­˜å¯†é›†å‹åº”ç”¨ï¼Œå¯ç”¨å¤§é¡µå†…å­˜
4. **ç£ç›˜ç¼“å­˜ç­–ç•¥**: æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç¼“å­˜æ¨¡å¼

è¿™äº›ä¼˜åŒ–å°†åœ¨åç»­çš„è™šæ‹Ÿæœºé…ç½®æ–‡æ¡£ä¸­è¯¦ç»†è¯´æ˜ã€‚

### å¸¸ç”¨ virsh å‘½ä»¤é€ŸæŸ¥

```bash
# è™šæ‹Ÿæœºç®¡ç†
virsh list --all              # åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœº
virsh start &lt;vm-name&gt;         # å¯åŠ¨è™šæ‹Ÿæœº
virsh shutdown &lt;vm-name&gt;      # å…³é—­è™šæ‹Ÿæœºï¼ˆä¼˜é›…å…³æœºï¼‰
virsh destroy &lt;vm-name&gt;       # å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº
virsh reboot &lt;vm-name&gt;        # é‡å¯è™šæ‹Ÿæœº
virsh autostart &lt;vm-name&gt;     # è®¾ç½®å¼€æœºè‡ªå¯
virsh autostart --disable &lt;vm-name&gt;  # ç¦ç”¨å¼€æœºè‡ªå¯

# è™šæ‹Ÿæœºä¿¡æ¯
virsh dominfo &lt;vm-name&gt;       # æŸ¥çœ‹è™šæ‹Ÿæœºè¯¦ç»†ä¿¡æ¯
virsh domstats &lt;vm-name&gt;      # æŸ¥çœ‹è™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯
virsh vcpuinfo &lt;vm-name&gt;      # æŸ¥çœ‹ vCPU ä¿¡æ¯

# ç½‘ç»œç®¡ç†
virsh net-list --all          # åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ
virsh net-info &lt;net-name&gt;     # æŸ¥çœ‹ç½‘ç»œä¿¡æ¯
virsh net-start &lt;net-name&gt;    # å¯åŠ¨ç½‘ç»œ
virsh net-autostart &lt;net-name&gt;  # è®¾ç½®ç½‘ç»œè‡ªå¯

# å­˜å‚¨ç®¡ç†
virsh pool-list --all         # åˆ—å‡ºæ‰€æœ‰å­˜å‚¨æ± 
virsh vol-list &lt;pool-name&gt;    # åˆ—å‡ºå­˜å‚¨æ± ä¸­çš„å·
virsh pool-refresh &lt;pool-name&gt;  # åˆ·æ–°å­˜å‚¨æ± 

# æ§åˆ¶å°è¿æ¥
virsh console &lt;vm-name&gt;       # è¿æ¥åˆ°è™šæ‹Ÿæœºæ§åˆ¶å°
# æŒ‰ Ctrl+] é€€å‡ºæ§åˆ¶å°
```




---



# 03 - ç£ç›˜ç©ºé—´æ‰©å±•

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨å°† 2TB SSD ä¸Šå‰©ä½™çš„çº¦ 1.75TB æœªåˆ†é…ç©ºé—´é…ç½®ä¸º KVM è™šæ‹ŸåŒ–å’Œ NAS ä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼š

- âœ… å½“å‰ç£ç›˜çŠ¶æ€æ£€æŸ¥
- âœ… å­˜å‚¨è§„åˆ’æ–¹æ¡ˆï¼ˆæ¨èé…ç½®ï¼‰
- âœ… åˆ›å»ºæ–°åˆ†åŒº
- âœ… é…ç½® LVM thin pool (1.2TB è™šæ‹Ÿæœºå­˜å‚¨)
- âœ… é…ç½® NAS æ•°æ®å· (500GB ç‹¬ç«‹å­˜å‚¨)
- âœ… é…ç½® KVM å­˜å‚¨æ± 
- âœ… ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬
- âœ… éªŒè¯å’Œæµ‹è¯•

**å‰ç½®æ¡ä»¶**: å·²å®Œæˆ [02-kvm-setup.md](#section-2)  
**é¢„è®¡è€—æ—¶**: 20 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­â˜†

âš ï¸ **é‡è¦è­¦å‘Š**: æœ¬æ–‡æ¡£æ¶‰åŠç£ç›˜åˆ†åŒºæ“ä½œï¼Œæ“ä½œå‰è¯·ç¡®ä¿ç†è§£æ¯ä¸ªæ­¥éª¤ã€‚è™½ç„¶è¿™æ˜¯æ–°ç³»ç»Ÿï¼Œä½†é”™è¯¯æ“ä½œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚

---

## ğŸ“Š æ­¥éª¤ 1: æ£€æŸ¥å½“å‰ç£ç›˜çŠ¶æ€

### 1.1 æŸ¥çœ‹ç£ç›˜å’Œåˆ†åŒºä¿¡æ¯

```bash
sudo su -

# æŸ¥çœ‹æ‰€æœ‰å—è®¾å¤‡
lsblk

# æŸ¥çœ‹è¯¦ç»†åˆ†åŒºä¿¡æ¯
fdisk -l

# æŸ¥çœ‹ LVM ä¿¡æ¯
pvdisplay    # ç‰©ç†å·
vgdisplay    # å·ç»„
lvdisplay    # é€»è¾‘å·

# æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æƒ…å†µ
df -h
```

### 1.2 åˆ›å»ºç£ç›˜çŠ¶æ€æŠ¥å‘Šè„šæœ¬

```bash
cat &gt; /root/check-disk-status.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       å½“å‰ç£ç›˜çŠ¶æ€æŠ¥å‘Š"
echo "========================================="
echo ""

echo "--- å—è®¾å¤‡æ¦‚è§ˆ ---"
lsblk -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT
echo ""

echo "--- ç£ç›˜åˆ†åŒºè¯¦æƒ… ---"
parted /dev/nvme0n1 print 2&gt;/dev/null || fdisk -l /dev/nvme0n1 2&gt;/dev/null || \
    parted /dev/sda print 2&gt;/dev/null || fdisk -l /dev/sda 2&gt;/dev/null
echo ""

echo "--- LVM ç‰©ç†å· ---"
pvdisplay -C
echo ""

echo "--- LVM å·ç»„ ---"
vgdisplay -C
echo ""

echo "--- LVM é€»è¾‘å· ---"
lvdisplay -C
echo ""

echo "--- æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ ---"
df -h | grep -E 'Filesystem|^/dev'
echo ""

echo "--- è®¡ç®—æœªåˆ†é…ç©ºé—´ ---"
DEVICE=$(lsblk -ndo NAME,TYPE | grep disk | head -1 | awk '{print $1}')
DEVICE="/dev/$DEVICE"
TOTAL_SIZE=$(lsblk -bdn -o SIZE $DEVICE)
USED_SIZE=$(parted $DEVICE unit B print free 2&gt;/dev/null | grep -E '^\s+[0-9]' | awk '{print $3}' | sed 's/B//' | awk '{sum+=$1} END {print sum}')
FREE_SIZE=$((TOTAL_SIZE - USED_SIZE))
FREE_GB=$((FREE_SIZE / 1024 / 1024 / 1024))

echo "ç£ç›˜è®¾å¤‡: $DEVICE"
echo "æ€»å®¹é‡: $((TOTAL_SIZE / 1024 / 1024 / 1024)) GB"
echo "æœªåˆ†é…ç©ºé—´: çº¦ ${FREE_GB} GB"
echo ""

echo "========================================="
EOF

chmod +x /root/check-disk-status.sh
```

### 1.3 è¿è¡ŒçŠ¶æ€æ£€æŸ¥

```bash
/root/check-disk-status.sh
```

æ ¹æ®è¾“å‡ºï¼Œè®°å½•æ‚¨çš„ç£ç›˜è®¾å¤‡åç§°ï¼ˆé€šå¸¸æ˜¯ `/dev/nvme0n1` æˆ– `/dev/sda`ï¼‰ã€‚

---

## ğŸ“ æ­¥éª¤ 2: å­˜å‚¨è§„åˆ’æ–¹æ¡ˆ

### 2.1 æ¨èçš„å­˜å‚¨æ¶æ„

åŸºäºæ‚¨çš„éœ€æ±‚ï¼ˆ4 ä¸ªè™šæ‹Ÿæœº + NASï¼‰ï¼Œæ¨èä»¥ä¸‹åˆ†é…ï¼š

```
è‡´æ€ 2TB NVMe SSD (çº¦ 1.86TB å¯ç”¨)
â”‚
â”œâ”€ å·²åˆ†é… (~110GB)
â”‚  â”œâ”€ /boot (1GB)
â”‚  â”œâ”€ / (root, ~100GB)
â”‚  â””â”€ swap (æ ¹æ®å†…å­˜å¤§å°)
â”‚
â””â”€ æ–°åˆ†åŒº (~1.75TB) â† æˆ‘ä»¬è¦é…ç½®çš„
   â”‚
   â”œâ”€ vg_kvm (LVM å·ç»„)
   â”‚  â”‚
   â”‚  â”œâ”€ kvm_thin_pool (LVM thin pool, 1.2TB)
   â”‚  â”‚  â””â”€ è™šæ‹Ÿæœºç£ç›˜ (qcow2/raw)
   â”‚  â”‚     â”œâ”€ python-dev: 80GB (qcow2)
   â”‚  â”‚     â”œâ”€ web-app: 100GB (qcow2)
   â”‚  â”‚     â”œâ”€ router: 20GB (qcow2)
   â”‚  â”‚     â”œâ”€ nas-system: 30GB (raw)
   â”‚  â”‚     â””â”€ é¢„ç•™: ~970GB (æœªæ¥æ‰©å±•)
   â”‚  â”‚
   â”‚  â””â”€ lv_nas_data (LVM é€»è¾‘å·, 500GB)
   â”‚     â””â”€ /data/nas (XFS, ä¾› NAS VM ä½¿ç”¨)
   â”‚
   â””â”€ æœªåˆ†é… (~50GB) â† åº”æ€¥é¢„ç•™
```

### 2.2 ä¸ºä»€ä¹ˆè¿™æ ·è§„åˆ’ï¼Ÿ

**LVM thin pool çš„ä¼˜åŠ¿**:
- **è¿‡é‡åˆ†é…**: å¯ä»¥åˆ›å»ºæ€»å®¹é‡è¶…è¿‡ç‰©ç†ç©ºé—´çš„è™šæ‹Ÿç£ç›˜
- **æŒ‰éœ€ä½¿ç”¨**: å®é™…åªå ç”¨å†™å…¥çš„æ•°æ®ç©ºé—´
- **å¿«ç…§é«˜æ•ˆ**: åˆ›å»ºå¿«ç…§å‡ ä¹ä¸å ç”¨é¢å¤–ç©ºé—´
- **ç»Ÿä¸€ç®¡ç†**: æ‰€æœ‰è™šæ‹Ÿæœºç£ç›˜åœ¨ä¸€ä¸ªæ± ä¸­

**NAS æ•°æ®ç‹¬ç«‹å­˜å‚¨**:
- **æ€§èƒ½ä¼˜åŒ–**: ç‹¬ç«‹ LVM å·ï¼Œé¿å… thin pool å¼€é”€
- **ä¾¿äºå¤‡ä»½**: å¯ä»¥å•ç‹¬æŒ‚è½½å’Œå¤‡ä»½
- **çµæ´»å…±äº«**: é€šè¿‡ virtio-fs å…±äº«ç»™ NAS VMï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿ

---

## ğŸ”¨ æ­¥éª¤ 3: åˆ›å»ºæ–°åˆ†åŒº

### 3.1 ç¡®å®šç£ç›˜è®¾å¤‡

```bash
# æŸ¥æ‰¾ä¸»ç£ç›˜è®¾å¤‡
DISK_DEVICE=$(lsblk -ndo NAME,TYPE | grep disk | head -1 | awk '{print "/dev/"$1}')
echo "æ£€æµ‹åˆ°ç£ç›˜è®¾å¤‡: $DISK_DEVICE"

# éªŒè¯è¿™æ˜¯æ­£ç¡®çš„è®¾å¤‡
lsblk $DISK_DEVICE
```

âš ï¸ **é‡è¦**: ç¡®è®¤ $DISK_DEVICE æ˜¯æ‚¨çš„ 2TB SSDï¼Œä¸æ˜¯å…¶ä»–è®¾å¤‡ï¼

### 3.2 ä½¿ç”¨ parted åˆ›å»ºæ–°åˆ†åŒº

```bash
# æ£€æŸ¥å½“å‰åˆ†åŒºè¡¨ç±»å‹
parted $DISK_DEVICE print

# åˆ›å»ºæ–°åˆ†åŒºï¼ˆä½¿ç”¨å‰©ä½™æ‰€æœ‰ç©ºé—´ï¼‰
# æ³¨æ„ï¼šè¿™ä¼šåˆ›å»ºä¸€ä¸ªå¤§åˆ†åŒºï¼Œæˆ‘ä»¬é¢„ç•™ 50GB çš„æ–¹æ³•æ˜¯ä¸ä½¿ç”¨ 100% è€Œæ˜¯ -50GB
parted $DISK_DEVICE mkpart primary ext4 110GB -50GB

# å¦‚æœæç¤ºåˆ†åŒºæœªå¯¹é½ï¼Œé€‰æ‹© Ignore æˆ– Yes

# æŸ¥çœ‹æ–°åˆ†åŒº
parted $DISK_DEVICE print
lsblk $DISK_DEVICE
```

### 3.3 è·å–æ–°åˆ†åŒºåç§°

```bash
# åˆ—å‡ºåˆ†åŒº
lsblk $DISK_DEVICE

# æ–°åˆ†åŒºé€šå¸¸æ˜¯æœ€åä¸€ä¸ªï¼Œä¾‹å¦‚:
# /dev/nvme0n1p3 (NVMe SSD)
# /dev/sda3 (SATA SSD)

# è®¾ç½®å˜é‡ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
NEW_PARTITION="${DISK_DEVICE}p3"  # NVMe
# æˆ–
# NEW_PARTITION="${DISK_DEVICE}3"  # SATA

# éªŒè¯
ls -l $NEW_PARTITION
```

---

## ğŸ—„ï¸ æ­¥éª¤ 4: é…ç½® LVM

### 4.1 åˆ›å»ºç‰©ç†å· (PV)

```bash
# åˆ›å»ºç‰©ç†å·
pvcreate $NEW_PARTITION

# éªŒè¯
pvdisplay $NEW_PARTITION
pvs
```

### 4.2 åˆ›å»ºå·ç»„ (VG)

```bash
# åˆ›å»ºåä¸º vg_kvm çš„å·ç»„
vgcreate vg_kvm $NEW_PARTITION

# éªŒè¯
vgdisplay vg_kvm
vgs
```

æ‚¨åº”è¯¥çœ‹åˆ°çº¦ 1.7TB çš„å¯ç”¨ç©ºé—´ã€‚

### 4.3 åˆ›å»º thin pool (è™šæ‹Ÿæœºå­˜å‚¨æ± )

```bash
# åˆ›å»º 1.2TB çš„ thin pool
lvcreate -L 1200G --thinpool kvm_thin_pool vg_kvm

# ä¼˜åŒ– thin pool æ€§èƒ½ï¼ˆç¦ç”¨é›¶åˆå§‹åŒ–ï¼‰
lvchange --zero n vg_kvm/kvm_thin_pool

# é…ç½® thin pool è‡ªåŠ¨æ‰©å±•ï¼ˆå½“ä½¿ç”¨ç‡è¶…è¿‡ 80% æ—¶ï¼‰
cat &gt;&gt; /etc/lvm/lvm.conf &lt;&lt;'EOF'

# Thin pool auto-extend settings
activation {
    thin_pool_autoextend_threshold = 80
    thin_pool_autoextend_percent = 20
}
EOF

# éªŒè¯
lvdisplay vg_kvm/kvm_thin_pool
lvs -a vg_kvm
```

### 4.4 åˆ›å»º NAS æ•°æ®å·

```bash
# åˆ›å»º 500GB çš„é€»è¾‘å·
lvcreate -L 500G -n lv_nas_data vg_kvm

# æ ¼å¼åŒ–ä¸º XFSï¼ˆé€‚åˆå¤§æ–‡ä»¶å­˜å‚¨ï¼‰
mkfs.xfs /dev/vg_kvm/lv_nas_data

# åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /data/nas

# æŒ‚è½½
mount /dev/vg_kvm/lv_nas_data /data/nas

# è®¾ç½®æƒé™
chmod 755 /data/nas

# é…ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½
echo "/dev/vg_kvm/lv_nas_data /data/nas xfs defaults 0 0" &gt;&gt; /etc/fstab

# éªŒè¯æŒ‚è½½
df -h /data/nas
mount | grep nas
```

### 4.5 è®¾ç½® SELinux ä¸Šä¸‹æ–‡

```bash
# ä¸º NAS æ•°æ®ç›®å½•è®¾ç½® SELinux ä¸Šä¸‹æ–‡
semanage fcontext -a -t virt_image_t '/data/nas(/.*)?'
restorecon -Rv /data/nas
```

---

## ğŸ¯ æ­¥éª¤ 5: é…ç½® KVM å­˜å‚¨æ± 

### 5.1 é…ç½®åŸºäº LVM thin çš„è™šæ‹Ÿæœºå­˜å‚¨æ± 

```bash
# å®šä¹‰ LVM thin å­˜å‚¨æ± 
virsh pool-define-as kvm_pool logical \
    --source-name vg_kvm \
    --target /dev/vg_kvm

# æ„å»ºå­˜å‚¨æ± 
virsh pool-build kvm_pool

# å¯åŠ¨å­˜å‚¨æ± 
virsh pool-start kvm_pool

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh pool-autostart kvm_pool

# éªŒè¯
virsh pool-list --all
virsh pool-info kvm_pool
```

### 5.2 é…ç½® NAS æ•°æ®ç›®å½•å­˜å‚¨æ± 

```bash
# å®šä¹‰åŸºäºç›®å½•çš„å­˜å‚¨æ± 
virsh pool-define-as nas_data_pool dir --target /data/nas

# å¯åŠ¨
virsh pool-start nas_data_pool

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh pool-autostart nas_data_pool

# éªŒè¯
virsh pool-list --all
virsh pool-info nas_data_pool
```

---

## ğŸ¤– æ­¥éª¤ 6: ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬

### 6.1 åˆ›å»ºå®Œæ•´çš„è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬

```bash
cat &gt; /root/setup-storage-auto.sh &lt;&lt;'EOF'
#!/bin/bash

# å­˜å‚¨æ‰©å±•è‡ªåŠ¨åŒ–è„šæœ¬
# ç”¨é€”: è‡ªåŠ¨é…ç½® KVM è™šæ‹Ÿæœºå­˜å‚¨å’Œ NAS æ•°æ®å­˜å‚¨

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=========================================${NC}"
echo -e "${GREEN}     KVM å­˜å‚¨æ‰©å±•è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬${NC}"
echo -e "${GREEN}=========================================${NC}"
echo ""

# æ£€æŸ¥æ˜¯å¦ä»¥ root è¿è¡Œ
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}é”™è¯¯: è¯·ä»¥ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${NC}"
    exit 1
fi

# é…ç½®å‚æ•°
THIN_POOL_SIZE="1200G"  # thin pool å¤§å°
NAS_DATA_SIZE="500G"    # NAS æ•°æ®å·å¤§å°
VG_NAME="vg_kvm"
THIN_POOL_NAME="kvm_thin_pool"
NAS_LV_NAME="lv_nas_data"
NAS_MOUNT_POINT="/data/nas"

echo -e "${YELLOW}é…ç½®å‚æ•°:${NC}"
echo "  - Thin Pool å¤§å°: $THIN_POOL_SIZE"
echo "  - NAS æ•°æ®å·å¤§å°: $NAS_DATA_SIZE"
echo "  - å·ç»„åç§°: $VG_NAME"
echo "  - NAS æŒ‚è½½ç‚¹: $NAS_MOUNT_POINT"
echo ""

# æ­¥éª¤ 1: æ£€æµ‹ç£ç›˜
echo -e "${GREEN}[1/8] æ£€æµ‹ç£ç›˜è®¾å¤‡...${NC}"
DISK_DEVICE=$(lsblk -ndo NAME,TYPE | grep disk | head -1 | awk '{print "/dev/"$1}')
echo "æ£€æµ‹åˆ°ç£ç›˜: $DISK_DEVICE"
lsblk $DISK_DEVICE
echo ""

read -p "ç¡®è®¤è¿™æ˜¯æ­£ç¡®çš„ç£ç›˜è®¾å¤‡å—? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo -e "${RED}æ“ä½œå·²å–æ¶ˆ${NC}"
    exit 1
fi

# æ­¥éª¤ 2: æŸ¥æ‰¾æœªåˆ†é…ç©ºé—´
echo -e "${GREEN}[2/8] åˆ†ææœªåˆ†é…ç©ºé—´...${NC}"
parted $DISK_DEVICE print free
echo ""

# æ­¥éª¤ 3: åˆ›å»ºæ–°åˆ†åŒº
echo -e "${GREEN}[3/8] åˆ›å»ºæ–°åˆ†åŒº...${NC}"
LAST_PARTITION=$(parted $DISK_DEVICE print | grep '^ ' | tail -1 | awk '{print $1}')
echo "æœ€åä¸€ä¸ªåˆ†åŒºç¼–å·: $LAST_PARTITION"

# è·å–æœ€åä¸€ä¸ªåˆ†åŒºçš„ç»“æŸä½ç½®
LAST_END=$(parted $DISK_DEVICE unit GB print | grep "^ $LAST_PARTITION" | awk '{print $3}' | sed 's/GB//')
echo "æœ€ååˆ†åŒºç»“æŸäº: ${LAST_END}GB"

# åˆ›å»ºæ–°åˆ†åŒºï¼ˆé¢„ç•™ 50GBï¼‰
echo "åˆ›å»ºæ–°åˆ†åŒºä» ${LAST_END}GB åˆ° -50GB..."
parted -a optimal $DISK_DEVICE mkpart primary ext4 ${LAST_END}GB -- -50GB

# åˆ·æ–°åˆ†åŒºè¡¨
partprobe $DISK_DEVICE
sleep 2

# ç¡®å®šæ–°åˆ†åŒºåç§°
if [[ $DISK_DEVICE == *"nvme"* ]]; then
    NEW_PARTITION="${DISK_DEVICE}p$((LAST_PARTITION + 1))"
else
    NEW_PARTITION="${DISK_DEVICE}$((LAST_PARTITION + 1))"
fi

echo "æ–°åˆ†åŒº: $NEW_PARTITION"
ls -l $NEW_PARTITION || (echo -e "${RED}æ–°åˆ†åŒºæœªåˆ›å»ºæˆåŠŸ${NC}" &amp;&amp; exit 1)
echo ""

# æ­¥éª¤ 4: åˆ›å»º LVM ç‰©ç†å·
echo -e "${GREEN}[4/8] åˆ›å»º LVM ç‰©ç†å·...${NC}"
pvcreate $NEW_PARTITION
pvdisplay $NEW_PARTITION
echo ""

# æ­¥éª¤ 5: åˆ›å»ºå·ç»„
echo -e "${GREEN}[5/8] åˆ›å»ºå·ç»„ $VG_NAME...${NC}"
vgcreate $VG_NAME $NEW_PARTITION
vgdisplay $VG_NAME
echo ""

# æ­¥éª¤ 6: åˆ›å»º thin pool
echo -e "${GREEN}[6/8] åˆ›å»º thin pool...${NC}"
lvcreate -L $THIN_POOL_SIZE --thinpool $THIN_POOL_NAME $VG_NAME
lvchange --zero n $VG_NAME/$THIN_POOL_NAME
lvdisplay $VG_NAME/$THIN_POOL_NAME
echo ""

# æ­¥éª¤ 7: åˆ›å»º NAS æ•°æ®å·
echo -e "${GREEN}[7/8] åˆ›å»º NAS æ•°æ®å·...${NC}"
lvcreate -L $NAS_DATA_SIZE -n $NAS_LV_NAME $VG_NAME
mkfs.xfs /dev/$VG_NAME/$NAS_LV_NAME

# æŒ‚è½½ NAS æ•°æ®å·
mkdir -p $NAS_MOUNT_POINT
mount /dev/$VG_NAME/$NAS_LV_NAME $NAS_MOUNT_POINT
chmod 755 $NAS_MOUNT_POINT

# æ·»åŠ åˆ° fstab
if ! grep -q "$NAS_MOUNT_POINT" /etc/fstab; then
    echo "/dev/$VG_NAME/$NAS_LV_NAME $NAS_MOUNT_POINT xfs defaults 0 0" &gt;&gt; /etc/fstab
fi

df -h $NAS_MOUNT_POINT
echo ""

# æ­¥éª¤ 8: é…ç½® KVM å­˜å‚¨æ± 
echo -e "${GREEN}[8/8] é…ç½® KVM å­˜å‚¨æ± ...${NC}"

# LVM thin å­˜å‚¨æ± 
if ! virsh pool-list --all | grep -q kvm_pool; then
    virsh pool-define-as kvm_pool logical --source-name $VG_NAME --target /dev/$VG_NAME
    virsh pool-build kvm_pool
    virsh pool-start kvm_pool
    virsh pool-autostart kvm_pool
fi

# NAS æ•°æ®ç›®å½•å­˜å‚¨æ± 
if ! virsh pool-list --all | grep -q nas_data_pool; then
    virsh pool-define-as nas_data_pool dir --target $NAS_MOUNT_POINT
    virsh pool-start nas_data_pool
    virsh pool-autostart nas_data_pool
fi

# è®¾ç½® SELinux ä¸Šä¸‹æ–‡
if command -v semanage &amp;&gt; /dev/null; then
    semanage fcontext -a -t virt_image_t "${NAS_MOUNT_POINT}(/.*)?" 2&gt;/dev/null || true
    restorecon -Rv $NAS_MOUNT_POINT
fi

virsh pool-list --all
echo ""

echo -e "${GREEN}=========================================${NC}"
echo -e "${GREEN}     é…ç½®å®Œæˆ!${NC}"
echo -e "${GREEN}=========================================${NC}"
echo ""
echo "å­˜å‚¨é…ç½®æ‘˜è¦:"
echo "  - å·ç»„: $VG_NAME"
echo "  - Thin Pool: $THIN_POOL_NAME ($(lvs --noheadings -o lv_size $VG_NAME/$THIN_POOL_NAME | xargs))"
echo "  - NAS æ•°æ®å·: $NAS_LV_NAME ($(lvs --noheadings -o lv_size $VG_NAME/$NAS_LV_NAME | xargs))"
echo "  - NAS æŒ‚è½½ç‚¹: $NAS_MOUNT_POINT"
echo ""
echo "KVM å­˜å‚¨æ± :"
echo "  - kvm_pool: LVM thin pool ç”¨äºè™šæ‹Ÿæœºç£ç›˜"
echo "  - nas_data_pool: ç›®å½•å­˜å‚¨æ± ç”¨äº NAS æ•°æ®"
echo ""
echo "ä¸‹ä¸€æ­¥: è¯·æŸ¥çœ‹ 04-vm-management.md åˆ›å»ºè™šæ‹Ÿæœº"
EOF

chmod +x /root/setup-storage-auto.sh
```

### 6.2 è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆå¯é€‰ï¼‰

âš ï¸ **æ³¨æ„**: å¦‚æœæ‚¨å·²ç»æ‰‹åŠ¨å®Œæˆäº†æ­¥éª¤ 3-5ï¼Œè·³è¿‡æ­¤æ­¥éª¤ã€‚

```bash
# å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œè¿è¡Œ:
# /root/setup-storage-auto.sh
```

---

## âœ… æ­¥éª¤ 7: éªŒè¯é…ç½®

### 7.1 åˆ›å»ºéªŒè¯è„šæœ¬

```bash
cat &gt; /root/verify-storage.sh &lt;&lt;'EOF'
#!/bin/bash

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "========================================="
echo "       å­˜å‚¨é…ç½®éªŒè¯"
echo "========================================="
echo ""

check_pass() {
    echo -e "${GREEN}âœ“${NC} $1"
}

check_fail() {
    echo -e "${RED}âœ—${NC} $1"
}

check_info() {
    echo -e "${YELLOW}â„¹${NC} $1"
}

# 1. LVM å·ç»„
echo "1. æ£€æŸ¥ LVM å·ç»„..."
if vgs vg_kvm &amp;&gt;/dev/null; then
    VG_SIZE=$(vgs --noheadings -o vg_size vg_kvm | xargs)
    VG_FREE=$(vgs --noheadings -o vg_free vg_kvm | xargs)
    check_pass "å·ç»„ vg_kvm å­˜åœ¨ (å¤§å°: $VG_SIZE, å¯ç”¨: $VG_FREE)"
else
    check_fail "å·ç»„ vg_kvm ä¸å­˜åœ¨"
    exit 1
fi

# 2. Thin pool
echo "2. æ£€æŸ¥ thin pool..."
if lvs vg_kvm/kvm_thin_pool &amp;&gt;/dev/null; then
    POOL_SIZE=$(lvs --noheadings -o lv_size vg_kvm/kvm_thin_pool | xargs)
    POOL_DATA=$(lvs --noheadings -o data_percent vg_kvm/kvm_thin_pool | xargs)
    check_pass "Thin pool å­˜åœ¨ (å¤§å°: $POOL_SIZE, ä½¿ç”¨ç‡: $POOL_DATA)"
else
    check_fail "Thin pool ä¸å­˜åœ¨"
fi

# 3. NAS æ•°æ®å·
echo "3. æ£€æŸ¥ NAS æ•°æ®å·..."
if lvs vg_kvm/lv_nas_data &amp;&gt;/dev/null; then
    NAS_SIZE=$(lvs --noheadings -o lv_size vg_kvm/lv_nas_data | xargs)
    check_pass "NAS æ•°æ®å·å­˜åœ¨ (å¤§å°: $NAS_SIZE)"
else
    check_fail "NAS æ•°æ®å·ä¸å­˜åœ¨"
fi

# 4. NAS æŒ‚è½½
echo "4. æ£€æŸ¥ NAS æŒ‚è½½..."
if mount | grep -q '/data/nas'; then
    NAS_USAGE=$(df -h /data/nas | tail -1 | awk '{print $5 " å·²ç”¨ï¼Œå‰©ä½™ " $4}')
    check_pass "NAS å·²æŒ‚è½½åˆ° /data/nas ($NAS_USAGE)"
else
    check_fail "NAS æœªæŒ‚è½½"
fi

if grep -q '/data/nas' /etc/fstab; then
    check_pass "NAS å·²æ·»åŠ åˆ° /etc/fstab (å¼€æœºè‡ªåŠ¨æŒ‚è½½)"
else
    check_fail "NAS æœªæ·»åŠ åˆ° /etc/fstab"
fi

# 5. KVM å­˜å‚¨æ± 
echo "5. æ£€æŸ¥ KVM å­˜å‚¨æ± ..."
if virsh pool-list --all | grep -q kvm_pool; then
    KVM_POOL_STATE=$(virsh pool-list --all | grep kvm_pool | awk '{print $2}')
    if [ "$KVM_POOL_STATE" == "active" ] || [ "$KVM_POOL_STATE" == "æ´»åŠ¨" ]; then
        check_pass "kvm_pool å­˜å‚¨æ± æ´»åŠ¨"
    else
        check_fail "kvm_pool å­˜å‚¨æ± ä¸æ´»åŠ¨"
    fi
else
    check_fail "kvm_pool å­˜å‚¨æ± ä¸å­˜åœ¨"
fi

if virsh pool-list --all | grep -q nas_data_pool; then
    NAS_POOL_STATE=$(virsh pool-list --all | grep nas_data_pool | awk '{print $2}')
    if [ "$NAS_POOL_STATE" == "active" ] || [ "$NAS_POOL_STATE" == "æ´»åŠ¨" ]; then
        check_pass "nas_data_pool å­˜å‚¨æ± æ´»åŠ¨"
    else
        check_fail "nas_data_pool å­˜å‚¨æ± ä¸æ´»åŠ¨"
    fi
else
    check_fail "nas_data_pool å­˜å‚¨æ± ä¸å­˜åœ¨"
fi

echo ""
echo "========================================="
echo "       è¯¦ç»†ä¿¡æ¯"
echo "========================================="
echo ""
echo "--- LVM é€»è¾‘å· ---"
lvs vg_kvm
echo ""
echo "--- KVM å­˜å‚¨æ±  ---"
virsh pool-list --all
echo ""
echo "--- ç£ç›˜ä½¿ç”¨æƒ…å†µ ---"
df -h | grep -E 'Filesystem|vg_kvm'
echo ""
echo "========================================="
echo "éªŒè¯å®Œæˆ!"
echo "========================================="
EOF

chmod +x /root/verify-storage.sh
```

### 7.2 è¿è¡ŒéªŒè¯

```bash
/root/verify-storage.sh
```

### 7.3 æµ‹è¯•åˆ›å»ºè™šæ‹Ÿç£ç›˜

```bash
# æµ‹è¯•åœ¨ thin pool ä¸­åˆ›å»º thin volume
lvcreate -V 100G --thinpool kvm_thin_pool -n test_thin_vol vg_kvm

# æŸ¥çœ‹
lvs vg_kvm
lvdisplay vg_kvm/test_thin_vol

# åˆ é™¤æµ‹è¯•å·
lvremove -f vg_kvm/test_thin_vol

# æµ‹è¯•é€šè¿‡ virsh åˆ›å»ºè™šæ‹Ÿç£ç›˜
virsh vol-create-as kvm_pool test-disk.qcow2 50G --format qcow2

# æŸ¥çœ‹
virsh vol-list kvm_pool

# åˆ é™¤æµ‹è¯•ç£ç›˜
virsh vol-delete test-disk.qcow2 kvm_pool

echo "æµ‹è¯•æˆåŠŸï¼"
```

---

## ğŸ“Š æ­¥éª¤ 8: å®¹é‡è§„åˆ’å’Œç›‘æ§

### 8.1 åˆ›å»ºå®¹é‡è§„åˆ’æ–‡æ¡£

```bash
cat &gt; /root/storage-capacity-plan.txt &lt;&lt;'EOF'
========================================
        å­˜å‚¨å®¹é‡è§„åˆ’
========================================

æ€»å­˜å‚¨: çº¦ 1.75TB (vg_kvm)

å·²åˆ†é…:
  - kvm_thin_pool:  1200GB (è™šæ‹Ÿæœºå­˜å‚¨)
  - lv_nas_data:     500GB (NAS æ•°æ®)
  - æ€»è®¡:           1700GB

æœªåˆ†é…: çº¦ 50GB (é¢„ç•™)

========================================
è™šæ‹Ÿæœºç£ç›˜åˆ†é… (åœ¨ thin pool ä¸­):
========================================

1. python-dev
   - ç³»ç»Ÿç›˜: 80GB (qcow2)
   - å®é™…å ç”¨: çº¦ 10-20GB (å–å†³äºå®‰è£…çš„è½¯ä»¶)

2. web-app
   - ç³»ç»Ÿç›˜: 100GB (qcow2)
   - å®é™…å ç”¨: çº¦ 15-30GB

3. router (æ—è·¯ç”±)
   - ç³»ç»Ÿç›˜: 20GB (qcow2)
   - å®é™…å ç”¨: çº¦ 2-5GB

4. nas
   - ç³»ç»Ÿç›˜: 30GB (raw, ä» thin pool)
   - å®é™…å ç”¨: 30GB (raw æ ¼å¼ç«‹å³å ç”¨å…¨éƒ¨ç©ºé—´)
   - æ•°æ®ç›˜: ä½¿ç”¨ /data/nas (500GB ç‹¬ç«‹å·)

è™šæ‹Ÿç£ç›˜æ€»åˆ†é…: 230GB
Thin pool æ€»å®¹é‡: 1200GB
å¯ç”¨äºæ‰©å±•æˆ–æ–° VM: çº¦ 970GB

========================================
Thin Pool ç‰¹æ€§:
========================================

- è¿‡é‡åˆ†é…: å¯ä»¥åˆ›å»ºæ€»å’Œ &gt; 1200GB çš„è™šæ‹Ÿç£ç›˜
- å®é™…ä½¿ç”¨: åªå ç”¨å®é™…å†™å…¥çš„æ•°æ®ç©ºé—´
- ä¾‹å¦‚: åˆ›å»º 5 ä¸ª 100GB çš„è™šæ‹Ÿç£ç›˜ (å…± 500GB)
        å¦‚æœæ¯ä¸ªåªç”¨äº† 20GBï¼Œå®é™…åªå ç”¨ 100GB

æ³¨æ„: éœ€è¦ç›‘æ§ thin pool ä½¿ç”¨ç‡ï¼Œé¿å…çœŸæ­£ç”¨æ»¡

========================================
ç›‘æ§å‘½ä»¤:
========================================

# æŸ¥çœ‹ thin pool ä½¿ç”¨ç‡
lvs -a vg_kvm

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
lvdisplay vg_kvm/kvm_thin_pool

# æŸ¥çœ‹æ‰€æœ‰è™šæ‹Ÿç£ç›˜
virsh vol-list kvm_pool

# æŸ¥çœ‹ NAS æ•°æ®ä½¿ç”¨
df -h /data/nas

========================================
æ‰©å®¹æŒ‡å—:
========================================

å¦‚æœ thin pool ä¸å¤Ÿç”¨:
1. æ‰©å±• thin pool
   lvextend -L +100G vg_kvm/kvm_thin_pool

å¦‚æœ NAS æ•°æ®ä¸å¤Ÿç”¨:
1. å¸è½½ NAS
   umount /data/nas
2. æ‰©å±•é€»è¾‘å·
   lvextend -L +100G vg_kvm/lv_nas_data
3. æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ
   xfs_growfs /data/nas
4. é‡æ–°æŒ‚è½½
   mount /data/nas

å¦‚æœå·ç»„ç©ºé—´ä¸å¤Ÿ:
1. ä½¿ç”¨æœªåˆ†é…çš„ 50GB
   parted /dev/nvmeXnY mkpart primary ext4 YYYYgb 100%
   pvcreate /dev/nvmeXnYpZ
   vgextend vg_kvm /dev/nvmeXnYpZ
EOF

cat /root/storage-capacity-plan.txt
```

### 8.2 åˆ›å»ºç›‘æ§è„šæœ¬

```bash
cat &gt; /usr/local/bin/storage-monitor &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       å­˜å‚¨ä½¿ç”¨ç›‘æ§"
echo "========================================="
date
echo ""

echo "--- LVM å·ç»„çŠ¶æ€ ---"
vgs vg_kvm
echo ""

echo "--- Thin Pool ä½¿ç”¨æƒ…å†µ ---"
lvs -a vg_kvm | grep -E 'LV|thin'
echo ""

POOL_DATA=$(lvs --noheadings -o data_percent vg_kvm/kvm_thin_pool | xargs | sed 's/%//')
POOL_META=$(lvs --noheadings -o metadata_percent vg_kvm/kvm_thin_pool | xargs | sed 's/%//')

echo "Thin Pool æ•°æ®ä½¿ç”¨ç‡: ${POOL_DATA}%"
echo "Thin Pool å…ƒæ•°æ®ä½¿ç”¨ç‡: ${POOL_META}%"

if (( $(echo "$POOL_DATA &gt; 80" | bc -l) )); then
    echo "âš ï¸  è­¦å‘Š: Thin pool æ•°æ®ä½¿ç”¨ç‡è¶…è¿‡ 80%!"
fi

if (( $(echo "$POOL_META &gt; 80" | bc -l) )); then
    echo "âš ï¸  è­¦å‘Š: Thin pool å…ƒæ•°æ®ä½¿ç”¨ç‡è¶…è¿‡ 80%!"
fi
echo ""

echo "--- NAS æ•°æ®å·ä½¿ç”¨æƒ…å†µ ---"
df -h /data/nas
echo ""

echo "--- è™šæ‹Ÿæœºç£ç›˜åˆ—è¡¨ ---"
virsh vol-list kvm_pool 2&gt;/dev/null || echo "kvm_pool ä¸­æš‚æ— è™šæ‹Ÿç£ç›˜"
echo ""

echo "========================================="
EOF

chmod +x /usr/local/bin/storage-monitor
```

### 8.3 è¿è¡Œç›‘æ§

```bash
storage-monitor
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

å®Œæˆæœ¬æ–‡æ¡£åï¼Œæ‚¨åº”è¯¥å·²ç»é…ç½®å¥½ï¼š

- [x] åˆ›å»ºäº†æ–°çš„ç£ç›˜åˆ†åŒºï¼ˆçº¦ 1.7TBï¼‰
- [x] é…ç½®äº† LVM ç‰©ç†å·å’Œå·ç»„ (vg_kvm)
- [x] åˆ›å»ºäº† LVM thin pool (1.2TB)
- [x] åˆ›å»ºäº† NAS æ•°æ®é€»è¾‘å· (500GB)
- [x] NAS æ•°æ®å·å·²æŒ‚è½½åˆ° /data/nas
- [x] é…ç½®äº† KVM å­˜å‚¨æ±  (kvm_pool)
- [x] é…ç½®äº† NAS æ•°æ®å­˜å‚¨æ±  (nas_data_pool)
- [x] éªŒè¯è„šæœ¬æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®æ­£å¸¸
- [x] é¢„ç•™äº†çº¦ 50GB åº”æ€¥ç©ºé—´

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: parted åˆ›å»ºåˆ†åŒºå¤±è´¥

**ç—‡çŠ¶**: æç¤º"åˆ†åŒºæœªå¯¹é½"æˆ–"æ— æ³•åˆ›å»ºåˆ†åŒº"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ä½¿ç”¨ -a optimal å‚æ•°
parted -a optimal /dev/nvme0n1 mkpart primary ext4 110GB -50GB

# æˆ–è€…å¿½ç•¥å¯¹é½è­¦å‘Š
# åœ¨ parted äº¤äº’æ¨¡å¼ä¸­é€‰æ‹© "Ignore"
```

### é—®é¢˜ 2: thin pool åˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**: lvcreate æç¤ºç©ºé—´ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å·ç»„å¯ç”¨ç©ºé—´
vgs vg_kvm

# å¦‚æœå¯ç”¨ç©ºé—´å°äº 1200GBï¼Œå‡å° thin pool å¤§å°
lvcreate -L 1000G --thinpool kvm_thin_pool vg_kvm

# æˆ–ä½¿ç”¨ç™¾åˆ†æ¯”
lvcreate -l 70%FREE --thinpool kvm_thin_pool vg_kvm
```

### é—®é¢˜ 3: NAS æ•°æ®å·æ— æ³•æŒ‚è½½

**ç—‡çŠ¶**: mount å‘½ä»¤å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥é€»è¾‘å·æ˜¯å¦å­˜åœ¨
lvs vg_kvm/lv_nas_data

# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
blkid /dev/vg_kvm/lv_nas_data

# å¦‚æœæœªæ ¼å¼åŒ–ï¼Œé‡æ–°æ ¼å¼åŒ–
mkfs.xfs -f /dev/vg_kvm/lv_nas_data

# æ£€æŸ¥æŒ‚è½½ç‚¹
ls -ld /data/nas

# å°è¯•æ‰‹åŠ¨æŒ‚è½½
mount -t xfs /dev/vg_kvm/lv_nas_data /data/nas

# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
dmesg | tail -20
```

### é—®é¢˜ 4: KVM å­˜å‚¨æ± æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: virsh pool-start å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
virsh pool-start kvm_pool

# åˆ é™¤å¹¶é‡æ–°åˆ›å»º
virsh pool-destroy kvm_pool
virsh pool-undefine kvm_pool
virsh pool-define-as kvm_pool logical --source-name vg_kvm --target /dev/vg_kvm
virsh pool-build kvm_pool
virsh pool-start kvm_pool

# æ£€æŸ¥æƒé™
ls -l /dev/vg_kvm/

# æ£€æŸ¥ SELinux
getenforce
# å¦‚æœæ˜¯ Enforcingï¼Œä¸´æ—¶åˆ‡æ¢åˆ° Permissive æµ‹è¯•
setenforce 0
virsh pool-start kvm_pool
setenforce 1
```

### é—®é¢˜ 5: Thin pool ä½¿ç”¨ç‡å¼‚å¸¸å¢é•¿

**ç—‡çŠ¶**: thin pool å¿«é€Ÿå¡«æ»¡

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹å“ªä¸ªè™šæ‹Ÿç£ç›˜å ç”¨ç©ºé—´å¤§
lvs -a vg_kvm

# åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œ fstrim é‡Šæ”¾ç©ºé—´
# (åœ¨è™šæ‹Ÿæœºå†…è¿è¡Œ)
sudo fstrim -av

# å®¿ä¸»æœºä¸Šæ£€æŸ¥ thin pool
lvs -a vg_kvm/kvm_thin_pool

# å¦‚æœç¡®å®éœ€è¦æ›´å¤šç©ºé—´ï¼Œæ‰©å±• thin pool
lvextend -L +100G vg_kvm/kvm_thin_pool
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸé…ç½®äº†å­˜å‚¨æ¶æ„ã€‚

ç°åœ¨æ‚¨å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ï¼š

ğŸ‘‰ **[04-vm-management.md - è™šæ‹Ÿæœºåˆ›å»ºå’Œç®¡ç†](#section-4)**

---

## ğŸ’¡ çŸ¥è¯†è¡¥å……

### LVM Thin Provisioning åŸç†

**ä¼ ç»Ÿ LVM**:
- åˆ›å»º 100GB é€»è¾‘å· â†’ ç«‹å³å ç”¨ 100GB ç‰©ç†ç©ºé—´
- å³ä½¿åªå†™å…¥ 1GB æ•°æ®ï¼Œä¹Ÿå ç”¨ 100GB

**Thin Provisioning**:
- åˆ›å»º 100GB thin volume â†’ å‡ ä¹ä¸å ç”¨ç‰©ç†ç©ºé—´
- å†™å…¥ 1GB æ•°æ® â†’ å ç”¨çº¦ 1GB ç‰©ç†ç©ºé—´
- å†™å…¥å¤šå°‘ï¼Œå ç”¨å¤šå°‘

**ä¼˜åŠ¿**:
- **è¿‡é‡åˆ†é…**: å¯ä»¥åˆ›å»ºæ€»å’Œ &gt; ç‰©ç†ç©ºé—´çš„è™šæ‹Ÿç£ç›˜
- **èŠ‚çœç©ºé—´**: å®é™…æŒ‰éœ€åˆ†é…
- **å¿«ç…§é«˜æ•ˆ**: å¿«ç…§åªå­˜å‚¨å·®å¼‚æ•°æ®

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ å¿…é¡»ç›‘æ§ä½¿ç”¨ç‡ï¼Œé¿å…çœŸæ­£ç”¨æ»¡å¯¼è‡´ I/O é”™è¯¯
- âš ï¸ éœ€è¦é…ç½®è‡ªåŠ¨æ‰©å±•ç­–ç•¥
- âš ï¸ æ€§èƒ½ç•¥ä½äºä¼ ç»Ÿ LVMï¼ˆ5-10%ï¼‰

### qcow2 vs raw æ ¼å¼é€‰æ‹©

| ç‰¹æ€§ | qcow2 | raw |
|------|-------|-----|
| ç©ºé—´å ç”¨ | æŒ‰éœ€å¢é•¿ | ç«‹å³å ç”¨å…¨éƒ¨ |
| æ€§èƒ½ | ç•¥ä½ 5-10% | æœ€ä½³ |
| å¿«ç…§ | åŸç”Ÿæ”¯æŒ | éœ€è¦ LVM å¿«ç…§ |
| å‹ç¼© | æ”¯æŒ | ä¸æ”¯æŒ |
| å…¼å®¹æ€§ | KVM/QEMU ä¸“ç”¨ | é€šç”¨æ ¼å¼ |
| æ¨èåœºæ™¯ | å¼€å‘ã€æµ‹è¯• VM | ç”Ÿäº§ã€æ•°æ®åº“ VM |

**æˆ‘ä»¬çš„é€‰æ‹©**:
- **python-dev, web-app, router**: qcow2ï¼ˆæ–¹ä¾¿å¿«ç…§å’Œå…‹éš†ï¼‰
- **nas ç³»ç»Ÿç›˜**: rawï¼ˆæ›´å¥½çš„ I/O æ€§èƒ½ï¼‰
- **nas æ•°æ®**: ç‹¬ç«‹ LVM å·ï¼ˆæœ€ä½³æ€§èƒ½å’Œçµæ´»æ€§ï¼‰

### å­˜å‚¨æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **XFS vs Ext4 for NAS**:
   - XFS: å¤§æ–‡ä»¶æ€§èƒ½æ›´å¥½ï¼Œæ”¯æŒåœ¨çº¿æ‰©å±•
   - Ext4: å°æ–‡ä»¶æ€§èƒ½æ›´å¥½ï¼Œæ›´æˆç†Ÿ
   - æ¨è NAS ä½¿ç”¨ XFS

2. **LVM æ¡å¸¦åŒ–** (å¦‚æœæœ‰å¤šå—ç›˜):
   ```bash
   lvcreate -L 1TB -i 2 -I 64 -n striped_vol vg_kvm
   # -i 2: ä½¿ç”¨ 2 å—ç›˜æ¡å¸¦åŒ–
   # -I 64: æ¡å¸¦å¤§å° 64KB
   ```

3. **SSD TRIM æ”¯æŒ**:
   ```bash
   # å¯ç”¨ discard (å®šæœŸ TRIM)
   lvchange --discards passdown vg_kvm/lv_nas_data
   ```

è¿™äº›é«˜çº§ä¼˜åŒ–å°†åœ¨å®é™…ä½¿ç”¨ä¸­æ ¹æ®æ€§èƒ½éœ€æ±‚è°ƒæ•´ã€‚




---



# 04 - è™šæ‹Ÿæœºåˆ›å»ºå’Œç®¡ç†

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£æä¾›è™šæ‹Ÿæœºåˆ›å»ºå’Œæ—¥å¸¸ç®¡ç†çš„å®ç”¨è„šæœ¬å’Œå·¥å…·ï¼ŒåŒ…æ‹¬ï¼š

- âœ… è™šæ‹Ÿæœºåˆ›å»ºè„šæœ¬
- âœ… è™šæ‹Ÿæœºå¯åŠ¨/åœæ­¢ç®¡ç†
- âœ… èµ„æºåˆ†é…ç­–ç•¥  
- âœ… è‡ªåŠ¨å¯åŠ¨é…ç½®
- âœ… ç»Ÿä¸€ç®¡ç†å·¥å…·
- âœ… å¸¸ç”¨æ“ä½œé€ŸæŸ¥

**å‰ç½®æ¡ä»¶**: å·²å®Œæˆ [03-storage-expansion.md](#section-3)  
**é¢„è®¡è€—æ—¶**: 15 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†

---

## ğŸš€ å¿«é€Ÿåˆ›å»ºè™šæ‹Ÿæœºè„šæœ¬

### åˆ›å»ºé€šç”¨VMåˆ›å»ºè„šæœ¬

```bash
sudo su -

cat &gt; /usr/local/bin/create-vm &lt;&lt;'EOF'
#!/bin/bash

# è™šæ‹Ÿæœºåˆ›å»ºè„šæœ¬
# ç”¨æ³•: create-vm &lt;vm-name&gt; &lt;ram-gb&gt; &lt;vcpus&gt; &lt;disk-gb&gt; &lt;disk-format&gt; &lt;iso-path&gt; &lt;static-ip&gt;

set -e

if [ $# -lt 7 ]; then
    echo "ç”¨æ³•: $0 &lt;vm-name&gt; &lt;ram-gb&gt; &lt;vcpus&gt; &lt;disk-gb&gt; &lt;format&gt; &lt;iso-path&gt; &lt;static-ip&gt;"
    echo "ç¤ºä¾‹: $0 python-dev 4 2 80 qcow2 /kvm/iso/ubuntu-22.04.iso 192.168.71.201"
    exit 1
fi

VM_NAME=$1
RAM_GB=$2
VCPUS=$3
DISK_GB=$4
DISK_FORMAT=$5
ISO_PATH=$6
STATIC_IP=$7

RAM_MB=$((RAM_GB * 1024))

echo "========================================="
echo "åˆ›å»ºè™šæ‹Ÿæœº: $VM_NAME"
echo "========================================="
echo "å†…å­˜: ${RAM_GB}GB"
echo "vCPU: $VCPUS"
echo "ç£ç›˜: ${DISK_GB}GB ($DISK_FORMAT)"
echo "ISO: $ISO_PATH"
echo "IPåœ°å€: $STATIC_IP"
echo ""

# æ£€æŸ¥ISOæ˜¯å¦å­˜åœ¨
if [ ! -f "$ISO_PATH" ]; then
    echo "é”™è¯¯: ISOæ–‡ä»¶ä¸å­˜åœ¨: $ISO_PATH"
    exit 1
fi

# åˆ›å»ºè™šæ‹Ÿç£ç›˜
if [ "$DISK_FORMAT" == "qcow2" ]; then
    virsh vol-create-as kvm_pool ${VM_NAME}.qcow2 ${DISK_GB}G --format qcow2
elif [ "$DISK_FORMAT" == "raw" ]; then
    lvcreate -V ${DISK_GB}G --thinpool kvm_thin_pool -n ${VM_NAME} vg_kvm
    DISK_PATH="/dev/vg_kvm/${VM_NAME}"
else
    echo "é”™è¯¯: ä¸æ”¯æŒçš„ç£ç›˜æ ¼å¼: $DISK_FORMAT"
    exit 1
fi

# ç¡®å®šç£ç›˜è·¯å¾„
if [ "$DISK_FORMAT" == "qcow2" ]; then
    DISK_PATH="/dev/vg_kvm/kvm_thin_pool+${VM_NAME}.qcow2"
fi

# åˆ›å»ºè™šæ‹Ÿæœº
virt-install \
    --name $VM_NAME \
    --ram $RAM_MB \
    --vcpus $VCPUS \
    --disk path=$DISK_PATH,format=$DISK_FORMAT,bus=virtio \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0 \
    --cdrom $ISO_PATH \
    --os-variant generic \
    --noautoconsole

echo ""
echo "è™šæ‹Ÿæœº $VM_NAME åˆ›å»ºæˆåŠŸ!"
echo ""
echo "ä¸‹ä¸€æ­¥:"
echo "1. ä½¿ç”¨VNCå®¢æˆ·ç«¯è¿æ¥å¹¶å®‰è£…ç³»ç»Ÿ"
echo "   IP: 192.168.71.200"
echo "   ç«¯å£: $(virsh vncdisplay $VM_NAME | cut -d: -f2 | awk '{print 5900+$1}')"
echo ""
echo "2. åœ¨ç³»ç»Ÿå®‰è£…æ—¶é…ç½®é™æ€IP: $STATIC_IP"
echo ""
echo "3. å®‰è£…å®Œæˆåæ‰§è¡Œ:"
echo "   virsh change-media $VM_NAME sda --eject"
echo "   virsh autostart $VM_NAME"
EOF

chmod +x /usr/local/bin/create-vm
```

---

## ğŸ“Š è™šæ‹Ÿæœºç®¡ç†å·¥å…·

### åˆ›å»ºVMç®¡ç†è„šæœ¬

```bash
cat &gt; /usr/local/bin/vm-manager &lt;&lt;'EOF'
#!/bin/bash

# è™šæ‹Ÿæœºç®¡ç†å·¥å…·

cmd_list() {
    echo "æ‰€æœ‰è™šæ‹ŸæœºçŠ¶æ€:"
    virsh list --all
}

cmd_start() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager start &lt;vm-name&gt;"
        return 1
    fi
    echo "å¯åŠ¨è™šæ‹Ÿæœº: $1"
    virsh start $1
}

cmd_stop() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager stop &lt;vm-name&gt;"
        return 1
    fi
    echo "å…³é—­è™šæ‹Ÿæœº: $1"
    virsh shutdown $1
}

cmd_force_stop() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager force-stop &lt;vm-name&gt;"
        return 1
    fi
    echo "å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº: $1"
    virsh destroy $1
}

cmd_restart() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager restart &lt;vm-name&gt;"
        return 1
    fi
    echo "é‡å¯è™šæ‹Ÿæœº: $1"
    virsh reboot $1
}

cmd_console() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager console &lt;vm-name&gt;"
        return 1
    fi
    echo "è¿æ¥åˆ°è™šæ‹Ÿæœºæ§åˆ¶å° (Ctrl+] é€€å‡º):"
    virsh console $1
}

cmd_info() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager info &lt;vm-name&gt;"
        return 1
    fi
    virsh dominfo $1
}

cmd_status() {
    echo "========================================="
    echo "       è™šæ‹ŸæœºçŠ¶æ€æ€»è§ˆ"
    echo "========================================="
    echo ""
    virsh list --all
    echo ""
    echo "--- èµ„æºä½¿ç”¨ ---"
    for vm in $(virsh list --name); do
        if [ -n "$vm" ]; then
            echo "VM: $vm"
            virsh domstats $vm | grep -E 'cpu\.|balloon\.current'
            echo ""
        fi
    done
}

cmd_start_all() {
    echo "å¯åŠ¨æ‰€æœ‰å·²å®šä¹‰ä¸ºè‡ªåŠ¨å¯åŠ¨çš„è™šæ‹Ÿæœº..."
    for vm in $(virsh list --autostart --name); do
        if ! virsh list --name | grep -q "^${vm}$"; then
            echo "å¯åŠ¨: $vm"
            virsh start $vm
        fi
    done
}

cmd_stop_all() {
    echo "å…³é—­æ‰€æœ‰è¿è¡Œä¸­çš„è™šæ‹Ÿæœº..."
    for vm in $(virsh list --name); do
        if [ -n "$vm" ]; then
            echo "å…³é—­: $vm"
            virsh shutdown $vm
        fi
    done
}

case "$1" in
    list|ls)
        cmd_list
        ;;
    start)
        cmd_start $2
        ;;
    stop|shutdown)
        cmd_stop $2
        ;;
    force-stop|destroy)
        cmd_force_stop $2
        ;;
    restart|reboot)
        cmd_restart $2
        ;;
    console|con)
        cmd_console $2
        ;;
    info)
        cmd_info $2
        ;;
    status|st)
        cmd_status
        ;;
    start-all)
        cmd_start_all
        ;;
    stop-all|shutdown-all)
        cmd_stop_all
        ;;
    *)
        echo "è™šæ‹Ÿæœºç®¡ç†å·¥å…·"
        echo ""
        echo "ç”¨æ³•: vm-manager &lt;command&gt; [vm-name]"
        echo ""
        echo "å‘½ä»¤:"
        echo "  list              åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœº"
        echo "  start &lt;vm&gt;        å¯åŠ¨è™šæ‹Ÿæœº"
        echo "  stop &lt;vm&gt;         å…³é—­è™šæ‹Ÿæœº"
        echo "  force-stop &lt;vm&gt;   å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº"
        echo "  restart &lt;vm&gt;      é‡å¯è™šæ‹Ÿæœº"
        echo "  console &lt;vm&gt;      è¿æ¥åˆ°è™šæ‹Ÿæœºæ§åˆ¶å°"
        echo "  info &lt;vm&gt;         æ˜¾ç¤ºè™šæ‹Ÿæœºä¿¡æ¯"
        echo "  status            æ˜¾ç¤ºæ‰€æœ‰VMçŠ¶æ€"
        echo "  start-all         å¯åŠ¨æ‰€æœ‰è‡ªåŠ¨å¯åŠ¨çš„VM"
        echo "  stop-all          å…³é—­æ‰€æœ‰è¿è¡Œä¸­çš„VM"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/vm-manager
```

---

## ğŸ’¾ è™šæ‹Ÿæœºå¤‡ä»½è„šæœ¬

```bash
cat &gt; /usr/local/bin/vm-backup &lt;&lt;'EOF'
#!/bin/bash

VM_NAME=$1
BACKUP_DIR="/backup/vms"

if [ -z "$VM_NAME" ]; then
    echo "ç”¨æ³•: vm-backup &lt;vm-name&gt;"
    exit 1
fi

mkdir -p $BACKUP_DIR

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${VM_NAME}-${TIMESTAMP}.xml"

echo "å¤‡ä»½è™šæ‹Ÿæœºé…ç½®: $VM_NAME"
virsh dumpxml $VM_NAME &gt; $BACKUP_FILE

echo "é…ç½®å·²å¤‡ä»½åˆ°: $BACKUP_FILE"
echo ""
echo "å¤‡ä»½ç£ç›˜éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ:"
DISK=$(virsh domblklist $VM_NAME | grep vd | awk '{print $2}')
echo "  cp $DISK ${BACKUP_DIR}/${VM_NAME}-${TIMESTAMP}.img"
EOF

chmod +x /usr/local/bin/vm-backup
```

---

## ğŸ“ è™šæ‹Ÿæœºèµ„æºåˆ†é…ç­–ç•¥

### æ¨èé…ç½®

```bash
cat &gt; /root/vm-resource-plan.txt &lt;&lt;'EOF'
========================================
        è™šæ‹Ÿæœºèµ„æºåˆ†é…è®¡åˆ’
========================================

å®¿ä¸»æœºé…ç½®:
  - CPU: AMD R5 5600G (6æ ¸12çº¿ç¨‹)
  - å†…å­˜: 32GB
  - å¯ç”¨äºVM: ~28GBå†…å­˜, 10-11ä¸ªvCPU

è™šæ‹Ÿæœºåˆ†é…:
========================================

1. python-dev (Pythonå¼€å‘)
   - vCPU: 2
   - å†…å­˜: 4GB  
   - ç£ç›˜: 80GB (qcow2)
   - IP: 192.168.71.201
   - è‡ªåŠ¨å¯åŠ¨: å¦

2. web-app (Webåº”ç”¨éƒ¨ç½²)
   - vCPU: 2
   - å†…å­˜: 4GB
   - ç£ç›˜: 100GB (qcow2)
   - IP: 192.168.71.202
   - è‡ªåŠ¨å¯åŠ¨: æ˜¯

3. router (æ—è·¯ç”±)
   - vCPU: 2
   - å†…å­˜: 2GB
   - ç£ç›˜: 20GB (qcow2)
   - IP: 192.168.71.254
   - è‡ªåŠ¨å¯åŠ¨: æ˜¯

4. nas (æ–‡ä»¶æœåŠ¡å™¨)
   - vCPU: 2
   - å†…å­˜: 4GB
   - ç£ç›˜: 30GB (raw) + 500GBæ•°æ®å·
   - IP: 192.168.71.210
   - è‡ªåŠ¨å¯åŠ¨: æ˜¯

æ€»è®¡:
  - vCPU: 8 (ç•™4ä¸ªç»™å®¿ä¸»æœº)
  - å†…å­˜: 14GB (ç•™18GBç»™å®¿ä¸»æœº+ç¼“å­˜)
  - ç£ç›˜: 230GB + 500GBæ•°æ®

========================================
CPUç»‘å®šç­–ç•¥(å¯é€‰):
========================================

# ä¸ºå…³é”®VMç»‘å®šCPUæ ¸å¿ƒ
virsh vcpupin nas 0 0,6
virsh vcpupin nas 1 1,7
virsh vcpupin router 0 2,8
virsh vcpupin router 1 3,9

# æŸ¥çœ‹CPUç»‘å®š
virsh vcpupin nas

========================================
EOF

cat /root/vm-resource-plan.txt
```

---

## ğŸ”„ è™šæ‹Ÿæœºè‡ªåŠ¨å¯åŠ¨é…ç½®

```bash
# è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨
virsh autostart nas
virsh autostart router
virsh autostart web-app

# ä¸è‡ªåŠ¨å¯åŠ¨å¼€å‘VM
virsh autostart --disable python-dev

# æŸ¥çœ‹è‡ªåŠ¨å¯åŠ¨çŠ¶æ€
virsh list --all --autostart
```

---

## ğŸ“š å¸¸ç”¨æ“ä½œé€ŸæŸ¥è¡¨

```bash
cat &gt; /root/vm-cheatsheet.txt &lt;&lt;'EOF'
========================================
     è™šæ‹Ÿæœºæ“ä½œé€ŸæŸ¥è¡¨
========================================

åˆ—å‡ºè™šæ‹Ÿæœº:
  virsh list --all          # æ‰€æœ‰VM
  virsh list                # è¿è¡Œä¸­çš„VM

å¯åŠ¨/åœæ­¢:
  virsh start &lt;vm&gt;          # å¯åŠ¨
  virsh shutdown &lt;vm&gt;       # ä¼˜é›…å…³æœº
  virsh destroy &lt;vm&gt;        # å¼ºåˆ¶å…³æœº
  virsh reboot &lt;vm&gt;         # é‡å¯

è‡ªåŠ¨å¯åŠ¨:
  virsh autostart &lt;vm&gt;      # å¯ç”¨è‡ªåŠ¨å¯åŠ¨
  virsh autostart --disable &lt;vm&gt;  # ç¦ç”¨

ä¿¡æ¯æŸ¥çœ‹:
  virsh dominfo &lt;vm&gt;        # VMä¿¡æ¯
  virsh domstats &lt;vm&gt;       # ç»Ÿè®¡ä¿¡æ¯  
  virsh vncdisplay &lt;vm&gt;     # VNCç«¯å£

æ§åˆ¶å°:
  virsh console &lt;vm&gt;        # æ–‡æœ¬æ§åˆ¶å° (Ctrl+] é€€å‡º)

å¿«ç…§:
  virsh snapshot-create-as &lt;vm&gt; snap1  # åˆ›å»ºå¿«ç…§
  virsh snapshot-list &lt;vm&gt;             # åˆ—å‡ºå¿«ç…§
  virsh snapshot-revert &lt;vm&gt; snap1     # æ¢å¤å¿«ç…§

ç£ç›˜ç®¡ç†:
  virsh domblklist &lt;vm&gt;     # åˆ—å‡ºç£ç›˜
  virsh attach-disk &lt;vm&gt; /path/to/disk vdb  # æŒ‚è½½ç£ç›˜
  
èµ„æºè°ƒæ•´:
  virsh setmem &lt;vm&gt; 4G      # è°ƒæ•´å†…å­˜(VMéœ€æ”¯æŒ)
  virsh setvcpus &lt;vm&gt; 4     # è°ƒæ•´CPU

ç½‘ç»œ:
  virsh domiflist &lt;vm&gt;      # åˆ—å‡ºç½‘å¡
  virsh domifstat &lt;vm&gt; vnet0  # ç½‘å¡ç»Ÿè®¡

åˆ é™¤VM:
  virsh destroy &lt;vm&gt;        # å…ˆå…³æœº
  virsh undefine &lt;vm&gt; --remove-all-storage  # åˆ é™¤VMå’Œç£ç›˜

========================================
è‡ªå®šä¹‰ç®¡ç†å‘½ä»¤:
========================================

vm-manager list           # åˆ—å‡ºæ‰€æœ‰VM
vm-manager start &lt;vm&gt;     # å¯åŠ¨VM
vm-manager stop &lt;vm&gt;      # å…³é—­VM
vm-manager status         # çŠ¶æ€æ€»è§ˆ
vm-manager console &lt;vm&gt;   # è¿æ¥æ§åˆ¶å°

create-vm &lt;name&gt; &lt;ram&gt; &lt;cpu&gt; &lt;disk&gt; &lt;format&gt; &lt;iso&gt; &lt;ip&gt;
vm-backup &lt;vm&gt;           # å¤‡ä»½VMé…ç½®

storage-monitor          # å­˜å‚¨ç›‘æ§
sysinfo                  # ç³»ç»Ÿä¿¡æ¯

========================================
EOF

cat /root/vm-cheatsheet.txt
```

---

## âœ… éªŒè¯å·¥å…·

```bash
cat &gt; /root/verify-vms.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       è™šæ‹Ÿæœºç¯å¢ƒéªŒè¯"
echo "========================================="
echo ""

echo "--- å­˜å‚¨æ± çŠ¶æ€ ---"
virsh pool-list --all
echo ""

echo "--- è™šæ‹Ÿæœºåˆ—è¡¨ ---"
virsh list --all
echo ""

echo "--- ç½‘ç»œé…ç½® ---"
virsh net-list --all
echo ""

echo "--- ç£ç›˜ä½¿ç”¨ ---"
storage-monitor 2&gt;/dev/null || lvs vg_kvm
echo ""

echo "éªŒè¯å®Œæˆ!"
EOF

chmod +x /root/verify-vms.sh
/root/verify-vms.sh
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

- [x] åˆ›å»ºäº†VMåˆ›å»ºè„šæœ¬
- [x] åˆ›å»ºäº†VMç®¡ç†å·¥å…·
- [x] é…ç½®äº†èµ„æºåˆ†é…è®¡åˆ’
- [x] äº†è§£äº†å¸¸ç”¨æ“ä½œå‘½ä»¤
- [x] å‡†å¤‡å¥½äº†å¤‡ä»½å·¥å…·

---

## ğŸ¯ ä¸‹ä¸€æ­¥

ğŸ‘‰ **[05-monitoring.md - ç›‘æ§æ–¹æ¡ˆ](#section-5)**

æˆ–ç›´æ¥åˆ›å»ºå…·ä½“çš„è™šæ‹Ÿæœº:
- **[06-vm-python-dev.md - Pythonå¼€å‘VM](#section-6)**
- **[11-vm-nas.md - NASæ–‡ä»¶æœåŠ¡å™¨](#section-11)**
- **[09-vm-router-openwrt.md - OpenWrtæ—è·¯ç”±](#section-9)**

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºUbuntuå¼€å‘VM

```bash
# å…ˆä¸‹è½½Ubuntu ISO
cd /kvm/iso
wget https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/22.04/ubuntu-22.04.3-live-server-amd64.iso

# åˆ›å»ºVM
create-vm python-dev 4 2 80 qcow2 /kvm/iso/ubuntu-22.04.3-live-server-amd64.iso 192.168.71.201
```

### æ—¥å¸¸ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰VMçŠ¶æ€
vm-manager status

# å¯åŠ¨VM
vm-manager start python-dev

# è¿æ¥æ§åˆ¶å°
vm-manager console python-dev

# å…³é—­æ‰€æœ‰VM(ç»´æŠ¤å‰)
vm-manager stop-all
```




---



# 05 - ç›‘æ§å’Œç®¡ç†æ–¹æ¡ˆ

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

é…ç½®Cockpit Webæ§åˆ¶å°å’Œæ€§èƒ½ç›‘æ§å·¥å…·ã€‚

**é¢„è®¡è€—æ—¶**: 25åˆ†é’Ÿ

---

## ğŸŒ Cockpit Webæ§åˆ¶å°

### å®‰è£…Cockpit

```bash
sudo dnf install -y cockpit cockpit-machines cockpit-storaged cockpit-packagekit

# å¯åŠ¨æœåŠ¡
sudo systemctl enable --now cockpit.socket

# å¼€æ”¾é˜²ç«å¢™
sudo firewall-cmd --permanent --add-service=cockpit
sudo firewall-cmd --reload
```

### è®¿é—®Cockpit

æµè§ˆå™¨è®¿é—®: **https://192.168.71.200:9090**

ç™»å½•è´¦æˆ·: chris (æˆ–root)

åŠŸèƒ½:
- ç³»ç»Ÿç›‘æ§(CPU/å†…å­˜/ç½‘ç»œ)
- è™šæ‹Ÿæœºç®¡ç†
- å­˜å‚¨ç®¡ç†
- æ—¥å¿—æŸ¥çœ‹

---

## ğŸ“Š æ€§èƒ½ç›‘æ§è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/sys-monitor &lt;&lt;'EOF'
#!/bin/bash
echo "=== ç³»ç»Ÿç›‘æ§ ==="
echo "è´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"
echo ""
free -h
echo ""
df -h | grep -E 'Filesystem|vg_kvm|/data'
echo ""
echo "=== è™šæ‹ŸæœºçŠ¶æ€ ==="
virsh list --all
EOF

sudo chmod +x /usr/local/bin/sys-monitor
```

---

## ğŸ”” èµ„æºç›‘æ§

```bash
# å®æ—¶ç›‘æ§
htop

# VMæ€§èƒ½
virt-top

# å­˜å‚¨ç›‘æ§
storage-monitor
```

---

## ğŸ“ å®Œæˆ

- [x] Cockpitå·²å®‰è£…
- [x] ç›‘æ§è„šæœ¬å·²åˆ›å»º
- [x] å¯é€šè¿‡Webç®¡ç†è™šæ‹Ÿæœº

ğŸ‘‰ **ä¸‹ä¸€æ­¥: [06-vm-python-dev.md](#section-6)**




---



# 06 - Pythonå¼€å‘è™šæ‹Ÿæœºé…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

åˆ›å»ºå’Œé…ç½®Ubuntu 22.04 Pythonå¼€å‘ç¯å¢ƒè™šæ‹Ÿæœºã€‚

**é¢„è®¡è€—æ—¶**: 40åˆ†é’Ÿ

---

## ğŸš€ æ­¥éª¤1: ä¸‹è½½Ubuntu ISO

```bash
cd /kvm/iso
wget https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/22.04/ubuntu-22.04.3-live-server-amd64.iso
```

---

## ğŸ’» æ­¥éª¤2: åˆ›å»ºè™šæ‹Ÿæœº

```bash
create-vm python-dev 4 2 80 qcow2 \
  /kvm/iso/ubuntu-22.04.3-live-server-amd64.iso \
  192.168.71.201
```

---

## âš™ï¸ æ­¥éª¤3: å®‰è£…Ubuntuç³»ç»Ÿ

1. è¿æ¥VNCæˆ–ä½¿ç”¨ `virt-viewer python-dev`
2. é€‰æ‹©è¯­è¨€: English
3. ç½‘ç»œé…ç½®:
   - ç¼–è¾‘enp1s0
   - IPv4 Method: Manual
   - Address: 192.168.71.201/24
   - Gateway: 192.168.71.1
   - DNS: 192.168.71.1,223.5.5.5
4. å­˜å‚¨: ä½¿ç”¨æ•´ä¸ªç£ç›˜
5. åˆ›å»ºç”¨æˆ·: dev/å¯†ç 
6. å®‰è£…OpenSSH server
7. ç­‰å¾…å®‰è£…å®Œæˆï¼Œé‡å¯

å®‰è£…å®Œæˆå:
```bash
# å¼¹å‡ºå®‰è£…å…‰ç›˜
virsh change-media python-dev sda --eject

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨(å¯é€‰)
# virsh autostart python-dev
```

---

## ğŸ”§ æ­¥éª¤4: ç³»ç»Ÿåˆå§‹åŒ–é…ç½®

SSHç™»å½•åˆ°è™šæ‹Ÿæœº:
```bash
ssh dev@192.168.71.201
```

### 4.1 é…ç½®å›½å†…é•œåƒæº

```bash
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak

sudo cat &gt; /etc/apt/sources.list &lt;&lt;'EOF'
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse
EOF

sudo apt update &amp;&amp; sudo apt upgrade -y
```

### 4.2 å®‰è£…Pythonç¯å¢ƒ

```bash
# å®‰è£…Python 3.11
sudo apt install -y software-properties-common
sudo add-apt-repository -y ppa:deadsnakes/ppa
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3.11-dev

# è®¾ç½®é»˜è®¤Python
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

# å®‰è£…pip
curl -sS https://bootstrap.pypa.io/get-pip.py | sudo python3.11

# é…ç½®pipæ¸…åæº
mkdir -p ~/.pip
cat &gt; ~/.pip/pip.conf &lt;&lt;'EOF'
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
EOF

# éªŒè¯
python3 --version
pip3 --version
```

### 4.3 å®‰è£…å¼€å‘å·¥å…·

```bash
sudo apt install -y \
    git \
    vim \
    htop \
    curl \
    wget \
    build-essential \
    libssl-dev \
    libffi-dev \
    python3-pip \
    tmux \
    tree
```

### 4.4 é…ç½®Git

```bash
git config --global user.name "Your Name"
git config --global user.email "your@email.com"
git config --global init.defaultBranch main
```

---

## ğŸ“¦ æ­¥éª¤5: å®‰è£…å¸¸ç”¨PythonåŒ…

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒç¤ºä¾‹
python3 -m venv ~/venv
source ~/venv/bin/activate

# å®‰è£…å¸¸ç”¨åŒ…
pip install \
    requests \
    flask \
    fastapi \
    uvicorn \
    sqlalchemy \
    pytest \
    black \
    flake8 \
    ipython

# é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
deactivate
```

---

## âœ… éªŒè¯é…ç½®

```bash
# ç³»ç»Ÿä¿¡æ¯
uname -a
python3 --version
pip3 --version
git --version

# ç½‘ç»œæµ‹è¯•
ping -c 3 223.5.5.5
```

---

## ğŸ“ å®Œæˆ

Pythonå¼€å‘ç¯å¢ƒå·²é…ç½®å®Œæˆ!

ä½¿ç”¨æ–¹å¼:
```bash
# SSHè¿æ¥
ssh dev@192.168.71.201

# åˆ›å»ºé¡¹ç›®
python3 -m venv myproject
cd myproject &amp;&amp; source bin/activate
pip install flask
```

ğŸ‘‰ **ä¸‹ä¸€æ­¥: [07-vm-web-app.md](#section-7)**




---



# 07 - Webåº”ç”¨éƒ¨ç½²è™šæ‹Ÿæœºé…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

åˆ›å»ºå’Œé…ç½®Ubuntu 22.04 Webåº”ç”¨ç”Ÿäº§éƒ¨ç½²ç¯å¢ƒè™šæ‹Ÿæœºã€‚

**é¢„è®¡è€—æ—¶**: 50åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†

---

## ğŸš€ æ­¥éª¤1: åˆ›å»ºè™šæ‹Ÿæœº

```bash
# ä½¿ç”¨å·²ä¸‹è½½çš„Ubuntu ISOï¼ˆå‚è€ƒ06æ–‡æ¡£ï¼‰
create-vm web-app 4 2 100 qcow2 \
  /kvm/iso/ubuntu-22.04.3-live-server-amd64.iso \
  192.168.71.202
```

---

## âš™ï¸ æ­¥éª¤2: å®‰è£…Ubuntuç³»ç»Ÿ

å®‰è£…è¿‡ç¨‹ä¸Pythonå¼€å‘VMç±»ä¼¼ï¼Œç½‘ç»œé…ç½®ï¼š
- IP: 192.168.71.202/24
- Gateway: 192.168.71.1
- DNS: 192.168.71.1,223.5.5.5
- ç”¨æˆ·: webadmin

å®‰è£…å®Œæˆåå¼¹å‡ºå…‰ç›˜ï¼š
```bash
virsh change-media web-app sda --eject
virsh autostart web-app  # ç”Ÿäº§ç¯å¢ƒè®¾ç½®è‡ªåŠ¨å¯åŠ¨
```

---

## ğŸ”§ æ­¥éª¤3: ç³»ç»Ÿåˆå§‹åŒ–

SSHç™»å½•ï¼š
```bash
ssh webadmin@192.168.71.202
```

### 3.1 é…ç½®é•œåƒæº

```bash
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak

sudo tee /etc/apt/sources.list &gt; /dev/null &lt;&lt;'EOF'
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse
EOF

sudo apt update &amp;&amp; sudo apt upgrade -y
```

### 3.2 å®‰è£…åŸºç¡€å·¥å…·

```bash
sudo apt install -y \
    vim \
    git \
    curl \
    wget \
    htop \
    net-tools \
    build-essential \
    software-properties-common
```

---

## ğŸ æ­¥éª¤4: Pythonç¯å¢ƒé…ç½®

```bash
# å®‰è£…Python 3.11
sudo add-apt-repository -y ppa:deadsnakes/ppa
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip

# é…ç½®pipæ¸…åæº
mkdir -p ~/.pip
cat &gt; ~/.pip/pip.conf &lt;&lt;'EOF'
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
EOF

sudo cp ~/.pip/pip.conf /root/.pip/pip.conf
```

---

## ğŸŒ æ­¥éª¤5: Nginxå®‰è£…é…ç½®

```bash
# å®‰è£…Nginx
sudo apt install -y nginx

# å¯åŠ¨å¹¶è®¾ç½®è‡ªå¯åŠ¨
sudo systemctl enable --now nginx

# éªŒè¯
sudo systemctl status nginx
curl http://localhost

# é…ç½®é˜²ç«å¢™
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 5.1 åˆ›å»ºåº”ç”¨é…ç½®æ¨¡æ¿

```bash
sudo tee /etc/nginx/sites-available/app-template &lt;&lt;'EOF'
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /var/www/app/static/;
    }

    location /media/ {
        alias /var/www/app/media/;
    }
}
EOF
```

---

## ğŸ”„ æ­¥éª¤6: åº”ç”¨æœåŠ¡å™¨é…ç½®

### 6.1 å®‰è£…Gunicorn

```bash
sudo pip3 install gunicorn
```

### 6.2 åˆ›å»ºsystemdæœåŠ¡æ¨¡æ¿

```bash
sudo tee /etc/systemd/system/webapp.service &lt;&lt;'EOF'
[Unit]
Description=Web Application
After=network.target

[Service]
Type=notify
User=webadmin
Group=webadmin
WorkingDirectory=/home/webadmin/app
Environment="PATH=/home/webadmin/app/venv/bin"
ExecStart=/home/webadmin/app/venv/bin/gunicorn \
    --workers 3 \
    --bind 127.0.0.1:8000 \
    --timeout 120 \
    --access-logfile /var/log/webapp/access.log \
    --error-logfile /var/log/webapp/error.log \
    wsgi:application

[Install]
WantedBy=multi-user.target
EOF

# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/webapp
sudo chown webadmin:webadmin /var/log/webapp
```

---

## ğŸ—„ï¸ æ­¥éª¤7: æ•°æ®åº“å®‰è£…

### 7.1 PostgreSQLï¼ˆæ¨èï¼‰

```bash
# å®‰è£…PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# å¯åŠ¨æœåŠ¡
sudo systemctl enable --now postgresql

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
sudo -u postgres psql &lt;&lt;'EOF'
CREATE DATABASE webapp_db;
CREATE USER webapp_user WITH PASSWORD 'secure_password';
ALTER ROLE webapp_user SET client_encoding TO 'utf8';
ALTER ROLE webapp_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE webapp_user SET timezone TO 'Asia/Shanghai';
GRANT ALL PRIVILEGES ON DATABASE webapp_db TO webapp_user;
\q
EOF

# å®‰è£…Python PostgreSQLé©±åŠ¨
pip3 install psycopg2-binary
```

### 7.2 MySQLï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£…MySQL
sudo apt install -y mysql-server

# å®‰å…¨é…ç½®
sudo mysql_secure_installation

# åˆ›å»ºæ•°æ®åº“
sudo mysql &lt;&lt;'EOF'
CREATE DATABASE webapp_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'webapp_user'@'localhost' IDENTIFIED BY 'secure_password';
GRANT ALL PRIVILEGES ON webapp_db.* TO 'webapp_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
EOF

# å®‰è£…Python MySQLé©±åŠ¨
pip3 install mysqlclient
```

---

## ğŸ“¦ æ­¥éª¤8: Redisç¼“å­˜

```bash
# å®‰è£…Redis
sudo apt install -y redis-server

# é…ç½®Redis
sudo sed -i 's/^supervised no/supervised systemd/' /etc/redis/redis.conf

# é‡å¯Redis
sudo systemctl restart redis-server
sudo systemctl enable redis-server

# éªŒè¯
redis-cli ping

# å®‰è£…Python Rediså®¢æˆ·ç«¯
pip3 install redis
```

---

## ğŸ³ æ­¥éª¤9: Dockerç¯å¢ƒï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£…Docker
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# é…ç½®Dockerå›½å†…é•œåƒ
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json &lt;&lt;'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
EOF

sudo systemctl daemon-reload
sudo systemctl restart docker
sudo systemctl enable docker

# æ·»åŠ ç”¨æˆ·åˆ°dockerç»„
sudo usermod -aG docker webadmin

# éªŒè¯
docker --version
docker run hello-world
```

---

## ğŸ“ æ­¥éª¤10: éƒ¨ç½²ç¤ºä¾‹åº”ç”¨

### 10.1 åˆ›å»ºFlaskåº”ç”¨ç¤ºä¾‹

```bash
mkdir -p ~/app
cd ~/app

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.11 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install flask gunicorn

# åˆ›å»ºåº”ç”¨
cat &gt; app.py &lt;&lt;'EOF'
from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello():
    return '&lt;h1&gt;Web Application Server&lt;/h1&gt;&lt;p&gt;Running on 192.168.71.202&lt;/p&gt;'

@app.route('/health')
def health():
    return {'status': 'healthy'}

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)
EOF

# åˆ›å»ºWSGIå…¥å£
cat &gt; wsgi.py &lt;&lt;'EOF'
from app import app

application = app

if __name__ == '__main__':
    application.run()
EOF

# æµ‹è¯•è¿è¡Œ
gunicorn --bind 0.0.0.0:8000 wsgi:application
```

### 10.2 é…ç½®Nginx

```bash
# åˆ›å»ºåº”ç”¨ä¸“ç”¨é…ç½®
sudo tee /etc/nginx/sites-available/myapp &lt;&lt;'EOF'
server {
    listen 80;
    server_name 192.168.71.202;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
EOF

# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl reload nginx
```

### 10.3 é…ç½®systemdæœåŠ¡

```bash
# ä¿®æ”¹æœåŠ¡é…ç½®
sudo tee /etc/systemd/system/myapp.service &lt;&lt;'EOF'
[Unit]
Description=My Flask Application
After=network.target

[Service]
Type=notify
User=webadmin
Group=webadmin
WorkingDirectory=/home/webadmin/app
Environment="PATH=/home/webadmin/app/venv/bin"
ExecStart=/home/webadmin/app/venv/bin/gunicorn \
    --workers 3 \
    --bind 127.0.0.1:8000 \
    wsgi:application

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable myapp
sudo systemctl start myapp

# éªŒè¯
sudo systemctl status myapp
curl http://192.168.71.202
```

---

## âœ… æ­¥éª¤11: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status nginx
sudo systemctl status myapp
sudo systemctl status postgresql
sudo systemctl status redis

# æµ‹è¯•è®¿é—®
curl http://192.168.71.202
curl http://192.168.71.202/health

# ä»å®¿ä¸»æœºæµ‹è¯•
# ssh chris@192.168.71.200
# curl http://192.168.71.202
```

---

## ğŸ”’ æ­¥éª¤12: å®‰å…¨åŠ å›º

```bash
# é…ç½®é˜²ç«å¢™
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw enable

# ç¦ç”¨root SSHç™»å½•
sudo sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart sshd

# é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

## ğŸ“Š æ­¥éª¤13: ç›‘æ§å’Œæ—¥å¿—

```bash
# å®‰è£…æ—¥å¿—æŸ¥çœ‹å·¥å…·
sudo apt install -y lnav

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
sudo journalctl -u myapp -f

# æŸ¥çœ‹Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# å®‰è£…htopç›‘æ§
htop
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

- [x] Ubuntuç³»ç»Ÿå®‰è£…å®Œæˆ
- [x] é•œåƒæºé…ç½®ä¸ºå›½å†…æº
- [x] Pythonç¯å¢ƒé…ç½®
- [x] Nginxå®‰è£…é…ç½®
- [x] æ•°æ®åº“å®‰è£…ï¼ˆPostgreSQL/MySQLï¼‰
- [x] Redisç¼“å­˜é…ç½®
- [x] Dockerç¯å¢ƒé…ç½®ï¼ˆå¯é€‰ï¼‰
- [x] ç¤ºä¾‹åº”ç”¨éƒ¨ç½²
- [x] systemdæœåŠ¡é…ç½®
- [x] é˜²ç«å¢™å’Œå®‰å…¨é…ç½®
- [x] å¯ä»å±€åŸŸç½‘è®¿é—®

---

## ğŸ¯ ä¸‹ä¸€æ­¥

Webåº”ç”¨æœåŠ¡å™¨å·²é…ç½®å®Œæˆï¼

### ä»å¼€å‘VMéƒ¨ç½²åº”ç”¨æµç¨‹

```bash
# åœ¨å¼€å‘VM (192.168.71.201) æ‰“åŒ…åº”ç”¨
cd ~/myproject
tar -czf myapp.tar.gz .

# ä¼ è¾“åˆ°ç”Ÿäº§VM
scp myapp.tar.gz webadmin@192.168.71.202:~/

# åœ¨ç”Ÿäº§VMéƒ¨ç½²
ssh webadmin@192.168.71.202
tar -xzf myapp.tar.gz -C ~/app/
cd ~/app
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart myapp
```

ğŸ‘‰ **[08-vm-router-comparison.md - æ—è·¯ç”±æ–¹æ¡ˆå¯¹æ¯”](#section-8)**




---



# 08 - æ—è·¯ç”±æ–¹æ¡ˆå¯¹æ¯”

## ğŸ“‹ ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”

### OpenWrt + OpenClash vs Rocky 9 + V2Ray

| ç‰¹æ€§ | OpenWrt + OpenClash | Rocky 9 + V2Ray |
|------|---------------------|-----------------|
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ Webç•Œé¢ | â­â­â­â˜†â˜† å‘½ä»¤è¡Œé…ç½® |
| **é…ç½®éš¾åº¦** | â­â­â˜†â˜†â˜† ç®€å• | â­â­â­â­â˜† è¾ƒå¤æ‚ |
| **Clashè®¢é˜…** | âœ… åŸç”Ÿæ”¯æŒ | âš ï¸ éœ€è½¬æ¢ |
| **æ€§èƒ½** | â­â­â­â­â˜† è¾ƒå¥½ | â­â­â­â­â­ ä¼˜ç§€ |
| **èµ„æºå ç”¨** | 512MB-1GB | 1GB-2GB |
| **ç¨³å®šæ€§** | â­â­â­â­â˜† | â­â­â­â­â­ |
| **åŠŸèƒ½ä¸°å¯Œåº¦** | â­â­â­â­â­ æ’ä»¶ä¸°å¯Œ | â­â­â­â˜†â˜† ä¸“æ³¨ä»£ç† |
| **ä¸Šæ‰‹æ—¶é—´** | 1-2å°æ—¶ | 3-4å°æ—¶ |

---

## ğŸ¯ æ¨èé€‰æ‹©

### é€‰æ‹©OpenWrtï¼Œå¦‚æœä½ ï¼š
- âœ… å¸Œæœ›æœ‰Webç•Œé¢ç®¡ç†
- âœ… ä¹ æƒ¯ä½¿ç”¨Clashè®¢é˜…
- âœ… éœ€è¦å»å¹¿å‘Šç­‰é¢å¤–åŠŸèƒ½
- âœ… æƒ³è¦å¼€ç®±å³ç”¨çš„ä½“éªŒ
- âœ… æ˜¯Linuxæ–°æ‰‹

### é€‰æ‹©V2Rayï¼Œå¦‚æœä½ ï¼š
- âœ… è¿½æ±‚æœ€ä½³æ€§èƒ½
- âœ… ç†Ÿæ‚‰Linuxå‘½ä»¤è¡Œ
- âœ… éœ€è¦é«˜åº¦è‡ªå®šä¹‰
- âœ… æƒ³æ·±å…¥å­¦ä¹ ä»£ç†æŠ€æœ¯
- âœ… æœ‰è„šæœ¬ç¼–å†™èƒ½åŠ›

---

## ğŸ’¡ æˆ‘çš„å»ºè®®

**å¯¹äºæ‚¨çš„æƒ…å†µï¼ˆLinuxç»éªŒè¾ƒå°‘ï¼‰ï¼šæ¨èOpenWrt + OpenClash**

ç†ç”±ï¼š
1. âœ… Webç•Œé¢å‹å¥½ï¼Œé™ä½å­¦ä¹ æ›²çº¿
2. âœ… Clashè®¢é˜…ç›´æ¥å¯¼å…¥ï¼Œæ— éœ€è½¬æ¢
3. âœ… ç¤¾åŒºèµ„æºä¸°å¯Œï¼Œé—®é¢˜å®¹æ˜“è§£å†³
4. âœ… å¯ä»¥è¾¹ç”¨è¾¹å­¦ï¼ŒåæœŸå†å°è¯•V2Ray

---

## ğŸ“š åç»­æ–‡æ¡£

- **[09-vm-router-openwrt.md](#section-9)** - OpenWrtæ—è·¯ç”±å®Œæ•´é…ç½®
- **[10-vm-router-v2ray.md](#section-10)** - V2Rayæ—è·¯ç”±å®Œæ•´é…ç½®

å»ºè®®å…ˆé˜…è¯»09æ–‡æ¡£ï¼Œå¦‚æœOpenWrtæ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå†å°è¯•10æ–‡æ¡£çš„V2Rayæ–¹æ¡ˆã€‚




---



# 09 - OpenWrtæ—è·¯ç”±é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

ä½¿ç”¨OpenWrt + OpenClashå®ç°é€æ˜ä»£ç†æ—è·¯ç”±ã€‚

**é¢„è®¡è€—æ—¶**: 60åˆ†é’Ÿ

---

## ğŸš€ æ­¥éª¤1: ä¸‹è½½OpenWrté•œåƒ

```bash
cd /kvm/iso

# ä¸‹è½½OpenWrt x86-64ç‰ˆæœ¬
wget https://mirrors.ustc.edu.cn/openwrt/releases/23.05.2/targets/x86/64/openwrt-23.05.2-x86-64-generic-ext4-combined.img.gz

# è§£å‹
gunzip openwrt-23.05.2-x86-64-generic-ext4-combined.img.gz
```

---

## ğŸ’» æ­¥éª¤2: åˆ›å»ºè™šæ‹Ÿæœº

```bash
# è½¬æ¢é•œåƒä¸ºqcow2
sudo qemu-img convert -f raw -O qcow2 \
    /kvm/iso/openwrt-23.05.2-x86-64-generic-ext4-combined.img \
    /kvm/iso/openwrt.qcow2

# æ‰©å±•ç£ç›˜åˆ°20GB
sudo qemu-img resize /kvm/iso/openwrt.qcow2 20G

# å¤åˆ¶åˆ°å­˜å‚¨æ± 
sudo cp /kvm/iso/openwrt.qcow2 /var/lib/libvirt/images/router.qcow2

# åˆ›å»ºè™šæ‹Ÿæœº
virt-install \
    --name router \
    --ram 2048 \
    --vcpus 2 \
    --disk /var/lib/libvirt/images/router.qcow2,format=qcow2,bus=virtio \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0 \
    --os-variant generic \
    --import \
    --noautoconsole
```

---

## âš™ï¸ æ­¥éª¤3: åˆå§‹é…ç½®

### 3.1 é€šè¿‡VNCè¿æ¥é…ç½®ç½‘ç»œ

```bash
# æŸ¥çœ‹VNCç«¯å£
virsh vncdisplay router

# OpenWrté»˜è®¤IP: 192.168.1.1
# éœ€è¦ä¿®æ”¹ä¸º: 192.168.71.254
```

åœ¨VNCæ§åˆ¶å°ï¼š
```bash
vi /etc/config/network

# ä¿®æ”¹lanæ¥å£:
config interface 'lan'
    option device 'br-lan'
    option proto 'static'
    option ipaddr '192.168.71.254'
    option netmask '255.255.255.0'
    option gateway '192.168.71.1'
    option dns '192.168.71.1 223.5.5.5'

# é‡å¯ç½‘ç»œ
/etc/init.d/network restart
```

### 3.2 Webè®¿é—®

æµè§ˆå™¨è®¿é—®: http://192.168.71.254

é»˜è®¤ç”¨æˆ·å: root  
é»˜è®¤å¯†ç : (æ— å¯†ç ï¼Œé¦–æ¬¡ç™»å½•è®¾ç½®)

---

## ğŸ“¦ æ­¥éª¤4: å®‰è£…OpenClash

### 4.1 ä¸Šä¼ OpenClashæ’ä»¶

```bash
# ä¸‹è½½OpenClash
wget https://github.com/vernesong/OpenClash/releases/download/v0.45.123/luci-app-openclash_0.45.123_all.ipk

# ä¸Šä¼ åˆ°OpenWrt
scp luci-app-openclash_0.45.123_all.ipk root@192.168.71.254:/tmp/
```

### 4.2 å®‰è£…æ’ä»¶

åœ¨OpenWrt Webç•Œé¢æˆ–SSHï¼š
```bash
ssh root@192.168.71.254

# å®‰è£…ä¾èµ–
opkg update
opkg install coreutils-nohup bash iptables dnsmasq-full curl ca-certificates ipset ip-full iptables-mod-tproxy iptables-mod-extra libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base

# å®‰è£…OpenClash
opkg install /tmp/luci-app-openclash_0.45.123_all.ipk
```

---

## ğŸ”§ æ­¥éª¤5: é…ç½®OpenClash

### 5.1 å¯¼å…¥Clashè®¢é˜…

Webç•Œé¢: http://192.168.71.254

1. æœåŠ¡ â†’ OpenClash â†’ é…ç½®æ–‡ä»¶è®¢é˜…
2. æ·»åŠ è®¢é˜…åœ°å€ï¼ˆä½ çš„æœºåœºè®¢é˜…é“¾æ¥ï¼‰
3. ä¿å­˜å¹¶æ›´æ–°

### 5.2 åŸºæœ¬è®¾ç½®

```
æ¨¡å¼è®¾ç½®:
- è¿è¡Œæ¨¡å¼: Redir-Host (æ¨è)
- è®¿é—®æ§åˆ¶: å…¨éƒ¨ä»£ç†

DNSè®¾ç½®:
- ä½¿ç”¨è‡ªå®šä¹‰DNS: å¯ç”¨
- æœ¬åœ°DNS: 223.5.5.5
- å›½å¤–DNS: 8.8.8.8
```

### 5.3 å¯åŠ¨æœåŠ¡

ç‚¹å‡»"å¯åŠ¨ OpenClash"

---

## ğŸŒ æ­¥éª¤6: å®¢æˆ·ç«¯é…ç½®

### æ–¹æ¡ˆA: DHCPè‡ªåŠ¨åˆ†å‘ï¼ˆæ¨èï¼‰

åœ¨ä¸»è·¯ç”±ï¼ˆ192.168.71.1ï¼‰é…ç½®DHCPé€‰é¡¹ï¼š
- ç½‘å…³: 192.168.71.254ï¼ˆOpenWrtæ—è·¯ç”±ï¼‰

æ‰€æœ‰è®¾å¤‡è‡ªåŠ¨èµ°ä»£ç†ã€‚

### æ–¹æ¡ˆB: æ‰‹åŠ¨é…ç½®

åœ¨éœ€è¦ç¿»å¢™çš„è®¾å¤‡ä¸Šï¼š
- ç½‘å…³æ”¹ä¸º: 192.168.71.254
- DNSæ”¹ä¸º: 192.168.71.254

---

## âœ… éªŒè¯

```bash
# åœ¨å®¢æˆ·ç«¯æµ‹è¯•
curl https://www.google.com
curl ipinfo.io

# æŸ¥çœ‹OpenClashçŠ¶æ€
ssh root@192.168.71.254
/etc/init.d/openclash status
```

---

## ğŸ“ å®Œæˆ

OpenWrtæ—è·¯ç”±é…ç½®å®Œæˆï¼

**Tips**:
- å®šæœŸæ›´æ–°è®¢é˜…
- å…³æ³¨OpenClashæ›´æ–°
- å¤‡ä»½é…ç½®æ–‡ä»¶

ğŸ‘‰ **[11-vm-nas.md](#section-11)**




---



# 09 - è¡¥å……OpenClashçœæµé…ç½®

## ğŸ“‹ é…ç½®ç›®æ ‡

- âœ… ä»…å¿…è¦ç½‘ç«™èµ°ä»£ç†ï¼ˆGoogleã€YouTubeã€Claudeç­‰ï¼‰
- âœ… å›½å†…ç½‘ç«™ç›´è¿
- âœ… æ–¹ä¾¿æ·»åŠ æ–°çš„ä»£ç†è§„åˆ™
- âœ… èŠ‚çœVPNæµé‡

---

## ğŸ¯ æ ¸å¿ƒé…ç½®ç­–ç•¥

### ä¸‰å±‚åˆ†æµè§„åˆ™

```
1. è‡ªå®šä¹‰è§„åˆ™ï¼ˆæœ€ä¼˜å…ˆï¼‰
   - æ‚¨æ‰‹åŠ¨æ·»åŠ çš„ç½‘ç«™
   - Googleã€YouTubeã€Claudeç­‰
   
2. GFWListè§„åˆ™ï¼ˆæ¬¡ä¼˜å…ˆï¼‰
   - å¸¸è§è¢«å¢™ç½‘ç«™
   
3. é»˜è®¤ç›´è¿ï¼ˆæœ€åï¼‰
   - æ‰€æœ‰å…¶ä»–æµé‡ç›´è¿
```

---

## âš™ï¸ è¯¦ç»†é…ç½®æ­¥éª¤

### æ­¥éª¤1: OpenClashåŸºæœ¬è®¾ç½®

ç™»å½•OpenWrt: http://192.168.71.254

è¿›å…¥ï¼š**æœåŠ¡ â†’ OpenClash â†’ å…¨å±€è®¾ç½®**

```
è¿è¡Œæ¨¡å¼: Rule (è§„åˆ™æ¨¡å¼) â† å…³é”®ï¼
é»˜è®¤ä»£ç†æ–¹å¼: DIRECT (ç›´è¿)
```

### æ­¥éª¤2: é…ç½®åˆ†æµè§„åˆ™

è¿›å…¥ï¼š**æœåŠ¡ â†’ OpenClash â†’ è§„åˆ™è®¾ç½®**

#### 2.1 å¯ç”¨è§„åˆ™

```
å¯ç”¨è‡ªå®šä¹‰è§„åˆ™: âœ…
å¯ç”¨è®¿é—®æ§åˆ¶: âœ…
```

#### 2.2 æ·»åŠ è‡ªå®šä¹‰è§„åˆ™

ç‚¹å‡»"è‡ªå®šä¹‰è§„åˆ™"ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```yaml
# Google æœåŠ¡
DOMAIN-SUFFIX,google.com,PROXY
DOMAIN-SUFFIX,googleapis.com,PROXY
DOMAIN-SUFFIX,googleusercontent.com,PROXY
DOMAIN-SUFFIX,gstatic.com,PROXY
DOMAIN-SUFFIX,gmail.com,PROXY
DOMAIN-SUFFIX,youtube.com,PROXY
DOMAIN-SUFFIX,ytimg.com,PROXY
DOMAIN-SUFFIX,googlevideo.com,PROXY
DOMAIN-SUFFIX,youtu.be,PROXY

# AI æœåŠ¡
DOMAIN-SUFFIX,openai.com,PROXY
DOMAIN-SUFFIX,anthropic.com,PROXY
DOMAIN-SUFFIX,claude.ai,PROXY
DOMAIN-SUFFIX,gemini.google.com,PROXY

# ç¤¾äº¤åª’ä½“
DOMAIN-SUFFIX,twitter.com,PROXY
DOMAIN-SUFFIX,x.com,PROXY
DOMAIN-SUFFIX,facebook.com,PROXY
DOMAIN-SUFFIX,instagram.com,PROXY
DOMAIN-SUFFIX,telegram.org,PROXY

# å¼€å‘å·¥å…·
DOMAIN-SUFFIX,github.com,PROXY
DOMAIN-SUFFIX,githubusercontent.com,PROXY
DOMAIN-SUFFIX,stackoverflow.com,PROXY

# å…¶ä»–å¸¸ç”¨
DOMAIN-SUFFIX,wikipedia.org,PROXY
DOMAIN-SUFFIX,reddit.com,PROXY

# å›½å†…ç½‘ç«™ç›´è¿
DOMAIN-SUFFIX,baidu.com,DIRECT
DOMAIN-SUFFIX,qq.com,DIRECT
DOMAIN-SUFFIX,taobao.com,DIRECT
DOMAIN-SUFFIX,alipay.com,DIRECT
DOMAIN-SUFFIX,bilibili.com,DIRECT
DOMAIN-SUFFIX,zhihu.com,DIRECT

# å›½å†…IPæ®µç›´è¿
GEOIP,CN,DIRECT

# æœ€ç»ˆè§„åˆ™ï¼šå…¶ä»–å…¨éƒ¨ç›´è¿
MATCH,DIRECT
```

---

## ğŸ”§ å¿«é€Ÿæ·»åŠ æ–°ç½‘ç«™

### æ–¹æ³•1: Webç•Œé¢æ·»åŠ ï¼ˆæ¨èï¼‰

1. è¿›å…¥ **OpenClash â†’ è§„åˆ™è®¾ç½® â†’ è‡ªå®šä¹‰è§„åˆ™**
2. åœ¨é¡¶éƒ¨æ·»åŠ ä¸€è¡Œï¼š
   ```
   DOMAIN-SUFFIX,example.com,PROXY
   ```
3. ç‚¹å‡»"ä¿å­˜é…ç½®"
4. é‡å¯OpenClash

### æ–¹æ³•2: SSHå‘½ä»¤è¡Œæ·»åŠ 

```bash
# SSHç™»å½•OpenWrt
ssh root@192.168.71.254

# ç¼–è¾‘è‡ªå®šä¹‰è§„åˆ™æ–‡ä»¶
vi /etc/openclash/custom/openclash_custom_rules.list

# æ·»åŠ æ–°è§„åˆ™
DOMAIN-SUFFIX,newsite.com,PROXY

# é‡å¯OpenClash
/etc/init.d/openclash restart
```

### æ–¹æ³•3: åˆ›å»ºå¿«æ·æ·»åŠ è„šæœ¬

```bash
# åœ¨OpenWrtä¸Šåˆ›å»º
cat &gt; /usr/bin/add-proxy &lt;&lt;'EOF'
#!/bin/sh
DOMAIN=$1
if [ -z "$DOMAIN" ]; then
    echo "ç”¨æ³•: add-proxy example.com"
    exit 1
fi

echo "DOMAIN-SUFFIX,$DOMAIN,PROXY" &gt;&gt; /etc/openclash/custom/openclash_custom_rules.list
echo "å·²æ·»åŠ : $DOMAIN"
echo "é‡å¯OpenClashç”Ÿæ•ˆ: /etc/init.d/openclash restart"
EOF

chmod +x /usr/bin/add-proxy

# ä½¿ç”¨æ–¹æ³•
add-proxy gemini.google.com
/etc/init.d/openclash restart
```

---

## ğŸ“Š è§„åˆ™è¯­æ³•è¯´æ˜

### å¸¸ç”¨è§„åˆ™ç±»å‹

```yaml
# 1. åŸŸååç¼€åŒ¹é…ï¼ˆæ¨èï¼Œè¦†ç›–æ‰€æœ‰å­åŸŸåï¼‰
DOMAIN-SUFFIX,google.com,PROXY
# åŒ¹é…: google.com, www.google.com, mail.google.com

# 2. å®Œæ•´åŸŸååŒ¹é…ï¼ˆç²¾ç¡®ï¼‰
DOMAIN,www.google.com,PROXY
# åªåŒ¹é…: www.google.com

# 3. åŸŸåå…³é”®è¯åŒ¹é…
DOMAIN-KEYWORD,google,PROXY
# åŒ¹é…åŒ…å«googleçš„æ‰€æœ‰åŸŸå

# 4. IP-CIDRåŒ¹é…
IP-CIDR,8.8.8.8/32,PROXY
# åŒ¹é…ç‰¹å®šIP

# 5. åœ°ç†ä½ç½®åŒ¹é…
GEOIP,US,PROXY
# ç¾å›½IPèµ°ä»£ç†

GEOIP,CN,DIRECT
# ä¸­å›½IPç›´è¿
```

---

## ğŸ¨ æ¨èçš„å®Œæ•´é…ç½®æ¨¡æ¿

åˆ›å»ºæ–‡ä»¶ï¼š`/etc/openclash/custom_rules.yaml`

```yaml
# ==========================================
# OpenClash ç²¾å‡†åˆ†æµè§„åˆ™ - æµé‡èŠ‚çœç‰ˆ
# ==========================================

# ===== 1. è‡ªå®šä¹‰ä»£ç†è§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰=====

# AIå·¥å…·
- DOMAIN-SUFFIX,openai.com,PROXY
- DOMAIN-SUFFIX,anthropic.com,PROXY
- DOMAIN-SUFFIX,claude.ai,PROXY
- DOMAIN-KEYWORD,chatgpt,PROXY
- DOMAIN-KEYWORD,gemini,PROXY

# Googleå…¨å®¶æ¡¶
- DOMAIN-SUFFIX,google.com,PROXY
- DOMAIN-SUFFIX,google.com.hk,PROXY
- DOMAIN-SUFFIX,googleapis.com,PROXY
- DOMAIN-SUFFIX,googleusercontent.com,PROXY
- DOMAIN-SUFFIX,gstatic.com,PROXY
- DOMAIN-SUFFIX,gmail.com,PROXY
- DOMAIN-SUFFIX,googlevideo.com,PROXY

# YouTube
- DOMAIN-SUFFIX,youtube.com,PROXY
- DOMAIN-SUFFIX,ytimg.com,PROXY
- DOMAIN-SUFFIX,youtu.be,PROXY
- DOMAIN-KEYWORD,youtube,PROXY

# å¼€å‘å·¥å…·
- DOMAIN-SUFFIX,github.com,PROXY
- DOMAIN-SUFFIX,githubusercontent.com,PROXY
- DOMAIN-SUFFIX,github.io,PROXY
- DOMAIN-SUFFIX,stackoverflow.com,PROXY
- DOMAIN-SUFFIX,stackexchange.com,PROXY

# ç¤¾äº¤åª’ä½“ï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰
- DOMAIN-SUFFIX,twitter.com,PROXY
- DOMAIN-SUFFIX,x.com,PROXY
- DOMAIN-SUFFIX,t.co,PROXY
# - DOMAIN-SUFFIX,facebook.com,PROXY
# - DOMAIN-SUFFIX,instagram.com,PROXY

# å­¦æœ¯èµ„æº
- DOMAIN-SUFFIX,scholar.google.com,PROXY
- DOMAIN-SUFFIX,arxiv.org,PROXY
- DOMAIN-SUFFIX,researchgate.net,PROXY

# ===== 2. å›½å†…ç½‘ç«™ç›´è¿ =====
- DOMAIN-SUFFIX,baidu.com,DIRECT
- DOMAIN-SUFFIX,qq.com,DIRECT
- DOMAIN-SUFFIX,taobao.com,DIRECT
- DOMAIN-SUFFIX,tmall.com,DIRECT
- DOMAIN-SUFFIX,alipay.com,DIRECT
- DOMAIN-SUFFIX,aliyun.com,DIRECT
- DOMAIN-SUFFIX,jd.com,DIRECT
- DOMAIN-SUFFIX,bilibili.com,DIRECT
- DOMAIN-SUFFIX,zhihu.com,DIRECT
- DOMAIN-SUFFIX,douyin.com,DIRECT
- DOMAIN-SUFFIX,tencent.com,DIRECT
- DOMAIN-SUFFIX,163.com,DIRECT
- DOMAIN-SUFFIX,sina.com.cn,DIRECT

# ===== 3. å±€åŸŸç½‘ç›´è¿ =====
- IP-CIDR,192.168.0.0/16,DIRECT
- IP-CIDR,10.0.0.0/8,DIRECT
- IP-CIDR,172.16.0.0/12,DIRECT
- IP-CIDR,127.0.0.0/8,DIRECT

# ===== 4. ä¸­å›½IPç›´è¿ =====
- GEOIP,CN,DIRECT

# ===== 5. æœ€ç»ˆè§„åˆ™ï¼šå…¶ä»–å…¨éƒ¨ç›´è¿ =====
- MATCH,DIRECT
```

---

## ğŸ“± å®æ—¶æŸ¥çœ‹è§„åˆ™ç”Ÿæ•ˆ

### æ–¹æ³•1: OpenClashæ—¥å¿—

Webç•Œé¢ï¼š**OpenClash â†’ æ—¥å¿—**

å¯ä»¥çœ‹åˆ°æ¯ä¸ªè¿æ¥åŒ¹é…çš„è§„åˆ™ã€‚

### æ–¹æ³•2: å‘½ä»¤è¡ŒæŸ¥çœ‹

```bash
# æŸ¥çœ‹å½“å‰è¿æ¥
logread | grep openclash

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
logread -f | grep -E "PROXY|DIRECT"
```

---

## ğŸ§ª æµ‹è¯•é…ç½®

### æµ‹è¯•è„šæœ¬

```bash
# åœ¨ä»»æ„è®¾å¤‡ä¸Šæµ‹è¯•
# ç½‘å…³è®¾ç½®ä¸º 192.168.71.254

# æµ‹è¯•ä»£ç†ç½‘ç«™
curl -I https://www.google.com
curl -I https://www.youtube.com
curl -I https://claude.ai

# æµ‹è¯•ç›´è¿ç½‘ç«™
curl -I https://www.baidu.com
curl -I https://www.zhihu.com

# æŸ¥çœ‹å½“å‰IP
curl ipinfo.io
curl cip.cc
```

---

## ğŸ“ˆ æµé‡ç»Ÿè®¡

### æŸ¥çœ‹æµé‡ä½¿ç”¨

OpenClash Webç•Œé¢ï¼š**æµé‡ç»Ÿè®¡**

å¯ä»¥çœ‹åˆ°ï¼š
- æ€»æµé‡
- ä»£ç†æµé‡
- ç›´è¿æµé‡

---

## ğŸ’¡ é«˜çº§æŠ€å·§

### 1. æŒ‰æ—¶é—´æ®µæ§åˆ¶

åªåœ¨å·¥ä½œæ—¶é—´ä½¿ç”¨ä»£ç†ï¼š

```bash
# æ·»åŠ åˆ° cron
0 9 * * 1-5 /etc/init.d/openclash start
0 18 * * 1-5 /etc/init.d/openclash stop
```

### 2. åˆ›å»ºç½‘ç«™åˆ†ç±»

```yaml
# æ–‡ä»¶: /etc/openclash/rules/ai-services.list
DOMAIN-SUFFIX,openai.com,PROXY
DOMAIN-SUFFIX,anthropic.com,PROXY
DOMAIN-SUFFIX,claude.ai,PROXY

# æ–‡ä»¶: /etc/openclash/rules/google-services.list
DOMAIN-SUFFIX,google.com,PROXY
DOMAIN-SUFFIX,googleapis.com,PROXY
```

### 3. ç™½åå•æ¨¡å¼ï¼ˆæ›´èŠ‚çœæµé‡ï¼‰

å¦‚æœæ‚¨åªæƒ³ä»£ç†æå°‘æ•°ç½‘ç«™ï¼š

```yaml
# åªä»£ç†ä»¥ä¸‹ç½‘ç«™ï¼Œå…¶ä»–å…¨éƒ¨ç›´è¿
- DOMAIN-SUFFIX,google.com,PROXY
- DOMAIN-SUFFIX,youtube.com,PROXY
- DOMAIN-SUFFIX,claude.ai,PROXY
- DOMAIN-SUFFIX,openai.com,PROXY

# å…¶ä»–å…¨éƒ¨ç›´è¿
- MATCH,DIRECT
```

---

## ğŸ”„ å¸¸ç”¨ç½‘ç«™è§„åˆ™åº“

### AIå·¥å…·

```yaml
- DOMAIN-SUFFIX,openai.com,PROXY
- DOMAIN-SUFFIX,anthropic.com,PROXY
- DOMAIN-SUFFIX,claude.ai,PROXY
- DOMAIN-SUFFIX,perplexity.ai,PROXY
- DOMAIN-SUFFIX,midjourney.com,PROXY
- DOMAIN-SUFFIX,bard.google.com,PROXY
- DOMAIN-SUFFIX,gemini.google.com,PROXY
- DOMAIN-SUFFIX,poe.com,PROXY
- DOMAIN-SUFFIX,huggingface.co,PROXY
```

### å¼€å‘å·¥å…·

```yaml
- DOMAIN-SUFFIX,github.com,PROXY
- DOMAIN-SUFFIX,githubusercontent.com,PROXY
- DOMAIN-SUFFIX,npmjs.com,PROXY
- DOMAIN-SUFFIX,pypi.org,PROXY
- DOMAIN-SUFFIX,docker.com,PROXY
- DOMAIN-SUFFIX,docker.io,PROXY
```

### å­¦ä¹ èµ„æº

```yaml
- DOMAIN-SUFFIX,coursera.org,PROXY
- DOMAIN-SUFFIX,udemy.com,PROXY
- DOMAIN-SUFFIX,edx.org,PROXY
- DOMAIN-SUFFIX,khanacademy.org,PROXY
```

---

## âœ… å®Œæˆ

ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… **ç²¾ç¡®æ§åˆ¶** - åªæœ‰æŒ‡å®šç½‘ç«™èµ°ä»£ç†
2. âœ… **èŠ‚çœæµé‡** - å…¶ä»–å…¨éƒ¨ç›´è¿
3. âœ… **æ˜“äºæ·»åŠ ** - Webç•Œé¢æˆ–å‘½ä»¤è¡Œå¿«é€Ÿæ·»åŠ 
4. âœ… **å®æ—¶ç”Ÿæ•ˆ** - è§„åˆ™ç«‹å³ç”Ÿæ•ˆ

**æ¨èå·¥ä½œæµç¨‹**ï¼š

```
1. ä½¿ç”¨ä¸Šé¢çš„æ¨¡æ¿é…ç½®åŸºç¡€è§„åˆ™
2. æ—¥å¸¸ä½¿ç”¨ä¸­é‡åˆ°éœ€è¦ä»£ç†çš„ç½‘ç«™
3. é€šè¿‡ add-proxy å‘½ä»¤å¿«é€Ÿæ·»åŠ 
4. é‡å¯OpenClashç”Ÿæ•ˆ
```

è¿™æ ·æ—¢èŠ‚çœæµé‡ï¼Œåˆèƒ½ç²¾ç¡®æ§åˆ¶ï¼ğŸ¯




---



# 10 - V2Rayæ—è·¯ç”±é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

ä½¿ç”¨Rocky Linux 9 + V2Ray/Xrayå®ç°é«˜æ€§èƒ½é€æ˜ä»£ç†ã€‚

**é¢„è®¡è€—æ—¶**: 60åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­â˜†

---

## ğŸš€ æ­¥éª¤1: åˆ›å»ºè™šæ‹Ÿæœº

```bash
# ä½¿ç”¨Rocky Linux 9 ISOï¼ˆå‚è€ƒ11-vm-nas.mdæ­¥éª¤1ï¼‰
create-vm router 2 2 20 qcow2 \
  /kvm/iso/Rocky-9.3-x86_64-minimal.iso \
  192.168.71.254
```

å®‰è£…æ—¶ç½‘ç»œé…ç½®ä¸º192.168.71.254/24ã€‚

---

## ğŸ”§ æ­¥éª¤2: å®‰è£…Xray

```bash
ssh root@192.168.71.254

# å®‰è£…Xrayï¼ˆæ¯”V2Rayæ›´é«˜æ•ˆï¼‰
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
```

---

## âš™ï¸ æ­¥éª¤3: è½¬æ¢Clashè®¢é˜…

### 3.1 ä½¿ç”¨è®¢é˜…è½¬æ¢æœåŠ¡

è®¿é—®: https://sub-web.netlify.app/

- è¾“å…¥ä½ çš„Clashè®¢é˜…é“¾æ¥
- å®¢æˆ·ç«¯é€‰æ‹©: V2Ray
- åç«¯åœ°å€: https://api.dler.io/sub
- ç‚¹å‡»ç”Ÿæˆè®¢é˜…é“¾æ¥

### 3.2 ä¸‹è½½é…ç½®

```bash
curl -o /usr/local/etc/xray/config.json \
    "è½¬æ¢åçš„è®¢é˜…é“¾æ¥"

# æˆ–æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶
vi /usr/local/etc/xray/config.json
```

---

## ğŸŒ æ­¥éª¤4: é…ç½®é€æ˜ä»£ç†

```bash
# å®‰è£…iptables
dnf install -y iptables-services

# åˆ›å»ºé€æ˜ä»£ç†è„šæœ¬
cat &gt; /usr/local/bin/setup-tproxy.sh &lt;&lt;'EOF'
#!/bin/bash

# æ¸…ç©ºè§„åˆ™
iptables -t nat -F
iptables -t mangle -F

# æœ¬åœ°æµé‡ç›´è¿
iptables -t nat -A PREROUTING -s 192.168.71.0/24 -d 192.168.71.0/24 -j RETURN

# é€æ˜ä»£ç†
iptables -t nat -A PREROUTING -s 192.168.71.0/24 -p tcp -j REDIRECT --to-ports 12345

# å¯ç”¨IPè½¬å‘
echo 1 &gt; /proc/sys/net/ipv4/ip_forward

echo "é€æ˜ä»£ç†å·²é…ç½®"
EOF

chmod +x /usr/local/bin/setup-tproxy.sh
```

---

## ğŸš€ æ­¥éª¤5: å¯åŠ¨æœåŠ¡

```bash
# é…ç½®Xrayé…ç½®æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
cat &gt; /usr/local/etc/xray/config.json &lt;&lt;'EOF'
{
  "inbounds": [{
    "port": 12345,
    "protocol": "dokodemo-door",
    "settings": {
      "network": "tcp,udp",
      "followRedirect": true
    },
    "streamSettings": {
      "sockopt": {
        "tproxy": "redirect"
      }
    }
  }],
  "outbounds": [{
    "protocol": "vmess",
    "settings": {
      "vnext": [{
        "address": "ä½ çš„æœåŠ¡å™¨åœ°å€",
        "port": 443,
        "users": [{
          "id": "ä½ çš„UUID",
          "alterId": 0
        }]
      }]
    }
  }]
}
EOF

# å¯åŠ¨æœåŠ¡
systemctl enable --now xray
systemctl status xray

# é…ç½®é€æ˜ä»£ç†
/usr/local/bin/setup-tproxy.sh

# å¼€æœºè‡ªåŠ¨é…ç½®
echo "/usr/local/bin/setup-tproxy.sh" &gt;&gt; /etc/rc.local
chmod +x /etc/rc.local
```

---

## âœ… éªŒè¯

```bash
# æµ‹è¯•ä»£ç†
curl -x socks5://127.0.0.1:1080 https://www.google.com

# åœ¨å®¢æˆ·ç«¯æµ‹è¯•
# è®¾ç½®ç½‘å…³ä¸º192.168.71.254
curl https://www.google.com
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. V2Ray/Xrayé…ç½®è¾ƒå¤æ‚ï¼Œå»ºè®®å…ˆå­¦ä¹ åŸºç¡€
2. è®¢é˜…è½¬æ¢å¯èƒ½ä¸å®Œå…¨å‡†ç¡®ï¼Œéœ€æ‰‹åŠ¨è°ƒæ•´
3. æ€§èƒ½ä¼˜äºOpenWrtï¼Œä½†é…ç½®éš¾åº¦æ›´é«˜
4. é€‚åˆæœ‰Linuxç»éªŒçš„ç”¨æˆ·

**æ¨èæ–°æ‰‹å…ˆä½¿ç”¨09æ–‡æ¡£çš„OpenWrtæ–¹æ¡ˆ**

---

## ğŸ¯ åç»­ä¼˜åŒ–

- é…ç½®åˆ†æµè§„åˆ™ï¼ˆå›½å†…ç›´è¿ï¼‰
- å¯ç”¨DNSæ±¡æŸ“é˜²æŠ¤
- é…ç½®æµé‡ç»Ÿè®¡

ğŸ‘‰ **[11-vm-nas.md](#section-11)**




---



# 11 - NASæ–‡ä»¶å…±äº«æœåŠ¡å™¨é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

é…ç½®Rocky Linux 9 NASè™šæ‹Ÿæœºï¼Œæä¾›SMB/NFSæ–‡ä»¶å…±äº«æœåŠ¡ã€‚

**é¢„è®¡è€—æ—¶**: 70åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­â˜†

---

## ğŸ¤” Samba vs NFS - æˆ‘éœ€è¦é…ç½®å“ªä¸ªï¼Ÿ

### å¿«é€Ÿé€‰æ‹©æŒ‡å—

**åªé…ç½®Sambaï¼Œå¦‚æœä½ ï¼š**
- âœ… ä¸»è¦ç”¨Windows/Mac/æ‰‹æœºè®¿é—®
- âœ… æ—¥å¸¸æ–‡ä»¶ç®¡ç†å’Œåª’ä½“æ’­æ”¾
- âœ… ä¸éœ€è¦Linuxè™šæ‹Ÿæœºé«˜æ€§èƒ½è®¿é—®

**åŒæ—¶é…ç½®Samba + NFSï¼Œå¦‚æœä½ ï¼š**
- âœ… éœ€è¦Linuxè™šæ‹Ÿæœºè®¿é—®ï¼ˆå¦‚Pythonå¼€å‘VMï¼‰
- âœ… éœ€è¦é«˜æ€§èƒ½å¤§æ–‡ä»¶ä¼ è¾“
- âœ… ç¼–è¯‘é¡¹ç›®éœ€è¦å¿«é€ŸIO

### ä¸¤è€…å¯¹æ¯”

| ç‰¹æ€§ | Samba (SMB) | NFS |
|------|------------|-----|
| **Windows** | âœ… å®Œç¾æ”¯æŒ | âŒ éœ€ç¬¬ä¸‰æ–¹å·¥å…· |
| **Mac** | âœ… åŸç”Ÿæ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒï¼ˆæ€§èƒ½æ›´å¥½ï¼‰ |
| **iOS/Android** | âœ… Appæ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **Linux** | âœ… æ”¯æŒ | âœ… åŸç”Ÿï¼ˆæ€§èƒ½æœ€ä½³ï¼‰ |
| **æ€§èƒ½** | â­â­â­â˜†â˜† | â­â­â­â­â­ |
| **é…ç½®éš¾åº¦** | â­â­â˜†â˜†â˜† | â­â­â­â˜†â˜† |

### æ¨èé…ç½®

```
æœ€å°é…ç½®ï¼ˆæ¨èæ–°æ‰‹ï¼‰:
  â””â”€ ä»…é…ç½® Samba
     â”œâ”€ æ­¥éª¤5: Sambaé…ç½® âœ…
     â””â”€ æ­¥éª¤6: NFSé…ç½® â­ï¸ è·³è¿‡

å®Œæ•´é…ç½®ï¼ˆæ¨èæœ‰Linux VMçš„ç”¨æˆ·ï¼‰:
  â””â”€ é…ç½® Samba + NFS
     â”œâ”€ æ­¥éª¤5: Sambaé…ç½® âœ…
     â””â”€ æ­¥éª¤6: NFSé…ç½® âœ…
```

---

## ğŸš€ æ­¥éª¤1: åˆ›å»ºNASè™šæ‹Ÿæœº

### 1.1 ä¸‹è½½Rocky Linux ISO

```bash
cd /kvm/iso
wget https://mirrors.aliyun.com/rockylinux/9/isos/x86_64/Rocky-9.3-x86_64-minimal.iso
virsh pool-refresh iso_pool
```

### 1.2 åˆ›å»ºè™šæ‹Ÿæœº

```bash
# åˆ›å»º30GBç³»ç»Ÿç›˜ï¼ˆrawæ ¼å¼ï¼Œæ€§èƒ½ä¼˜å…ˆï¼‰
lvcreate -V 30G --thinpool kvm_thin_pool -n nas vg_kvm

# åˆ›å»ºè™šæ‹Ÿæœº
virt-install \
    --name nas \
    --ram 4096 \
    --vcpus 2 \
    --disk path=/dev/vg_kvm/nas,format=raw,bus=virtio \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0 \
    --cdrom /kvm/iso/Rocky-9.3-x86_64-minimal.iso \
    --os-variant rhel9.0 \
    --noautoconsole

# æŸ¥çœ‹VNCç«¯å£
virsh vncdisplay nas
```

---

## âš™ï¸ æ­¥éª¤2: å®‰è£…Rocky Linux 9

é€šè¿‡VNCè¿æ¥å®‰è£…ï¼š

1. **è¯­è¨€**: ç®€ä½“ä¸­æ–‡
2. **æ—¶åŒº**: äºšæ´²/ä¸Šæµ·
3. **è½¯ä»¶é€‰æ‹©**: æœ€å°åŒ–å®‰è£…
4. **ç½‘ç»œé…ç½®**:
   - IP: 192.168.71.210
   - å­ç½‘æ©ç : 255.255.255.0
   - ç½‘å…³: 192.168.71.1
   - DNS: 192.168.71.1,223.5.5.5
5. **Rootå¯†ç **: è®¾ç½®å¼ºå¯†ç 
6. **åˆ›å»ºç”¨æˆ·**: nasadmin

å®‰è£…å®Œæˆåï¼š
```bash
# å¼¹å‡ºå…‰ç›˜
virsh change-media nas sda --eject

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh autostart nas

# é‡å¯
virsh reboot nas
```

---

## ğŸ”§ æ­¥éª¤3: ç³»ç»Ÿåˆå§‹åŒ–

SSHç™»å½•ï¼š
```bash
ssh root@192.168.71.210
```

### 3.1 é…ç½®é•œåƒæº

```bash
# å¤‡ä»½åŸå§‹é…ç½®
mkdir -p /etc/yum.repos.d/backup
mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/

# é…ç½®é˜¿é‡Œäº‘é•œåƒ
cat &gt; /etc/yum.repos.d/rocky-aliyun.repo &lt;&lt;'EOF'
[baseos]
name=Rocky Linux $releasever - BaseOS
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[appstream]
name=Rocky Linux $releasever - AppStream
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[extras]
name=Rocky Linux $releasever - Extras
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/extras/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9
EOF

# æ›´æ–°ç³»ç»Ÿ
dnf clean all
dnf makecache
dnf update -y
```

### 3.2 å®‰è£…åŸºç¡€å·¥å…·

```bash
dnf install -y \
    vim \
    wget \
    curl \
    htop \
    net-tools \
    bind-utils \
    tree
```

---

## ğŸ’¾ æ­¥éª¤4: æŒ‚è½½å®¿ä¸»æœºå…±äº«çš„NASæ•°æ®å·

### 4.1 åœ¨å®¿ä¸»æœºé…ç½®virtio-fs

åœ¨å®¿ä¸»æœºä¸Šæ“ä½œï¼š
```bash
ssh chris@192.168.71.200

# ç¡®è®¤NASæ•°æ®ç›®å½•å­˜åœ¨
ls -ld /data/nas

# ç¼–è¾‘NASè™šæ‹Ÿæœºé…ç½®
sudo virsh edit nas

# åœ¨&lt;devices&gt;èŠ‚ç‚¹å†…æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆåœ¨&lt;/devices&gt;å‰ï¼‰ï¼š
# &lt;filesystem type='mount' accessmode='passthrough'&gt;
#   &lt;driver type='virtiofs'/&gt;
#   &lt;source dir='/data/nas'/&gt;
#   &lt;target dir='nas_data'/&gt;
# &lt;/filesystem&gt;

# ä¿å­˜åé‡å¯è™šæ‹Ÿæœº
sudo virsh shutdown nas
sleep 5
sudo virsh start nas
```

### 4.2 åœ¨NASè™šæ‹ŸæœºæŒ‚è½½

å›åˆ°NASè™šæ‹Ÿæœºï¼š
```bash
ssh root@192.168.71.210

# åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /mnt/nas_data

# æŒ‚è½½virtio-fs
mount -t virtiofs nas_data /mnt/nas_data

# éªŒè¯
df -h /mnt/nas_data
ls -l /mnt/nas_data

# é…ç½®è‡ªåŠ¨æŒ‚è½½
echo "nas_data /mnt/nas_data virtiofs defaults 0 0" &gt;&gt; /etc/fstab

# éªŒè¯fstab
mount -a
```

---

## ğŸ“‚ æ­¥éª¤5: Sambaé…ç½®ï¼ˆWindows/Mac/iOSè®¿é—®ï¼‰

### 5.1 å®‰è£…Samba

```bash
dnf install -y samba samba-client

# å¯åŠ¨æœåŠ¡
systemctl enable --now smb nmb
```

### 5.2 é…ç½®Samba

```bash
# å¤‡ä»½åŸå§‹é…ç½®
cp /etc/samba/smb.conf /etc/samba/smb.conf.bak

# åˆ›å»ºæ–°é…ç½®
cat &gt; /etc/samba/smb.conf &lt;&lt;'EOF'
[global]
    workgroup = WORKGROUP
    server string = Home NAS Server
    netbios name = NAS
    security = user
    map to guest = bad user
    dns proxy = no
    # æ€§èƒ½ä¼˜åŒ–
    socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=524288 SO_SNDBUF=524288
    read raw = yes
    write raw = yes
    max xmit = 65535
    dead time = 15
    getwd cache = yes

[Public]
    comment = å…¬å…±æ–‡ä»¶å¤¹
    path = /mnt/nas_data/public
    browseable = yes
    writable = yes
    guest ok = yes
    create mask = 0777
    directory mask = 0777

[Private]
    comment = ç§äººæ–‡ä»¶å¤¹
    path = /mnt/nas_data/private
    browseable = yes
    writable = yes
    valid users = nasadmin
    create mask = 0770
    directory mask = 0770

[Media]
    comment = åª’ä½“æ–‡ä»¶
    path = /mnt/nas_data/media
    browseable = yes
    writable = yes
    guest ok = yes
    create mask = 0775
    directory mask = 0775
EOF

# åˆ›å»ºå…±äº«ç›®å½•
mkdir -p /mnt/nas_data/{public,private,media}
chmod 777 /mnt/nas_data/public
chmod 770 /mnt/nas_data/private
chmod 775 /mnt/nas_data/media

# åˆ›å»ºSambaç”¨æˆ·
smbpasswd -a nasadmin
# è¾“å…¥Sambaå¯†ç 

# æµ‹è¯•é…ç½®
testparm

# é‡å¯æœåŠ¡
systemctl restart smb nmb
```

### 5.3 é…ç½®é˜²ç«å¢™

```bash
firewall-cmd --permanent --add-service=samba
firewall-cmd --reload
```

---

## ğŸ§ æ­¥éª¤6: NFSé…ç½®ï¼ˆLinuxé«˜æ€§èƒ½è®¿é—®ï¼‰

### 6.1 å®‰è£…NFS

```bash
dnf install -y nfs-utils

# å¯åŠ¨æœåŠ¡
systemctl enable --now nfs-server
```

### 6.2 é…ç½®NFSå¯¼å‡º

```bash
# é…ç½®å¯¼å‡º
cat &gt; /etc/exports &lt;&lt;'EOF'
/mnt/nas_data/public  192.168.71.0/24(rw,sync,no_subtree_check,no_root_squash)
/mnt/nas_data/private 192.168.71.0/24(rw,sync,no_subtree_check,root_squash)
/mnt/nas_data/media   192.168.71.0/24(rw,sync,no_subtree_check,no_root_squash)
EOF

# ä½¿é…ç½®ç”Ÿæ•ˆ
exportfs -arv

# æŸ¥çœ‹å¯¼å‡º
exportfs -v
```

### 6.3 é…ç½®é˜²ç«å¢™

```bash
firewall-cmd --permanent --add-service=nfs
firewall-cmd --permanent --add-service=rpc-bind
firewall-cmd --permanent --add-service=mountd
firewall-cmd --reload
```

---

## ğŸŒ æ­¥éª¤7: å®¢æˆ·ç«¯è®¿é—®é…ç½®

### 7.1 Windowsè®¿é—®

```
1. æ‰“å¼€"æ­¤ç”µè„‘"
2. ç‚¹å‡»"æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨"
3. è¾“å…¥: \\192.168.71.210\Public
4. æˆ–è®¿é—®: \\192.168.71.210\Private
   ç”¨æˆ·å: nasadmin
   å¯†ç : &lt;Sambaå¯†ç &gt;
```

### 7.2 macOSè®¿é—®

```
1. Finder â†’ å‰å¾€ â†’ è¿æ¥æœåŠ¡å™¨ (Cmd+K)
2. è¾“å…¥: smb://192.168.71.210/Public
3. æˆ–: smb://nasadmin@192.168.71.210/Private
```

### 7.3 Linuxè®¿é—®ï¼ˆNFSï¼‰

```bash
# åœ¨å…¶ä»–Linuxæœºå™¨ä¸Š
sudo apt install -y nfs-common  # Ubuntu
# æˆ–
sudo dnf install -y nfs-utils   # Rocky/CentOS

# æŒ‚è½½NFS
sudo mkdir -p /mnt/nas_public
sudo mount -t nfs 192.168.71.210:/mnt/nas_data/public /mnt/nas_public

# è‡ªåŠ¨æŒ‚è½½
echo "192.168.71.210:/mnt/nas_data/public /mnt/nas_public nfs defaults 0 0" | sudo tee -a /etc/fstab
```

### 7.4 iOS/iPadOSè®¿é—®

```
ä½¿ç”¨"æ–‡ä»¶"åº”ç”¨:
1. æ‰“å¼€"æ–‡ä»¶"åº”ç”¨
2. ç‚¹å‡»å³ä¸Šè§’"â€¦" â†’ è¿æ¥æœåŠ¡å™¨
3. è¾“å…¥: smb://192.168.71.210
4. é€‰æ‹©å…±äº«æ–‡ä»¶å¤¹
```

---

## ğŸ”’ æ­¥éª¤8: å¤–ç½‘è®¿é—®æ–¹æ¡ˆ

### æ–¹æ¡ˆA: WireGuard VPNï¼ˆæ¨èï¼‰

åœ¨å®¿ä¸»æœºé…ç½®WireGuardï¼Œé€šè¿‡VPNè®¿é—®å®¶åº­ç½‘ç»œã€‚

### æ–¹æ¡ˆB: FRPåå‘ä»£ç†

ä½¿ç”¨é˜¿é‡Œäº‘ECSåšåå‘ä»£ç†ï¼š

```bash
# åœ¨é˜¿é‡Œäº‘ECSä¸Šå®‰è£…frps
wget https://github.com/fatedier/frp/releases/download/v0.52.0/frp_0.52.0_linux_amd64.tar.gz
tar -xzf frp_0.52.0_linux_amd64.tar.gz

# é…ç½®æœåŠ¡ç«¯
cat &gt; frps.ini &lt;&lt;'EOF'
[common]
bind_port = 7000
token = your_secret_token
EOF

# å¯åŠ¨
./frps -c frps.ini

# åœ¨å®¿ä¸»æœºå®‰è£…frpc
wget https://github.com/fatedier/frp/releases/download/v0.52.0/frp_0.52.0_linux_amd64.tar.gz
tar -xzf frp_0.52.0_linux_amd64.tar.gz

# é…ç½®å®¢æˆ·ç«¯
cat &gt; frpc.ini &lt;&lt;'EOF'
[common]
server_addr = &lt;é˜¿é‡Œäº‘ECSå…¬ç½‘IP&gt;
server_port = 7000
token = your_secret_token

[nas-smb]
type = tcp
local_ip = 192.168.71.210
local_port = 445
remote_port = 8445
EOF

# å¯åŠ¨
./frpc -c frpc.ini
```

---

## ğŸ“Š æ­¥éª¤9: ç›‘æ§å’Œç»´æŠ¤

### 9.1 ç£ç›˜ä½¿ç”¨ç›‘æ§

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
cat &gt; /usr/local/bin/nas-monitor &lt;&lt;'EOF'
#!/bin/bash
echo "=== NASå­˜å‚¨ç›‘æ§ ==="
df -h /mnt/nas_data
echo ""
echo "=== Sambaè¿æ¥ ==="
smbstatus -b
echo ""
echo "=== NFSè¿æ¥ ==="
showmount -a
EOF

chmod +x /usr/local/bin/nas-monitor
```

### 9.2 æ—¥å¿—æŸ¥çœ‹

```bash
# Sambaæ—¥å¿—
tail -f /var/log/samba/log.smbd

# NFSæ—¥å¿—
journalctl -u nfs-server -f
```

---

## âœ… éªŒè¯å’Œæµ‹è¯•

```bash
# åœ¨NASè™šæ‹Ÿæœºä¸Š
nas-monitor

# åœ¨Windowsä¸Š
net use \\192.168.71.210\Public

# åœ¨Linuxä¸Š
showmount -e 192.168.71.210
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

- [x] Rocky Linux 9å®‰è£…å®Œæˆ
- [x] virtio-fsæŒ‚è½½å®¿ä¸»æœºæ•°æ®å·
- [x] Sambaé…ç½®ï¼ˆWindows/Mac/iOSè®¿é—®ï¼‰
- [x] NFSé…ç½®ï¼ˆLinuxé«˜æ€§èƒ½è®¿é—®ï¼‰
- [x] é˜²ç«å¢™é…ç½®
- [x] å®¢æˆ·ç«¯è®¿é—®æµ‹è¯•
- [x] å¤–ç½‘è®¿é—®æ–¹æ¡ˆäº†è§£
- [x] ç›‘æ§è„šæœ¬é…ç½®

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### æ—¥å¸¸æ–‡ä»¶å…±äº«
```
Windowsç”µè„‘ â†’ \\192.168.71.210\Public
Macç”µè„‘ â†’ smb://192.168.71.210/Public
iPhone/iPad â†’ æ–‡ä»¶Appè¿æ¥æœåŠ¡å™¨
Linuxå¼€å‘æœº â†’ NFSæŒ‚è½½
```

### åª’ä½“å­˜å‚¨
```
å°†ç”µå½±ã€ç…§ç‰‡æ”¾å…¥Mediaå…±äº«
å„è®¾å¤‡å¯ç›´æ¥è®¿é—®å’Œæ’­æ”¾
```

ğŸ‘‰ **[12-backup-restore.md - å¤‡ä»½æ¢å¤](#section-12)**




---



# 12 - å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

## ğŸ“‹ å¤‡ä»½ç­–ç•¥

### ä¸‰å±‚å¤‡ä»½æ–¹æ¡ˆ

**å±‚æ¬¡1: è™šæ‹Ÿæœºé…ç½®å¤‡ä»½ï¼ˆæ¯å‘¨ï¼‰**
- è™šæ‹ŸæœºXMLå®šä¹‰
- å­˜å‚¨æ± é…ç½®
- ç½‘ç»œé…ç½®

**å±‚æ¬¡2: é‡è¦æ•°æ®å¤‡ä»½ï¼ˆæ¯å¤©ï¼‰**
- NASå…±äº«æ•°æ®
- æ•°æ®åº“
- åº”ç”¨é…ç½®æ–‡ä»¶

**å±‚æ¬¡3: å®Œæ•´é•œåƒå¤‡ä»½ï¼ˆæ¯æœˆï¼‰**
- è™šæ‹Ÿæœºç£ç›˜å¿«ç…§
- ç³»ç»Ÿå®Œæ•´é•œåƒ

---

## ğŸ”„ è‡ªåŠ¨å¤‡ä»½è„šæœ¬

### è™šæ‹Ÿæœºé…ç½®å¤‡ä»½

```bash
sudo cat &gt; /usr/local/bin/backup-vm-configs &lt;&lt;'EOF'
#!/bin/bash

BACKUP_DIR="/backup/vm-configs"
DATE=$(date +%Y%m%d)
BACKUP_PATH="$BACKUP_DIR/$DATE"

mkdir -p $BACKUP_PATH

# å¤‡ä»½è™šæ‹Ÿæœºå®šä¹‰
for vm in $(virsh list --all --name); do
    [ -n "$vm" ] &amp;&amp; virsh dumpxml $vm &gt; $BACKUP_PATH/${vm}.xml
done

# å¤‡ä»½å­˜å‚¨æ± é…ç½®
for pool in $(virsh pool-list --all --name); do
    [ -n "$pool" ] &amp;&amp; virsh pool-dumpxml $pool &gt; $BACKUP_PATH/pool-${pool}.xml
done

# å¤‡ä»½ç½‘ç»œé…ç½®
for net in $(virsh net-list --all --name); do
    [ -n "$net" ] &amp;&amp; virsh net-dumpxml $net &gt; $BACKUP_PATH/net-${net}.xml
done

# å¤‡ä»½LVMé…ç½®
vgcfgbackup -f $BACKUP_PATH/vg_kvm.cfg vg_kvm

# å‹ç¼©
tar -czf $BACKUP_DIR/vm-configs-${DATE}.tar.gz -C $BACKUP_DIR $DATE
rm -rf $BACKUP_PATH

# åªä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "vm-configs-*.tar.gz" -mtime +30 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR/vm-configs-${DATE}.tar.gz"
EOF

sudo chmod +x /usr/local/bin/backup-vm-configs
```

### NASæ•°æ®å¤‡ä»½

```bash
sudo cat &gt; /usr/local/bin/backup-nas-data &lt;&lt;'EOF'
#!/bin/bash

SOURCE="/data/nas"
BACKUP_DIR="/backup/nas-data"
DATE=$(date +%Y%m%d)

# ä½¿ç”¨rsyncå¢é‡å¤‡ä»½
rsync -av --delete \
    --exclude='*.tmp' \
    --exclude='.Trash' \
    $SOURCE/ $BACKUP_DIR/latest/

# åˆ›å»ºç¡¬é“¾æ¥å¿«ç…§ï¼ˆèŠ‚çœç©ºé—´ï¼‰
cp -al $BACKUP_DIR/latest $BACKUP_DIR/$DATE

echo "NASæ•°æ®å¤‡ä»½å®Œæˆ: $BACKUP_DIR/$DATE"
EOF

sudo chmod +x /usr/local/bin/backup-nas-data
```

### è™šæ‹Ÿæœºå¿«ç…§å¤‡ä»½

```bash
# ä¸ºè™šæ‹Ÿæœºåˆ›å»ºå¿«ç…§
sudo cat &gt; /usr/local/bin/vm-snapshot &lt;&lt;'EOF'
#!/bin/bash

VM_NAME=$1
SNAPSHOT_NAME="snap-$(date +%Y%m%d-%H%M%S)"

if [ -z "$VM_NAME" ]; then
    echo "ç”¨æ³•: vm-snapshot &lt;vm-name&gt;"
    exit 1
fi

virsh snapshot-create-as $VM_NAME $SNAPSHOT_NAME \
    --description "Auto snapshot $(date)"

echo "å¿«ç…§åˆ›å»ºæˆåŠŸ: $SNAPSHOT_NAME"
EOF

sudo chmod +x /usr/local/bin/vm-snapshot
```

---

## â° å®šæ—¶å¤‡ä»½

```bash
# é…ç½®crontab
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹å†…å®¹:

# æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹å¤‡ä»½VMé…ç½®
0 2 * * 0 /usr/local/bin/backup-vm-configs

# æ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½NASæ•°æ®
0 3 * * * /usr/local/bin/backup-nas-data

# æ¯æœˆ1å·å‡Œæ™¨4ç‚¹åˆ›å»ºVMå¿«ç…§
0 4 1 * * /usr/local/bin/vm-snapshot nas
0 4 1 * * /usr/local/bin/vm-snapshot web-app
```

---

## ğŸ”™ æ¢å¤æµç¨‹

### æ¢å¤è™šæ‹Ÿæœºé…ç½®

```bash
# è§£å‹å¤‡ä»½
cd /backup/vm-configs
tar -xzf vm-configs-20260224.tar.gz

# æ¢å¤è™šæ‹Ÿæœº
virsh define 20260224/nas.xml
virsh define 20260224/web-app.xml

# æ¢å¤å­˜å‚¨æ± 
virsh pool-define 20260224/pool-kvm_pool.xml
virsh pool-start kvm_pool
```

### æ¢å¤è™šæ‹Ÿæœºå¿«ç…§

```bash
# åˆ—å‡ºå¿«ç…§
virsh snapshot-list nas

# æ¢å¤å¿«ç…§
virsh snapshot-revert nas snap-20260224-020000

# åˆ é™¤æ—§å¿«ç…§
virsh snapshot-delete nas snap-20260101-020000
```

### æ¢å¤NASæ•°æ®

```bash
# ä»å¤‡ä»½æ¢å¤
rsync -av /backup/nas-data/20260224/ /data/nas/
```

---

## ğŸ’¾ ç¦»çº¿å¤‡ä»½å»ºè®®

### é‡è¦æ•°æ®å¤–éƒ¨å¤‡ä»½

```bash
# æ¯æœˆå¤‡ä»½åˆ°ç§»åŠ¨ç¡¬ç›˜
rsync -av --progress \
    /backup/vm-configs/ \
    /mnt/external-hdd/backup/vm-configs/

rsync -av --progress \
    /data/nas/important/ \
    /mnt/external-hdd/backup/nas-important/
```

---

## âœ… å¤‡ä»½éªŒè¯

```bash
# å®šæœŸéªŒè¯å¤‡ä»½å¯ç”¨æ€§
sudo cat &gt; /usr/local/bin/verify-backup &lt;&lt;'EOF'
#!/bin/bash

echo "=== å¤‡ä»½éªŒè¯ ==="
echo "VMé…ç½®å¤‡ä»½:"
ls -lh /backup/vm-configs/ | tail -5

echo ""
echo "NASæ•°æ®å¤‡ä»½:"
du -sh /backup/nas-data/latest

echo ""
echo "ç£ç›˜ç©ºé—´:"
df -h | grep backup
EOF

sudo chmod +x /usr/local/bin/verify-backup
```

---

## ğŸ“ å®Œæˆ

å¤‡ä»½ç­–ç•¥å·²é…ç½®å®Œæˆï¼

å»ºè®®æ¯æœˆè¿è¡Œä¸€æ¬¡æ¢å¤æµ‹è¯•ï¼Œç¡®ä¿å¤‡ä»½å¯ç”¨ã€‚




---



# 13 - ç³»ç»Ÿç»´æŠ¤æŒ‡å—

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æ­£ç¡®çš„å¼€å…³æœºæµç¨‹ã€æ—¥å¸¸ç»´æŠ¤å’Œæ•…éšœæ¢å¤ã€‚

---

## ğŸ”Œ æ­£ç¡®çš„å…³æœºæµç¨‹

### è®¡åˆ’æ€§å…³æœºï¼ˆæ¨èï¼‰

```bash
# 1. ä¼˜é›…å…³é—­æ‰€æœ‰è™šæ‹Ÿæœº
vm-manager stop-all

# ç­‰å¾…æ‰€æœ‰VMå…³é—­(çº¦1-2åˆ†é’Ÿ)
watch -n 2 'virsh list --all'

# 2. å…³é—­å®¿ä¸»æœº
sudo shutdown -h now
# æˆ–å®šæ—¶å…³æœº
sudo shutdown -h +10  # 10åˆ†é’Ÿåå…³æœº
```

### ç´§æ€¥å…³æœº

```bash
# å¼ºåˆ¶å…³é—­æ‰€æœ‰VM
for vm in $(virsh list --name); do
    virsh destroy $vm
done

# ç«‹å³å…³æœº
sudo poweroff
```

---

## ğŸ”„ å¼€æœºå’Œæ¢å¤æµç¨‹

### æ­£å¸¸å¼€æœº

1. **æŒ‰ä¸‹ç”µæºæŒ‰é’®**
2. **å®¿ä¸»æœºå¯åŠ¨** (çº¦30-60ç§’)
3. **è‡ªåŠ¨å¯åŠ¨é…ç½®çš„VM** (å·²è®¾ç½®autostartçš„è™šæ‹Ÿæœº)

### éªŒè¯ç³»ç»Ÿå¯åŠ¨

```bash
# SSHç™»å½•å®¿ä¸»æœº
ssh chris@192.168.71.200

# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
sysinfo

# æ£€æŸ¥è™šæ‹ŸæœºçŠ¶æ€
vm-manager status

# æ£€æŸ¥å­˜å‚¨
storage-monitor

# æ£€æŸ¥ç½‘ç»œ
ping -c 3 192.168.71.1
```

### æ‰‹åŠ¨å¯åŠ¨æœªè‡ªåŠ¨å¯åŠ¨çš„VM

```bash
# å¯åŠ¨å¼€å‘VM
vm-manager start python-dev

# æˆ–ä½¿ç”¨virsh
virsh start python-dev
```

---

## ğŸ”§ æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡

### æ¯å‘¨æ£€æŸ¥æ¸…å•

```bash
cat &gt; /root/weekly-check.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       æ¯å‘¨ç³»ç»Ÿæ£€æŸ¥"
echo "========================================="
date
echo ""

echo "1. ç³»ç»Ÿè´Ÿè½½å’Œå†…å­˜"
uptime
free -h
echo ""

echo "2. ç£ç›˜ä½¿ç”¨"
df -h | grep -E 'Filesystem|vg_kvm|/data'
echo ""

echo "3. Thin PoolçŠ¶æ€"
lvs -a vg_kvm | grep -E 'LV|thin'
echo ""

echo "4. è™šæ‹ŸæœºçŠ¶æ€"
virsh list --all
echo ""

echo "5. ç³»ç»Ÿæ›´æ–°æ£€æŸ¥"
dnf check-update | head -20
echo ""

echo "æ£€æŸ¥å®Œæˆ!"
EOF

chmod +x /root/weekly-check.sh
```

è¿è¡Œ: `sudo /root/weekly-check.sh`

### æ¯æœˆç»´æŠ¤ä»»åŠ¡

```bash
# 1. ç³»ç»Ÿæ›´æ–°
sudo dnf update -y

# 2. æ¸…ç†æ—§å†…æ ¸
sudo dnf remove $(dnf repoquery --installonly --latest-limit=-2 -q)

# 3. æ£€æŸ¥æ—¥å¿—å¤§å°
sudo journalctl --disk-usage
# å¦‚æœè¿‡å¤§ï¼Œæ¸…ç†
sudo journalctl --vacuum-time=30d

# 4. æ£€æŸ¥å¤±è´¥çš„æœåŠ¡
systemctl --failed

# 5. å¤‡ä»½é‡è¦VMé…ç½®
for vm in $(virsh list --name --all); do
    virsh dumpxml $vm &gt; /backup/vms/${vm}.xml
done
```

---

## ğŸ“… è‡ªåŠ¨åŒ–ç»´æŠ¤è„šæœ¬

### åˆ›å»ºè‡ªåŠ¨ç»´æŠ¤è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/auto-maintain &lt;&lt;'EOF'
#!/bin/bash

LOG_FILE="/var/log/auto-maintain.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

log "å¼€å§‹è‡ªåŠ¨ç»´æŠ¤"

# æ¸…ç†æ—§æ—¥å¿—
log "æ¸…ç†ç³»ç»Ÿæ—¥å¿—..."
journalctl --vacuum-time=30d &gt;&gt; $LOG_FILE 2&gt;&amp;1

# æ¸…ç†åŒ…ç¼“å­˜
log "æ¸…ç†åŒ…ç¼“å­˜..."
dnf clean all &gt;&gt; $LOG_FILE 2&gt;&amp;1

# æ£€æŸ¥å¹¶è®°å½•ç£ç›˜ä½¿ç”¨
log "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
df -h | grep -E 'Filesystem|vg_kvm|/data' | tee -a $LOG_FILE

# æ£€æŸ¥thin pool
log "Thin poolçŠ¶æ€:"
lvs -a vg_kvm | grep thin | tee -a $LOG_FILE

log "ç»´æŠ¤å®Œæˆ"
echo ""
EOF

sudo chmod +x /usr/local/bin/auto-maintain
```

### é…ç½®å®šæ—¶ä»»åŠ¡

```bash
# ç¼–è¾‘crontab
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹å†…å®¹:
# æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œç»´æŠ¤
0 3 * * 0 /usr/local/bin/auto-maintain

# æ¯å¤©æ£€æŸ¥å¤‡ä»½
0 2 * * * /usr/local/bin/vm-backup nas
```

---

## ğŸš¨ æ•…éšœæ¢å¤

### è™šæ‹Ÿæœºå¯åŠ¨å¤±è´¥

```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
virsh start &lt;vm-name&gt;
tail -50 /var/log/libvirt/qemu/&lt;vm-name&gt;.log

# 2. å¸¸è§åŸå› 
# - ç£ç›˜è·¯å¾„ä¸å­˜åœ¨
# - å­˜å‚¨æ± æœªå¯åŠ¨
# - ç½‘ç»œé…ç½®é”™è¯¯

# 3. ä¿®å¤å­˜å‚¨æ± 
virsh pool-start kvm_pool

# 4. æ£€æŸ¥ç£ç›˜
virsh domblklist &lt;vm-name&gt;
ls -l /dev/vg_kvm/
```

### ç½‘æ¡¥ç½‘ç»œæ•…éšœ

```bash
# 1. æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
ip addr show br0
nmcli connection show br0

# 2. é‡å¯ç½‘æ¡¥
sudo nmcli connection down br0
sudo nmcli connection up br0-slave
sudo nmcli connection up br0

# 3. é‡å¯ç½‘ç»œæœåŠ¡
sudo systemctl restart NetworkManager
```

### å­˜å‚¨ç©ºé—´æ»¡

```bash
# 1. æ£€æŸ¥ä½¿ç”¨æƒ…å†µ
lvs -a vg_kvm
df -h

# 2. æ‰©å±•thin pool
sudo lvextend -L +100G vg_kvm/kvm_thin_pool

# 3. æ¸…ç†è™šæ‹Ÿæœºå¿«ç…§
virsh snapshot-list &lt;vm-name&gt;
virsh snapshot-delete &lt;vm-name&gt; &lt;snapshot-name&gt;

# 4. åœ¨VMå†…æ‰§è¡Œfstrimé‡Šæ”¾ç©ºé—´
# (åœ¨è™šæ‹Ÿæœºå†…è¿è¡Œ)
sudo fstrim -av
```

---

## ğŸ’¾ å¤‡ä»½ç­–ç•¥

### é‡è¦é…ç½®å¤‡ä»½

```bash
sudo cat &gt; /usr/local/bin/backup-config &lt;&lt;'EOF'
#!/bin/bash

BACKUP_DIR="/backup/config/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# å¤‡ä»½ç½‘ç»œé…ç½®
cp -r /etc/NetworkManager/system-connections/ $BACKUP_DIR/

# å¤‡ä»½LVMé…ç½®
vgcfgbackup -f $BACKUP_DIR/vg_kvm.cfg vg_kvm

# å¤‡ä»½è™šæ‹Ÿæœºå®šä¹‰
for vm in $(virsh list --name --all); do
    virsh dumpxml $vm &gt; $BACKUP_DIR/${vm}.xml
done

# å¤‡ä»½å­˜å‚¨æ± å®šä¹‰
for pool in $(virsh pool-list --name --all); do
    virsh pool-dumpxml $pool &gt; $BACKUP_DIR/pool-${pool}.xml
done

# å¤‡ä»½è‡ªå®šä¹‰è„šæœ¬
cp -r /usr/local/bin/ $BACKUP_DIR/scripts/

echo "é…ç½®å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
tar -czf /backup/config-$(date +%Y%m%d).tar.gz -C /backup/config $(date +%Y%m%d)
EOF

sudo chmod +x /usr/local/bin/backup-config
```

---

## ğŸ” å¥åº·æ£€æŸ¥è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/health-check &lt;&lt;'EOF'
#!/bin/bash

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

check() {
    if $1 &amp;&gt;/dev/null; then
        echo -e "${GREEN}âœ“${NC} $2"
        return 0
    else
        echo -e "${RED}âœ—${NC} $2"
        return 1
    fi
}

echo "ç³»ç»Ÿå¥åº·æ£€æŸ¥"
echo "======================="

check "systemctl is-active libvirtd" "libvirtdæœåŠ¡"
check "systemctl is-active firewalld" "é˜²ç«å¢™æœåŠ¡"
check "systemctl is-active chronyd" "æ—¶é—´åŒæ­¥"
check "ping -c 1 192.168.71.1" "ç½‘å…³è¿é€šæ€§"
check "virsh pool-info kvm_pool" "KVMå­˜å‚¨æ± "
check "[ $(df /data/nas | tail -1 | awk '{print $5}' | sed 's/%//') -lt 90 ]" "NASå­˜å‚¨ç©ºé—´"

echo ""
echo "è™šæ‹ŸæœºçŠ¶æ€:"
virsh list --all

echo ""
echo "è´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"
free -h | grep Mem
EOF

sudo chmod +x /usr/local/bin/health-check
```

---

## ğŸ“ å®Œæˆ

ç³»ç»Ÿç»´æŠ¤æŒ‡å—å·²å‡†å¤‡å°±ç»ªï¼

**æ—¥å¸¸ä½¿ç”¨**:
- å®šæœŸè¿è¡Œ `health-check`
- æ¯å‘¨æŸ¥çœ‹ `weekly-check.sh`
- é‡è¦æ“ä½œå‰è¿è¡Œ `backup-config`

**ç´§æ€¥æƒ…å†µ**:
- å‚è€ƒæ•…éšœæ¢å¤ç« èŠ‚
- æŸ¥çœ‹ [14-troubleshooting.md](#section-14)

ğŸ‘‰ **ç›¸å…³æ–‡æ¡£: [12-backup-restore.md](#section-12)**




---



# 14 - å¸¸è§é—®é¢˜æ’æŸ¥

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

è§£ç­”æ‚¨åœ¨kickoff.mdä¸­æå‡ºçš„é›¶ç¢é—®é¢˜å’Œå¸¸è§æ•…éšœæ’æŸ¥ã€‚

---

## â“ é—®é¢˜1: å†…å­˜æ˜¾ç¤º27Gè€Œä¸æ˜¯32Gçš„åŸå› 

### åˆ†æ

æ‚¨è´­ä¹°äº†32GBå†…å­˜(16GBÃ—2)ï¼Œä½†ç³»ç»Ÿæ˜¾ç¤ºçº¦27GBå¯ç”¨ã€‚å°‘äº†çº¦5GBçš„åŸå› ï¼š

### å¯èƒ½åŸå› 

#### 1. é›†æˆæ˜¾å¡æ˜¾å­˜å ç”¨ (æœ€å¯èƒ½)

AMD R5 5600Gæ˜¯APU(é›†æˆæ˜¾å¡)ï¼Œä¼šä»ç³»ç»Ÿå†…å­˜ä¸­åˆ†é…æ˜¾å­˜ã€‚

```bash
# æŸ¥çœ‹å®é™…æƒ…å†µ
sudo dmidecode -t memory | grep -i size
free -h
```

**å…¸å‹é…ç½®**:
- BIOSé»˜è®¤ç»™é›†æ˜¾åˆ†é…2-4GB
- å¯åœ¨BIOSä¸­è°ƒæ•´UMA (Unified Memory Architecture) Frame Buffer Size

**è§£å†³æ–¹æ¡ˆ**:
```
è¿›å…¥BIOS â†’ Advanced â†’ UMA Frame Buffer Size
é€‰é¡¹: Auto / 512M / 1G / 2G / 4Gç­‰

å»ºè®®:
- å¦‚æœä¸ç”¨æ˜¾ç¤ºè¾“å‡º: è®¾ç½®ä¸º512Mæˆ–æœ€å°å€¼
- å¦‚æœéœ€è¦å¶å°”è°ƒè¯•: ä¿æŒ1-2G
```

#### 2. ç¡¬ä»¶é¢„ç•™å†…å­˜

```bash
# æŸ¥çœ‹å†…å­˜è¯¦æƒ…
cat /proc/meminfo | grep -i mem
```

éƒ¨åˆ†å†…å­˜è¢«ç¡¬ä»¶/å†…æ ¸é¢„ç•™ç”¨äº:
- DMAç¼“å†²åŒº
- å†…æ ¸ä»£ç å’Œæ•°æ®
- ç¡¬ä»¶æ˜ å°„åŒºåŸŸ

è¿™éƒ¨åˆ†é€šå¸¸å ç”¨å‡ ç™¾MBï¼Œæ˜¯æ­£å¸¸çš„ã€‚

#### 3. å†…å­˜ç¡®è®¤

```bash
# éªŒè¯ç‰©ç†å†…å­˜
sudo dmidecode -t 17 | grep -i size

# åº”è¯¥æ˜¾ç¤ºä¸¤æ¡16GBå†…å­˜
```

### æ€»ç»“

**27GBå¯ç”¨å†…å­˜æ˜¯æ­£å¸¸çš„**:
- çº¦4-5GBç»™äº†é›†æˆæ˜¾å¡
- çº¦500MBè¢«å†…æ ¸é¢„ç•™
- å®é™…å¯ç”¨çº¦27-28GB

**å¦‚æœéœ€è¦æ›´å¤šå†…å­˜**:
1. è¿›BIOSè°ƒä½æ˜¾å­˜åˆ†é…
2. é‡å¯åéªŒè¯: `free -h`

---

## ğŸ–¥ï¸ é—®é¢˜2: æ— å¤´æ¨¡å¼ä¸‹è¿œç¨‹BIOSè®¿é—®æ–¹æ¡ˆ

### èƒŒæ™¯

æ‚¨çš„æœåŠ¡å™¨æ²¡æœ‰æ¥æ˜¾ç¤ºå™¨é”®ç›˜(æ— å¤´æ¨¡å¼)ï¼Œéœ€è¦è°ƒè¯•æ—¶æ¬è®¾å¤‡å¾ˆéº»çƒ¦ã€‚

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æˆæœ¬ | éš¾åº¦ | åŠŸèƒ½ |
|------|------|------|------|
| IPMI | $$$ | â­â­â­ | å®Œæ•´(æœ€ä½³) |
| PiKVM | $$ | â­â­â­â­ | å®Œæ•´ |
| è½¯ä»¶KVM | $ | â­â­ | ç³»ç»Ÿå¯åŠ¨å |
| GRUBä¸²å£ | $0 | â­â­â­ | æœ‰é™ |

### æ¨èæ–¹æ¡ˆ1: IPMI (å¦‚æœä¸»æ¿æ”¯æŒ)

MSI B550M PRO-VDH **ä¸æ”¯æŒIPMI**ï¼Œæ­¤æ–¹æ¡ˆä¸é€‚ç”¨ã€‚

### æ¨èæ–¹æ¡ˆ2: PiKVM (æœ€å®ç”¨)

ä½¿ç”¨æ ‘è“æ´¾Zero 2Wåˆ¶ä½œKVM over IPè®¾å¤‡ã€‚

**æ‰€éœ€ç¡¬ä»¶**:
- æ ‘è“æ´¾ Zero 2W (çº¦150å…ƒ)
- HDMI é‡‡é›†å¡ (çº¦50å…ƒ)
- USB OTGçº¿ (çº¦20å…ƒ)
- Micro SDå¡ (çº¦30å…ƒ)

**æ€»æˆæœ¬**: çº¦250å…ƒ

**ä¼˜ç‚¹**:
- å®Œå…¨è¿œç¨‹æ§åˆ¶BIOS
- è™šæ‹Ÿé”®é¼ 
- è¿œç¨‹å¼€æœº/å…³æœº
- ISOæŒ‚è½½

**ç¼ºç‚¹**:
- éœ€è¦é¢å¤–ç¡¬ä»¶
- éœ€è¦æœåŠ¡å™¨æœ‰HDMIè¾“å‡º

### æ¨èæ–¹æ¡ˆ3: GRUBä¸²å£é‡å®šå‘ (é›¶æˆæœ¬ä¸´æ—¶æ–¹æ¡ˆ)

é€šè¿‡SSHè®¿é—®GRUBèœå•(ä½†æ— æ³•è®¿é—®BIOS)ã€‚

```bash
# åœ¨å®¿ä¸»æœºé…ç½®
sudo vim /etc/default/grub

# æ·»åŠ 
GRUB_TERMINAL="console serial"
GRUB_SERIAL_COMMAND="serial --speed=115200"
GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200n8"

# æ›´æ–°GRUB
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

**é™åˆ¶**: åªèƒ½è®¿é—®GRUBï¼Œæ— æ³•è®¿é—®BIOSã€‚

### å®é™…å»ºè®®

**çŸ­æœŸæ–¹æ¡ˆ**:
- ä¿æŒç°çŠ¶ï¼Œéœ€è¦è¿›BIOSæ—¶æ¬è®¾å¤‡(ä¸€å¹´1-2æ¬¡)
- é€šè¿‡Cockpit Webç®¡ç†æ—¥å¸¸æ“ä½œ

**é•¿æœŸæ–¹æ¡ˆ**:
- å¦‚æœç»å¸¸éœ€è¦è°ƒè¯•: è´­ä¹°PiKVMå¥—ä»¶(250å…ƒ)
- æˆ–è´­ä¹°æ”¯æŒIPMIçš„æœåŠ¡å™¨çº§ä¸»æ¿(ä¸‹æ¬¡å‡çº§)

**æˆ‘çš„å»ºè®®**:
å®¶ç”¨æœåŠ¡å™¨å¾ˆå°‘éœ€è¦è¿›BIOSï¼Œä¿æŒç°çŠ¶å³å¯ã€‚å¦‚æœåç»­å‘ç°é¢‘ç¹éœ€è¦ï¼Œå†è€ƒè™‘PiKVMã€‚

---

## ğŸ”§ å¸¸è§æŠ€æœ¯é—®é¢˜æ’æŸ¥

### é—®é¢˜: SSHè¿æ¥æ…¢

```bash
# ç—‡çŠ¶: sshè¿æ¥éœ€è¦10-20ç§’
# åŸå› : DNSåå‘è§£æ

# è§£å†³:
sudo vim /etc/ssh/sshd_config
# æ·»åŠ :
UseDNS no

sudo systemctl restart sshd
```

### é—®é¢˜: è™šæ‹Ÿæœºæ— æ³•è”ç½‘

```bash
# 1. æ£€æŸ¥ç½‘æ¡¥
ip addr show br0
bridge link show

# 2. æ£€æŸ¥è™šæ‹Ÿæœºç½‘ç»œ
virsh domiflist &lt;vm-name&gt;

# 3. åœ¨è™šæ‹Ÿæœºå†…æ£€æŸ¥
ip addr
ip route
ping 192.168.71.1
```

### é—®é¢˜: å­˜å‚¨ç©ºé—´ä¸è¶³

```bash
# æ£€æŸ¥thin poolä½¿ç”¨ç‡
lvs -a vg_kvm

# å¦‚æœè¶…è¿‡80%
lvextend -L +100G vg_kvm/kvm_thin_pool
```

### é—®é¢˜: è™šæ‹Ÿæœºæ€§èƒ½å·®

```bash
# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†virtioé©±åŠ¨
virsh dumpxml &lt;vm&gt; | grep -i driver

# å¯ç”¨virtio-scsi (æ›´å¥½çš„ç£ç›˜æ€§èƒ½)
# ç¼–è¾‘VMé…ç½®æ·»åŠ virtio-scsiæ§åˆ¶å™¨
```

### é—®é¢˜: æ—¶é—´ä¸åŒæ­¥

```bash
# å®¿ä¸»æœº
sudo systemctl status chronyd
chronyc tracking

# è™šæ‹Ÿæœºå†…
sudo apt install chrony
sudo systemctl enable --now chrony
```

---

## ğŸ“ è·å–å¸®åŠ©

### æ—¥å¿—ä½ç½®

```bash
# ç³»ç»Ÿæ—¥å¿—
journalctl -xe
journalctl -u libvirtd

# è™šæ‹Ÿæœºæ—¥å¿—
cat /var/log/libvirt/qemu/&lt;vm-name&gt;.log

# å†…æ ¸æ—¥å¿—
dmesg | tail -50
```

### æ”¶é›†è¯Šæ–­ä¿¡æ¯

```bash
# è¿è¡Œè¯Šæ–­è„šæœ¬
virt-host-validate
/root/verify-kvm-setup.sh
/root/verify-storage.sh

# ç³»ç»Ÿä¿¡æ¯
sysinfo
storage-monitor
vm-manager status
```

---

## ğŸ“ å®Œæˆ

å¸¸è§é—®é¢˜å·²è§£ç­”ï¼

**å…³é”®è¦ç‚¹**:
1. âœ… 27GBå†…å­˜æ˜¯æ­£å¸¸çš„(æ˜¾å¡å ç”¨çº¦5GB)
2. âœ… æš‚æ—¶ä¿æŒç°çŠ¶ï¼Œéœ€è¦æ—¶æ‰‹åŠ¨è¿›BIOS
3. âœ… é•¿æœŸå¯è€ƒè™‘PiKVMæ–¹æ¡ˆ
4. âœ… æŒæ¡äº†å¸¸è§é—®é¢˜æ’æŸ¥æ–¹æ³•




---



# å¸¸è§ç–‘é—® FAQ

## ğŸ¤” å…³äºæ–‡æ¡£å’Œé…ç½®çš„å¸¸è§é—®é¢˜

---

## Q1: Sambaå’ŒNFSæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿæˆ‘éœ€è¦éƒ½é…ç½®å—ï¼Ÿ

### A: å®ƒä»¬æ˜¯äº’è¡¥å…³ç³»ï¼Œä¸æ˜¯äºŒé€‰ä¸€

**ç®€å•å›ç­”**:
- å¦‚æœä½ åªç”¨Windows/Mac/æ‰‹æœºè®¿é—®NAS â†’ **åªé…ç½®Samba**
- å¦‚æœä½ çš„Linuxè™šæ‹Ÿæœºä¹Ÿéœ€è¦è®¿é—®NAS â†’ **é…ç½®Samba + NFS**

### è¯¦ç»†è¯´æ˜

#### Samba (SMB/CIFSåè®®)
- **ç”¨é€”**: Windowsã€Macã€iOSã€Androidè®¾å¤‡è®¿é—®
- **åœºæ™¯**: æ—¥å¸¸æ–‡ä»¶ç®¡ç†ã€ç…§ç‰‡æŸ¥çœ‹ã€è§†é¢‘æ’­æ”¾
- **ä¼˜ç‚¹**: å…¼å®¹æ€§å¥½ï¼Œæ‰€æœ‰è®¾å¤‡éƒ½æ”¯æŒ
- **ç¼ºç‚¹**: æ€§èƒ½ç•¥ä½äºNFS

#### NFS (Network File System)
- **ç”¨é€”**: Linuxç³»ç»Ÿé«˜æ€§èƒ½æ–‡ä»¶è®¿é—®
- **åœºæ™¯**: ç¼–è¯‘é¡¹ç›®ã€å¤§æ–‡ä»¶ä¼ è¾“ã€å¼€å‘ç¯å¢ƒ
- **ä¼˜ç‚¹**: LinuxåŸç”Ÿï¼Œæ€§èƒ½æœ€ä½³
- **ç¼ºç‚¹**: Windows/iOSä¸æ”¯æŒ

### å®é™…ä½¿ç”¨ç¤ºä¾‹

```
åœºæ™¯1: åœ¨Windowsä¸Šç®¡ç†ç…§ç‰‡
  â””â”€ ä½¿ç”¨Samba
  â””â”€ æ‰“å¼€"æ­¤ç”µè„‘" â†’ æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨ â†’ \\192.168.71.210\Media

åœºæ™¯2: Pythonå¼€å‘VMè¯»å–æ•°æ®æ–‡ä»¶
  â””â”€ ä½¿ç”¨NFS
  â””â”€ mount -t nfs 192.168.71.210:/mnt/nas_data/data
  â””â”€ æ€§èƒ½æ¯”Sambaå¿«30-50%

åœºæ™¯3: iPhoneæŸ¥çœ‹æ–‡æ¡£
  â””â”€ ä½¿ç”¨Samba
  â””â”€ æ–‡ä»¶App â†’ è¿æ¥æœåŠ¡å™¨ â†’ smb://192.168.71.210
```

### æ¨èé…ç½®

| ä½ çš„æƒ…å†µ | æ¨èæ–¹æ¡ˆ |
|---------|---------|
| åªæœ‰Windows/Mac/æ‰‹æœºè®¿é—® | ä»…Samba |
| æœ‰Linuxè™šæ‹Ÿæœºéœ€è¦è®¿é—® | Samba + NFS |
| ä¸ç¡®å®š | å…ˆé…ç½®Sambaï¼Œéœ€è¦æ—¶å†åŠ NFS |

### é…ç½®æ­¥éª¤

åœ¨ `11-vm-nas.md` æ–‡æ¡£ä¸­ï¼š

**æœ€å°é…ç½®ï¼ˆæ–°æ‰‹æ¨èï¼‰**:
```
æ­¥éª¤1-4: åŸºç¡€é…ç½® âœ…
æ­¥éª¤5: Sambaé…ç½® âœ…
æ­¥éª¤6: NFSé…ç½® â­ï¸ è·³è¿‡
æ­¥éª¤7: å®¢æˆ·ç«¯è®¿é—® âœ…
```

**å®Œæ•´é…ç½®**:
```
æ­¥éª¤1-4: åŸºç¡€é…ç½® âœ…
æ­¥éª¤5: Sambaé…ç½® âœ…
æ­¥éª¤6: NFSé…ç½® âœ…
æ­¥éª¤7: å®¢æˆ·ç«¯è®¿é—® âœ…
```

---

## Q2: ä¸ºä»€ä¹ˆHTMLæ»šåŠ¨é€Ÿåº¦é‚£ä¹ˆæ…¢ï¼Ÿ

### A: å·²ä¿®å¤ï¼ç°åœ¨ä½¿ç”¨å³æ—¶è·³è½¬

**é—®é¢˜åŸå› **:
- ä¹‹å‰ä½¿ç”¨ `behavior: 'smooth'` å¹³æ»‘æ»šåŠ¨
- åŠ¨ç”»æŒç»­æ—¶é—´è¾ƒé•¿

**ä¿®å¤æ–¹æ¡ˆ**:
- æ”¹ä¸º `behavior: 'auto'` å³æ—¶è·³è½¬
- ç‚¹å‡»å¯¼èˆªç«‹å³è·³è½¬åˆ°ç›®æ ‡ä½ç½®

**ç”Ÿæ•ˆæ–¹å¼**:
é‡æ–°ç”ŸæˆHTMLå³å¯ï¼š
```bash
cd /home/qiang.sheng/Projects/Toolbox/linux_setup
python3 generate_html.py
```

---

## Q3: æ—è·¯ç”±çš„"è§„åˆ™æ¨¡å¼"å’Œ"å…¨å±€æ¨¡å¼"æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: è§„åˆ™æ¨¡å¼ç²¾å‡†æ§åˆ¶æµé‡ï¼ŒèŠ‚çœVPNæµé‡

| æ¨¡å¼ | å·¥ä½œæ–¹å¼ | VPNæµé‡æ¶ˆè€— | æ¨èåº¦ |
|------|---------|------------|--------|
| **è§„åˆ™æ¨¡å¼** | æŒ‰è§„åˆ™åˆ†æµ | ä»…ä»£ç†æŒ‡å®šç½‘ç«™ | â­â­â­â­â­ |
| å…¨å±€æ¨¡å¼ | æ‰€æœ‰æµé‡èµ°ä»£ç† | å…¨éƒ¨æµé‡ | â­â˜†â˜†â˜†â˜† |
| ç›´è¿æ¨¡å¼ | å…¨éƒ¨ç›´è¿ | 0 | è°ƒè¯•ç”¨ |

**è§„åˆ™æ¨¡å¼ç¤ºä¾‹**:
```yaml
# ä»…è¿™äº›ç½‘ç«™èµ°ä»£ç†
Googleã€YouTubeã€Claudeã€ChatGPT
â†“
VPNæµé‡: 500MB/å¤©

# å…¶ä»–ç½‘ç«™ç›´è¿
ç™¾åº¦ã€æ·˜å®ã€Bç«™ã€çŸ¥ä¹
â†“
ç›´è¿ï¼Œä¸æ¶ˆè€—VPNæµé‡

æ€»VPNæµé‡: 500MB/å¤© vs å…¨å±€æ¨¡å¼çš„3GB/å¤©
èŠ‚çœ: 83%
```

**é…ç½®æ–‡æ¡£**: `09-è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®.md`

---

## Q4: è™šæ‹Ÿæœºç£ç›˜ç”¨qcow2è¿˜æ˜¯rawæ ¼å¼ï¼Ÿ

### A: æ ¹æ®ç”¨é€”é€‰æ‹©

| æ ¼å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èç”¨é€” |
|------|------|------|----------|
| **qcow2** | æ”¯æŒå¿«ç…§ã€æŒ‰éœ€å¢é•¿ã€èŠ‚çœç©ºé—´ | æ€§èƒ½ç•¥ä½5-10% | å¼€å‘ã€æµ‹è¯•VM |
| **raw** | æ€§èƒ½æœ€ä½³ | å ç”¨å…¨éƒ¨ç©ºé—´ã€ä¸æ”¯æŒå¿«ç…§ | ç”Ÿäº§ã€æ•°æ®åº“VM |

**æˆ‘ä»¬çš„é…ç½®**:
```
Pythonå¼€å‘VM    â†’ qcow2 (æ–¹ä¾¿å¿«ç…§)
Webåº”ç”¨VM       â†’ qcow2 (æ–¹ä¾¿å¿«ç…§)
æ—è·¯ç”±VM        â†’ qcow2 (é…ç½®ä¸ºä¸»)
NASç³»ç»Ÿç›˜       â†’ raw (æ€§èƒ½ä¼˜å…ˆ)
NASæ•°æ®ç›˜       â†’ ç‹¬ç«‹LVMå· (æœ€ä½³æ€§èƒ½)
```

---

## Q5: LVM thin poolæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å®ƒï¼Ÿ

### A: æ”¯æŒè¿‡é‡åˆ†é…ï¼ŒèŠ‚çœç©ºé—´

**ä¼ ç»ŸLVM**:
```
åˆ›å»º100GBé€»è¾‘å· â†’ ç«‹å³å ç”¨100GBç‰©ç†ç©ºé—´
å³ä½¿åªå†™å…¥1GBæ•°æ®ï¼Œä¹Ÿå ç”¨100GB
```

**LVM thin pool**:
```
åˆ›å»º100GB thinå· â†’ å‡ ä¹ä¸å ç‰©ç†ç©ºé—´
å†™å…¥1GBæ•°æ® â†’ å ç”¨çº¦1GBç‰©ç†ç©ºé—´
æŒ‰éœ€åˆ†é…ï¼ŒèŠ‚çœç©ºé—´
```

**è¿‡é‡åˆ†é…ç¤ºä¾‹**:
```
Thin poolæ€»å®¹é‡: 1.2TB

å¯ä»¥åˆ›å»º:
- VM1: 100GB
- VM2: 100GB
- VM3: 100GB
- VM4: 100GB
- VM5: 100GB
æ€»è®¡: 500GB

å®é™…å ç”¨: å–å†³äºæ¯ä¸ªVMå®é™…å†™å…¥çš„æ•°æ®
å¦‚æœæ¯ä¸ªVMåªç”¨äº†20GBï¼Œå®é™…åªå ç”¨100GB
```

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ éœ€è¦ç›‘æ§ä½¿ç”¨ç‡ï¼Œé¿å…çœŸæ­£ç”¨æ»¡
- âš ï¸ é…ç½®è‡ªåŠ¨æ‰©å±•ç­–ç•¥
- ğŸ“Š ä½¿ç”¨ `storage-monitor` å‘½ä»¤å®šæœŸæ£€æŸ¥

---

## Q6: ä¸ºä»€ä¹ˆè¦é…ç½®å›½å†…é•œåƒæºï¼Ÿ

### A: é€Ÿåº¦æå‡10-100å€

**å¯¹æ¯”**:
```
ä½¿ç”¨å®˜æ–¹æº:
  ä¸‹è½½é€Ÿåº¦: 50-200 KB/s
  å®‰è£…è½¯ä»¶åŒ…: 5-10åˆ†é’Ÿ
  ç³»ç»Ÿæ›´æ–°: 30-60åˆ†é’Ÿ

ä½¿ç”¨å›½å†…é•œåƒæº:
  ä¸‹è½½é€Ÿåº¦: 5-50 MB/s
  å®‰è£…è½¯ä»¶åŒ…: 10-30ç§’
  ç³»ç»Ÿæ›´æ–°: 2-5åˆ†é’Ÿ
```

**å·²é…ç½®çš„é•œåƒæº**:
- Rocky Linux: é˜¿é‡Œäº‘/æ¸…å
- Ubuntu: æ¸…å/ä¸­ç§‘å¤§
- Python pip: æ¸…åpypi
- Docker: é˜¿é‡Œäº‘å®¹å™¨åŠ é€Ÿ
- npm: æ·˜å®é•œåƒ

---

## Q7: ä¸ºä»€ä¹ˆå†…å­˜æ˜¾ç¤º27GBè€Œä¸æ˜¯32GBï¼Ÿ

### A: é›†æˆæ˜¾å¡å ç”¨4-5GBæ˜¯æ­£å¸¸çš„

**åŸå› åˆ†æ**:
```
è´­ä¹°: 32GB (16GB Ã— 2)
ç³»ç»Ÿæ˜¾ç¤º: ~27GBå¯ç”¨

å·®å¼‚: ~5GB

å»å‘:
1. é›†æˆæ˜¾å¡ (iGPU) å ç”¨: 4-5GB
   - AMD R5 5600Gæ˜¯APUï¼Œä»ç³»ç»Ÿå†…å­˜åˆ†é…æ˜¾å­˜
   
2. ç¡¬ä»¶é¢„ç•™: ~500MB
   - å†…æ ¸ã€DMAç¼“å†²åŒºç­‰

æ€»è®¡: çº¦5GB
```

**å¦‚ä½•è°ƒæ•´**:
```
è¿›å…¥BIOS â†’ Advanced â†’ UMA Frame Buffer Size

é€‰é¡¹:
- Auto (é»˜è®¤ï¼Œé€šå¸¸2-4GB)
- 512M (æœ€å°)
- 1G
- 2G
- 4G

å»ºè®®:
- æ— å¤´æœåŠ¡å™¨: è®¾ç½®ä¸º512M
- å¶å°”éœ€è¦æ˜¾ç¤º: ä¿æŒ1-2G
```

**ç»“è®º**: 27GBå¯ç”¨å†…å­˜æ˜¯æ­£å¸¸çš„ï¼Œå¤Ÿç”¨äº†ï¼

è¯¦è§: `14-troubleshooting.md`

---

## Q8: ç½‘æ¡¥(Bridge)æ¨¡å¼å’ŒNATæ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: Bridgeæ¨¡å¼è™šæ‹Ÿæœºåœ¨åŒä¸€ç½‘æ®µï¼ŒNATæ¨¡å¼åœ¨ç‹¬ç«‹ç½‘æ®µ

| ç‰¹æ€§ | Bridgeæ¨¡å¼ (æ¨è) | NATæ¨¡å¼ |
|------|------------------|---------|
| **è™šæ‹ŸæœºIP** | 192.168.71.x (ä¸å®¿ä¸»æœºåŒç½‘æ®µ) | 192.168.122.x (ç‹¬ç«‹ç½‘æ®µ) |
| **å±€åŸŸç½‘è®¿é—®VM** | âœ… ç›´æ¥è®¿é—® | âŒ éœ€ç«¯å£è½¬å‘ |
| **VMè®¿é—®å±€åŸŸç½‘** | âœ… ç›´æ¥è®¿é—® | âœ… é€šè¿‡NAT |
| **é…ç½®éš¾åº¦** | â­â­â­â˜†â˜† | â­â­â˜†â˜†â˜† |
| **é€‚ç”¨åœºæ™¯** | æœåŠ¡å™¨VM | æµ‹è¯•VM |

**æˆ‘ä»¬çš„é€‰æ‹©**: Bridgeæ¨¡å¼
- NASéœ€è¦å±€åŸŸç½‘è®¾å¤‡ç›´æ¥è®¿é—®
- æ—è·¯ç”±éœ€è¦åœ¨åŒä¸€ç½‘æ®µ
- Webåº”ç”¨éœ€è¦å±€åŸŸç½‘è®¿é—®

---

## Q9: virtio-fsæ˜¯ä»€ä¹ˆï¼Ÿå’Œæ™®é€šæŒ‚è½½æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: å®¿ä¸»æœºå’Œè™šæ‹Ÿæœºå…±äº«ç›®å½•çš„é«˜æ€§èƒ½æ–¹æ¡ˆ

**ä¼ ç»Ÿæ–¹æ¡ˆ**: NFS/Sambaåœ¨VMå†…æŒ‚è½½
```
å®¿ä¸»æœº â†’ ç½‘ç»œ â†’ VM
æ€§èƒ½: å—ç½‘ç»œåè®®å¼€é”€å½±å“
```

**virtio-fsæ–¹æ¡ˆ**: ç›´æ¥å…±äº«
```
å®¿ä¸»æœº â†’ virtio-fs â†’ VM
æ€§èƒ½: æ¥è¿‘åŸç”Ÿæ–‡ä»¶ç³»ç»Ÿ
```

**æˆ‘ä»¬çš„ä½¿ç”¨**:
```
å®¿ä¸»æœº: /data/nas (500GBç‹¬ç«‹LVMå·)
    â†“ virtio-fså…±äº«
NAS VM: /mnt/nas_data
    â†“ Samba/NFSå…±äº«
å±€åŸŸç½‘è®¾å¤‡: è®¿é—®æ–‡ä»¶
```

**ä¼˜åŠ¿**:
- âœ… æ€§èƒ½æœ€ä½³
- âœ… å®¿ä¸»æœºå¯ç›´æ¥å¤‡ä»½ /data/nas
- âœ… VMæŸåæ—¶æ•°æ®ä¸ä¸¢å¤±

---

## Q10: å¦‚ä½•å¿«é€Ÿæ·»åŠ éœ€è¦ä»£ç†çš„ç½‘ç«™ï¼Ÿ

### A: ä¸‰ç§æ–¹æ³•ï¼Œæ¨èå‘½ä»¤è¡Œæ–¹å¼

**æ–¹æ³•1: å‘½ä»¤è¡Œï¼ˆæœ€å¿«ï¼‰**
```bash
# SSHç™»å½•åˆ°OpenWrt
ssh root@192.168.71.254

# ä½¿ç”¨add-proxyå‘½ä»¤
add-proxy gemini.google.com

# é‡å¯OpenClash
/etc/init.d/openclash restart
```

**æ–¹æ³•2: Webç•Œé¢ï¼ˆæœ€ç®€å•ï¼‰**
```
1. è®¿é—® http://192.168.71.254
2. æœåŠ¡ â†’ OpenClash â†’ è§„åˆ™è®¾ç½®
3. è‡ªå®šä¹‰è§„åˆ™ â†’ æ·»åŠ ä¸€è¡Œ:
   DOMAIN-SUFFIX,gemini.google.com,PROXY
4. ä¿å­˜ â†’ é‡å¯OpenClash
```

**æ–¹æ³•3: æ‰¹é‡æ·»åŠ **
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vi /etc/openclash/custom/openclash_custom_rules.list

# æ·»åŠ å¤šè¡Œ
DOMAIN-SUFFIX,site1.com,PROXY
DOMAIN-SUFFIX,site2.com,PROXY
DOMAIN-SUFFIX,site3.com,PROXY

# é‡å¯
/etc/init.d/openclash restart
```

è¯¦è§: `09-è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®.md`

---

## Q11: å¦‚ä½•éªŒè¯è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

### A: æŸ¥çœ‹æ—¥å¿—æˆ–æµ‹è¯•è®¿é—®

**æ–¹æ³•1: å®æ—¶æŸ¥çœ‹æ—¥å¿—**
```bash
# OpenWrtä¸Š
logread -f | grep -E "PROXY|DIRECT"

# ä¼šæ˜¾ç¤ºæ¯ä¸ªè¿æ¥åŒ¹é…çš„è§„åˆ™
```

**æ–¹æ³•2: Webç•Œé¢æŸ¥çœ‹**
```
OpenClash â†’ æ—¥å¿—
å¯ä»¥çœ‹åˆ°å®æ—¶è¿æ¥å’Œè§„åˆ™åŒ¹é…
```

**æ–¹æ³•3: æµ‹è¯•è®¿é—®**
```bash
# åœ¨å®¢æˆ·ç«¯
curl -I https://www.google.com
curl ipinfo.io

# æŸ¥çœ‹æ˜¯å¦èµ°ä»£ç†
```

---

## Q12: æ–‡æ¡£å¤ªå¤šï¼Œä»å“ªé‡Œå¼€å§‹ï¼Ÿ

### A: æŒ‰é¡ºåºï¼Œå¿…é¡»çš„åªæœ‰å‰5ä¸ª

**æœ€å°è·¯å¾„ï¼ˆ1å°æ—¶ï¼‰**:
```
01 â†’ 02 â†’ 03
åŸºç¡€ç¯å¢ƒæ­å»ºå®Œæˆ
```

**æ¨èè·¯å¾„ï¼ˆ1å‘¨ï¼‰**:
```
ç¬¬1å¤©: 01 â†’ 02 â†’ 03 â†’ 04 â†’ 05 (åŸºç¡€ç¯å¢ƒ)
ç¬¬2å¤©: 06 (Pythonå¼€å‘VM)
ç¬¬3å¤©: 08 â†’ 09 â†’ 09è¡¥å…… (æ—è·¯ç”±)
ç¬¬4å¤©: 11 (NASæ–‡ä»¶å…±äº«)
```

**æŒ‰éœ€æŸ¥é˜…**:
- é‡åˆ°é—®é¢˜ â†’ 14-troubleshooting.md
- éœ€è¦å¤‡ä»½ â†’ 12-backup-restore.md
- æ—¥å¸¸ç»´æŠ¤ â†’ 13-maintenance.md

---

## Q13: HTMLå’ŒMarkdownæ–‡æ¡£æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: HTMLç”¨äºé˜…è¯»ï¼ŒMarkdownç”¨äºç¼–è¾‘

**HTMLæ–‡æ¡£** (`KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html`):
- âœ… æµè§ˆå™¨æ‰“å¼€ï¼Œç¾è§‚æ˜“è¯»
- âœ… å·¦ä¾§å¯¼èˆªï¼Œå¿«é€Ÿè·³è½¬
- âœ… ä»£ç é«˜äº®ï¼Œä¸€ç›®äº†ç„¶
- âœ… å¯ä»¥å¤åˆ¶åˆ°æ‰‹æœºæŸ¥çœ‹
- âŒ ä¸èƒ½ç¼–è¾‘

**Markdownæ–‡æ¡£** (`.md`æ–‡ä»¶):
- âœ… å¯ä»¥ç¼–è¾‘ä¿®æ”¹
- âœ… æ˜“äºç»´æŠ¤å’Œæ›´æ–°
- âœ… é€‚åˆåšç¬”è®°
- âŒ é˜…è¯»ä½“éªŒç•¥å·®

**å·¥ä½œæµç¨‹**:
```
1. ç”¨HTMLé˜…è¯»æ–‡æ¡£
2. éœ€è¦ä¿®æ”¹æ—¶ç¼–è¾‘.mdæ–‡ä»¶
3. è¿è¡Œ python3 generate_html.py
4. ç”Ÿæˆæ–°çš„HTML
```

---

## Q14: ç”ŸæˆHTMLåæ–‡ä»¶å¾ˆå¤§ï¼Œå¦‚ä½•åˆ†äº«ï¼Ÿ

### A: 147KBä¸ç®—å¤§ï¼Œå¯ä»¥éšæ„åˆ†äº«

**æ–‡ä»¶å¤§å°**:
```
KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html: 147KB
ç›¸å½“äº: 1å¼ æ‰‹æœºç…§ç‰‡çš„1/20
```

**åˆ†äº«æ–¹å¼**:
1. **é‚®ä»¶**: å¯ä»¥ç›´æ¥å‘é€
2. **ç½‘ç›˜**: ä¸Šä¼ åˆ°ç™¾åº¦ç½‘ç›˜/åšæœäº‘
3. **Uç›˜**: å¤åˆ¶åˆ°Uç›˜
4. **æ‰‹æœº**: é€šè¿‡å¾®ä¿¡/QQä¼ è¾“
5. **GitHub**: ä¸Šä¼ åˆ°ä»“åº“

**åœ¨çº¿æŸ¥çœ‹**:
å¦‚æœæƒ³åœ¨çº¿æŸ¥çœ‹ï¼Œå¯ä»¥ï¼š
1. ä¸Šä¼ åˆ°GitHub Pages
2. ä¸Šä¼ åˆ°Gitee Pagesï¼ˆå›½å†…è®¿é—®å¿«ï¼‰
3. æ”¾åˆ°ä»»ä½•WebæœåŠ¡å™¨

---

## ğŸ’¡ æ›´å¤šé—®é¢˜ï¼Ÿ

æŸ¥çœ‹å¯¹åº”æ–‡æ¡£ï¼š
- **æŠ€æœ¯é—®é¢˜** â†’ 14-troubleshooting.md
- **ä½¿ç”¨é—®é¢˜** â†’ å¯¹åº”ç« èŠ‚çš„æ–‡æ¡£
- **é…ç½®é—®é¢˜** â†’ æŸ¥çœ‹è„šæœ¬æ³¨é‡Š

æˆ–éšæ—¶é—®æˆ‘ï¼ğŸ¯

            </article>
        </main>
        
        <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
        <div class="back-to-top" id="backToTop">â†‘</div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
    <script>
        // é…ç½® marked - ä½¿ç”¨å¼‚æ­¥åˆå§‹åŒ–
        marked.use({
            breaks: true,
            gfm: true,
            pedantic: false,
            headerIds: true,
            mangle: false
        });
        
        // æ¸²æŸ“Markdownå†…å®¹
        function renderMarkdown() {
            const content = document.getElementById('content');
            const rawContent = content.textContent;
            content.innerHTML = marked.parse(rawContent);
            
            // ä»£ç é«˜äº®
            content.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // ç”Ÿæˆå¯¼èˆª
            generateNav();
        }
        
        // ç”Ÿæˆå¯¼èˆª
        function generateNav() {
            const navList = document.getElementById('nav-list');
            const content = document.getElementById('content');
            const sections = content.querySelectorAll('h1');
            
            navList.innerHTML = '';
            
            sections.forEach((section, index) => {
                const id = 'section-' + index;
                section.id = id;
                
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#' + id;
                a.textContent = section.textContent;
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    // ä½¿ç”¨å³æ—¶è·³è½¬ï¼ˆæœ€å¿«ï¼‰
                    const targetPosition = section.offsetTop - 20;
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'auto'  // å³æ—¶è·³è½¬ï¼Œæ— åŠ¨ç”»
                    });
                    updateActiveNav();
                });
                
                li.appendChild(a);
                navList.appendChild(li);
            });
        }
        
        // æ›´æ–°æ´»åŠ¨å¯¼èˆªé¡¹
        function updateActiveNav() {
            const sections = document.querySelectorAll('h1');
            const navLinks = document.querySelectorAll('.nav-list a');
            
            let currentSection = '';
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 100) {
                    currentSection = section.id;
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + currentSection) {
                    link.classList.add('active');
                }
            });
        }
        
        // å›åˆ°é¡¶éƒ¨
        const backToTop = document.getElementById('backToTop');
        window.addEventListener('scroll', function() {
            if (window.scrollY > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
            
            updateActiveNav();
        });
        
        backToTop.addEventListener('click', function() {
            // å¿«é€Ÿæ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({
                top: 0,
                behavior: 'auto'  // ä½¿ç”¨autoå®ç°å³æ—¶æ»šåŠ¨
            });
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderMarkdown();
            updateActiveNav();
        });
    </script>
</body>
</html>
