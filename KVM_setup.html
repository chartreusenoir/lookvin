<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æœåŠ¡å™¨ KVM è™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --code-bg: #161b22;
            --nav-bg: #161b22;
            --nav-active: #1f6feb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: var(--nav-active);
            color: white;
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: background 0.3s;
        }
        
        .menu-toggle:active {
            background: #1158c7;
        }
        
        /* é®ç½©å±‚ */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .overlay.visible {
            opacity: 1;
        }
        
        /* ä¾§è¾¹å¯¼èˆªæ  */
        .sidebar {
            width: 300px;
            background: var(--nav-bg);
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            z-index: 1000;
        }
        
        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #58a6ff;
        }
        
        .nav-list {
            list-style: none;
        }
        
        .nav-list li {
            margin-bottom: 8px;
        }
        
        .nav-list a {
            color: var(--text-color);
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .nav-list a:hover {
            background: rgba(56, 139, 253, 0.1);
            color: #58a6ff;
        }
        
        .nav-list a.active {
            background: rgba(31, 111, 235, 0.15);
            color: var(--nav-active);
            font-weight: 600;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            margin-left: 300px;
            padding: 40px 60px;
            max-width: 1400px;
        }
        
        /* Markdownæ ·å¼å¢å¼º */
        .markdown-body {
            background: transparent !important;
            color: var(--text-color) !important;
        }
        
        .markdown-body h1 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 40px;
            margin-bottom: 20px;
            color: #58a6ff;
        }
        
        .markdown-body h2 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-top: 30px;
            margin-bottom: 16px;
        }
        
        .markdown-body h3 {
            margin-top: 24px;
            margin-bottom: 12px;
        }
        
        .markdown-body pre {
            background: var(--code-bg) !important;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        
        .markdown-body code {
            background: var(--code-bg) !important;
            color: #ff7b72 !important;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .markdown-body pre code {
            color: var(--text-color) !important;
            padding: 0;
        }
        
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .markdown-body table th,
        .markdown-body table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
        }
        
        .markdown-body table th {
            background: var(--code-bg);
        }
        
        .markdown-body blockquote {
            border-left: 4px solid #388bfd;
            padding-left: 16px;
            color: #8b949e;
        }
        
        /* æ–‡æ¡£åˆ†éš” */
        .doc-separator {
            margin: 60px 0;
            border: none;
            border-top: 3px solid var(--border-color);
        }
        
        /* å›åˆ°é¡¶éƒ¨æŒ‰é’® */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--nav-active);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, background 0.3s;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .back-to-top.visible {
            opacity: 1;
        }
        
        .back-to-top:hover {
            background: #1158c7;
        }
        
        /* å¹³æ¿é€‚é… */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
            
            .main-content {
                margin-left: 280px;
                padding: 30px 40px;
            }
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .overlay {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-out;
                width: 280px;
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 70px 20px 20px 20px;
                width: 100%;
            }
            
            .markdown-body {
                font-size: 15px;
            }
            
            .markdown-body h1 {
                font-size: 1.8em;
                margin-top: 30px;
            }
            
            .markdown-body h2 {
                font-size: 1.5em;
                margin-top: 24px;
            }
            
            .markdown-body h3 {
                font-size: 1.3em;
            }
            
            .markdown-body pre {
                font-size: 13px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .markdown-body code {
                font-size: 13px;
                word-wrap: break-word;
            }
            
            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
        }
        
        /* å°å±æ‰‹æœºé€‚é… */
        @media (max-width: 480px) {
            .sidebar {
                width: 85%;
                max-width: 280px;
            }
            
            .main-content {
                padding: 60px 15px 15px 15px;
            }
            
            .markdown-body {
                font-size: 14px;
            }
            
            .markdown-body h1 {
                font-size: 1.6em;
            }
            
            .markdown-body h2 {
                font-size: 1.4em;
            }
            
            .markdown-body h3 {
                font-size: 1.2em;
            }
            
            .markdown-body pre {
                font-size: 12px;
            }
            
            .markdown-body table {
                font-size: 13px;
            }
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            .sidebar,
            .back-to-top,
            .menu-toggle,
            .overlay {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
                padding: 0;
            }
            
            .markdown-body {
                font-size: 12pt;
            }
        }
    </style>
</head>
<body>
    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="menu-toggle" id="menuToggle">â˜°</button>
    
    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>
    
    <div class="container">
        <!-- ä¾§è¾¹å¯¼èˆª -->
        <nav class="sidebar" id="sidebar">
            <h2>ğŸ“š æ–‡æ¡£å¯¼èˆª</h2>
            <ul class="nav-list" id="nav-list">
                <!-- å¯¼èˆªé¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
            </ul>
        </nav>
        
        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <article class="markdown-body" id="content">
# å®¶åº­æœåŠ¡å™¨ KVM è™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—

## ğŸ“š æ–‡æ¡£æ¦‚è§ˆ

æœ¬æ–‡æ¡£é›†ä¸ºæ‚¨æä¾›ä»é›¶æ­å»ºåŸºäº Rocky Linux 9 + KVM çš„å®¶åº­æœåŠ¡å™¨å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…å« Python å¼€å‘ã€Web åº”ç”¨éƒ¨ç½²ã€æ—è·¯ç”±ã€NAS ç­‰åŠŸèƒ½è™šæ‹Ÿæœºçš„è¯¦ç»†é…ç½®æŒ‡å—ã€‚

### ğŸ–¥ï¸ æœåŠ¡å™¨é…ç½®

- **CPU**: AMD Ryzen 5 5600G
- **ä¸»æ¿**: MSI B550M PRO-VDH
- **å†…å­˜**: 32GB DDR4 2666MHz (16GB Ã— 2)
- **å­˜å‚¨**: è‡´æ€ TiPlus7100s 2TB NVMe SSD
- **ç³»ç»Ÿ**: Rocky Linux 9 Minimal
- **ç½‘ç»œ**: 192.168.71.200/24 (é™æ€IP)

### ğŸ¯ è™šæ‹Ÿæœºè§„åˆ’

| è™šæ‹Ÿæœº | æ“ä½œç³»ç»Ÿ | ç£ç›˜ | IPåœ°å€ | ç”¨é€” |
|--------|----------|------|--------|------|
| python-dev | Ubuntu 22.04 LTS | 80GB (qcow2) | 192.168.71.201 | Python å¼€å‘å’Œæµ‹è¯• |
| web-app | Ubuntu 22.04 LTS | 100GB (qcow2) | 192.168.71.202 | Web åº”ç”¨ç”Ÿäº§éƒ¨ç½² |
| router | OpenWrt/Rocky 9 | 20GB (qcow2) | 192.168.71.254 | é€æ˜ä»£ç†/æ—è·¯ç”± |
| nas | Rocky Linux 9 | 30GB (raw) + 500GB æ•°æ® | 192.168.71.210 | æ–‡ä»¶å…±äº«æœåŠ¡ |

### ğŸ“‚ å­˜å‚¨æ¶æ„

```
è‡´æ€ 2TB NVMe SSD
â”œâ”€ ç³»ç»Ÿåˆ†åŒº (110GB)
â”‚  â”œâ”€ / (root)
â”‚  â”œâ”€ /boot
â”‚  â””â”€ swap
â”‚
â”œâ”€ KVM å­˜å‚¨æ±  (1.2TB LVM thin pool)
â”‚  â”œâ”€ python-dev.qcow2 (80GB)
â”‚  â”œâ”€ web-app.qcow2 (100GB)
â”‚  â”œâ”€ router.qcow2 (20GB)
â”‚  â”œâ”€ nas-system.raw (30GB)
â”‚  â””â”€ é¢„ç•™ç©ºé—´ (~970GB)
â”‚
â”œâ”€ NAS æ•°æ®å· (500GB LVM)
â”‚  â””â”€ /data/nas (é€šè¿‡ virtio-fs å…±äº«ç»™ NAS VM)
â”‚
â””â”€ æœªåˆ†é…ç©ºé—´ (~50GB åº”æ€¥é¢„ç•™)
```

### ğŸŒ ç½‘ç»œæ‹“æ‰‘

```
äº’è”ç½‘
  â”‚
  â”œâ”€ ç”µä¿¡äº‘å®½å¸¦ç½‘å…³ (192.168.71.1)
  â”‚
  â””â”€ ç‰©ç†ç½‘ç»œ (192.168.71.0/24)
       â”‚
       â”œâ”€ å®¿ä¸»æœº (192.168.71.200)
       â”‚    â””â”€ br0 ç½‘æ¡¥ (Bridge æ¨¡å¼)
       â”‚         â”œâ”€ python-dev (192.168.71.201)
       â”‚         â”œâ”€ web-app (192.168.71.202)
       â”‚         â”œâ”€ nas (192.168.71.210)
       â”‚         â””â”€ router (192.168.71.254) â† å¯é€‰æ—è·¯ç”±ç½‘å…³
       â”‚
       â””â”€ å…¶ä»–å±€åŸŸç½‘è®¾å¤‡
```

---

## ğŸ“– æ–‡æ¡£å¯¼èˆª

### ğŸš€ ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç¯å¢ƒæ­å»º (å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œ)

| æ–‡æ¡£ | æè¿° | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| [01-host-init.md](#section-1) | å®¿ä¸»æœºåˆå§‹åŒ–é…ç½®&lt;br&gt;â€¢ SSH å¯†é’¥è®¤è¯&lt;br&gt;â€¢ ç³»ç»Ÿæ›´æ–°å’Œå¿…è¦è½¯ä»¶å®‰è£…&lt;br&gt;â€¢ å›½å†…é•œåƒæºé…ç½®&lt;br&gt;â€¢ é˜²ç«å¢™å’Œ SELinux é…ç½® | 20 åˆ†é’Ÿ |
| [02-kvm-setup.md](#section-2) | KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»º&lt;br&gt;â€¢ KVM/QEMU å®‰è£…&lt;br&gt;â€¢ libvirt é…ç½®&lt;br&gt;â€¢ ç½‘æ¡¥åˆ›å»º&lt;br&gt;â€¢ éªŒè¯è™šæ‹ŸåŒ–æ”¯æŒ | 30 åˆ†é’Ÿ |
| [03-storage-expansion.md](#section-3) | ç£ç›˜ç©ºé—´æ‰©å±•&lt;br&gt;â€¢ LVM thin pool åˆ›å»º (1.2TB)&lt;br&gt;â€¢ NAS æ•°æ®å·åˆ›å»º (500GB)&lt;br&gt;â€¢ KVM å­˜å‚¨æ± é…ç½®&lt;br&gt;â€¢ ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬ | 20 åˆ†é’Ÿ |
| [04-vm-management.md](#section-4) | è™šæ‹Ÿæœºåˆ›å»ºå’Œç®¡ç†&lt;br&gt;â€¢ VM åˆ›å»ºè„šæœ¬&lt;br&gt;â€¢ è‡ªåŠ¨å¯åŠ¨é…ç½®&lt;br&gt;â€¢ èµ„æºåˆ†é…ç­–ç•¥&lt;br&gt;â€¢ ç»Ÿä¸€ç®¡ç†å·¥å…· | 15 åˆ†é’Ÿ |
| [05-monitoring.md](#section-5) | ç›‘æ§æ–¹æ¡ˆéƒ¨ç½²&lt;br&gt;â€¢ Cockpit Web æ§åˆ¶å°&lt;br&gt;â€¢ è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§&lt;br&gt;â€¢ èµ„æºä½¿ç”¨è„šæœ¬&lt;br&gt;â€¢ å‘Šè­¦é…ç½® | 25 åˆ†é’Ÿ |

### ğŸ› ï¸ ç¬¬äºŒé˜¶æ®µï¼šè™šæ‹Ÿæœºé…ç½® (å¯æ ¹æ®éœ€è¦é€‰æ‹©)

| æ–‡æ¡£ | æè¿° | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| [06-vm-python-dev.md](#section-6) | Python å¼€å‘ç¯å¢ƒé…ç½®&lt;br&gt;â€¢ Ubuntu 22.04 å®‰è£…&lt;br&gt;â€¢ Python 3.11+ ç¯å¢ƒ&lt;br&gt;â€¢ pip æ¸…åæºé…ç½®&lt;br&gt;â€¢ å¸¸ç”¨å¼€å‘å·¥å…· | 40 åˆ†é’Ÿ |
| [07-vm-web-app.md](#section-7) | Web åº”ç”¨éƒ¨ç½²ç¯å¢ƒ&lt;br&gt;â€¢ Nginx + uWSGI/Gunicorn&lt;br&gt;â€¢ PostgreSQL/MySQL&lt;br&gt;â€¢ Docker ç¯å¢ƒ&lt;br&gt;â€¢ SSL è¯ä¹¦é…ç½® | 50 åˆ†é’Ÿ |
| [08-vm-router-comparison.md](#section-8) | æ—è·¯ç”±æ–¹æ¡ˆå¯¹æ¯”&lt;br&gt;â€¢ OpenWrt vs V2Ray è¯¦ç»†å¯¹æ¯”&lt;br&gt;â€¢ é€‚ç”¨åœºæ™¯åˆ†æ&lt;br&gt;â€¢ æ€§èƒ½å’Œæ˜“ç”¨æ€§è¯„ä¼°&lt;br&gt;â€¢ æ–¹æ¡ˆé€‰æ‹©å»ºè®® | é˜…è¯» 15 åˆ†é’Ÿ |
| [09-vm-router-openwrt.md](#section-9) | OpenWrt æ—è·¯ç”±é…ç½®&lt;br&gt;â€¢ OpenWrt å®‰è£…&lt;br&gt;â€¢ OpenClash æ’ä»¶é…ç½®&lt;br&gt;â€¢ Clash è®¢é˜…å¯¼å…¥&lt;br&gt;â€¢ è‡ªåŠ¨/æ‰‹åŠ¨ç½‘å…³è®¾ç½® | 60 åˆ†é’Ÿ |
| [10-vm-router-v2ray.md](#section-10) | V2Ray æ—è·¯ç”±é…ç½®&lt;br&gt;â€¢ Rocky 9 + V2Ray å®‰è£…&lt;br&gt;â€¢ é€æ˜ä»£ç†é…ç½®&lt;br&gt;â€¢ è®¢é˜…è½¬æ¢å’Œæ›´æ–°&lt;br&gt;â€¢ åˆ†æµè§„åˆ™ä¼˜åŒ– | 60 åˆ†é’Ÿ |
| [11-vm-nas.md](#section-11) | NAS æ–‡ä»¶å…±äº«æœåŠ¡&lt;br&gt;â€¢ Samba (Windows/macOS/iOS)&lt;br&gt;â€¢ NFS (Linux/é«˜æ€§èƒ½)&lt;br&gt;â€¢ virtio-fs å®¿ä¸»æœºå…±äº«&lt;br&gt;â€¢ å¤–ç½‘è®¿é—® (VPN/FRP) | 70 åˆ†é’Ÿ |

### ğŸ”§ ç¬¬ä¸‰é˜¶æ®µï¼šè¿ç»´å’Œç»´æŠ¤ (å‚è€ƒæ–‡æ¡£)

| æ–‡æ¡£ | æè¿° |
|------|------|
| [12-backup-restore.md](#section-12) | å¤‡ä»½å’Œæ¢å¤ç­–ç•¥&lt;br&gt;â€¢ è™šæ‹Ÿæœºå¿«ç…§å’Œå¤‡ä»½&lt;br&gt;â€¢ å®šæœŸå¤‡ä»½è„šæœ¬&lt;br&gt;â€¢ å¢é‡å¤‡ä»½æ–¹æ¡ˆ&lt;br&gt;â€¢ ç¾éš¾æ¢å¤æµç¨‹ |
| [13-maintenance.md](#section-13) | ç³»ç»Ÿç»´æŠ¤æŒ‡å—&lt;br&gt;â€¢ æ­£ç¡®çš„å…³æœºå’Œå¯åŠ¨æµç¨‹&lt;br&gt;â€¢ è™šæ‹Ÿæœºè‡ªåŠ¨å¯åŠ¨é…ç½®&lt;br&gt;â€¢ ç³»ç»Ÿæ›´æ–°ç­–ç•¥&lt;br&gt;â€¢ æ—¥å¸¸ç»´æŠ¤æ£€æŸ¥æ¸…å• |
| [14-troubleshooting.md](#section-14) | å¸¸è§é—®é¢˜æ’æŸ¥&lt;br&gt;â€¢ å†…å­˜æ˜¾ç¤º 27G çš„åŸå› &lt;br&gt;â€¢ è¿œç¨‹ BIOS è®¿é—®æ–¹æ¡ˆ&lt;br&gt;â€¢ ç½‘ç»œè¿é€šæ€§é—®é¢˜&lt;br&gt;â€¢ æ€§èƒ½ä¼˜åŒ–å»ºè®® |

---

## âš¡ å¿«é€Ÿå¼€å§‹

### æœ€å°åŒ–éƒ¨ç½²è·¯å¾„ï¼ˆä»…æµ‹è¯• KVM ç¯å¢ƒï¼‰

å¦‚æœæ‚¨åªæƒ³å¿«é€Ÿæµ‹è¯• KVM ç¯å¢ƒï¼ŒæŒ‰ä»¥ä¸‹æœ€å°è·¯å¾„æ“ä½œï¼š

```bash
# 1. åŸºç¡€é…ç½® (01-host-init.md)
# 2. KVM å®‰è£… (02-kvm-setup.md)
# 3. åˆ›å»ºä¸€ä¸ªæµ‹è¯•è™šæ‹ŸæœºéªŒè¯ç¯å¢ƒ
```

**é¢„è®¡æ—¶é—´**: 1 å°æ—¶

### å®Œæ•´ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

å¦‚æœè¦éƒ¨ç½²å®Œæ•´çš„å®¶åº­æœåŠ¡å™¨æ–¹æ¡ˆï¼š

```bash
# ç¬¬ä¸€å¤©ï¼šåŸºç¡€ç¯å¢ƒ (1-2 å°æ—¶)
01 â†’ 02 â†’ 03 â†’ 04 â†’ 05

# ç¬¬äºŒå¤©ï¼šæŒ‰éœ€é…ç½®è™šæ‹Ÿæœº (2-4 å°æ—¶)
06 (Python å¼€å‘) â†’ 07 (Web åº”ç”¨)

# ç¬¬ä¸‰å¤©ï¼šç½‘ç»œæœåŠ¡ (2-3 å°æ—¶)
é€‰æ‹© 09 (OpenWrt) æˆ– 10 (V2Ray) â†’ 11 (NAS)

# ç¬¬å››å¤©ï¼šå¤‡ä»½å’Œä¼˜åŒ– (1 å°æ—¶)
12 â†’ 13 â†’ 14
```

**é¢„è®¡æ—¶é—´**: åˆ† 4 å¤©å®Œæˆï¼Œæ¯å¤© 1-4 å°æ—¶

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### æ–‡æ¡£ç‰¹ç‚¹

âœ… **æ‰€æœ‰è„šæœ¬å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨** - æ— éœ€ä¿®æ”¹å³å¯åœ¨æ‚¨çš„ç¯å¢ƒä¸­è¿è¡Œ  
âœ… **å›½å†…ç½‘ç»œä¼˜åŒ–** - æ‰€æœ‰é…ç½®éƒ½åŒ…å«å›½å†…é•œåƒæºï¼Œç¡®ä¿ç¨³å®šä¸‹è½½  
âœ… **è¯¦ç»†çš„éªŒè¯æ­¥éª¤** - æ¯ä¸ªæ“ä½œåéƒ½æœ‰éªŒè¯å‘½ä»¤ï¼Œç¡®ä¿é…ç½®æ­£ç¡®  
âœ… **æ•…éšœæ’æŸ¥æŒ‡å—** - å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ  
âœ… **æ¨¡å—åŒ–è®¾è®¡** - å¯ä»¥è·³è¿‡ä¸éœ€è¦çš„è™šæ‹Ÿæœºé…ç½®

### æ³¨æ„äº‹é¡¹

âš ï¸ **æ“ä½œå‰å¤‡ä»½** - è™½ç„¶è¿™æ˜¯æ–°ç³»ç»Ÿï¼Œä½†é‡è¦æ•°æ®è¯·æå‰å¤‡ä»½  
âš ï¸ **æŒ‰é¡ºåºæ“ä½œ** - ç¬¬ä¸€é˜¶æ®µæ–‡æ¡£å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œç¬¬äºŒé˜¶æ®µå¯ä»¥é€‰æ‹©æ€§æ‰§è¡Œ  
âš ï¸ **æ£€æŸ¥ç¡¬ä»¶æ”¯æŒ** - ç¡®ä¿ CPU æ”¯æŒè™šæ‹ŸåŒ– (AMD-V æˆ– Intel VT-x)  
âš ï¸ **ç½‘ç»œé…ç½®** - ç¡®ä¿ 192.168.71.201-254 è¿™äº› IP æœªè¢«å ç”¨  
âš ï¸ **è„šæœ¬å®‰å…¨æ€§** - æ‰€æœ‰è„šæœ¬éƒ½ä¼šåœ¨æ‰§è¡Œå‰è¦æ±‚ç¡®è®¤ï¼Œé¿å…è¯¯æ“ä½œ

### è„šæœ¬ä½¿ç”¨æ–¹å¼

æ–‡æ¡£ä¸­çš„è„šæœ¬æœ‰ä¸‰ç§ç±»å‹ï¼š

1. **ç›´æ¥å‘½ä»¤** - å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œ
```bash
# ç¤ºä¾‹
dnf update -y
```

2. **é…ç½®æ–‡ä»¶** - éœ€è¦åˆ›å»ºæ–‡ä»¶åå¤åˆ¶å†…å®¹
```bash
# ç¤ºä¾‹
cat &gt; /etc/example.conf &lt;&lt;'EOF'
é…ç½®å†…å®¹
EOF
```

3. **å®Œæ•´è„šæœ¬** - å»ºè®®ä¿å­˜ä¸º .sh æ–‡ä»¶åæ‰§è¡Œ
```bash
# ç¤ºä¾‹
cat &gt; setup-script.sh &lt;&lt;'EOF'
#!/bin/bash
è„šæœ¬å†…å®¹
EOF
chmod +x setup-script.sh
./setup-script.sh
```

---

## ğŸŒŸ å›½å†…ç½‘ç»œä¼˜åŒ–

æœ¬æ–‡æ¡£é›†é’ˆå¯¹å›½å†…ç½‘ç»œç¯å¢ƒè¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼š

### è½¯ä»¶åŒ…é•œåƒæº

- **Rocky Linux**: é˜¿é‡Œäº‘ / æ¸…åå¤§å­¦é•œåƒ
- **Ubuntu**: æ¸…åå¤§å­¦ / ä¸­ç§‘å¤§é•œåƒ
- **Python pip**: æ¸…åå¤§å­¦ pypi é•œåƒ
- **Docker**: é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
- **Node.js/npm**: æ·˜å® npm é•œåƒ
- **Homebrew**: æ¸…åå¤§å­¦é•œåƒ

### ä¸‹è½½åŠ é€Ÿ

- **GitHub Release**: ä½¿ç”¨ ghproxy.com æˆ– mirror.ghproxy.com åŠ é€Ÿ
- **ISO é•œåƒ**: æä¾›å›½å†…é«˜é€Ÿä¸‹è½½é“¾æ¥
- **å®¹å™¨é•œåƒ**: é…ç½®å›½å†… Docker Hub é•œåƒ

### è™šæ‹ŸåŒ–é•œåƒä¸‹è½½

æ‰€æœ‰è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿ ISO æ–‡ä»¶éƒ½æä¾›å›½å†…é•œåƒç«™ä¸‹è½½é“¾æ¥ï¼š

- Ubuntu: mirrors.tuna.tsinghua.edu.cn
- Rocky Linux: mirrors.aliyun.com
- OpenWrt: mirrors.ustc.edu.cn

---

## ğŸ†˜ è·å–å¸®åŠ©

### å¸¸è§é—®é¢˜

å¤§éƒ¨åˆ†é—®é¢˜å¯ä»¥åœ¨ [14-troubleshooting.md](#section-14) ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚

### æ£€æŸ¥æ¸…å•

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·å…ˆæ£€æŸ¥ï¼š

1. âœ… CPU è™šæ‹ŸåŒ–æ˜¯å¦å·²åœ¨ BIOS ä¸­å¯ç”¨
2. âœ… ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
3. âœ… é˜²ç«å¢™è§„åˆ™æ˜¯å¦æ­£ç¡®
4. âœ… SELinux æ˜¯å¦æŒ‰æ–‡æ¡£é…ç½®
5. âœ… IP åœ°å€æ˜¯å¦å†²çª
6. âœ… å­˜å‚¨ç©ºé—´æ˜¯å¦å……è¶³

### ç³»ç»Ÿä¿¡æ¯æ”¶é›†

æé—®å‰è¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

```bash
# ç³»ç»Ÿä¿¡æ¯
hostnamectl

# è™šæ‹ŸåŒ–æ”¯æŒ
virt-host-validate

# ç£ç›˜ç©ºé—´
df -h
vgs
lvs

# ç½‘ç»œé…ç½®
ip addr
virsh net-list --all

# è™šæ‹ŸæœºçŠ¶æ€
virsh list --all
```

---

## ğŸ“Š ç‰ˆæœ¬å†å²

- **v1.0** (2026-02-24): åˆå§‹ç‰ˆæœ¬
  - å®Œæ•´çš„ KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»ºæŒ‡å—
  - 4 ä¸ªåŠŸèƒ½è™šæ‹Ÿæœºé…ç½®æ–¹æ¡ˆ
  - å›½å†…ç½‘ç»œç¯å¢ƒä¼˜åŒ–
  - å¤‡ä»½å’Œè¿ç»´æ–‡æ¡£

---

## ğŸ“„ è®¸å¯

æœ¬æ–‡æ¡£é›†ä¾›ä¸ªäººå­¦ä¹ å’Œä½¿ç”¨ï¼Œæ¬¢è¿åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚

---

## ğŸš¦ å¼€å§‹æ‚¨çš„æ—…ç¨‹

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬ä»ç¬¬ä¸€æ­¥å¼€å§‹ï¼š

ğŸ‘‰ **[01-host-init.md - å®¿ä¸»æœºåˆå§‹åŒ–é…ç½®](#section-1)**

ç¥æ‚¨æ­å»ºé¡ºåˆ©ï¼ğŸ‰




---



# 01 - å®¿ä¸»æœºåˆå§‹åŒ–é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨å®Œæˆ Rocky Linux 9 å®¿ä¸»æœºçš„åŸºç¡€é…ç½®ï¼ŒåŒ…æ‹¬ï¼š

- âœ… SSH å¯†é’¥è®¤è¯é…ç½®
- âœ… ç³»ç»Ÿæ›´æ–°å’Œè½¯ä»¶åŒ…ç®¡ç†
- âœ… å›½å†…é•œåƒæºé…ç½®
- âœ… é˜²ç«å¢™å’Œ SELinux é…ç½®
- âœ… å¿…è¦çš„ç³»ç»Ÿå·¥å…·å®‰è£…
- âœ… æ—¶åŒºå’Œ NTP æ—¶é—´åŒæ­¥

**é¢„è®¡è€—æ—¶**: 20 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â˜†â˜†â˜†

---

## ğŸ” æ­¥éª¤ 1: SSH å¯†é’¥è®¤è¯é…ç½®

### 1.1 åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

**Windows ç”¨æˆ·** (PowerShell):
```powershell
# æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯†é’¥
dir $env:USERPROFILE\.ssh

# å¦‚æœæ²¡æœ‰ï¼Œç”Ÿæˆæ–°å¯†é’¥
ssh-keygen -t ed25519 -C "your_email@example.com"
# æˆ–ä½¿ç”¨ RSAï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# ä¸€è·¯å›è½¦ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼Œå¯ä»¥è®¾ç½®å¯†ç æˆ–ç•™ç©º
```

**macOS/Linux ç”¨æˆ·**:
```bash
# æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯†é’¥
ls -la ~/.ssh

# å¦‚æœæ²¡æœ‰ï¼Œç”Ÿæˆæ–°å¯†é’¥
ssh-keygen -t ed25519 -C "your_email@example.com"
# æˆ–ä½¿ç”¨ RSA
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

### 1.2 å°†å…¬é’¥å¤åˆ¶åˆ°æœåŠ¡å™¨

**æ–¹æ³• A: ä½¿ç”¨ ssh-copy-id (æ¨èï¼ŒmacOS/Linux)**

```bash
# ä»¥ chris ç”¨æˆ·ç™»å½•
ssh-copy-id chris@192.168.71.200

# è¾“å…¥å¯†ç åï¼Œå…¬é’¥ä¼šè‡ªåŠ¨é…ç½®
```

**æ–¹æ³• B: æ‰‹åŠ¨å¤åˆ¶ (é€‚ç”¨äºæ‰€æœ‰ç³»ç»Ÿ)**

åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œï¼š
```bash
# Windows (PowerShell)
type $env:USERPROFILE\.ssh\id_ed25519.pub

# macOS/Linux
cat ~/.ssh/id_ed25519.pub
```

å¤åˆ¶è¾“å‡ºçš„å…¬é’¥å†…å®¹ï¼Œç„¶ååœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# SSH ç™»å½•åˆ°æœåŠ¡å™¨
ssh chris@192.168.71.200

# åˆ›å»º .ssh ç›®å½•å¹¶è®¾ç½®æƒé™
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# å°†å…¬é’¥æ·»åŠ åˆ° authorized_keys
cat &gt;&gt; ~/.ssh/authorized_keys &lt;&lt;'EOF'
[ç²˜è´´æ‚¨åˆšæ‰å¤åˆ¶çš„å…¬é’¥å†…å®¹]
EOF

# è®¾ç½®æ­£ç¡®çš„æƒé™
chmod 600 ~/.ssh/authorized_keys
```

### 1.3 æµ‹è¯• SSH å¯†é’¥ç™»å½•

```bash
# é€€å‡ºå½“å‰ä¼šè¯
exit

# é‡æ–°è¿æ¥ï¼Œåº”è¯¥ä¸éœ€è¦è¾“å…¥å¯†ç 
ssh chris@192.168.71.200

# å¦‚æœæˆåŠŸï¼Œæ‚¨åº”è¯¥ç›´æ¥ç™»å½•ï¼Œæ— éœ€å¯†ç 
```

### 1.4 ï¼ˆå¯é€‰ï¼‰ç¦ç”¨å¯†ç ç™»å½•ï¼Œä»…å…è®¸å¯†é’¥è®¤è¯

âš ï¸ **è­¦å‘Š**: åœ¨æ‰§è¡Œæ­¤æ­¥éª¤å‰ï¼Œè¯·ç¡®ä¿å¯†é’¥ç™»å½•å·²ç»æµ‹è¯•æˆåŠŸï¼

```bash
# åˆ‡æ¢åˆ° root ç”¨æˆ·
sudo su -

# å¤‡ä»½ SSH é…ç½®æ–‡ä»¶
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%F)

# ä¿®æ”¹é…ç½®
cat &gt;&gt; /etc/ssh/sshd_config.d/10-harden.conf &lt;&lt;'EOF'
# ç¦ç”¨å¯†ç è®¤è¯
PasswordAuthentication no
# ç¦ç”¨è´¨è¯¢å“åº”è®¤è¯
ChallengeResponseAuthentication no
# å¯ç”¨å…¬é’¥è®¤è¯
PubkeyAuthentication yes
# ç¦æ­¢ root ç›´æ¥ç™»å½•ï¼ˆå»ºè®®ï¼‰
PermitRootLogin no
EOF

# æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
sshd -t

# å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œé‡å¯ SSH æœåŠ¡
systemctl restart sshd

# é€€å‡º rootï¼Œä¿æŒå½“å‰ SSH è¿æ¥ä¸è¦æ–­å¼€
exit
```

### 1.5 éªŒè¯é…ç½®

**åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£**æµ‹è¯•æ–°è¿æ¥ï¼ˆä¸è¦å…³é—­å½“å‰è¿æ¥ï¼Œä»¥é˜²é…ç½®é”™è¯¯ï¼‰ï¼š

```bash
# æµ‹è¯•å¯†é’¥ç™»å½•
ssh chris@192.168.71.200

# å¦‚æœæˆåŠŸï¼Œé…ç½®å®Œæˆï¼
```

---

## ğŸ“¦ æ­¥éª¤ 2: é…ç½®å›½å†…é•œåƒæºï¼ˆæå‡ä¸‹è½½é€Ÿåº¦ï¼‰

### 2.1 å¤‡ä»½åŸæœ‰é…ç½®

```bash
# åˆ‡æ¢åˆ° root
sudo su -

# å¤‡ä»½åŸæœ‰çš„ repo é…ç½®
# æ³¨æ„ï¼šè™½ç„¶ç›®å½•åæ˜¯ yum.repos.dï¼ˆå†å²é—ç•™ï¼‰ï¼Œä½†å‘½ä»¤ä½¿ç”¨ dnf
# åœ¨ Rocky 9 ä¸­ï¼Œyum åªæ˜¯ dnf çš„è½¯é“¾æ¥
mkdir -p /etc/yum.repos.d/backup
mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/
```

### 2.2 é…ç½®é˜¿é‡Œäº‘é•œåƒæº

```bash
# åˆ›å»º Rocky Linux 9 é˜¿é‡Œäº‘é•œåƒé…ç½®
cat &gt; /etc/yum.repos.d/rocky-aliyun.repo &lt;&lt;'EOF'
[baseos]
name=Rocky Linux $releasever - BaseOS - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[appstream]
name=Rocky Linux $releasever - AppStream - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[extras]
name=Rocky Linux $releasever - Extras - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/extras/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[crb]
name=Rocky Linux $releasever - CRB - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/CRB/$basearch/os/
gpgcheck=1
enabled=0
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9
EOF
```

### 2.3 é…ç½® EPEL é•œåƒæºï¼ˆé¢å¤–è½¯ä»¶åŒ…ï¼‰

```bash
# å®‰è£… EPEL ä»“åº“
dnf install -y epel-release

# å¤‡ä»½ EPEL åŸå§‹é…ç½®
cp /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak

# ä½¿ç”¨é˜¿é‡Œäº‘ EPEL é•œåƒ
sed -i 's|^metalink=|#metalink=|g' /etc/yum.repos.d/epel.repo
sed -i 's|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|g' /etc/yum.repos.d/epel.repo
```

### 2.4 æ¸…ç†å¹¶é‡å»ºç¼“å­˜

```bash
# æ¸…ç†ç¼“å­˜
dnf clean all

# åˆ›å»ºç¼“å­˜
dnf makecache

# éªŒè¯é•œåƒæº
dnf repolist
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼š
```
repo id                    repo name
appstream                  Rocky Linux 9 - AppStream - Aliyun
baseos                     Rocky Linux 9 - BaseOS - Aliyun
epel                       Extra Packages for Enterprise Linux 9
extras                     Rocky Linux 9 - Extras - Aliyun
```

---

## ğŸ”„ æ­¥éª¤ 3: ç³»ç»Ÿæ›´æ–°

### 3.1 æ›´æ–°æ‰€æœ‰è½¯ä»¶åŒ…

```bash
# æ›´æ–°ç³»ç»Ÿï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰
dnf update -y

# æŸ¥çœ‹æ›´æ–°äº†å“ªäº›åŒ…
dnf history info last
```

### 3.2 å¦‚æœå†…æ ¸æ›´æ–°ï¼Œé‡å¯ç³»ç»Ÿ

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…æ ¸
dnf list kernel --installed

# å¦‚æœæ›´æ–°äº†å†…æ ¸ï¼Œé‡å¯ç³»ç»Ÿ
reboot

# ç­‰å¾…çº¦ 1 åˆ†é’Ÿåé‡æ–°è¿æ¥
# ssh chris@192.168.71.200

# éªŒè¯å†…æ ¸ç‰ˆæœ¬
uname -r
```

---

## ğŸ› ï¸ æ­¥éª¤ 4: å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·

### 4.1 å®‰è£…å¸¸ç”¨å·¥å…·åŒ…

```bash
sudo su -

# å®‰è£…å¼€å‘å·¥å…·å’Œå¸¸ç”¨è½¯ä»¶
dnf install -y \
    vim \
    wget \
    curl \
    git \
    htop \
    tmux \
    net-tools \
    bind-utils \
    telnet \
    traceroute \
    lsof \
    sysstat \
    iotop \
    ncdu \
    tree \
    rsync \
    bash-completion \
    policycoreutils-python-utils

# éªŒè¯å®‰è£…
which vim git htop
```

### 4.2 é…ç½® vim åŸºç¡€ç¯å¢ƒ

```bash
# ä¸º root ç”¨æˆ·é…ç½® vim
cat &gt; /root/.vimrc &lt;&lt;'EOF'
syntax on
set number
set tabstop=4
set shiftwidth=4
set expandtab
set autoindent
set smartindent
set showmatch
set hlsearch
set incsearch
set ignorecase
set smartcase
set encoding=utf-8
EOF

# ä¸º chris ç”¨æˆ·é…ç½® vim
cp /root/.vimrc /home/chris/.vimrc
chown chris:chris /home/chris/.vimrc
```

---

## â° æ­¥éª¤ 5: æ—¶åŒºå’Œæ—¶é—´åŒæ­¥é…ç½®

### 5.1 è®¾ç½®æ—¶åŒº

```bash
# æŸ¥çœ‹å½“å‰æ—¶åŒº
timedatectl

# è®¾ç½®ä¸ºä¸­å›½æ—¶åŒº
timedatectl set-timezone Asia/Shanghai

# éªŒè¯
timedatectl
date
```

### 5.2 é…ç½® NTP æ—¶é—´åŒæ­¥

```bash
# å®‰è£… chronyï¼ˆRocky 9 é»˜è®¤æ—¶é—´åŒæ­¥å·¥å…·ï¼‰
dnf install -y chrony

# å¤‡ä»½é…ç½®
cp /etc/chrony.conf /etc/chrony.conf.bak

# é…ç½®å›½å†… NTP æœåŠ¡å™¨
cat &gt; /etc/chrony.conf &lt;&lt;'EOF'
# ä½¿ç”¨é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘ NTP æœåŠ¡å™¨
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst
server ntp.tencent.com iburst
server cn.ntp.org.cn iburst

# æœ¬åœ°æ—¶é—´æº
driftfile /var/lib/chrony/drift

# å…è®¸ç³»ç»Ÿæ—¶é’Ÿå¤§å¹…è°ƒæ•´
makestep 1.0 3

# å¯ç”¨å†…æ ¸æ—¶é—´åŒæ­¥
rtcsync

# è®°å½•æ—¥å¿—
logdir /var/log/chrony
EOF

# å¯åŠ¨å¹¶å¯ç”¨ chrony æœåŠ¡
systemctl enable --now chronyd

# æŸ¥çœ‹åŒæ­¥çŠ¶æ€
chronyc sources -v
chronyc tracking
```

---

## ğŸ”¥ æ­¥éª¤ 6: é˜²ç«å¢™é…ç½®

### 6.1 æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€

```bash
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
systemctl status firewalld

# æŸ¥çœ‹å½“å‰è§„åˆ™
firewall-cmd --list-all
```

### 6.2 é…ç½®é˜²ç«å¢™è§„åˆ™

```bash
# ç¡®ä¿ SSH ç«¯å£å¼€æ”¾ï¼ˆé»˜è®¤å·²å¼€æ”¾ï¼‰
firewall-cmd --permanent --add-service=ssh

# å¼€æ”¾ Cockpit Web æ§åˆ¶å°ç«¯å£ï¼ˆåç»­ç›‘æ§éœ€è¦ï¼‰
firewall-cmd --permanent --add-service=cockpit

# å¼€æ”¾ KVM è™šæ‹Ÿæœºç®¡ç†ç«¯å£ï¼ˆå¦‚éœ€è¿œç¨‹ç®¡ç†ï¼‰
firewall-cmd --permanent --add-service=libvirt

# é‡è½½é˜²ç«å¢™è§„åˆ™
firewall-cmd --reload

# éªŒè¯è§„åˆ™
firewall-cmd --list-all
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
public (active)
  target: default
  services: cockpit dhcpv6-client libvirt ssh
  ...
```

---

## ğŸ›¡ï¸ æ­¥éª¤ 7: SELinux é…ç½®

### 7.1 æŸ¥çœ‹ SELinux çŠ¶æ€

```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
getenforce
sestatus
```

### 7.2 é…ç½® SELinux

å¯¹äº KVM è™šæ‹ŸåŒ–ç¯å¢ƒï¼Œå»ºè®®ä¿æŒ SELinux ä¸º **Permissive** æˆ– **Enforcing** æ¨¡å¼ã€‚

**é€‰é¡¹ A: ä¿æŒ Enforcingï¼ˆæ¨èï¼Œæ›´å®‰å…¨ï¼‰**

```bash
# ç¡®ä¿ SELinux å¤„äº enforcing æ¨¡å¼
setenforce 1

# æ°¸ä¹…è®¾ç½®
sed -i 's/^SELINUX=.*/SELINUX=enforcing/' /etc/selinux/config

# å®‰è£… SELinux ç®¡ç†å·¥å…·
dnf install -y policycoreutils-python-utils

# éªŒè¯
getenforce
```

**é€‰é¡¹ B: è®¾ç½®ä¸º Permissiveï¼ˆä»…è®°å½•ä¸é˜»æ­¢ï¼‰**

```bash
# è®¾ç½®ä¸º permissive æ¨¡å¼
setenforce 0

# æ°¸ä¹…è®¾ç½®
sed -i 's/^SELINUX=.*/SELINUX=permissive/' /etc/selinux/config

# éªŒè¯
getenforce
```

âš ï¸ **æ³¨æ„**: å¦‚æœæ‚¨æ˜¯ Linux æ–°æ‰‹ï¼Œå»ºè®®ä½¿ç”¨ Permissive æ¨¡å¼ï¼Œè¿™æ · SELinux ä¸ä¼šé˜»æ­¢æ“ä½œï¼Œåªä¼šè®°å½•è¿è§„ã€‚ç­‰ç†Ÿæ‚‰åå†åˆ‡æ¢åˆ° Enforcingã€‚

---

## ğŸ“Š æ­¥éª¤ 8: ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥

### 8.1 åˆ›å»ºç³»ç»Ÿä¿¡æ¯æŸ¥çœ‹è„šæœ¬

```bash
cat &gt; /usr/local/bin/sysinfo &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "         ç³»ç»Ÿä¿¡æ¯æ¦‚è§ˆ"
echo "========================================="
echo ""

echo "ä¸»æœºå: $(hostname)"
echo "ç³»ç»Ÿç‰ˆæœ¬: $(cat /etc/redhat-release)"
echo "å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
echo "è¿è¡Œæ—¶é—´: $(uptime -p)"
echo ""

echo "--- CPU ä¿¡æ¯ ---"
echo "å‹å·: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
echo "æ ¸å¿ƒæ•°: $(nproc) æ ¸å¿ƒ"
echo "è™šæ‹ŸåŒ–: $(lscpu | grep 'Virtualization' | cut -d: -f2 | xargs)"
echo ""

echo "--- å†…å­˜ä¿¡æ¯ ---"
free -h | grep -E 'Mem|Swap'
echo ""

echo "--- ç£ç›˜ä½¿ç”¨ ---"
df -h | grep -E 'Filesystem|^/dev'
echo ""

echo "--- ç½‘ç»œé…ç½® ---"
ip -br addr show | grep -E 'UP|192.168'
echo ""

echo "--- ç³»ç»Ÿè´Ÿè½½ ---"
uptime
echo ""

echo "========================================="
EOF

chmod +x /usr/local/bin/sysinfo
```

### 8.2 è¿è¡Œç³»ç»Ÿä¿¡æ¯è„šæœ¬

```bash
sysinfo
```

### 8.3 éªŒè¯è™šæ‹ŸåŒ–æ”¯æŒ

```bash
# æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–
lscpu | grep Virtualization

# AMD CPU åº”è¯¥æ˜¾ç¤º: AMD-V
# Intel CPU åº”è¯¥æ˜¾ç¤º: VT-x

# æ£€æŸ¥å†…æ ¸æ¨¡å—
lsmod | grep kvm

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œå°è¯•åŠ è½½æ¨¡å—
modprobe kvm
modprobe kvm_amd  # AMD CPU
# æˆ–
modprobe kvm_intel  # Intel CPU
```

---

## âœ… æ­¥éª¤ 9: éªŒè¯é…ç½®

### 9.1 åˆ›å»ºé…ç½®éªŒè¯è„šæœ¬

```bash
cat &gt; /root/verify-host-init.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       å®¿ä¸»æœºé…ç½®éªŒè¯"
echo "========================================="
echo ""

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

check_pass() {
    echo -e "${GREEN}âœ“${NC} $1"
}

check_fail() {
    echo -e "${RED}âœ—${NC} $1"
}

# 1. SSH å¯†é’¥é…ç½®
echo "1. æ£€æŸ¥ SSH é…ç½®..."
if grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config* 2&gt;/dev/null; then
    check_pass "SSH å¯†é’¥è®¤è¯å·²é…ç½®"
else
    check_fail "SSH å¯†ç è®¤è¯ä»ç„¶å¯ç”¨ï¼ˆå¯é€‰é¡¹ï¼‰"
fi

# 2. é•œåƒæºé…ç½®
echo "2. æ£€æŸ¥é•œåƒæº..."
if grep -q "aliyun.com" /etc/yum.repos.d/*.repo 2&gt;/dev/null; then
    check_pass "å›½å†…é•œåƒæºå·²é…ç½®"
else
    check_fail "æœªé…ç½®å›½å†…é•œåƒæº"
fi

# 3. ç³»ç»Ÿæ›´æ–°
echo "3. æ£€æŸ¥ç³»ç»Ÿæ›´æ–°..."
if dnf check-update &amp;&gt;/dev/null; then
    check_pass "ç³»ç»Ÿå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
else
    updates=$(dnf check-update 2&gt;/dev/null | grep -E '^[a-z]' | wc -l)
    if [ $updates -eq 0 ]; then
        check_pass "ç³»ç»Ÿå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    else
        check_fail "æœ‰ $updates ä¸ªè½¯ä»¶åŒ…å¯æ›´æ–°"
    fi
fi

# 4. æ—¶é—´åŒæ­¥
echo "4. æ£€æŸ¥æ—¶é—´åŒæ­¥..."
if systemctl is-active chronyd &amp;&gt;/dev/null; then
    check_pass "æ—¶é—´åŒæ­¥æœåŠ¡è¿è¡Œä¸­"
else
    check_fail "æ—¶é—´åŒæ­¥æœåŠ¡æœªè¿è¡Œ"
fi

# 5. é˜²ç«å¢™
echo "5. æ£€æŸ¥é˜²ç«å¢™..."
if systemctl is-active firewalld &amp;&gt;/dev/null; then
    check_pass "é˜²ç«å¢™è¿è¡Œä¸­"
    if firewall-cmd --list-services | grep -q cockpit; then
        check_pass "Cockpit ç«¯å£å·²å¼€æ”¾"
    else
        check_fail "Cockpit ç«¯å£æœªå¼€æ”¾"
    fi
else
    check_fail "é˜²ç«å¢™æœªè¿è¡Œ"
fi

# 6. SELinux
echo "6. æ£€æŸ¥ SELinux..."
selinux_status=$(getenforce)
if [ "$selinux_status" == "Enforcing" ] || [ "$selinux_status" == "Permissive" ]; then
    check_pass "SELinux çŠ¶æ€: $selinux_status"
else
    check_fail "SELinux çŠ¶æ€: $selinux_status"
fi

# 7. è™šæ‹ŸåŒ–æ”¯æŒ
echo "7. æ£€æŸ¥è™šæ‹ŸåŒ–æ”¯æŒ..."
if lscpu | grep -q 'AMD-V\|VT-x'; then
    virt_type=$(lscpu | grep Virtualization | cut -d: -f2 | xargs)
    check_pass "CPU è™šæ‹ŸåŒ–æ”¯æŒ: $virt_type"
else
    check_fail "CPU è™šæ‹ŸåŒ–æœªå¯ç”¨ï¼ˆéœ€åœ¨ BIOS ä¸­å¯ç”¨ï¼‰"
fi

echo ""
echo "========================================="
echo "éªŒè¯å®Œæˆï¼"
echo "========================================="
EOF

chmod +x /root/verify-host-init.sh
```

### 9.2 è¿è¡ŒéªŒè¯è„šæœ¬

```bash
/root/verify-host-init.sh
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

å®Œæˆæœ¬æ–‡æ¡£åï¼Œæ‚¨åº”è¯¥å·²ç»é…ç½®å¥½ï¼š

- [x] SSH å¯†é’¥è®¤è¯ç™»å½•
- [x] ï¼ˆå¯é€‰ï¼‰ç¦ç”¨å¯†ç ç™»å½•
- [x] å›½å†…é•œåƒæºï¼ˆé˜¿é‡Œäº‘/æ¸…åï¼‰
- [x] ç³»ç»Ÿæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- [x] å¸¸ç”¨å¼€å‘å·¥å…·å’Œç®¡ç†å·¥å…·
- [x] æ—¶åŒºè®¾ç½®ä¸º Asia/Shanghai
- [x] NTP æ—¶é—´åŒæ­¥
- [x] é˜²ç«å¢™è§„åˆ™ï¼ˆSSH + Cockpitï¼‰
- [x] SELinux é…ç½®
- [x] éªŒè¯ CPU è™šæ‹ŸåŒ–æ”¯æŒ

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: SSH å¯†é’¥ç™»å½•å¤±è´¥

**ç—‡çŠ¶**: é…ç½®å¯†é’¥åä»ç„¶è¦æ±‚è¾“å…¥å¯†ç 

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æƒé™
ls -la ~/.ssh
# .ssh ç›®å½•åº”è¯¥æ˜¯ 700
# authorized_keys åº”è¯¥æ˜¯ 600

# ä¿®å¤æƒé™
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

# æŸ¥çœ‹ SSH æ—¥å¿—
sudo tail -f /var/log/secure

# å°è¯•è¿æ¥æ—¶æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
ssh -v chris@192.168.71.200
```

### é—®é¢˜ 2: é•œåƒæºé…ç½®åä»ç„¶å¾ˆæ…¢

**ç—‡çŠ¶**: dnf ä¸‹è½½é€Ÿåº¦ä»ç„¶å¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å°è¯•æ¸…åå¤§å­¦é•œåƒæº
sed -i 's|mirrors.aliyun.com|mirrors.tuna.tsinghua.edu.cn|g' /etc/yum.repos.d/*.repo

# æ¸…ç†å¹¶é‡å»ºç¼“å­˜
dnf clean all
dnf makecache
```

### é—®é¢˜ 3: CPU è™šæ‹ŸåŒ–æœªæ£€æµ‹åˆ°

**ç—‡çŠ¶**: `lscpu | grep Virtualization` æ— è¾“å‡º

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. ç¡®è®¤ CPU æ”¯æŒè™šæ‹ŸåŒ–
cat /proc/cpuinfo | grep -E 'vmx|svm'

# vmx = Intel VT-x
# svm = AMD-V

# 2. å¦‚æœæœ‰è¾“å‡ºä½† lscpu æ²¡æœ‰ï¼Œéœ€è¦åœ¨ BIOS ä¸­å¯ç”¨è™šæ‹ŸåŒ–
# AMD: æŸ¥æ‰¾ "SVM Mode" æˆ– "AMD-V"
# Intel: æŸ¥æ‰¾ "Intel VT-x" æˆ– "Virtualization Technology"

# 3. å¯ç”¨åé‡å¯ç³»ç»ŸéªŒè¯
reboot
```

### é—®é¢˜ 4: æ—¶é—´åŒæ­¥å¤±è´¥

**ç—‡çŠ¶**: chronyc æ— æ³•åŒæ­¥æ—¶é—´

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ chronyd çŠ¶æ€
systemctl status chronyd

# æŸ¥çœ‹åŒæ­¥æº
chronyc sources

# å¦‚æœå…¨éƒ¨æ˜¾ç¤º ^?, æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --add-service=ntp --permanent
firewall-cmd --reload

# æ‰‹åŠ¨å¼ºåˆ¶åŒæ­¥
chronyc -a makestep

# æŸ¥çœ‹åŒæ­¥çŠ¶æ€
chronyc tracking
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»å®Œæˆäº†å®¿ä¸»æœºçš„åŸºç¡€é…ç½®ã€‚

ç°åœ¨æ‚¨å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ï¼š

ğŸ‘‰ **[02-kvm-setup.md - KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»º](#section-2)**

---

## ğŸ’¡ è¡¥å……è¯´æ˜

### ä¸ºä»€ä¹ˆè¦é…ç½®å›½å†…é•œåƒæºï¼Ÿ

- **ä¸‹è½½é€Ÿåº¦**: å›½å¤–æºåœ¨å›½å†…è®¿é—®é€Ÿåº¦å¾ˆæ…¢ï¼Œé…ç½®å›½å†…é•œåƒæºå¯ä»¥å°†ä¸‹è½½é€Ÿåº¦ä» 100KB/s æå‡åˆ° 10MB/s ä»¥ä¸Š
- **ç¨³å®šæ€§**: å‡å°‘å› ç½‘ç»œé—®é¢˜å¯¼è‡´çš„å®‰è£…å¤±è´¥
- **èŠ‚çœæ—¶é—´**: å¤§å¹…ç¼©çŸ­è½¯ä»¶å®‰è£…å’Œç³»ç»Ÿæ›´æ–°æ—¶é—´

### SSH å¯†é’¥ vs å¯†ç ç™»å½•

| ç‰¹æ€§ | å¯†é’¥è®¤è¯ | å¯†ç è®¤è¯ |
|------|----------|----------|
| å®‰å…¨æ€§ | â­â­â­â­â­ | â­â­â­â˜†â˜† |
| ä¾¿åˆ©æ€§ | â­â­â­â­â­ | â­â­â­â˜†â˜† |
| æŠ—æš´åŠ›ç ´è§£ | â­â­â­â­â­ | â­â­â˜†â˜†â˜† |
| é…ç½®éš¾åº¦ | â­â­â­â˜†â˜† | â­â˜†â˜†â˜†â˜† |

**å»ºè®®**: å®¶åº­æœåŠ¡å™¨å»ºè®®ä½¿ç”¨å¯†é’¥è®¤è¯ï¼Œæ›´å®‰å…¨ä¸”ä¸éœ€è¦æ¯æ¬¡è¾“å…¥å¯†ç ã€‚

### SELinux æ¨¡å¼é€‰æ‹©

- **Enforcing**: æœ€å®‰å…¨ï¼Œå¼ºåˆ¶æ‰§è¡Œç­–ç•¥ï¼Œå¯èƒ½é˜»æ­¢æŸäº›æ“ä½œ
- **Permissive**: æŠ˜ä¸­æ–¹æ¡ˆï¼Œåªè®°å½•è¿è§„ä¸é˜»æ­¢ï¼Œé€‚åˆå­¦ä¹ 
- **Disabled**: ä¸æ¨èï¼Œé™¤éç‰¹æ®Šéœ€æ±‚

**å»ºè®®**: æ–°æ‰‹ä½¿ç”¨ Permissiveï¼Œç†Ÿæ‚‰ååˆ‡æ¢åˆ° Enforcingã€‚

### YUM vs DNF

è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„ç–‘é—®ï¼š

**åœ¨ Rocky Linux 9 ä¸­**:
- **DNF** (Dandified YUM) æ˜¯çœŸæ­£çš„åŒ…ç®¡ç†å™¨
- **YUM** åªæ˜¯æŒ‡å‘ DNF çš„è½¯é“¾æ¥ï¼ˆä¸ºäº†å‘åå…¼å®¹ï¼‰
- é…ç½®ç›®å½•ä»å« `/etc/yum.repos.d/`ï¼ˆå†å²é—ç•™å‘½åï¼‰

```bash
# éªŒè¯ yum æ˜¯ dnf çš„è½¯é“¾æ¥
ls -l /usr/bin/yum
# è¾“å‡ºï¼š/usr/bin/yum -&gt; dnf-3

# ä¸¤ä¸ªå‘½ä»¤å®Œå…¨ç­‰ä»·
yum install package  # å®é™…è°ƒç”¨ dnf
dnf install package  # ç›´æ¥è°ƒç”¨ dnf
```

**ä¸ºä»€ä¹ˆç›®å½•è¿˜å« yum.repos.dï¼Ÿ**
- å†å²å…¼å®¹æ€§ï¼šé¿å…ç ´åç°æœ‰è„šæœ¬å’Œæ–‡æ¡£
- é€šç”¨çº¦å®šï¼šæ‰€æœ‰ RHEL ç³»åˆ—éƒ½ç”¨è¿™ä¸ªç›®å½•å
- å®é™…ä¸å½±å“ä½¿ç”¨ï¼šDNF ä¼šè‡ªåŠ¨è¯»å–è¯¥ç›®å½•

**æœ€ä½³å®è·µ**:
- âœ… å‘½ä»¤ä½¿ç”¨ `dnf`ï¼ˆæ›´æ˜ç¡®ï¼Œæ¨èï¼‰
- âœ… é…ç½®ç›®å½•ä»æ˜¯ `/etc/yum.repos.d/`ï¼ˆç³»ç»Ÿæ ‡å‡†ï¼‰
- âš ï¸ ä¸è¦è¢«ç›®å½•åå›°æƒ‘ï¼Œå®ƒä»¬æ˜¯åŒä¸€ä¸ªä¸œè¥¿

æœ¬æ–‡æ¡£ç»Ÿä¸€ä½¿ç”¨ `dnf` å‘½ä»¤ï¼Œä½†é…ç½®ç›®å½•ä»ç„¶æ˜¯ `yum.repos.d`ã€‚




---



# 02 - KVM è™šæ‹ŸåŒ–ç¯å¢ƒæ­å»º

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨åœ¨ Rocky Linux 9 ä¸Šå®‰è£…å’Œé…ç½® KVM (Kernel-based Virtual Machine) è™šæ‹ŸåŒ–ç¯å¢ƒï¼ŒåŒ…æ‹¬ï¼š

- âœ… éªŒè¯ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ
- âœ… å®‰è£… KVM/QEMU å’Œç›¸å…³å·¥å…·
- âœ… é…ç½® libvirt æœåŠ¡
- âœ… åˆ›å»ºç½‘æ¡¥ (Bridge) ç½‘ç»œ
- âœ… å®‰è£…è™šæ‹Ÿæœºç®¡ç†å·¥å…·
- âœ… éªŒè¯ KVM ç¯å¢ƒ

**å‰ç½®æ¡ä»¶**: å·²å®Œæˆ [01-host-init.md](#section-1)  
**é¢„è®¡è€—æ—¶**: 30 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†

---

## ğŸ” æ­¥éª¤ 1: éªŒè¯è™šæ‹ŸåŒ–æ”¯æŒ

### 1.1 æ£€æŸ¥ CPU è™šæ‹ŸåŒ–æ‰©å±•

```bash
# æ–¹æ³• 1: ä½¿ç”¨ lscpu
lscpu | grep Virtualization

# AMD CPU åº”è¯¥æ˜¾ç¤º: Virtualization:      AMD-V
# Intel CPU åº”è¯¥æ˜¾ç¤º: Virtualization:   VT-x

# æ–¹æ³• 2: æ£€æŸ¥ CPU flags
grep -E 'vmx|svm' /proc/cpuinfo

# vmx = Intel VT-x
# svm = AMD-V
# å¦‚æœæœ‰å¤§é‡è¾“å‡ºï¼Œè¯´æ˜è™šæ‹ŸåŒ–å·²å¯ç”¨
```

### 1.2 æ£€æŸ¥å†…æ ¸ KVM æ¨¡å—

```bash
# æ£€æŸ¥ KVM æ¨¡å—æ˜¯å¦å·²åŠ è½½
lsmod | grep kvm

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œæ‰‹åŠ¨åŠ è½½æ¨¡å—
sudo modprobe kvm
sudo modprobe kvm_amd   # å¯¹äº AMD CPU (R5 5600G)
# æˆ–
# sudo modprobe kvm_intel  # å¯¹äº Intel CPU

# å†æ¬¡æ£€æŸ¥
lsmod | grep kvm
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
kvm_amd               188416  0
kvm                  1282048  1 kvm_amd
```

### 1.3 éªŒè¯ KVM è®¾å¤‡

```bash
# æ£€æŸ¥ KVM è®¾å¤‡æ–‡ä»¶
ls -l /dev/kvm

# åº”è¯¥æ˜¾ç¤º:
# crw-rw-rw-. 1 root kvm 10, 232 xxx /dev/kvm
```

---

## ğŸ“¦ æ­¥éª¤ 2: å®‰è£… KVM å’Œè™šæ‹ŸåŒ–å·¥å…·

### 2.1 å®‰è£… KVM ç›¸å…³è½¯ä»¶åŒ…

```bash
sudo su -

# å®‰è£…è™šæ‹ŸåŒ–è½¯ä»¶åŒ…ç»„
dnf groupinstall -y "Virtualization Host"

# æˆ–è€…æ‰‹åŠ¨å®‰è£…æ ¸å¿ƒç»„ä»¶
dnf install -y \
    qemu-kvm \
    libvirt \
    libvirt-daemon-kvm \
    libvirt-daemon-config-network \
    libvirt-daemon-config-nwfilter \
    virt-install \
    virt-viewer \
    virt-manager \
    libguestfs-tools \
    libguestfs-xfs \
    python3-libvirt \
    bridge-utils \
    net-tools
```

### 2.2 éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥ QEMU ç‰ˆæœ¬
qemu-kvm --version

# æ£€æŸ¥ libvirt ç‰ˆæœ¬
libvirtd --version

# æ£€æŸ¥ virt-install
virt-install --version
```

---

## ğŸ”§ æ­¥éª¤ 3: é…ç½® libvirt æœåŠ¡

### 3.1 å¯åŠ¨ libvirt æœåŠ¡

```bash
# å¯åŠ¨ libvirtd
systemctl start libvirtd

# è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable libvirtd

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status libvirtd
```

### 3.2 é…ç½® libvirt ç”¨æˆ·ç»„

```bash
# å°† chris ç”¨æˆ·æ·»åŠ åˆ° libvirt ç»„ï¼ˆå…è®¸ç®¡ç†è™šæ‹Ÿæœºï¼‰
usermod -aG libvirt chris

# å°† chris ç”¨æˆ·æ·»åŠ åˆ° kvm ç»„
usermod -aG kvm chris

# éªŒè¯
groups chris
```

### 3.3 é…ç½® libvirt ç½‘ç»œ

```bash
# æŸ¥çœ‹é»˜è®¤ç½‘ç»œ
virsh net-list --all

# åº”è¯¥çœ‹åˆ° default ç½‘ç»œ
# å¦‚æœ default ç½‘ç»œä¸æ´»è·ƒï¼Œå¯åŠ¨å®ƒ
virsh net-start default
virsh net-autostart default

# éªŒè¯
virsh net-list --all
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
 åç§°      çŠ¶æ€    è‡ªåŠ¨å¼€å§‹  æŒä¹…
---------------------------------------
 default   æ´»åŠ¨    æ˜¯        æ˜¯
```

âš ï¸ **æ³¨æ„**: default ç½‘ç»œæ˜¯ NAT æ¨¡å¼ï¼Œæˆ‘ä»¬åç»­ä¼šåˆ›å»º Bridge æ¨¡å¼ç½‘ç»œï¼Œä½†ä¿ç•™ default ç½‘ç»œä½œä¸ºå¤‡é€‰ã€‚

---

## ğŸ’¡ libvirt å·¥ä½œåŸç†è¯¦è§£

### ä»€ä¹ˆæ˜¯ libvirtï¼Ÿ

**libvirt** æ˜¯ä¸€ä¸ªè™šæ‹ŸåŒ–ç®¡ç†æŠ½è±¡å±‚ï¼Œå®ƒåœ¨ KVM/QEMU ä¹‹ä¸Šæä¾›ç»Ÿä¸€çš„ç®¡ç†æ¥å£ï¼š

```
ç”¨æˆ·æ“ä½œå±‚:
  virsh å‘½ä»¤ / virt-install / virt-manager
         |
         â†“
  libvirt API (ç»Ÿä¸€æ¥å£)
         |
         â†“
  libvirtd å®ˆæŠ¤è¿›ç¨‹ (/var/run/libvirt/libvirt-sock)
         |
         â†“
  QEMU/KVM (å®é™…çš„è™šæ‹ŸåŒ–å¼•æ“)
         |
         â†“
  ç¡¬ä»¶è™šæ‹ŸåŒ– (CPU VT-x/AMD-V)
```

### libvirt çš„æ ¸å¿ƒåŠŸèƒ½

1. **ç»Ÿä¸€çš„è™šæ‹ŸåŒ–ç®¡ç†æ¥å£**
   - æ”¯æŒå¤šç§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼šKVMã€Xenã€VMwareã€VirtualBox ç­‰
   - æä¾›ä¸€è‡´çš„ API å’Œå‘½ä»¤è¡Œå·¥å…·
   - è™šæ‹Ÿæœºé…ç½®ä»¥ XML æ ¼å¼å­˜å‚¨åœ¨ `/etc/libvirt/qemu/`

2. **èµ„æºç®¡ç†**
   - **è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸ**ï¼šåˆ›å»ºã€å¯åŠ¨ã€æš‚åœã€å…³é—­ã€åˆ é™¤
   - **ç½‘ç»œç®¡ç†**ï¼šè™šæ‹Ÿç½‘ç»œã€ç½‘æ¡¥ã€NAT
   - **å­˜å‚¨ç®¡ç†**ï¼šå­˜å‚¨æ± ã€å·ã€ç£ç›˜é•œåƒ
   - **å¿«ç…§ç®¡ç†**ï¼šåˆ›å»ºå’Œæ¢å¤è™šæ‹Ÿæœºå¿«ç…§

3. **æƒé™æ§åˆ¶ç³»ç»Ÿ**

   **libvirtd æœåŠ¡å¯åŠ¨å**ï¼š
   ```bash
   # åˆ›å»º Unix socket ç”¨äºé€šä¿¡
   /var/run/libvirt/libvirt-sock  (å±äº libvirt ç»„)
   
   # æä¾› KVM è®¾å¤‡è®¿é—®
   /dev/kvm  (å±äº kvm ç»„)
   ```

   **ç”¨æˆ·ç»„æƒé™è¯´æ˜**ï¼š
   - `libvirt` ç»„ï¼šå…è®¸é€šè¿‡ socket è¿æ¥ libvirtdï¼Œæ‰§è¡Œè™šæ‹Ÿæœºç®¡ç†æ“ä½œ
   - `kvm` ç»„ï¼šå…è®¸ç›´æ¥è®¿é—® `/dev/kvm` è®¾å¤‡
   - ä¸åœ¨è¿™äº›ç»„çš„ç”¨æˆ·æ— æ³•ä½¿ç”¨ `virsh` ç­‰å·¥å…·

### default ç½‘ç»œï¼ˆNAT æ¨¡å¼ï¼‰å·¥ä½œåŸç†

å½“æ‰§è¡Œ `virsh net-start default` æ—¶ï¼Œlibvirt ä¼šï¼š

1. **åˆ›å»ºè™šæ‹Ÿç½‘æ¡¥** `virbr0`ï¼ˆlibvirt ä¸“ç”¨ï¼Œä¸ç‰©ç†ç½‘å¡æ— å…³ï¼‰
2. **åˆ†é…ç§æœ‰ç½‘æ®µ**ï¼ˆé€šå¸¸æ˜¯ 192.168.122.0/24ï¼‰
3. **å¯åŠ¨ dnsmasq æœåŠ¡**ï¼š
   - ä¸ºè™šæ‹Ÿæœºæä¾› DHCPï¼ˆè‡ªåŠ¨åˆ†é… IPï¼‰
   - æä¾› DNS è§£ææœåŠ¡
4. **é…ç½® iptables NAT è§„åˆ™**ï¼š
   ```
   è™šæ‹Ÿæœº (192.168.122.10)
     â†’ virbr0 ç½‘æ¡¥
     â†’ NAT è½¬æ¢ï¼ˆä½¿ç”¨å®¿ä¸»æœº IPï¼‰
     â†’ å®¿ä¸»æœºç‰©ç†ç½‘å¡
     â†’ å¤–éƒ¨ç½‘ç»œ
   ```

**NAT æ¨¡å¼ç‰¹ç‚¹**ï¼š
- âœ… é…ç½®ç®€å•ï¼Œå¼€ç®±å³ç”¨
- âœ… è™šæ‹Ÿæœºå¯ä»¥è®¿é—®å¤–ç½‘
- âŒ å¤–éƒ¨ç½‘ç»œæ— æ³•ç›´æ¥è®¿é—®è™šæ‹Ÿæœºï¼ˆéœ€è¦ç«¯å£è½¬å‘ï¼‰
- âŒ è™šæ‹Ÿæœº IP ä¸å±€åŸŸç½‘è®¾å¤‡ä¸åœ¨åŒä¸€ç½‘æ®µ

**ä¸ºä»€ä¹ˆä¿ç•™ default ç½‘ç»œï¼Ÿ**
- ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼šBridge æ¨¡å¼é…ç½®å¤±è´¥æ—¶å¯ç”¨
- æµ‹è¯•ç¯å¢ƒï¼šéš”ç¦»çš„æµ‹è¯•è™šæ‹Ÿæœºä¸éœ€è¦å¤–éƒ¨è®¿é—®

---

## ğŸŒ‰ æ­¥éª¤ 4: åˆ›å»ºç½‘æ¡¥ (Bridge) ç½‘ç»œ

### 4.1 æŸ¥çœ‹å½“å‰ç½‘ç»œé…ç½®

```bash
# æŸ¥çœ‹ç½‘ç»œæ¥å£
ip addr show

# æŸ¥çœ‹å½“å‰ç½‘ç»œè¿æ¥
nmcli connection show

# è®°å½•å½“å‰ç‰©ç†ç½‘å¡åç§°ï¼ˆé€šå¸¸æ˜¯ eno1, enp1s0, eth0 ç­‰ï¼‰
# å‡è®¾æ‚¨çš„ç½‘å¡æ˜¯ enp1s0
```

### 4.2 åˆ›å»ºç½‘æ¡¥é…ç½®

âš ï¸ **é‡è¦**: ä»¥ä¸‹æ“ä½œä¼šçŸ­æš‚ä¸­æ–­ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿æ‚¨æ˜¯é€šè¿‡æœ¬åœ°æ“ä½œæˆ–æœ‰å¤‡ç”¨è¿æ¥æ–¹å¼ï¼

**é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€**ï¼š
- **æ–¹å¼ Aï¼ˆæ¨èï¼‰**ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆè§ 4.2.1ï¼‰- æ›´å®‰å…¨ï¼Œå¸¦å¤‡ä»½å’Œå›æ»š
- **æ–¹å¼ B**ï¼šæ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ï¼ˆè§ 4.2.2ï¼‰- é€‚åˆç†è§£æ¯ä¸€æ­¥æ“ä½œ

#### 4.2.1 ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬åˆ›å»ºç½‘æ¡¥ï¼ˆæ¨èï¼‰

**æ­¥éª¤ 1ï¼šåˆ›å»ºè„šæœ¬æ–‡ä»¶**

```bash
# åˆ›å»ºè„šæœ¬
cat &gt; /root/create-bridge.sh &lt;&lt;'EOF'
#!/bin/bash
# è„šæœ¬åç§°ï¼šcreate-bridge.sh
# åŠŸèƒ½ï¼šåˆ›å»º KVM ç½‘æ¡¥é…ç½®
# ä½¿ç”¨æ–¹æ³•ï¼š
#   1. ä¿®æ”¹ä¸‹æ–¹ã€é…ç½®åŒºã€‘çš„å˜é‡
#   2. ä»¥ root è¿è¡Œï¼šsudo bash create-bridge.sh
#   3. ç¡®è®¤å‚æ•°åè¾“å…¥ yes
#   4. å¦‚æœå‡ºé”™ï¼Œè¿è¡Œç”Ÿæˆçš„ rollback-bridge.sh æ¢å¤

#==================== é…ç½®åŒº ====================
# â¬‡ï¸ è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹è¿™é‡Œ
BRIDGE_NAME="br0"
PHYSICAL_INTERFACE="enp1s0"     # ç‰©ç†ç½‘å¡åç§°
HOST_IP="192.168.71.200"        # å®¿ä¸»æœºIP
GATEWAY="192.168.71.1"          # ç½‘å…³
DNS1="192.168.71.1"             # ä¸»DNS
DNS2="223.5.5.5"                # å¤‡ç”¨DNSï¼ˆé˜¿é‡Œï¼‰
#================================================

# é¢œè‰²å®šä¹‰ï¼ˆç¾åŒ–è¾“å‡ºï¼‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ£€æŸ¥ root æƒé™
if [[ $EUID -ne 0 ]]; then
   log_error "å¿…é¡»ä»¥ root è¿è¡Œæ­¤è„šæœ¬"
   echo "è¯·ä½¿ç”¨: sudo bash $0"
   exit 1
fi

# æ˜¾ç¤ºé…ç½®æ‘˜è¦
echo "========================================="
echo "    KVM ç½‘æ¡¥é…ç½®è„šæœ¬"
echo "========================================="
echo ""
echo "å³å°†æ‰§è¡Œä»¥ä¸‹é…ç½®ï¼š"
echo "  ç½‘æ¡¥åç§°:     $BRIDGE_NAME"
echo "  ç‰©ç†ç½‘å¡:     $PHYSICAL_INTERFACE"
echo "  å®¿ä¸»æœºIP:     $HOST_IP/24"
echo "  ç½‘å…³åœ°å€:     $GATEWAY"
echo "  DNS æœåŠ¡å™¨:   $DNS1, $DNS2"
echo ""
log_warn "âš ï¸  æ­¤æ“ä½œå°†ä¿®æ”¹ç½‘ç»œé…ç½®ï¼Œå¯èƒ½å¯¼è‡´çŸ­æš‚æ–­ç½‘"
echo ""

# SSH ä¼šè¯æ£€æµ‹
if [ -n "$SSH_CONNECTION" ]; then
    log_warn "âš ï¸  æ£€æµ‹åˆ°æ‚¨é€šè¿‡ SSH è¿æ¥ï¼"
    echo "     å¦‚æœé…ç½®å¤±è´¥ï¼ŒSSH ä¼šè¯å°†æ–­å¼€"
    echo "     å»ºè®®å‡†å¤‡å¥½ç‰©ç†è®¿é—®æˆ–å¸¦å¤–ç®¡ç†"
    echo ""
fi

# ç”¨æˆ·ç¡®è®¤
read -p "æ˜¯å¦ç»§ç»­ï¼Ÿè¾“å…¥ yes ç¡®è®¤: " CONFIRM
if [[ "$CONFIRM" != "yes" ]]; then
    log_info "æ“ä½œå·²å–æ¶ˆ"
    exit 0
fi

echo ""
log_info "å¼€å§‹æ‰§è¡Œ..."

# 1. å¤‡ä»½å½“å‰é…ç½®
BACKUP_DIR="/root/network-backup-$(date +%Y%m%d-%H%M%S)"
log_info "å¤‡ä»½ç½‘ç»œé…ç½®åˆ°: $BACKUP_DIR"
cp -r /etc/NetworkManager/system-connections/ "$BACKUP_DIR"
log_success "å¤‡ä»½å®Œæˆ"

# 2. ç”Ÿæˆå›æ»šè„šæœ¬
ROLLBACK_SCRIPT="/root/rollback-bridge.sh"
log_info "ç”Ÿæˆå›æ»šè„šæœ¬: $ROLLBACK_SCRIPT"

cat &gt; "$ROLLBACK_SCRIPT" &lt;&lt;'ROLLBACK_EOF'
#!/bin/bash
# ç½‘æ¡¥é…ç½®å›æ»šè„šæœ¬
# è‡ªåŠ¨ç”Ÿæˆäº: $(date)

echo "æ­£åœ¨å›æ»šç½‘æ¡¥é…ç½®..."

# åˆ é™¤ç½‘æ¡¥è¿æ¥
nmcli connection delete br0 2&gt;/dev/null
nmcli connection delete br0-slave 2&gt;/dev/null

# æ¢å¤å¤‡ä»½ï¼ˆéœ€è¦æ‰‹åŠ¨æŒ‡å®šå¤‡ä»½ç›®å½•ï¼‰
echo "è¯·æ‰‹åŠ¨æ¢å¤å¤‡ä»½ï¼š"
echo "  cp -r BACKUP_DIR/* /etc/NetworkManager/system-connections/"
echo "  nmcli connection reload"
echo "  systemctl restart NetworkManager"

echo "æˆ–è€…é‡æ–°é…ç½®åŸç½‘å¡ï¼š"
echo "  nmcli connection add type ethernet con-name PHYSICAL_INTERFACE ifname PHYSICAL_INTERFACE"
ROLLBACK_EOF

chmod +x "$ROLLBACK_SCRIPT"
log_success "å›æ»šè„šæœ¬å·²ç”Ÿæˆ"

# 3. åˆ›å»ºç½‘æ¡¥
log_info "åˆ›å»ºç½‘æ¡¥ $BRIDGE_NAME..."
nmcli connection add type bridge \
    con-name "$BRIDGE_NAME" \
    ifname "$BRIDGE_NAME" \
    ipv4.method manual \
    ipv4.addresses "$HOST_IP/24" \
    ipv4.gateway "$GATEWAY" \
    ipv4.dns "$DNS1 $DNS2"

if [ $? -eq 0 ]; then
    log_success "ç½‘æ¡¥åˆ›å»ºæˆåŠŸ"
else
    log_error "ç½‘æ¡¥åˆ›å»ºå¤±è´¥ï¼"
    exit 1
fi

# 4. æ·»åŠ ç‰©ç†ç½‘å¡ä¸º slave
log_info "å°† $PHYSICAL_INTERFACE æ·»åŠ åˆ°ç½‘æ¡¥..."
nmcli connection add type bridge-slave \
    con-name "${BRIDGE_NAME}-slave" \
    ifname "$PHYSICAL_INTERFACE" \
    master "$BRIDGE_NAME"

if [ $? -eq 0 ]; then
    log_success "Slave æ·»åŠ æˆåŠŸ"
else
    log_error "Slave æ·»åŠ å¤±è´¥ï¼"
    exit 1
fi

# 5. ç¦ç”¨åŸæœ‰è¿æ¥
log_info "ç¦ç”¨åŸæœ‰çš„ç‰©ç†ç½‘å¡è¿æ¥..."
OLD_CONNECTION=$(nmcli -g NAME,DEVICE connection show | grep "$PHYSICAL_INTERFACE" | grep -v slave | cut -d: -f1)
if [ -n "$OLD_CONNECTION" ]; then
    log_info "æ‰¾åˆ°æ—§è¿æ¥: $OLD_CONNECTION"
    nmcli connection down "$OLD_CONNECTION"
    nmcli connection delete "$OLD_CONNECTION"
    log_success "æ—§è¿æ¥å·²åˆ é™¤"
else
    log_warn "æœªæ‰¾åˆ°æ—§è¿æ¥ï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰"
fi

# 6. å¯åŠ¨ç½‘æ¡¥
log_info "å¯åŠ¨ç½‘æ¡¥è¿æ¥..."
nmcli connection up "${BRIDGE_NAME}-slave"
nmcli connection up "$BRIDGE_NAME"

if [ $? -eq 0 ]; then
    log_success "ç½‘æ¡¥å·²å¯åŠ¨"
else
    log_error "ç½‘æ¡¥å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥é…ç½®"
    echo "å¯ä»¥è¿è¡Œå›æ»šè„šæœ¬: $ROLLBACK_SCRIPT"
    exit 1
fi

# 7. ç­‰å¾…ç½‘ç»œç¨³å®š
log_info "ç­‰å¾…ç½‘ç»œç¨³å®š..."
sleep 5

# 8. éªŒè¯é…ç½®
echo ""
echo "========================================="
echo "    é…ç½®å®Œæˆï¼ŒéªŒè¯ç»“æœï¼š"
echo "========================================="
echo ""

# æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
log_info "ç½‘æ¡¥æ¥å£çŠ¶æ€:"
ip addr show "$BRIDGE_NAME" | grep -E "inet |state"

echo ""
log_info "ç½‘æ¡¥è¿æ¥çŠ¶æ€:"
bridge link show

echo ""
log_info "æµ‹è¯•ç½‘å…³è¿é€šæ€§:"
if ping -c 2 -W 2 "$GATEWAY" &amp;&gt;/dev/null; then
    log_success "ç½‘å…³ $GATEWAY è¿é€šæ­£å¸¸"
else
    log_error "æ— æ³•è¿æ¥åˆ°ç½‘å…³ï¼"
fi

echo ""
log_info "æµ‹è¯•å¤–ç½‘è¿é€šæ€§:"
if ping -c 2 -W 2 223.5.5.5 &amp;&gt;/dev/null; then
    log_success "å¤–ç½‘è¿é€šæ­£å¸¸"
else
    log_warn "å¤–ç½‘è¿æ¥å¤±è´¥ï¼ˆå¯èƒ½DNSé—®é¢˜ï¼‰"
fi

echo ""
echo "========================================="
log_success "ç½‘æ¡¥é…ç½®å®Œæˆï¼"
echo "========================================="
echo ""
echo "ğŸ“ å¤‡ä»½ç›®å½•: $BACKUP_DIR"
echo "ğŸ”„ å›æ»šè„šæœ¬: $ROLLBACK_SCRIPT"
echo ""
echo "ä¸‹ä¸€æ­¥ï¼š"
echo "  1. é…ç½® libvirt ç½‘æ¡¥ç½‘ç»œï¼ˆå‚è§æ–‡æ¡£æ­¥éª¤ 4.4ï¼‰"
echo "  2. é…ç½®é˜²ç«å¢™è§„åˆ™"
echo "  3. å¦‚æœå‡ºç°é—®é¢˜ï¼Œè¿è¡Œ: bash $ROLLBACK_SCRIPT"
EOF

chmod +x /root/create-bridge.sh
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹è„šæœ¬ä¸­çš„é…ç½®å‚æ•°**

```bash
# ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹ã€é…ç½®åŒºã€‘çš„å˜é‡
vi /root/create-bridge.sh

# éœ€è¦ä¿®æ”¹çš„å˜é‡ï¼š
# - PHYSICAL_INTERFACE: æ”¹æˆæ‚¨çš„å®é™…ç½‘å¡åï¼ˆé€šè¿‡ ip addr show æŸ¥çœ‹ï¼‰
# - HOST_IP: æ”¹æˆæ‚¨å¸Œæœ›çš„å®¿ä¸»æœº IP
# - GATEWAY: æ”¹æˆæ‚¨çš„ç½‘å…³åœ°å€
# - DNS1/DNS2: æ ¹æ®éœ€è¦ä¿®æ”¹ DNS æœåŠ¡å™¨
```

**æ­¥éª¤ 3ï¼šè¿è¡Œè„šæœ¬**

```bash
# ä»¥ root æƒé™è¿è¡Œ
sudo bash /root/create-bridge.sh

# è„šæœ¬ä¼šæ˜¾ç¤ºé…ç½®æ‘˜è¦ï¼Œç¡®è®¤æ— è¯¯åè¾“å…¥ yes
```

**æ­¥éª¤ 4ï¼šå¦‚æœé…ç½®å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š**

```bash
# è¿è¡Œè‡ªåŠ¨ç”Ÿæˆçš„å›æ»šè„šæœ¬
sudo bash /root/rollback-bridge.sh

# æˆ–æ‰‹åŠ¨æ¢å¤å¤‡ä»½ï¼ˆå¤‡ä»½è·¯å¾„ä¼šåœ¨è„šæœ¬æ‰§è¡Œæ—¶æ˜¾ç¤ºï¼‰
sudo cp -r /root/network-backup-&lt;æ—¶é—´æˆ³&gt;/* /etc/NetworkManager/system-connections/
sudo nmcli connection reload
sudo systemctl restart NetworkManager
```

---

#### 4.2.2 æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤åˆ›å»ºç½‘æ¡¥

å¦‚æœæ‚¨æƒ³æ‰‹åŠ¨æ‰§è¡Œæ¯ä¸€æ­¥ï¼ˆä¸ä½¿ç”¨è„šæœ¬ï¼‰ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

```bash
# è®¾ç½®å˜é‡ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
BRIDGE_NAME="br0"
PHYSICAL_INTERFACE="enp1s0"  # â† æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ç½‘å¡åç§°
HOST_IP="192.168.71.200"
GATEWAY="192.168.71.1"
DNS1="192.168.71.1"
DNS2="223.5.5.5"  # é˜¿é‡Œ DNS

# å¤‡ä»½å½“å‰ç½‘ç»œé…ç½®
cp -r /etc/NetworkManager/system-connections/ /root/network-backup-$(date +%F)

# åˆ›å»ºç½‘æ¡¥
nmcli connection add type bridge \
    con-name $BRIDGE_NAME \
    ifname $BRIDGE_NAME \
    ipv4.method manual \
    ipv4.addresses $HOST_IP/24 \
    ipv4.gateway $GATEWAY \
    ipv4.dns "$DNS1 $DNS2"

# å°†ç‰©ç†ç½‘å¡æ·»åŠ åˆ°ç½‘æ¡¥ï¼ˆä½œä¸º slaveï¼‰
nmcli connection add type bridge-slave \
    con-name ${BRIDGE_NAME}-slave \
    ifname $PHYSICAL_INTERFACE \
    master $BRIDGE_NAME

# ç¦ç”¨åŸæœ‰çš„ç‰©ç†ç½‘å¡è¿æ¥
OLD_CONNECTION=$(nmcli -g NAME,DEVICE connection show | grep "$PHYSICAL_INTERFACE" | grep -v slave | cut -d: -f1)
if [ -n "$OLD_CONNECTION" ]; then
    nmcli connection down "$OLD_CONNECTION"
    nmcli connection delete "$OLD_CONNECTION"
fi

# å¯åŠ¨ç½‘æ¡¥
nmcli connection up $BRIDGE_NAME
nmcli connection up ${BRIDGE_NAME}-slave
```

---

### 4.3 éªŒè¯ç½‘æ¡¥é…ç½®

```bash
# ç­‰å¾…å‡ ç§’é’Ÿè®©ç½‘ç»œç¨³å®š
sleep 5

# æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
ip addr show br0

# æ£€æŸ¥æ¡¥æ¥æ¥å£
bridge link show

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping -c 4 192.168.71.1
ping -c 4 223.5.5.5

# æ£€æŸ¥ DNS è§£æ
nslookup www.baidu.com
```

### 4.4 åˆ›å»º libvirt ç½‘æ¡¥ç½‘ç»œå®šä¹‰

```bash
# åˆ›å»ºç½‘æ¡¥ç½‘ç»œ XML å®šä¹‰
cat &gt; /tmp/br0-network.xml &lt;&lt;'EOF'
&lt;network&gt;
  &lt;name&gt;br0&lt;/name&gt;
  &lt;forward mode="bridge"/&gt;
  &lt;bridge name="br0"/&gt;
&lt;/network&gt;
EOF

# å®šä¹‰ç½‘ç»œ
virsh net-define /tmp/br0-network.xml

# å¯åŠ¨ç½‘ç»œ
virsh net-start br0

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh net-autostart br0

# éªŒè¯
virsh net-list --all
```

---

## ğŸ’¡ ç½‘æ¡¥ï¼ˆBridgeï¼‰å·¥ä½œåŸç†è¯¦è§£

### ä»€ä¹ˆæ˜¯ç½‘æ¡¥ï¼Ÿ

**ç½‘æ¡¥ï¼ˆBridgeï¼‰** æ˜¯ä¸€ä¸ªå·¥ä½œåœ¨ **OSI ç¬¬2å±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰** çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**è½¯ä»¶å®ç°çš„äº¤æ¢æœº**ã€‚

### ç‰©ç†ç½‘ç»œæ‹“æ‰‘å¯¹æ¯”

**åˆ›å»ºç½‘æ¡¥å‰çš„ç½‘ç»œç»“æ„**ï¼š
```
äº’è”ç½‘
  |
è·¯ç”±å™¨ (192.168.71.1)
  |
ç‰©ç†äº¤æ¢æœº
  |
  +----+----+----+
  |    |    |    |
 PC  PC  PC  ç‰©ç†æœåŠ¡å™¨
              |
           enp1s0 (192.168.71.200)
              |
         Rocky Linux å®¿ä¸»æœº
```

**åˆ›å»ºç½‘æ¡¥åçš„è™šæ‹Ÿæ‹“æ‰‘**ï¼š
```
äº’è”ç½‘
  |
è·¯ç”±å™¨ (192.168.71.1) â† ä¸ºæ‰€æœ‰è®¾å¤‡åˆ†é…IP
  |
ç‰©ç†äº¤æ¢æœº
  |
  +----+----+----+
  |    |    |    |
 PC  PC  PC  ç‰©ç†æœåŠ¡å™¨
              |
          enp1s0 â† å˜æˆçº¯è½¬å‘å£ï¼Œæ— IPåœ°å€
            (åªå·¥ä½œåœ¨æ•°æ®é“¾è·¯å±‚)
              |
         +----+----+
         |  br0   | â† è™šæ‹Ÿç½‘æ¡¥ï¼ˆè½¯ä»¶äº¤æ¢æœºï¼‰
         | (192.168.71.200) â† å®¿ä¸»æœºIPé…åœ¨è¿™é‡Œ
         +----+----+
              |
     +--------+--------+--------+
     |        |        |        |
  å®¿ä¸»æœº    VM-NAS  VM-Router  VM-Dev
         (.201)    (.202)     (.203)
```

### ç½‘æ¡¥çš„ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½

#### 1. MAC åœ°å€å­¦ä¹ ï¼ˆLearningï¼‰

ç½‘æ¡¥ç»´æŠ¤ä¸€ä¸ª **MAC åœ°å€è¡¨**ï¼ˆç±»ä¼¼ç‰©ç†äº¤æ¢æœºçš„ CAM è¡¨ï¼‰ï¼š

```
ç«¯å£              MAC åœ°å€           å­¦ä¹ æ¥æº
-------------------------------------------------
enp1s0         aa:bb:cc:dd:ee:01  (ç‰©ç†è·¯ç”±å™¨)
vnet0 (VM1)    52:54:00:12:34:56  (NASè™šæ‹Ÿæœº)
vnet1 (VM2)    52:54:00:12:34:57  (Routerè™šæ‹Ÿæœº)
br0-host       xx:xx:xx:xx:xx:xx  (å®¿ä¸»æœºè‡ªèº«)
```

**å·¥ä½œè¿‡ç¨‹**ï¼š
1. æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œè®°å½•æº MAC åœ°å€å’Œå…¥å£ç«¯å£
2. æ ¹æ®ç›®çš„ MAC åœ°å€æŸ¥è¡¨ï¼Œå†³å®šä»å“ªä¸ªç«¯å£è½¬å‘
3. å¦‚æœç›®çš„ MAC æœªçŸ¥ï¼Œ**æ´ªæ³›**ï¼ˆfloodingï¼‰åˆ°æ‰€æœ‰ç«¯å£

#### 2. æ•°æ®åŒ…è½¬å‘ï¼ˆForwardingï¼‰

**ç¤ºä¾‹ï¼šå¤–éƒ¨ PC è®¿é—® NAS è™šæ‹Ÿæœº**

```
æ•°æ®æµå‘ï¼š
å¤–éƒ¨ PC (192.168.71.100)
  â†’ å‘é€æ•°æ®åŒ…: ç›®çš„IP=192.168.71.201, ç›®çš„MAC=52:54:00:12:34:56
  â†’ ç‰©ç†äº¤æ¢æœº
  â†’ enp1s0 (æ··æ‚æ¨¡å¼ï¼Œæ¥æ”¶æ‰€æœ‰æ•°æ®åŒ…)
  â†’ br0 æŸ¥ MAC åœ°å€è¡¨: 52:54:00:12:34:56 â†’ vnet0 ç«¯å£
  â†’ vnet0 è™šæ‹Ÿç½‘å¡
  â†’ NAS è™šæ‹Ÿæœºæ¥æ”¶
```

**ç¤ºä¾‹ï¼šNAS è™šæ‹Ÿæœºè®¿é—®äº’è”ç½‘**

```
æ•°æ®æµå‘ï¼š
NAS è™šæ‹Ÿæœº (192.168.71.201)
  â†’ vnet0 è™šæ‹Ÿç½‘å¡
  â†’ br0 è½¬å‘: ç›®çš„æ˜¯ç½‘å…³ï¼ŒæŸ¥è¡¨å‘ç°åœ¨ enp1s0
  â†’ enp1s0 ç‰©ç†ç½‘å¡
  â†’ ç‰©ç†äº¤æ¢æœº
  â†’ è·¯ç”±å™¨ (192.168.71.1)
  â†’ äº’è”ç½‘
```

#### 3. æ··æ‚æ¨¡å¼ï¼ˆPromiscuous Modeï¼‰

**ç‰©ç†ç½‘å¡ enp1s0 å˜æˆ bridge slave å**ï¼š

```bash
# æŸ¥çœ‹ç½‘å¡æ¨¡å¼
ip link show enp1s0
# è¾“å‡ºåŒ…å«: PROMISC (æ··æ‚æ¨¡å¼æ ‡å¿—)
```

**æ­£å¸¸æ¨¡å¼ vs æ··æ‚æ¨¡å¼**ï¼š

| æ¨¡å¼ | æ¥æ”¶çš„æ•°æ®åŒ… | ç”¨é€” |
|------|------------|------|
| **æ­£å¸¸æ¨¡å¼** | åªæ¥æ”¶ç›®çš„MACæ˜¯è‡ªå·±çš„åŒ… | æ™®é€šç½‘å¡ |
| **æ··æ‚æ¨¡å¼** | æ¥æ”¶æ‰€æœ‰ç»è¿‡çš„æ•°æ®åŒ… | ç½‘æ¡¥ã€æŠ“åŒ…å·¥å…· |

**ä¸ºä»€ä¹ˆéœ€è¦æ··æ‚æ¨¡å¼ï¼Ÿ**
- è™šæ‹Ÿæœºçš„ MAC åœ°å€ä¸ç‰©ç†ç½‘å¡ä¸åŒ
- ç‰©ç†ç½‘å¡éœ€è¦æ¥æ”¶å‘ç»™è™šæ‹Ÿæœºçš„æ•°æ®åŒ…ï¼ˆç›®çš„MACä¸æ˜¯è‡ªå·±ï¼‰
- ç„¶åç”± br0 æ ¹æ® MAC è¡¨è½¬å‘ç»™æ­£ç¡®çš„è™šæ‹Ÿæœº

### æ­¥éª¤ 4.2 åˆ›å»ºç½‘æ¡¥çš„åº•å±‚æ“ä½œ

**æ‰§è¡Œ `nmcli connection add type bridge` æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ**ï¼š

1. **åˆ›å»ºè™šæ‹Ÿç½‘æ¡¥è®¾å¤‡**
   ```bash
   # å†…æ ¸åˆ›å»º br0 è®¾å¤‡
   ip link add name br0 type bridge
   
   # åˆ†é… IP åœ°å€ï¼ˆåŸæœ¬åœ¨ enp1s0 ä¸Šçš„ï¼‰
   ip addr add 192.168.71.200/24 dev br0
   ip link set br0 up
   ```

2. **å°†ç‰©ç†ç½‘å¡åŠ å…¥ç½‘æ¡¥**
   ```bash
   # enp1s0 å˜æˆ br0 çš„ slave
   ip link set enp1s0 master br0
   
   # å¯ç”¨æ··æ‚æ¨¡å¼
   ip link set enp1s0 promisc on
   
   # æ¸…é™¤ enp1s0 çš„ IP åœ°å€
   ip addr flush dev enp1s0
   ```

3. **ç»“æœéªŒè¯**
   ```bash
   # æŸ¥çœ‹ç½‘æ¡¥åŠå…¶ç«¯å£
   bridge link show
   # è¾“å‡º:
   # 2: enp1s0: &lt;BROADCAST,MULTICAST,PROMISC,UP&gt; master br0
   ```

### Bridge æ¨¡å¼ vs NAT æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | Bridge æ¨¡å¼ (br0) | NAT æ¨¡å¼ (virbr0) |
|------|------------------|-------------------|
| **è™šæ‹ŸæœºIP** | 192.168.71.xï¼ˆä¸å®¿ä¸»æœºåŒç½‘æ®µï¼‰ | 192.168.122.xï¼ˆç‹¬ç«‹ç§æœ‰ç½‘æ®µï¼‰ |
| **è·¯ç”±å™¨å¯è§** | âœ… å¯ä»¥çœ‹åˆ°æ¯ä¸ªè™šæ‹Ÿæœº | âŒ åªèƒ½çœ‹åˆ°å®¿ä¸»æœº |
| **å±€åŸŸç½‘ç›´æ¥è®¿é—®** | âœ… å¯ä»¥ï¼ˆåƒç‹¬ç«‹ç‰©ç†æœºï¼‰ | âŒ éœ€è¦ç«¯å£è½¬å‘ |
| **IPåˆ†é…æ–¹å¼** | è·¯ç”±å™¨ DHCP æˆ–æ‰‹åŠ¨é…ç½® | libvirt dnsmasq |
| **ç‰©ç†ç½‘å¡ä¾èµ–** | âœ… éœ€è¦ï¼ˆä½œä¸º slaveï¼‰ | âŒ ä¸éœ€è¦ï¼ˆçº¯è™šæ‹Ÿï¼‰ |
| **ç½‘ç»œæ€§èƒ½** | â­â­â­â­â­ï¼ˆäºŒå±‚è½¬å‘ï¼‰ | â­â­â­â­â˜†ï¼ˆä¸‰å±‚NATï¼‰ |
| **é€‚ç”¨åœºæ™¯** | ç”Ÿäº§æœåŠ¡å™¨ï¼ˆNASã€è·¯ç”±ï¼‰ | æµ‹è¯•ã€å¼€å‘ç¯å¢ƒ |

### libvirt ç½‘æ¡¥ç½‘ç»œå®šä¹‰çš„ä½œç”¨

æ­¥éª¤ 4.4 ä¸­çš„ XML é…ç½®ï¼š

```xml
&lt;network&gt;
  &lt;name&gt;br0&lt;/name&gt;
  &lt;forward mode="bridge"/&gt;
  &lt;bridge name="br0"/&gt;
&lt;/network&gt;
```

**å…³é”®ç‚¹**ï¼š
- `forward mode="bridge"`ï¼šå‘Šè¯‰ libvirt è¿™æ˜¯**çº¯æ¡¥æ¥æ¨¡å¼**
- libvirt **ä¸ç®¡ç†** IP åˆ†é…ï¼ˆç”±è·¯ç”±å™¨ DHCP æˆ–æ‰‹åŠ¨é…ç½®ï¼‰
- libvirt **ä¸å¯åŠ¨** dnsmasqï¼ˆä¸ default ç½‘ç»œä¸åŒï¼‰
- åªæ˜¯å‘Šè¯‰ libvirtï¼š"æœ‰ä¸ªå« br0 çš„ç½‘æ¡¥å¯ç”¨ï¼Œè™šæ‹Ÿæœºå¯ä»¥è¿æ¥"

**åˆ›å»ºè™šæ‹Ÿæœºæ—¶ä½¿ç”¨**ï¼š
```bash
virt-install \
    --network bridge=br0,model=virtio \
    ...
```
- libvirt åˆ›å»ºè™šæ‹Ÿç½‘å¡ `vnetX`
- è‡ªåŠ¨å°† `vnetX` åŠ å…¥ br0 ç½‘æ¡¥
- è™šæ‹Ÿæœºå¯åŠ¨åä»è·¯ç”±å™¨è·å– 192.168.71.x IP

### ä¸ºä»€ä¹ˆé€‰æ‹© Bridge æ¨¡å¼ï¼Ÿï¼ˆé€‚åˆæ‚¨çš„åœºæ™¯ï¼‰

**æ‚¨çš„éœ€æ±‚**ï¼š
- âœ… NAS è™šæ‹Ÿæœºéœ€è¦å±€åŸŸç½‘è®¾å¤‡ç›´æ¥è®¿é—®ï¼ˆSMBã€NFSï¼‰
- âœ… æ—è·¯ç”±è™šæ‹Ÿæœºéœ€è¦ä½œä¸ºç½‘å…³è¢«å…¶ä»–è®¾å¤‡ä½¿ç”¨
- âœ… è™šæ‹Ÿæœºåƒç‹¬ç«‹æœåŠ¡å™¨ä¸€æ ·å·¥ä½œ

**Bridge æ¨¡å¼ä¼˜åŠ¿**ï¼š
1. **é€æ˜æ€§**ï¼šè™šæ‹Ÿæœºå°±åƒç‰©ç†æœºä¸€æ ·æ’åœ¨äº¤æ¢æœºä¸Š
2. **ç®€åŒ–ç®¡ç†**ï¼šä¸éœ€è¦é…ç½®ç«¯å£è½¬å‘è§„åˆ™
3. **æ€§èƒ½æœ€ä¼˜**ï¼šäºŒå±‚è½¬å‘ï¼Œé›¶ NAT å¼€é”€
4. **çµæ´»æ€§**ï¼šå¯ä»¥ç»™è™šæ‹Ÿæœºåˆ†é…å›ºå®š IPï¼ˆåœ¨è·¯ç”±å™¨è®¾ç½® DHCP ä¿ç•™ï¼‰

---

## ğŸ› ï¸ æ­¥éª¤ 5: é…ç½®é˜²ç«å¢™å’Œ SELinux

### 5.1 é…ç½®é˜²ç«å¢™

```bash
# å…è®¸ç½‘æ¡¥æµé‡é€šè¿‡
firewall-cmd --permanent --zone=public --add-interface=br0

# å…è®¸ libvirt ç›¸å…³æœåŠ¡
firewall-cmd --permanent --add-service=libvirt

# å¯ç”¨ IP è½¬å‘ï¼ˆå¦‚æœéœ€è¦è™šæ‹Ÿæœºè®¿é—®å¤–ç½‘ï¼‰
firewall-cmd --permanent --add-masquerade

# é‡è½½é˜²ç«å¢™
firewall-cmd --reload

# éªŒè¯
firewall-cmd --list-all
firewall-cmd --get-active-zones
```

### 5.2 é…ç½® SELinux

```bash
# è®¾ç½® SELinux å¸ƒå°”å€¼ï¼Œå…è®¸ libvirt ä½¿ç”¨ NFS ç­‰
setsebool -P virt_use_nfs 1
setsebool -P virt_use_samba 1

# å¦‚æœä½¿ç”¨ virtio-fs å…±äº«ç›®å½•ï¼ˆåç»­ NAS ä¼šç”¨åˆ°ï¼‰
setsebool -P virt_use_fusefs 1

# æ£€æŸ¥è®¾ç½®
getsebool -a | grep virt
```

---

## ğŸ“‚ æ­¥éª¤ 6: é…ç½®è™šæ‹Ÿæœºå­˜å‚¨ç›®å½•

### 6.1 åˆ›å»º ISO é•œåƒå­˜å‚¨ç›®å½•

```bash
# åˆ›å»ºç›®å½•
mkdir -p /kvm/iso
chmod 755 /kvm/iso

# åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜ä¸´æ—¶å­˜å‚¨ç›®å½•ï¼ˆåç»­ä¼šé…ç½® LVM å­˜å‚¨æ± ï¼‰
mkdir -p /kvm/images
chmod 711 /kvm/images

# è®¾ç½® SELinux ä¸Šä¸‹æ–‡
semanage fcontext -a -t virt_image_t '/kvm/iso(/.*)?'
semanage fcontext -a -t virt_image_t '/kvm/images(/.*)?'
restorecon -Rv /kvm
```

### 6.2 å®šä¹‰ ISO å­˜å‚¨æ± 

```bash
# å®šä¹‰ ISO å­˜å‚¨æ± 
virsh pool-define-as iso_pool dir - - - - /kvm/iso

# æ„å»ºå¹¶å¯åŠ¨
virsh pool-build iso_pool
virsh pool-start iso_pool
virsh pool-autostart iso_pool

# éªŒè¯
virsh pool-list --all
virsh pool-info iso_pool
```

---

## âœ… æ­¥éª¤ 7: éªŒè¯ KVM ç¯å¢ƒ

### 7.1 ä½¿ç”¨ virt-host-validate éªŒè¯

```bash
# å®‰è£…éªŒè¯å·¥å…·ï¼ˆé€šå¸¸å·²åŒ…å«ï¼‰
dnf install -y libvirt-client

# è¿è¡ŒéªŒè¯
virt-host-validate

# æ‚¨åº”è¯¥çœ‹åˆ°å¤§éƒ¨åˆ†é¡¹ç›®æ˜¾ç¤º PASS
# å¦‚æœæœ‰ WARN æˆ– FAILï¼ŒæŸ¥çœ‹æç¤ºä¿¡æ¯ä¿®å¤
```

é¢„æœŸè¾“å‡ºï¼š
```
  QEMU: Checking for hardware virtualization                                 : PASS
  QEMU: Checking if device /dev/kvm exists                                   : PASS
  QEMU: Checking if device /dev/kvm is accessible                            : PASS
  QEMU: Checking if device /dev/vhost-net exists                             : PASS
  QEMU: Checking if device /dev/net/tun exists                               : PASS
  QEMU: Checking for cgroup 'cpu' controller support                         : PASS
  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS
  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS
  QEMU: Checking for cgroup 'memory' controller support                      : PASS
  QEMU: Checking for cgroup 'devices' controller support                     : PASS
  QEMU: Checking for cgroup 'blkio' controller support                       : PASS
  QEMU: Checking for device assignment IOMMU support                         : WARN (No ACPI IVRS table found, IOMMU either disabled in BIOS or not supported by this hardware platform)
  LXC: Checking for Linux &gt;= 2.6.26                                          : PASS
```

âš ï¸ **æ³¨æ„**: IOMMU è­¦å‘Šå¯ä»¥å¿½ç•¥ï¼Œé™¤éæ‚¨éœ€è¦ PCI è®¾å¤‡ç›´é€šåŠŸèƒ½ã€‚

### 7.2 åˆ›å»ºå®Œæ•´éªŒè¯è„šæœ¬

```bash
cat &gt; /root/verify-kvm-setup.sh &lt;&lt;'EOF'
#!/bin/bash

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "========================================="
echo "       KVM ç¯å¢ƒéªŒè¯"
echo "========================================="
echo ""

check_pass() {
    echo -e "${GREEN}âœ“${NC} $1"
}

check_fail() {
    echo -e "${RED}âœ—${NC} $1"
}

check_warn() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# 1. CPU è™šæ‹ŸåŒ–
echo "1. æ£€æŸ¥ CPU è™šæ‹ŸåŒ–æ”¯æŒ..."
if lscpu | grep -q 'AMD-V\|VT-x'; then
    virt_type=$(lscpu | grep Virtualization | cut -d: -f2 | xargs)
    check_pass "CPU è™šæ‹ŸåŒ–: $virt_type"
else
    check_fail "CPU è™šæ‹ŸåŒ–æœªå¯ç”¨"
    exit 1
fi

# 2. KVM æ¨¡å—
echo "2. æ£€æŸ¥ KVM å†…æ ¸æ¨¡å—..."
if lsmod | grep -q kvm; then
    check_pass "KVM æ¨¡å—å·²åŠ è½½"
else
    check_fail "KVM æ¨¡å—æœªåŠ è½½"
fi

# 3. libvirt æœåŠ¡
echo "3. æ£€æŸ¥ libvirt æœåŠ¡..."
if systemctl is-active --quiet libvirtd; then
    check_pass "libvirtd æœåŠ¡è¿è¡Œä¸­"
else
    check_fail "libvirtd æœåŠ¡æœªè¿è¡Œ"
fi

# 4. ç½‘æ¡¥é…ç½®
echo "4. æ£€æŸ¥ç½‘æ¡¥é…ç½®..."
if ip link show br0 &amp;&gt;/dev/null; then
    check_pass "ç½‘æ¡¥ br0 å·²åˆ›å»º"
    if virsh net-list | grep -q br0; then
        check_pass "libvirt ç½‘æ¡¥ç½‘ç»œå·²é…ç½®"
    else
        check_warn "libvirt ç½‘æ¡¥ç½‘ç»œæœªé…ç½®"
    fi
else
    check_fail "ç½‘æ¡¥ br0 ä¸å­˜åœ¨"
fi

# 5. å­˜å‚¨æ± 
echo "5. æ£€æŸ¥å­˜å‚¨æ± ..."
pool_count=$(virsh pool-list --all | grep -c 'active\|inactive')
if [ $pool_count -gt 0 ]; then
    check_pass "å·²é…ç½® $pool_count ä¸ªå­˜å‚¨æ± "
    virsh pool-list --all | tail -n +3 | while read line; do
        echo "   - $line"
    done
else
    check_warn "æœªé…ç½®å­˜å‚¨æ± "
fi

# 6. ç½‘ç»œè¿é€šæ€§
echo "6. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."
if ping -c 1 -W 2 192.168.71.1 &amp;&gt;/dev/null; then
    check_pass "ç½‘å…³è¿é€šæ­£å¸¸"
else
    check_fail "æ— æ³•è¿æ¥åˆ°ç½‘å…³"
fi

if ping -c 1 -W 2 223.5.5.5 &amp;&gt;/dev/null; then
    check_pass "å¤–ç½‘è¿é€šæ­£å¸¸"
else
    check_fail "æ— æ³•è¿æ¥åˆ°å¤–ç½‘"
fi

# 7. é˜²ç«å¢™
echo "7. æ£€æŸ¥é˜²ç«å¢™é…ç½®..."
if firewall-cmd --get-active-zones | grep -q br0; then
    check_pass "br0 å·²æ·»åŠ åˆ°é˜²ç«å¢™"
else
    check_warn "br0 æœªæ·»åŠ åˆ°é˜²ç«å¢™"
fi

# 8. ç”¨æˆ·ç»„
echo "8. æ£€æŸ¥ç”¨æˆ·ç»„..."
if groups chris | grep -q libvirt; then
    check_pass "chris ç”¨æˆ·åœ¨ libvirt ç»„"
else
    check_warn "chris ç”¨æˆ·ä¸åœ¨ libvirt ç»„"
fi

echo ""
echo "========================================="
echo "æ‰§è¡Œ virt-host-validate å®Œæ•´éªŒè¯..."
echo "========================================="
echo ""
virt-host-validate

echo ""
echo "========================================="
echo "éªŒè¯å®Œæˆï¼"
echo "========================================="
EOF

chmod +x /root/verify-kvm-setup.sh
```

### 7.3 è¿è¡ŒéªŒè¯è„šæœ¬

```bash
/root/verify-kvm-setup.sh
```

---

## ğŸ§ª æ­¥éª¤ 8: åˆ›å»ºæµ‹è¯•è™šæ‹Ÿæœºï¼ˆå¯é€‰ï¼‰

### 8.1 ä¸‹è½½è½»é‡çº§æµ‹è¯• ISO

```bash
# ä¸‹è½½ Alpine Linux (è½»é‡çº§ï¼Œçº¦ 200MB)
cd /kvm/iso
wget https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.19/releases/x86_64/alpine-virt-3.19.1-x86_64.iso

# åˆ·æ–° ISO å­˜å‚¨æ± 
virsh pool-refresh iso_pool

# éªŒè¯ ISO
virsh vol-list iso_pool
```

### 8.2 åˆ›å»ºæµ‹è¯•è™šæ‹Ÿæœº

```bash
# åˆ›å»ºæµ‹è¯•è™šæ‹Ÿæœºï¼ˆä½¿ç”¨ä¸´æ—¶ç›®å½•å­˜å‚¨ï¼‰
virt-install \
    --name test-vm \
    --ram 512 \
    --vcpus 1 \
    --disk path=/kvm/images/test-vm.qcow2,size=5,format=qcow2 \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0,port=5900 \
    --cdrom /kvm/iso/alpine-virt-3.19.1-x86_64.iso \
    --os-variant alpinelinux3.18 \
    --noautoconsole

# æŸ¥çœ‹è™šæ‹ŸæœºçŠ¶æ€
virsh list --all

# æŸ¥çœ‹ VNC ç«¯å£
virsh vncdisplay test-vm
```

### 8.3 è¿æ¥æµ‹è¯•è™šæ‹Ÿæœº

**æ–¹æ³• A: ä½¿ç”¨ virt-viewer (å¦‚æœå®‰è£…äº†å›¾å½¢ç•Œé¢)**
```bash
virt-viewer test-vm
```

**æ–¹æ³• B: ä½¿ç”¨ VNC å®¢æˆ·ç«¯**
- åœ¨æ‚¨çš„ç”µè„‘ä¸Šå®‰è£… VNC Viewer (å¦‚ TigerVNC, RealVNC)
- è¿æ¥åˆ°: `192.168.71.200:5900`

**æ–¹æ³• C: æ§åˆ¶å°è¿æ¥ï¼ˆæ–‡æœ¬æ¨¡å¼ï¼‰**
```bash
virsh console test-vm
# æŒ‰ Ctrl+] é€€å‡ºæ§åˆ¶å°
```

### 8.4 åˆ é™¤æµ‹è¯•è™šæ‹Ÿæœº

```bash
# å…³é—­è™šæ‹Ÿæœº
virsh destroy test-vm

# åˆ é™¤è™šæ‹Ÿæœºå®šä¹‰
virsh undefine test-vm --remove-all-storage

# éªŒè¯
virsh list --all
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

å®Œæˆæœ¬æ–‡æ¡£åï¼Œæ‚¨åº”è¯¥å·²ç»é…ç½®å¥½ï¼š

- [x] CPU è™šæ‹ŸåŒ–å·²éªŒè¯å¹¶å¯ç”¨
- [x] KVM/QEMU è½¯ä»¶åŒ…å·²å®‰è£…
- [x] libvirt æœåŠ¡è¿è¡Œå¹¶è®¾ç½®è‡ªå¯åŠ¨
- [x] ç½‘æ¡¥ br0 å·²åˆ›å»ºå¹¶é…ç½®
- [x] libvirt ç½‘æ¡¥ç½‘ç»œå·²å®šä¹‰
- [x] ISO å­˜å‚¨æ± å·²åˆ›å»º
- [x] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [x] SELinux ç­–ç•¥å·²é…ç½®
- [x] chris ç”¨æˆ·å·²æ·»åŠ åˆ° libvirt ç»„
- [x] éªŒè¯è„šæœ¬æ˜¾ç¤ºæ‰€æœ‰å…³é”®é¡¹ç›®é€šè¿‡

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç½‘æ¡¥åˆ›å»ºåæ— æ³•è¿æ¥ç½‘ç»œ

**ç—‡çŠ¶**: åˆ›å»º br0 å SSH è¿æ¥æ–­å¼€æˆ–æ— æ³•è®¿é—®ç½‘ç»œ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¦‚æœé€šè¿‡æœ¬åœ°æ§åˆ¶å°è®¿é—®
# æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
nmcli connection show

# é‡å¯ç½‘æ¡¥
nmcli connection down br0
nmcli connection up br0-slave
nmcli connection up br0

# å¦‚æœä»ç„¶æ— æ³•æ¢å¤ï¼Œåˆ é™¤ç½‘æ¡¥å›é€€
nmcli connection delete br0
nmcli connection delete br0-slave

# æ¢å¤å¤‡ä»½çš„é…ç½®
cp -r /root/network-backup-&lt;æ—¥æœŸ&gt;/* /etc/NetworkManager/system-connections/
nmcli connection reload
systemctl restart NetworkManager
```

### é—®é¢˜ 2: virt-host-validate æ˜¾ç¤º FAIL

**ç—‡çŠ¶**: æŸäº›é¡¹ç›®æ˜¾ç¤º FAIL

**å¸¸è§ FAIL é¡¹ç›®åŠè§£å†³æ–¹æ¡ˆ**:

**FAIL: /dev/kvm ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®**
```bash
# åŠ è½½ KVM æ¨¡å—
modprobe kvm
modprobe kvm_amd  # æˆ– kvm_intel

# æ°¸ä¹…åŠ è½½
echo "kvm" &gt;&gt; /etc/modules-load.d/kvm.conf
echo "kvm_amd" &gt;&gt; /etc/modules-load.d/kvm.conf  # æˆ– kvm_intel
```

**FAIL: cgroup æ§åˆ¶å™¨ä¸æ”¯æŒ**
```bash
# æ£€æŸ¥ cgroup v2
mount | grep cgroup

# å¦‚æœéœ€è¦ï¼Œåœ¨ GRUB ä¸­å¯ç”¨ cgroup v1
# ç¼–è¾‘ /etc/default/grubï¼Œæ·»åŠ :
# GRUB_CMDLINE_LINUX="... systemd.unified_cgroup_hierarchy=0"
# ç„¶å:
grub2-mkconfig -o /boot/grub2/grub.cfg
reboot
```

### é—®é¢˜ 3: è™šæ‹Ÿæœºæ— æ³•è·å– IP åœ°å€

**ç—‡çŠ¶**: è™šæ‹Ÿæœºå¯åŠ¨åæ— æ³•è¿æ¥ç½‘ç»œ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘æ¡¥æ˜¯å¦å·¥ä½œ
brctl show
# æˆ–
bridge link show

# ç¡®ä¿ br0 å·²è¿æ¥åˆ°ç‰©ç†ç½‘å¡
ip link show br0

# æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --zone=public --list-all

# ç¡®ä¿ br0 åœ¨æ­£ç¡®çš„ zone
firewall-cmd --get-zone-of-interface=br0

# å¦‚æœä¸åœ¨ public zoneï¼Œæ·»åŠ å®ƒ
firewall-cmd --permanent --zone=public --add-interface=br0
firewall-cmd --reload
```

### é—®é¢˜ 4: chris ç”¨æˆ·æ— æ³•ç®¡ç†è™šæ‹Ÿæœº

**ç—‡çŠ¶**: ä½¿ç”¨ chris ç”¨æˆ·æ‰§è¡Œ virsh å‘½ä»¤æ—¶æƒé™è¢«æ‹’ç»

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®ä¿ç”¨æˆ·åœ¨æ­£ç¡®çš„ç»„
sudo usermod -aG libvirt,kvm chris

# è®©ç”¨æˆ·é‡æ–°ç™»å½•ä»¥åº”ç”¨ç»„æ›´æ”¹
# æˆ–ä½¿ç”¨ newgrp
newgrp libvirt

# æ£€æŸ¥ libvirt socket æƒé™
ls -l /var/run/libvirt/libvirt-sock

# åº”è¯¥æ˜¯:
# srwxrwx--- 1 root libvirt ... /var/run/libvirt/libvirt-sock
```

### é—®é¢˜ 5: ç½‘æ¡¥æ¨¡å¼ä¸‹è™šæ‹Ÿæœºæ— æ³•è®¿é—®å¤–ç½‘

**ç—‡çŠ¶**: è™šæ‹Ÿæœºå¯ä»¥ ping é€šç½‘å…³ä½†æ— æ³•è®¿é—®å¤–ç½‘

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥ IP è½¬å‘
cat /proc/sys/net/ipv4/ip_forward
# åº”è¯¥æ˜¯ 1

# å¦‚æœæ˜¯ 0ï¼Œå¯ç”¨å®ƒ
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
# æ°¸ä¹…å¯ç”¨
echo "net.ipv4.ip_forward = 1" &gt;&gt; /etc/sysctl.conf
sysctl -p

# 2. æ£€æŸ¥é˜²ç«å¢™ masquerade
firewall-cmd --query-masquerade
# å¦‚æœæ˜¯ noï¼Œå¯ç”¨å®ƒ
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload

# 3. æ£€æŸ¥è™šæ‹Ÿæœºçš„ç½‘å…³é…ç½®
# åœ¨è™šæ‹Ÿæœºå†…æ£€æŸ¥:
# ip route show
# ç¡®ä¿é»˜è®¤ç½‘å…³æŒ‡å‘ 192.168.71.1
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸæ­å»ºäº† KVM è™šæ‹ŸåŒ–ç¯å¢ƒã€‚

ç°åœ¨æ‚¨å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ï¼š

ğŸ‘‰ **[03-storage-expansion.md - ç£ç›˜ç©ºé—´æ‰©å±•](#section-3)**

---

## ğŸ’¡ çŸ¥è¯†è¡¥å……

### Bridge æ¨¡å¼ vs NAT æ¨¡å¼

| ç‰¹æ€§ | Bridge æ¨¡å¼ | NAT æ¨¡å¼ |
|------|-------------|----------|
| IP åœ°å€ | ä¸å®¿ä¸»æœºåŒç½‘æ®µ (192.168.71.x) | ç‹¬ç«‹ç½‘æ®µ (192.168.122.x) |
| å±€åŸŸç½‘è®¿é—® | å¯ä»¥ç›´æ¥è®¿é—®è™šæ‹Ÿæœº | éœ€è¦ç«¯å£è½¬å‘ |
| é…ç½®å¤æ‚åº¦ | â­â­â­â˜†â˜† | â­â­â˜†â˜†â˜† |
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­â­â˜† |
| é€‚ç”¨åœºæ™¯ | æœåŠ¡å™¨è™šæ‹Ÿæœºï¼ˆæ¨èï¼‰ | æµ‹è¯•å’Œå¼€å‘ |

**ä¸ºä»€ä¹ˆé€‰æ‹© Bridge æ¨¡å¼ï¼Ÿ**
- NASã€æ—è·¯ç”±ç­‰éœ€è¦å±€åŸŸç½‘è®¾å¤‡ç›´æ¥è®¿é—®
- è™šæ‹Ÿæœºå°±åƒç‰©ç†æœºä¸€æ ·å·¥ä½œåœ¨å±€åŸŸç½‘ä¸­
- ä¾¿äºç®¡ç†å’Œç›‘æ§

### KVM æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ virtio é©±åŠ¨**: ç½‘ç»œå’Œç£ç›˜éƒ½ä½¿ç”¨ virtioï¼Œæ€§èƒ½æ¥è¿‘ç‰©ç†æœº
2. **CPU ç»‘å®š**: å¯¹äºç”Ÿäº§è™šæ‹Ÿæœºï¼Œå¯ä»¥ç»‘å®šç‰¹å®š CPU æ ¸å¿ƒ
3. **å¤§é¡µå†…å­˜**: å¯¹äºå†…å­˜å¯†é›†å‹åº”ç”¨ï¼Œå¯ç”¨å¤§é¡µå†…å­˜
4. **ç£ç›˜ç¼“å­˜ç­–ç•¥**: æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç¼“å­˜æ¨¡å¼

è¿™äº›ä¼˜åŒ–å°†åœ¨åç»­çš„è™šæ‹Ÿæœºé…ç½®æ–‡æ¡£ä¸­è¯¦ç»†è¯´æ˜ã€‚

### å¸¸ç”¨ virsh å‘½ä»¤é€ŸæŸ¥

```bash
# è™šæ‹Ÿæœºç®¡ç†
virsh list --all              # åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœº
virsh start &lt;vm-name&gt;         # å¯åŠ¨è™šæ‹Ÿæœº
virsh shutdown &lt;vm-name&gt;      # å…³é—­è™šæ‹Ÿæœºï¼ˆä¼˜é›…å…³æœºï¼‰
virsh destroy &lt;vm-name&gt;       # å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº
virsh reboot &lt;vm-name&gt;        # é‡å¯è™šæ‹Ÿæœº
virsh autostart &lt;vm-name&gt;     # è®¾ç½®å¼€æœºè‡ªå¯
virsh autostart --disable &lt;vm-name&gt;  # ç¦ç”¨å¼€æœºè‡ªå¯

# è™šæ‹Ÿæœºä¿¡æ¯
virsh dominfo &lt;vm-name&gt;       # æŸ¥çœ‹è™šæ‹Ÿæœºè¯¦ç»†ä¿¡æ¯
virsh domstats &lt;vm-name&gt;      # æŸ¥çœ‹è™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯
virsh vcpuinfo &lt;vm-name&gt;      # æŸ¥çœ‹ vCPU ä¿¡æ¯

# ç½‘ç»œç®¡ç†
virsh net-list --all          # åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ
virsh net-info &lt;net-name&gt;     # æŸ¥çœ‹ç½‘ç»œä¿¡æ¯
virsh net-start &lt;net-name&gt;    # å¯åŠ¨ç½‘ç»œ
virsh net-autostart &lt;net-name&gt;  # è®¾ç½®ç½‘ç»œè‡ªå¯

# å­˜å‚¨ç®¡ç†
virsh pool-list --all         # åˆ—å‡ºæ‰€æœ‰å­˜å‚¨æ± 
virsh vol-list &lt;pool-name&gt;    # åˆ—å‡ºå­˜å‚¨æ± ä¸­çš„å·
virsh pool-refresh &lt;pool-name&gt;  # åˆ·æ–°å­˜å‚¨æ± 

# æ§åˆ¶å°è¿æ¥
virsh console &lt;vm-name&gt;       # è¿æ¥åˆ°è™šæ‹Ÿæœºæ§åˆ¶å°
# æŒ‰ Ctrl+] é€€å‡ºæ§åˆ¶å°
```




---



# 03 - ç£ç›˜ç©ºé—´æ‰©å±•

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨å°† 2TB SSD ä¸Šå‰©ä½™çš„çº¦ 1.75TB æœªåˆ†é…ç©ºé—´é…ç½®ä¸º KVM è™šæ‹ŸåŒ–å’Œ NAS ä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼š

- âœ… å½“å‰ç£ç›˜çŠ¶æ€æ£€æŸ¥
- âœ… å­˜å‚¨è§„åˆ’æ–¹æ¡ˆï¼ˆæ¨èé…ç½®ï¼‰
- âœ… åˆ›å»ºæ–°åˆ†åŒº
- âœ… é…ç½® LVM thin pool (1.2TB è™šæ‹Ÿæœºå­˜å‚¨)
- âœ… é…ç½® NAS æ•°æ®å· (500GB ç‹¬ç«‹å­˜å‚¨)
- âœ… é…ç½® KVM å­˜å‚¨æ± 
- âœ… ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬
- âœ… éªŒè¯å’Œæµ‹è¯•

**å‰ç½®æ¡ä»¶**: å·²å®Œæˆ [02-kvm-setup.md](#section-2)  
**é¢„è®¡è€—æ—¶**: 20 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­â˜†

âš ï¸ **é‡è¦è­¦å‘Š**: æœ¬æ–‡æ¡£æ¶‰åŠç£ç›˜åˆ†åŒºæ“ä½œï¼Œæ“ä½œå‰è¯·ç¡®ä¿ç†è§£æ¯ä¸ªæ­¥éª¤ã€‚è™½ç„¶è¿™æ˜¯æ–°ç³»ç»Ÿï¼Œä½†é”™è¯¯æ“ä½œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚

---

## ğŸ“Š æ­¥éª¤ 1: æ£€æŸ¥å½“å‰ç£ç›˜çŠ¶æ€

### 1.1 æŸ¥çœ‹ç£ç›˜å’Œåˆ†åŒºä¿¡æ¯

```bash
sudo su -

# æŸ¥çœ‹æ‰€æœ‰å—è®¾å¤‡
lsblk

# æŸ¥çœ‹è¯¦ç»†åˆ†åŒºä¿¡æ¯
fdisk -l

# æŸ¥çœ‹ LVM ä¿¡æ¯
pvdisplay    # ç‰©ç†å·
vgdisplay    # å·ç»„
lvdisplay    # é€»è¾‘å·

# æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æƒ…å†µ
df -h
```

### 1.2 åˆ›å»ºç£ç›˜çŠ¶æ€æŠ¥å‘Šè„šæœ¬

```bash
cat &gt; /root/check-disk-status.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       å½“å‰ç£ç›˜çŠ¶æ€æŠ¥å‘Š"
echo "========================================="
echo ""

echo "--- å—è®¾å¤‡æ¦‚è§ˆ ---"
lsblk -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT
echo ""

echo "--- ç£ç›˜åˆ†åŒºè¯¦æƒ… ---"
parted /dev/nvme0n1 print 2&gt;/dev/null || fdisk -l /dev/nvme0n1 2&gt;/dev/null || \
    parted /dev/sda print 2&gt;/dev/null || fdisk -l /dev/sda 2&gt;/dev/null
echo ""

echo "--- LVM ç‰©ç†å· ---"
pvdisplay -C
echo ""

echo "--- LVM å·ç»„ ---"
vgdisplay -C
echo ""

echo "--- LVM é€»è¾‘å· ---"
lvdisplay -C
echo ""

echo "--- æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ ---"
df -h | grep -E 'Filesystem|^/dev'
echo ""

echo "--- è®¡ç®—æœªåˆ†é…ç©ºé—´ ---"
DEVICE=$(lsblk -ndo NAME,TYPE | grep disk | head -1 | awk '{print $1}')
DEVICE="/dev/$DEVICE"
TOTAL_SIZE=$(lsblk -bdn -o SIZE $DEVICE)
USED_SIZE=$(parted $DEVICE unit B print free 2&gt;/dev/null | grep -E '^\s+[0-9]' | awk '{print $3}' | sed 's/B//' | awk '{sum+=$1} END {print sum}')
FREE_SIZE=$((TOTAL_SIZE - USED_SIZE))
FREE_GB=$((FREE_SIZE / 1024 / 1024 / 1024))

echo "ç£ç›˜è®¾å¤‡: $DEVICE"
echo "æ€»å®¹é‡: $((TOTAL_SIZE / 1024 / 1024 / 1024)) GB"
echo "æœªåˆ†é…ç©ºé—´: çº¦ ${FREE_GB} GB"
echo ""

echo "========================================="
EOF

chmod +x /root/check-disk-status.sh
```

### 1.3 è¿è¡ŒçŠ¶æ€æ£€æŸ¥

```bash
/root/check-disk-status.sh
```

æ ¹æ®è¾“å‡ºï¼Œè®°å½•æ‚¨çš„ç£ç›˜è®¾å¤‡åç§°ï¼ˆé€šå¸¸æ˜¯ `/dev/nvme0n1` æˆ– `/dev/sda`ï¼‰ã€‚

---

## ğŸ“ æ­¥éª¤ 2: å­˜å‚¨è§„åˆ’æ–¹æ¡ˆ

### 2.1 æ¨èçš„å­˜å‚¨æ¶æ„

åŸºäºæ‚¨çš„éœ€æ±‚ï¼ˆ4 ä¸ªè™šæ‹Ÿæœº + NASï¼‰ï¼Œæ¨èä»¥ä¸‹åˆ†é…ï¼š

```
è‡´æ€ 2TB NVMe SSD (çº¦ 1.86TB å¯ç”¨)
â”‚
â”œâ”€ å·²åˆ†é… (~110GB)
â”‚  â”œâ”€ /boot (1GB)
â”‚  â”œâ”€ / (root, ~100GB)
â”‚  â””â”€ swap (æ ¹æ®å†…å­˜å¤§å°)
â”‚
â””â”€ æ–°åˆ†åŒº (~1.75TB) â† æˆ‘ä»¬è¦é…ç½®çš„
   â”‚
   â”œâ”€ vg_kvm (LVM å·ç»„)
   â”‚  â”‚
   â”‚  â”œâ”€ kvm_thin_pool (LVM thin pool, 1.2TB)
   â”‚  â”‚  â””â”€ è™šæ‹Ÿæœºç£ç›˜ (qcow2/raw)
   â”‚  â”‚     â”œâ”€ python-dev: 80GB (qcow2)
   â”‚  â”‚     â”œâ”€ web-app: 100GB (qcow2)
   â”‚  â”‚     â”œâ”€ router: 20GB (qcow2)
   â”‚  â”‚     â”œâ”€ nas-system: 30GB (raw)
   â”‚  â”‚     â””â”€ é¢„ç•™: ~970GB (æœªæ¥æ‰©å±•)
   â”‚  â”‚
   â”‚  â””â”€ lv_nas_data (LVM é€»è¾‘å·, 500GB)
   â”‚     â””â”€ /data/nas (XFS, ä¾› NAS VM ä½¿ç”¨)
   â”‚
   â””â”€ æœªåˆ†é… (~50GB) â† åº”æ€¥é¢„ç•™
```

### 2.2 ä¸ºä»€ä¹ˆè¿™æ ·è§„åˆ’ï¼Ÿ

**LVM thin pool çš„ä¼˜åŠ¿**:
- **è¿‡é‡åˆ†é…**: å¯ä»¥åˆ›å»ºæ€»å®¹é‡è¶…è¿‡ç‰©ç†ç©ºé—´çš„è™šæ‹Ÿç£ç›˜
- **æŒ‰éœ€ä½¿ç”¨**: å®é™…åªå ç”¨å†™å…¥çš„æ•°æ®ç©ºé—´
- **å¿«ç…§é«˜æ•ˆ**: åˆ›å»ºå¿«ç…§å‡ ä¹ä¸å ç”¨é¢å¤–ç©ºé—´
- **ç»Ÿä¸€ç®¡ç†**: æ‰€æœ‰è™šæ‹Ÿæœºç£ç›˜åœ¨ä¸€ä¸ªæ± ä¸­

**NAS æ•°æ®ç‹¬ç«‹å­˜å‚¨**:
- **æ€§èƒ½ä¼˜åŒ–**: ç‹¬ç«‹ LVM å·ï¼Œé¿å… thin pool å¼€é”€
- **ä¾¿äºå¤‡ä»½**: å¯ä»¥å•ç‹¬æŒ‚è½½å’Œå¤‡ä»½
- **çµæ´»å…±äº«**: é€šè¿‡ virtio-fs å…±äº«ç»™ NAS VMï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿ

---

## ğŸ”¨ æ­¥éª¤ 3: åˆ›å»ºæ–°åˆ†åŒº

### 3.1 ç¡®å®šç£ç›˜è®¾å¤‡

```bash
# æŸ¥æ‰¾ä¸»ç£ç›˜è®¾å¤‡
DISK_DEVICE=$(lsblk -ndo NAME,TYPE | grep disk | head -1 | awk '{print "/dev/"$1}')
echo "æ£€æµ‹åˆ°ç£ç›˜è®¾å¤‡: $DISK_DEVICE"

# éªŒè¯è¿™æ˜¯æ­£ç¡®çš„è®¾å¤‡
lsblk $DISK_DEVICE
```

âš ï¸ **é‡è¦**: ç¡®è®¤ $DISK_DEVICE æ˜¯æ‚¨çš„ 2TB SSDï¼Œä¸æ˜¯å…¶ä»–è®¾å¤‡ï¼

### 3.2 ä½¿ç”¨ parted åˆ›å»ºæ–°åˆ†åŒº

```bash
# æ£€æŸ¥å½“å‰åˆ†åŒºè¡¨ç±»å‹
parted $DISK_DEVICE print

# åˆ›å»ºæ–°åˆ†åŒºï¼ˆä½¿ç”¨å‰©ä½™æ‰€æœ‰ç©ºé—´ï¼‰
# æ³¨æ„ï¼šè¿™ä¼šåˆ›å»ºä¸€ä¸ªå¤§åˆ†åŒºï¼Œæˆ‘ä»¬é¢„ç•™ 50GB çš„æ–¹æ³•æ˜¯ä¸ä½¿ç”¨ 100% è€Œæ˜¯ -50GB
parted $DISK_DEVICE mkpart primary ext4 110GB -50GB

# å¦‚æœæç¤ºåˆ†åŒºæœªå¯¹é½ï¼Œé€‰æ‹© Ignore æˆ– Yes

# æŸ¥çœ‹æ–°åˆ†åŒº
parted $DISK_DEVICE print
lsblk $DISK_DEVICE
```

### 3.3 è·å–æ–°åˆ†åŒºåç§°

```bash
# åˆ—å‡ºåˆ†åŒº
lsblk $DISK_DEVICE

# æ–°åˆ†åŒºé€šå¸¸æ˜¯æœ€åä¸€ä¸ªï¼Œä¾‹å¦‚:
# /dev/nvme0n1p3 (NVMe SSD)
# /dev/sda3 (SATA SSD)

# è®¾ç½®å˜é‡ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
NEW_PARTITION="${DISK_DEVICE}p3"  # NVMe
# æˆ–
# NEW_PARTITION="${DISK_DEVICE}3"  # SATA

# éªŒè¯
ls -l $NEW_PARTITION
```

---

## ğŸ—„ï¸ æ­¥éª¤ 4: é…ç½® LVM

### 4.1 åˆ›å»ºç‰©ç†å· (PV)

```bash
# åˆ›å»ºç‰©ç†å·
pvcreate $NEW_PARTITION

# éªŒè¯
pvdisplay $NEW_PARTITION
pvs
```

### 4.2 åˆ›å»ºå·ç»„ (VG)

```bash
# åˆ›å»ºåä¸º vg_kvm çš„å·ç»„
vgcreate vg_kvm $NEW_PARTITION

# éªŒè¯
vgdisplay vg_kvm
vgs
```

æ‚¨åº”è¯¥çœ‹åˆ°çº¦ 1.7TB çš„å¯ç”¨ç©ºé—´ã€‚

### 4.3 åˆ›å»º thin pool (è™šæ‹Ÿæœºå­˜å‚¨æ± )

```bash
# åˆ›å»º 1.2TB çš„ thin pool
lvcreate -L 1200G --thinpool kvm_thin_pool vg_kvm

# ä¼˜åŒ– thin pool æ€§èƒ½ï¼ˆç¦ç”¨é›¶åˆå§‹åŒ–ï¼‰
lvchange --zero n vg_kvm/kvm_thin_pool

# é…ç½® thin pool è‡ªåŠ¨æ‰©å±•ï¼ˆå½“ä½¿ç”¨ç‡è¶…è¿‡ 80% æ—¶ï¼‰
cat &gt;&gt; /etc/lvm/lvm.conf &lt;&lt;'EOF'

# Thin pool auto-extend settings
activation {
    thin_pool_autoextend_threshold = 80
    thin_pool_autoextend_percent = 20
}
EOF

# éªŒè¯
lvdisplay vg_kvm/kvm_thin_pool
lvs -a vg_kvm
```

### 4.4 åˆ›å»º NAS æ•°æ®å·

```bash
# åˆ›å»º 500GB çš„é€»è¾‘å·
lvcreate -L 500G -n lv_nas_data vg_kvm

# æ ¼å¼åŒ–ä¸º XFSï¼ˆé€‚åˆå¤§æ–‡ä»¶å­˜å‚¨ï¼‰
mkfs.xfs /dev/vg_kvm/lv_nas_data

# åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /data/nas

# æŒ‚è½½
mount /dev/vg_kvm/lv_nas_data /data/nas

# è®¾ç½®æƒé™
chmod 755 /data/nas

# é…ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½
echo "/dev/vg_kvm/lv_nas_data /data/nas xfs defaults 0 0" &gt;&gt; /etc/fstab

# éªŒè¯æŒ‚è½½
df -h /data/nas
mount | grep nas
```

### 4.5 è®¾ç½® SELinux ä¸Šä¸‹æ–‡

```bash
# ä¸º NAS æ•°æ®ç›®å½•è®¾ç½® SELinux ä¸Šä¸‹æ–‡
semanage fcontext -a -t virt_image_t '/data/nas(/.*)?'
restorecon -Rv /data/nas
```

---

## ğŸ¯ æ­¥éª¤ 5: é…ç½® KVM å­˜å‚¨æ± 

### 5.1 é…ç½®åŸºäº LVM thin çš„è™šæ‹Ÿæœºå­˜å‚¨æ± 

```bash
# å®šä¹‰ LVM thin å­˜å‚¨æ± 
virsh pool-define-as kvm_pool logical \
    --source-name vg_kvm \
    --target /dev/vg_kvm

# æ„å»ºå­˜å‚¨æ± 
virsh pool-build kvm_pool

# å¯åŠ¨å­˜å‚¨æ± 
virsh pool-start kvm_pool

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh pool-autostart kvm_pool

# éªŒè¯
virsh pool-list --all
virsh pool-info kvm_pool
```

### 5.2 é…ç½® NAS æ•°æ®ç›®å½•å­˜å‚¨æ± 

```bash
# å®šä¹‰åŸºäºç›®å½•çš„å­˜å‚¨æ± 
virsh pool-define-as nas_data_pool dir --target /data/nas

# å¯åŠ¨
virsh pool-start nas_data_pool

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh pool-autostart nas_data_pool

# éªŒè¯
virsh pool-list --all
virsh pool-info nas_data_pool
```

---

## ğŸ¤– æ­¥éª¤ 6: ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬

### 6.1 åˆ›å»ºå®Œæ•´çš„è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬

```bash
cat &gt; /root/setup-storage-auto.sh &lt;&lt;'EOF'
#!/bin/bash

# å­˜å‚¨æ‰©å±•è‡ªåŠ¨åŒ–è„šæœ¬
# ç”¨é€”: è‡ªåŠ¨é…ç½® KVM è™šæ‹Ÿæœºå­˜å‚¨å’Œ NAS æ•°æ®å­˜å‚¨

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=========================================${NC}"
echo -e "${GREEN}     KVM å­˜å‚¨æ‰©å±•è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬${NC}"
echo -e "${GREEN}=========================================${NC}"
echo ""

# æ£€æŸ¥æ˜¯å¦ä»¥ root è¿è¡Œ
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}é”™è¯¯: è¯·ä»¥ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${NC}"
    exit 1
fi

# é…ç½®å‚æ•°
THIN_POOL_SIZE="1200G"  # thin pool å¤§å°
NAS_DATA_SIZE="500G"    # NAS æ•°æ®å·å¤§å°
VG_NAME="vg_kvm"
THIN_POOL_NAME="kvm_thin_pool"
NAS_LV_NAME="lv_nas_data"
NAS_MOUNT_POINT="/data/nas"

echo -e "${YELLOW}é…ç½®å‚æ•°:${NC}"
echo "  - Thin Pool å¤§å°: $THIN_POOL_SIZE"
echo "  - NAS æ•°æ®å·å¤§å°: $NAS_DATA_SIZE"
echo "  - å·ç»„åç§°: $VG_NAME"
echo "  - NAS æŒ‚è½½ç‚¹: $NAS_MOUNT_POINT"
echo ""

# æ­¥éª¤ 1: æ£€æµ‹ç£ç›˜
echo -e "${GREEN}[1/8] æ£€æµ‹ç£ç›˜è®¾å¤‡...${NC}"
DISK_DEVICE=$(lsblk -ndo NAME,TYPE | grep disk | head -1 | awk '{print "/dev/"$1}')
echo "æ£€æµ‹åˆ°ç£ç›˜: $DISK_DEVICE"
lsblk $DISK_DEVICE
echo ""

read -p "ç¡®è®¤è¿™æ˜¯æ­£ç¡®çš„ç£ç›˜è®¾å¤‡å—? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo -e "${RED}æ“ä½œå·²å–æ¶ˆ${NC}"
    exit 1
fi

# æ­¥éª¤ 2: æŸ¥æ‰¾æœªåˆ†é…ç©ºé—´
echo -e "${GREEN}[2/8] åˆ†ææœªåˆ†é…ç©ºé—´...${NC}"
parted $DISK_DEVICE print free
echo ""

# æ­¥éª¤ 3: åˆ›å»ºæ–°åˆ†åŒº
echo -e "${GREEN}[3/8] åˆ›å»ºæ–°åˆ†åŒº...${NC}"
LAST_PARTITION=$(parted $DISK_DEVICE print | grep '^ ' | tail -1 | awk '{print $1}')
echo "æœ€åä¸€ä¸ªåˆ†åŒºç¼–å·: $LAST_PARTITION"

# è·å–æœ€åä¸€ä¸ªåˆ†åŒºçš„ç»“æŸä½ç½®
LAST_END=$(parted $DISK_DEVICE unit GB print | grep "^ $LAST_PARTITION" | awk '{print $3}' | sed 's/GB//')
echo "æœ€ååˆ†åŒºç»“æŸäº: ${LAST_END}GB"

# åˆ›å»ºæ–°åˆ†åŒºï¼ˆé¢„ç•™ 50GBï¼‰
echo "åˆ›å»ºæ–°åˆ†åŒºä» ${LAST_END}GB åˆ° -50GB..."
parted -a optimal $DISK_DEVICE mkpart primary ext4 ${LAST_END}GB -- -50GB

# åˆ·æ–°åˆ†åŒºè¡¨
partprobe $DISK_DEVICE
sleep 2

# ç¡®å®šæ–°åˆ†åŒºåç§°
if [[ $DISK_DEVICE == *"nvme"* ]]; then
    NEW_PARTITION="${DISK_DEVICE}p$((LAST_PARTITION + 1))"
else
    NEW_PARTITION="${DISK_DEVICE}$((LAST_PARTITION + 1))"
fi

echo "æ–°åˆ†åŒº: $NEW_PARTITION"
ls -l $NEW_PARTITION || (echo -e "${RED}æ–°åˆ†åŒºæœªåˆ›å»ºæˆåŠŸ${NC}" &amp;&amp; exit 1)
echo ""

# æ­¥éª¤ 4: åˆ›å»º LVM ç‰©ç†å·
echo -e "${GREEN}[4/8] åˆ›å»º LVM ç‰©ç†å·...${NC}"
pvcreate $NEW_PARTITION
pvdisplay $NEW_PARTITION
echo ""

# æ­¥éª¤ 5: åˆ›å»ºå·ç»„
echo -e "${GREEN}[5/8] åˆ›å»ºå·ç»„ $VG_NAME...${NC}"
vgcreate $VG_NAME $NEW_PARTITION
vgdisplay $VG_NAME
echo ""

# æ­¥éª¤ 6: åˆ›å»º thin pool
echo -e "${GREEN}[6/8] åˆ›å»º thin pool...${NC}"
lvcreate -L $THIN_POOL_SIZE --thinpool $THIN_POOL_NAME $VG_NAME
lvchange --zero n $VG_NAME/$THIN_POOL_NAME
lvdisplay $VG_NAME/$THIN_POOL_NAME
echo ""

# æ­¥éª¤ 7: åˆ›å»º NAS æ•°æ®å·
echo -e "${GREEN}[7/8] åˆ›å»º NAS æ•°æ®å·...${NC}"
lvcreate -L $NAS_DATA_SIZE -n $NAS_LV_NAME $VG_NAME
mkfs.xfs /dev/$VG_NAME/$NAS_LV_NAME

# æŒ‚è½½ NAS æ•°æ®å·
mkdir -p $NAS_MOUNT_POINT
mount /dev/$VG_NAME/$NAS_LV_NAME $NAS_MOUNT_POINT
chmod 755 $NAS_MOUNT_POINT

# æ·»åŠ åˆ° fstab
if ! grep -q "$NAS_MOUNT_POINT" /etc/fstab; then
    echo "/dev/$VG_NAME/$NAS_LV_NAME $NAS_MOUNT_POINT xfs defaults 0 0" &gt;&gt; /etc/fstab
fi

df -h $NAS_MOUNT_POINT
echo ""

# æ­¥éª¤ 8: é…ç½® KVM å­˜å‚¨æ± 
echo -e "${GREEN}[8/8] é…ç½® KVM å­˜å‚¨æ± ...${NC}"

# LVM thin å­˜å‚¨æ± 
if ! virsh pool-list --all | grep -q kvm_pool; then
    virsh pool-define-as kvm_pool logical --source-name $VG_NAME --target /dev/$VG_NAME
    virsh pool-build kvm_pool
    virsh pool-start kvm_pool
    virsh pool-autostart kvm_pool
fi

# NAS æ•°æ®ç›®å½•å­˜å‚¨æ± 
if ! virsh pool-list --all | grep -q nas_data_pool; then
    virsh pool-define-as nas_data_pool dir --target $NAS_MOUNT_POINT
    virsh pool-start nas_data_pool
    virsh pool-autostart nas_data_pool
fi

# è®¾ç½® SELinux ä¸Šä¸‹æ–‡
if command -v semanage &amp;&gt; /dev/null; then
    semanage fcontext -a -t virt_image_t "${NAS_MOUNT_POINT}(/.*)?" 2&gt;/dev/null || true
    restorecon -Rv $NAS_MOUNT_POINT
fi

virsh pool-list --all
echo ""

echo -e "${GREEN}=========================================${NC}"
echo -e "${GREEN}     é…ç½®å®Œæˆ!${NC}"
echo -e "${GREEN}=========================================${NC}"
echo ""
echo "å­˜å‚¨é…ç½®æ‘˜è¦:"
echo "  - å·ç»„: $VG_NAME"
echo "  - Thin Pool: $THIN_POOL_NAME ($(lvs --noheadings -o lv_size $VG_NAME/$THIN_POOL_NAME | xargs))"
echo "  - NAS æ•°æ®å·: $NAS_LV_NAME ($(lvs --noheadings -o lv_size $VG_NAME/$NAS_LV_NAME | xargs))"
echo "  - NAS æŒ‚è½½ç‚¹: $NAS_MOUNT_POINT"
echo ""
echo "KVM å­˜å‚¨æ± :"
echo "  - kvm_pool: LVM thin pool ç”¨äºè™šæ‹Ÿæœºç£ç›˜"
echo "  - nas_data_pool: ç›®å½•å­˜å‚¨æ± ç”¨äº NAS æ•°æ®"
echo ""
echo "ä¸‹ä¸€æ­¥: è¯·æŸ¥çœ‹ 04-vm-management.md åˆ›å»ºè™šæ‹Ÿæœº"
EOF

chmod +x /root/setup-storage-auto.sh
```

### 6.2 è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆå¯é€‰ï¼‰

âš ï¸ **æ³¨æ„**: å¦‚æœæ‚¨å·²ç»æ‰‹åŠ¨å®Œæˆäº†æ­¥éª¤ 3-5ï¼Œè·³è¿‡æ­¤æ­¥éª¤ã€‚

```bash
# å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œè¿è¡Œ:
# /root/setup-storage-auto.sh
```

---

## âœ… æ­¥éª¤ 7: éªŒè¯é…ç½®

### 7.1 åˆ›å»ºéªŒè¯è„šæœ¬

```bash
cat &gt; /root/verify-storage.sh &lt;&lt;'EOF'
#!/bin/bash

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "========================================="
echo "       å­˜å‚¨é…ç½®éªŒè¯"
echo "========================================="
echo ""

check_pass() {
    echo -e "${GREEN}âœ“${NC} $1"
}

check_fail() {
    echo -e "${RED}âœ—${NC} $1"
}

check_info() {
    echo -e "${YELLOW}â„¹${NC} $1"
}

# 1. LVM å·ç»„
echo "1. æ£€æŸ¥ LVM å·ç»„..."
if vgs vg_kvm &amp;&gt;/dev/null; then
    VG_SIZE=$(vgs --noheadings -o vg_size vg_kvm | xargs)
    VG_FREE=$(vgs --noheadings -o vg_free vg_kvm | xargs)
    check_pass "å·ç»„ vg_kvm å­˜åœ¨ (å¤§å°: $VG_SIZE, å¯ç”¨: $VG_FREE)"
else
    check_fail "å·ç»„ vg_kvm ä¸å­˜åœ¨"
    exit 1
fi

# 2. Thin pool
echo "2. æ£€æŸ¥ thin pool..."
if lvs vg_kvm/kvm_thin_pool &amp;&gt;/dev/null; then
    POOL_SIZE=$(lvs --noheadings -o lv_size vg_kvm/kvm_thin_pool | xargs)
    POOL_DATA=$(lvs --noheadings -o data_percent vg_kvm/kvm_thin_pool | xargs)
    check_pass "Thin pool å­˜åœ¨ (å¤§å°: $POOL_SIZE, ä½¿ç”¨ç‡: $POOL_DATA)"
else
    check_fail "Thin pool ä¸å­˜åœ¨"
fi

# 3. NAS æ•°æ®å·
echo "3. æ£€æŸ¥ NAS æ•°æ®å·..."
if lvs vg_kvm/lv_nas_data &amp;&gt;/dev/null; then
    NAS_SIZE=$(lvs --noheadings -o lv_size vg_kvm/lv_nas_data | xargs)
    check_pass "NAS æ•°æ®å·å­˜åœ¨ (å¤§å°: $NAS_SIZE)"
else
    check_fail "NAS æ•°æ®å·ä¸å­˜åœ¨"
fi

# 4. NAS æŒ‚è½½
echo "4. æ£€æŸ¥ NAS æŒ‚è½½..."
if mount | grep -q '/data/nas'; then
    NAS_USAGE=$(df -h /data/nas | tail -1 | awk '{print $5 " å·²ç”¨ï¼Œå‰©ä½™ " $4}')
    check_pass "NAS å·²æŒ‚è½½åˆ° /data/nas ($NAS_USAGE)"
else
    check_fail "NAS æœªæŒ‚è½½"
fi

if grep -q '/data/nas' /etc/fstab; then
    check_pass "NAS å·²æ·»åŠ åˆ° /etc/fstab (å¼€æœºè‡ªåŠ¨æŒ‚è½½)"
else
    check_fail "NAS æœªæ·»åŠ åˆ° /etc/fstab"
fi

# 5. KVM å­˜å‚¨æ± 
echo "5. æ£€æŸ¥ KVM å­˜å‚¨æ± ..."
if virsh pool-list --all | grep -q kvm_pool; then
    KVM_POOL_STATE=$(virsh pool-list --all | grep kvm_pool | awk '{print $2}')
    if [ "$KVM_POOL_STATE" == "active" ] || [ "$KVM_POOL_STATE" == "æ´»åŠ¨" ]; then
        check_pass "kvm_pool å­˜å‚¨æ± æ´»åŠ¨"
    else
        check_fail "kvm_pool å­˜å‚¨æ± ä¸æ´»åŠ¨"
    fi
else
    check_fail "kvm_pool å­˜å‚¨æ± ä¸å­˜åœ¨"
fi

if virsh pool-list --all | grep -q nas_data_pool; then
    NAS_POOL_STATE=$(virsh pool-list --all | grep nas_data_pool | awk '{print $2}')
    if [ "$NAS_POOL_STATE" == "active" ] || [ "$NAS_POOL_STATE" == "æ´»åŠ¨" ]; then
        check_pass "nas_data_pool å­˜å‚¨æ± æ´»åŠ¨"
    else
        check_fail "nas_data_pool å­˜å‚¨æ± ä¸æ´»åŠ¨"
    fi
else
    check_fail "nas_data_pool å­˜å‚¨æ± ä¸å­˜åœ¨"
fi

echo ""
echo "========================================="
echo "       è¯¦ç»†ä¿¡æ¯"
echo "========================================="
echo ""
echo "--- LVM é€»è¾‘å· ---"
lvs vg_kvm
echo ""
echo "--- KVM å­˜å‚¨æ±  ---"
virsh pool-list --all
echo ""
echo "--- ç£ç›˜ä½¿ç”¨æƒ…å†µ ---"
df -h | grep -E 'Filesystem|vg_kvm'
echo ""
echo "========================================="
echo "éªŒè¯å®Œæˆ!"
echo "========================================="
EOF

chmod +x /root/verify-storage.sh
```

### 7.2 è¿è¡ŒéªŒè¯

```bash
/root/verify-storage.sh
```

### 7.3 æµ‹è¯•åˆ›å»ºè™šæ‹Ÿç£ç›˜

```bash
# æµ‹è¯•åœ¨ thin pool ä¸­åˆ›å»º thin volume
lvcreate -V 100G --thinpool kvm_thin_pool -n test_thin_vol vg_kvm

# æŸ¥çœ‹
lvs vg_kvm
lvdisplay vg_kvm/test_thin_vol

# åˆ é™¤æµ‹è¯•å·
lvremove -f vg_kvm/test_thin_vol

# æµ‹è¯•é€šè¿‡ virsh åˆ›å»ºè™šæ‹Ÿç£ç›˜
virsh vol-create-as kvm_pool test-disk.qcow2 50G --format qcow2

# æŸ¥çœ‹
virsh vol-list kvm_pool

# åˆ é™¤æµ‹è¯•ç£ç›˜
virsh vol-delete test-disk.qcow2 kvm_pool

echo "æµ‹è¯•æˆåŠŸï¼"
```

---

## ğŸ“Š æ­¥éª¤ 8: å®¹é‡è§„åˆ’å’Œç›‘æ§

### 8.1 åˆ›å»ºå®¹é‡è§„åˆ’æ–‡æ¡£

```bash
cat &gt; /root/storage-capacity-plan.txt &lt;&lt;'EOF'
========================================
        å­˜å‚¨å®¹é‡è§„åˆ’
========================================

æ€»å­˜å‚¨: çº¦ 1.75TB (vg_kvm)

å·²åˆ†é…:
  - kvm_thin_pool:  1200GB (è™šæ‹Ÿæœºå­˜å‚¨)
  - lv_nas_data:     500GB (NAS æ•°æ®)
  - æ€»è®¡:           1700GB

æœªåˆ†é…: çº¦ 50GB (é¢„ç•™)

========================================
è™šæ‹Ÿæœºç£ç›˜åˆ†é… (åœ¨ thin pool ä¸­):
========================================

1. python-dev
   - ç³»ç»Ÿç›˜: 80GB (qcow2)
   - å®é™…å ç”¨: çº¦ 10-20GB (å–å†³äºå®‰è£…çš„è½¯ä»¶)

2. web-app
   - ç³»ç»Ÿç›˜: 100GB (qcow2)
   - å®é™…å ç”¨: çº¦ 15-30GB

3. router (æ—è·¯ç”±)
   - ç³»ç»Ÿç›˜: 20GB (qcow2)
   - å®é™…å ç”¨: çº¦ 2-5GB

4. nas
   - ç³»ç»Ÿç›˜: 30GB (raw, ä» thin pool)
   - å®é™…å ç”¨: 30GB (raw æ ¼å¼ç«‹å³å ç”¨å…¨éƒ¨ç©ºé—´)
   - æ•°æ®ç›˜: ä½¿ç”¨ /data/nas (500GB ç‹¬ç«‹å·)

è™šæ‹Ÿç£ç›˜æ€»åˆ†é…: 230GB
Thin pool æ€»å®¹é‡: 1200GB
å¯ç”¨äºæ‰©å±•æˆ–æ–° VM: çº¦ 970GB

========================================
Thin Pool ç‰¹æ€§:
========================================

- è¿‡é‡åˆ†é…: å¯ä»¥åˆ›å»ºæ€»å’Œ &gt; 1200GB çš„è™šæ‹Ÿç£ç›˜
- å®é™…ä½¿ç”¨: åªå ç”¨å®é™…å†™å…¥çš„æ•°æ®ç©ºé—´
- ä¾‹å¦‚: åˆ›å»º 5 ä¸ª 100GB çš„è™šæ‹Ÿç£ç›˜ (å…± 500GB)
        å¦‚æœæ¯ä¸ªåªç”¨äº† 20GBï¼Œå®é™…åªå ç”¨ 100GB

æ³¨æ„: éœ€è¦ç›‘æ§ thin pool ä½¿ç”¨ç‡ï¼Œé¿å…çœŸæ­£ç”¨æ»¡

========================================
ç›‘æ§å‘½ä»¤:
========================================

# æŸ¥çœ‹ thin pool ä½¿ç”¨ç‡
lvs -a vg_kvm

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
lvdisplay vg_kvm/kvm_thin_pool

# æŸ¥çœ‹æ‰€æœ‰è™šæ‹Ÿç£ç›˜
virsh vol-list kvm_pool

# æŸ¥çœ‹ NAS æ•°æ®ä½¿ç”¨
df -h /data/nas

========================================
æ‰©å®¹æŒ‡å—:
========================================

å¦‚æœ thin pool ä¸å¤Ÿç”¨:
1. æ‰©å±• thin pool
   lvextend -L +100G vg_kvm/kvm_thin_pool

å¦‚æœ NAS æ•°æ®ä¸å¤Ÿç”¨:
1. å¸è½½ NAS
   umount /data/nas
2. æ‰©å±•é€»è¾‘å·
   lvextend -L +100G vg_kvm/lv_nas_data
3. æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ
   xfs_growfs /data/nas
4. é‡æ–°æŒ‚è½½
   mount /data/nas

å¦‚æœå·ç»„ç©ºé—´ä¸å¤Ÿ:
1. ä½¿ç”¨æœªåˆ†é…çš„ 50GB
   parted /dev/nvmeXnY mkpart primary ext4 YYYYgb 100%
   pvcreate /dev/nvmeXnYpZ
   vgextend vg_kvm /dev/nvmeXnYpZ
EOF

cat /root/storage-capacity-plan.txt
```

### 8.2 åˆ›å»ºç›‘æ§è„šæœ¬

```bash
cat &gt; /usr/local/bin/storage-monitor &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       å­˜å‚¨ä½¿ç”¨ç›‘æ§"
echo "========================================="
date
echo ""

echo "--- LVM å·ç»„çŠ¶æ€ ---"
vgs vg_kvm
echo ""

echo "--- Thin Pool ä½¿ç”¨æƒ…å†µ ---"
lvs -a vg_kvm | grep -E 'LV|thin'
echo ""

POOL_DATA=$(lvs --noheadings -o data_percent vg_kvm/kvm_thin_pool | xargs | sed 's/%//')
POOL_META=$(lvs --noheadings -o metadata_percent vg_kvm/kvm_thin_pool | xargs | sed 's/%//')

echo "Thin Pool æ•°æ®ä½¿ç”¨ç‡: ${POOL_DATA}%"
echo "Thin Pool å…ƒæ•°æ®ä½¿ç”¨ç‡: ${POOL_META}%"

if (( $(echo "$POOL_DATA &gt; 80" | bc -l) )); then
    echo "âš ï¸  è­¦å‘Š: Thin pool æ•°æ®ä½¿ç”¨ç‡è¶…è¿‡ 80%!"
fi

if (( $(echo "$POOL_META &gt; 80" | bc -l) )); then
    echo "âš ï¸  è­¦å‘Š: Thin pool å…ƒæ•°æ®ä½¿ç”¨ç‡è¶…è¿‡ 80%!"
fi
echo ""

echo "--- NAS æ•°æ®å·ä½¿ç”¨æƒ…å†µ ---"
df -h /data/nas
echo ""

echo "--- è™šæ‹Ÿæœºç£ç›˜åˆ—è¡¨ ---"
virsh vol-list kvm_pool 2&gt;/dev/null || echo "kvm_pool ä¸­æš‚æ— è™šæ‹Ÿç£ç›˜"
echo ""

echo "========================================="
EOF

chmod +x /usr/local/bin/storage-monitor
```

### 8.3 è¿è¡Œç›‘æ§

```bash
storage-monitor
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

å®Œæˆæœ¬æ–‡æ¡£åï¼Œæ‚¨åº”è¯¥å·²ç»é…ç½®å¥½ï¼š

- [x] åˆ›å»ºäº†æ–°çš„ç£ç›˜åˆ†åŒºï¼ˆçº¦ 1.7TBï¼‰
- [x] é…ç½®äº† LVM ç‰©ç†å·å’Œå·ç»„ (vg_kvm)
- [x] åˆ›å»ºäº† LVM thin pool (1.2TB)
- [x] åˆ›å»ºäº† NAS æ•°æ®é€»è¾‘å· (500GB)
- [x] NAS æ•°æ®å·å·²æŒ‚è½½åˆ° /data/nas
- [x] é…ç½®äº† KVM å­˜å‚¨æ±  (kvm_pool)
- [x] é…ç½®äº† NAS æ•°æ®å­˜å‚¨æ±  (nas_data_pool)
- [x] éªŒè¯è„šæœ¬æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®æ­£å¸¸
- [x] é¢„ç•™äº†çº¦ 50GB åº”æ€¥ç©ºé—´

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: parted åˆ›å»ºåˆ†åŒºå¤±è´¥

**ç—‡çŠ¶**: æç¤º"åˆ†åŒºæœªå¯¹é½"æˆ–"æ— æ³•åˆ›å»ºåˆ†åŒº"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ä½¿ç”¨ -a optimal å‚æ•°
parted -a optimal /dev/nvme0n1 mkpart primary ext4 110GB -50GB

# æˆ–è€…å¿½ç•¥å¯¹é½è­¦å‘Š
# åœ¨ parted äº¤äº’æ¨¡å¼ä¸­é€‰æ‹© "Ignore"
```

### é—®é¢˜ 2: thin pool åˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**: lvcreate æç¤ºç©ºé—´ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å·ç»„å¯ç”¨ç©ºé—´
vgs vg_kvm

# å¦‚æœå¯ç”¨ç©ºé—´å°äº 1200GBï¼Œå‡å° thin pool å¤§å°
lvcreate -L 1000G --thinpool kvm_thin_pool vg_kvm

# æˆ–ä½¿ç”¨ç™¾åˆ†æ¯”
lvcreate -l 70%FREE --thinpool kvm_thin_pool vg_kvm
```

### é—®é¢˜ 3: NAS æ•°æ®å·æ— æ³•æŒ‚è½½

**ç—‡çŠ¶**: mount å‘½ä»¤å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥é€»è¾‘å·æ˜¯å¦å­˜åœ¨
lvs vg_kvm/lv_nas_data

# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
blkid /dev/vg_kvm/lv_nas_data

# å¦‚æœæœªæ ¼å¼åŒ–ï¼Œé‡æ–°æ ¼å¼åŒ–
mkfs.xfs -f /dev/vg_kvm/lv_nas_data

# æ£€æŸ¥æŒ‚è½½ç‚¹
ls -ld /data/nas

# å°è¯•æ‰‹åŠ¨æŒ‚è½½
mount -t xfs /dev/vg_kvm/lv_nas_data /data/nas

# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
dmesg | tail -20
```

### é—®é¢˜ 4: KVM å­˜å‚¨æ± æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: virsh pool-start å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
virsh pool-start kvm_pool

# åˆ é™¤å¹¶é‡æ–°åˆ›å»º
virsh pool-destroy kvm_pool
virsh pool-undefine kvm_pool
virsh pool-define-as kvm_pool logical --source-name vg_kvm --target /dev/vg_kvm
virsh pool-build kvm_pool
virsh pool-start kvm_pool

# æ£€æŸ¥æƒé™
ls -l /dev/vg_kvm/

# æ£€æŸ¥ SELinux
getenforce
# å¦‚æœæ˜¯ Enforcingï¼Œä¸´æ—¶åˆ‡æ¢åˆ° Permissive æµ‹è¯•
setenforce 0
virsh pool-start kvm_pool
setenforce 1
```

### é—®é¢˜ 5: Thin pool ä½¿ç”¨ç‡å¼‚å¸¸å¢é•¿

**ç—‡çŠ¶**: thin pool å¿«é€Ÿå¡«æ»¡

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹å“ªä¸ªè™šæ‹Ÿç£ç›˜å ç”¨ç©ºé—´å¤§
lvs -a vg_kvm

# åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œ fstrim é‡Šæ”¾ç©ºé—´
# (åœ¨è™šæ‹Ÿæœºå†…è¿è¡Œ)
sudo fstrim -av

# å®¿ä¸»æœºä¸Šæ£€æŸ¥ thin pool
lvs -a vg_kvm/kvm_thin_pool

# å¦‚æœç¡®å®éœ€è¦æ›´å¤šç©ºé—´ï¼Œæ‰©å±• thin pool
lvextend -L +100G vg_kvm/kvm_thin_pool
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸé…ç½®äº†å­˜å‚¨æ¶æ„ã€‚

ç°åœ¨æ‚¨å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ï¼š

ğŸ‘‰ **[04-vm-management.md - è™šæ‹Ÿæœºåˆ›å»ºå’Œç®¡ç†](#section-4)**

---

## ğŸ’¡ çŸ¥è¯†è¡¥å……

### LVM Thin Provisioning åŸç†

**ä¼ ç»Ÿ LVM**:
- åˆ›å»º 100GB é€»è¾‘å· â†’ ç«‹å³å ç”¨ 100GB ç‰©ç†ç©ºé—´
- å³ä½¿åªå†™å…¥ 1GB æ•°æ®ï¼Œä¹Ÿå ç”¨ 100GB

**Thin Provisioning**:
- åˆ›å»º 100GB thin volume â†’ å‡ ä¹ä¸å ç”¨ç‰©ç†ç©ºé—´
- å†™å…¥ 1GB æ•°æ® â†’ å ç”¨çº¦ 1GB ç‰©ç†ç©ºé—´
- å†™å…¥å¤šå°‘ï¼Œå ç”¨å¤šå°‘

**ä¼˜åŠ¿**:
- **è¿‡é‡åˆ†é…**: å¯ä»¥åˆ›å»ºæ€»å’Œ &gt; ç‰©ç†ç©ºé—´çš„è™šæ‹Ÿç£ç›˜
- **èŠ‚çœç©ºé—´**: å®é™…æŒ‰éœ€åˆ†é…
- **å¿«ç…§é«˜æ•ˆ**: å¿«ç…§åªå­˜å‚¨å·®å¼‚æ•°æ®

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ å¿…é¡»ç›‘æ§ä½¿ç”¨ç‡ï¼Œé¿å…çœŸæ­£ç”¨æ»¡å¯¼è‡´ I/O é”™è¯¯
- âš ï¸ éœ€è¦é…ç½®è‡ªåŠ¨æ‰©å±•ç­–ç•¥
- âš ï¸ æ€§èƒ½ç•¥ä½äºä¼ ç»Ÿ LVMï¼ˆ5-10%ï¼‰

### qcow2 vs raw æ ¼å¼é€‰æ‹©

| ç‰¹æ€§ | qcow2 | raw |
|------|-------|-----|
| ç©ºé—´å ç”¨ | æŒ‰éœ€å¢é•¿ | ç«‹å³å ç”¨å…¨éƒ¨ |
| æ€§èƒ½ | ç•¥ä½ 5-10% | æœ€ä½³ |
| å¿«ç…§ | åŸç”Ÿæ”¯æŒ | éœ€è¦ LVM å¿«ç…§ |
| å‹ç¼© | æ”¯æŒ | ä¸æ”¯æŒ |
| å…¼å®¹æ€§ | KVM/QEMU ä¸“ç”¨ | é€šç”¨æ ¼å¼ |
| æ¨èåœºæ™¯ | å¼€å‘ã€æµ‹è¯• VM | ç”Ÿäº§ã€æ•°æ®åº“ VM |

**æˆ‘ä»¬çš„é€‰æ‹©**:
- **python-dev, web-app, router**: qcow2ï¼ˆæ–¹ä¾¿å¿«ç…§å’Œå…‹éš†ï¼‰
- **nas ç³»ç»Ÿç›˜**: rawï¼ˆæ›´å¥½çš„ I/O æ€§èƒ½ï¼‰
- **nas æ•°æ®**: ç‹¬ç«‹ LVM å·ï¼ˆæœ€ä½³æ€§èƒ½å’Œçµæ´»æ€§ï¼‰

### å­˜å‚¨æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **XFS vs Ext4 for NAS**:
   - XFS: å¤§æ–‡ä»¶æ€§èƒ½æ›´å¥½ï¼Œæ”¯æŒåœ¨çº¿æ‰©å±•
   - Ext4: å°æ–‡ä»¶æ€§èƒ½æ›´å¥½ï¼Œæ›´æˆç†Ÿ
   - æ¨è NAS ä½¿ç”¨ XFS

2. **LVM æ¡å¸¦åŒ–** (å¦‚æœæœ‰å¤šå—ç›˜):
   ```bash
   lvcreate -L 1TB -i 2 -I 64 -n striped_vol vg_kvm
   # -i 2: ä½¿ç”¨ 2 å—ç›˜æ¡å¸¦åŒ–
   # -I 64: æ¡å¸¦å¤§å° 64KB
   ```

3. **SSD TRIM æ”¯æŒ**:
   ```bash
   # å¯ç”¨ discard (å®šæœŸ TRIM)
   lvchange --discards passdown vg_kvm/lv_nas_data
   ```

è¿™äº›é«˜çº§ä¼˜åŒ–å°†åœ¨å®é™…ä½¿ç”¨ä¸­æ ¹æ®æ€§èƒ½éœ€æ±‚è°ƒæ•´ã€‚




---



# 04 - è™šæ‹Ÿæœºåˆ›å»ºå’Œç®¡ç†

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£æä¾›è™šæ‹Ÿæœºåˆ›å»ºå’Œæ—¥å¸¸ç®¡ç†çš„å®ç”¨è„šæœ¬å’Œå·¥å…·ï¼ŒåŒ…æ‹¬ï¼š

- âœ… è™šæ‹Ÿæœºåˆ›å»ºè„šæœ¬
- âœ… è™šæ‹Ÿæœºå¯åŠ¨/åœæ­¢ç®¡ç†
- âœ… èµ„æºåˆ†é…ç­–ç•¥  
- âœ… è‡ªåŠ¨å¯åŠ¨é…ç½®
- âœ… ç»Ÿä¸€ç®¡ç†å·¥å…·
- âœ… å¸¸ç”¨æ“ä½œé€ŸæŸ¥

**å‰ç½®æ¡ä»¶**: å·²å®Œæˆ [03-storage-expansion.md](#section-3)  
**é¢„è®¡è€—æ—¶**: 15 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†

---

## ğŸš€ å¿«é€Ÿåˆ›å»ºè™šæ‹Ÿæœºè„šæœ¬

### åˆ›å»ºé€šç”¨VMåˆ›å»ºè„šæœ¬

```bash
sudo su -

cat &gt; /usr/local/bin/create-vm &lt;&lt;'EOF'
#!/bin/bash

# è™šæ‹Ÿæœºåˆ›å»ºè„šæœ¬
# ç”¨æ³•: create-vm &lt;vm-name&gt; &lt;ram-gb&gt; &lt;vcpus&gt; &lt;disk-gb&gt; &lt;disk-format&gt; &lt;iso-path&gt; &lt;static-ip&gt;

set -e

if [ $# -lt 7 ]; then
    echo "ç”¨æ³•: $0 &lt;vm-name&gt; &lt;ram-gb&gt; &lt;vcpus&gt; &lt;disk-gb&gt; &lt;format&gt; &lt;iso-path&gt; &lt;static-ip&gt;"
    echo "ç¤ºä¾‹: $0 python-dev 4 2 80 qcow2 /kvm/iso/ubuntu-22.04.iso 192.168.71.201"
    exit 1
fi

VM_NAME=$1
RAM_GB=$2
VCPUS=$3
DISK_GB=$4
DISK_FORMAT=$5
ISO_PATH=$6
STATIC_IP=$7

RAM_MB=$((RAM_GB * 1024))

echo "========================================="
echo "åˆ›å»ºè™šæ‹Ÿæœº: $VM_NAME"
echo "========================================="
echo "å†…å­˜: ${RAM_GB}GB"
echo "vCPU: $VCPUS"
echo "ç£ç›˜: ${DISK_GB}GB ($DISK_FORMAT)"
echo "ISO: $ISO_PATH"
echo "IPåœ°å€: $STATIC_IP"
echo ""

# æ£€æŸ¥ISOæ˜¯å¦å­˜åœ¨
if [ ! -f "$ISO_PATH" ]; then
    echo "é”™è¯¯: ISOæ–‡ä»¶ä¸å­˜åœ¨: $ISO_PATH"
    exit 1
fi

# åˆ›å»ºè™šæ‹Ÿç£ç›˜
if [ "$DISK_FORMAT" == "qcow2" ]; then
    virsh vol-create-as kvm_pool ${VM_NAME}.qcow2 ${DISK_GB}G --format qcow2
elif [ "$DISK_FORMAT" == "raw" ]; then
    lvcreate -V ${DISK_GB}G --thinpool kvm_thin_pool -n ${VM_NAME} vg_kvm
    DISK_PATH="/dev/vg_kvm/${VM_NAME}"
else
    echo "é”™è¯¯: ä¸æ”¯æŒçš„ç£ç›˜æ ¼å¼: $DISK_FORMAT"
    exit 1
fi

# ç¡®å®šç£ç›˜è·¯å¾„
if [ "$DISK_FORMAT" == "qcow2" ]; then
    DISK_PATH="/dev/vg_kvm/kvm_thin_pool+${VM_NAME}.qcow2"
fi

# åˆ›å»ºè™šæ‹Ÿæœº
virt-install \
    --name $VM_NAME \
    --ram $RAM_MB \
    --vcpus $VCPUS \
    --disk path=$DISK_PATH,format=$DISK_FORMAT,bus=virtio \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0 \
    --cdrom $ISO_PATH \
    --os-variant generic \
    --noautoconsole

echo ""
echo "è™šæ‹Ÿæœº $VM_NAME åˆ›å»ºæˆåŠŸ!"
echo ""
echo "ä¸‹ä¸€æ­¥:"
echo "1. ä½¿ç”¨VNCå®¢æˆ·ç«¯è¿æ¥å¹¶å®‰è£…ç³»ç»Ÿ"
echo "   IP: 192.168.71.200"
echo "   ç«¯å£: $(virsh vncdisplay $VM_NAME | cut -d: -f2 | awk '{print 5900+$1}')"
echo ""
echo "2. åœ¨ç³»ç»Ÿå®‰è£…æ—¶é…ç½®é™æ€IP: $STATIC_IP"
echo ""
echo "3. å®‰è£…å®Œæˆåæ‰§è¡Œ:"
echo "   virsh change-media $VM_NAME sda --eject"
echo "   virsh autostart $VM_NAME"
EOF

chmod +x /usr/local/bin/create-vm
```

---

## ğŸ“Š è™šæ‹Ÿæœºç®¡ç†å·¥å…·

### åˆ›å»ºVMç®¡ç†è„šæœ¬

```bash
cat &gt; /usr/local/bin/vm-manager &lt;&lt;'EOF'
#!/bin/bash

# è™šæ‹Ÿæœºç®¡ç†å·¥å…·

cmd_list() {
    echo "æ‰€æœ‰è™šæ‹ŸæœºçŠ¶æ€:"
    virsh list --all
}

cmd_start() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager start &lt;vm-name&gt;"
        return 1
    fi
    echo "å¯åŠ¨è™šæ‹Ÿæœº: $1"
    virsh start $1
}

cmd_stop() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager stop &lt;vm-name&gt;"
        return 1
    fi
    echo "å…³é—­è™šæ‹Ÿæœº: $1"
    virsh shutdown $1
}

cmd_force_stop() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager force-stop &lt;vm-name&gt;"
        return 1
    fi
    echo "å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº: $1"
    virsh destroy $1
}

cmd_restart() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager restart &lt;vm-name&gt;"
        return 1
    fi
    echo "é‡å¯è™šæ‹Ÿæœº: $1"
    virsh reboot $1
}

cmd_console() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager console &lt;vm-name&gt;"
        return 1
    fi
    echo "è¿æ¥åˆ°è™šæ‹Ÿæœºæ§åˆ¶å° (Ctrl+] é€€å‡º):"
    virsh console $1
}

cmd_info() {
    if [ -z "$1" ]; then
        echo "ç”¨æ³•: vm-manager info &lt;vm-name&gt;"
        return 1
    fi
    virsh dominfo $1
}

cmd_status() {
    echo "========================================="
    echo "       è™šæ‹ŸæœºçŠ¶æ€æ€»è§ˆ"
    echo "========================================="
    echo ""
    virsh list --all
    echo ""
    echo "--- èµ„æºä½¿ç”¨ ---"
    for vm in $(virsh list --name); do
        if [ -n "$vm" ]; then
            echo "VM: $vm"
            virsh domstats $vm | grep -E 'cpu\.|balloon\.current'
            echo ""
        fi
    done
}

cmd_start_all() {
    echo "å¯åŠ¨æ‰€æœ‰å·²å®šä¹‰ä¸ºè‡ªåŠ¨å¯åŠ¨çš„è™šæ‹Ÿæœº..."
    for vm in $(virsh list --autostart --name); do
        if ! virsh list --name | grep -q "^${vm}$"; then
            echo "å¯åŠ¨: $vm"
            virsh start $vm
        fi
    done
}

cmd_stop_all() {
    echo "å…³é—­æ‰€æœ‰è¿è¡Œä¸­çš„è™šæ‹Ÿæœº..."
    for vm in $(virsh list --name); do
        if [ -n "$vm" ]; then
            echo "å…³é—­: $vm"
            virsh shutdown $vm
        fi
    done
}

case "$1" in
    list|ls)
        cmd_list
        ;;
    start)
        cmd_start $2
        ;;
    stop|shutdown)
        cmd_stop $2
        ;;
    force-stop|destroy)
        cmd_force_stop $2
        ;;
    restart|reboot)
        cmd_restart $2
        ;;
    console|con)
        cmd_console $2
        ;;
    info)
        cmd_info $2
        ;;
    status|st)
        cmd_status
        ;;
    start-all)
        cmd_start_all
        ;;
    stop-all|shutdown-all)
        cmd_stop_all
        ;;
    *)
        echo "è™šæ‹Ÿæœºç®¡ç†å·¥å…·"
        echo ""
        echo "ç”¨æ³•: vm-manager &lt;command&gt; [vm-name]"
        echo ""
        echo "å‘½ä»¤:"
        echo "  list              åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœº"
        echo "  start &lt;vm&gt;        å¯åŠ¨è™šæ‹Ÿæœº"
        echo "  stop &lt;vm&gt;         å…³é—­è™šæ‹Ÿæœº"
        echo "  force-stop &lt;vm&gt;   å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº"
        echo "  restart &lt;vm&gt;      é‡å¯è™šæ‹Ÿæœº"
        echo "  console &lt;vm&gt;      è¿æ¥åˆ°è™šæ‹Ÿæœºæ§åˆ¶å°"
        echo "  info &lt;vm&gt;         æ˜¾ç¤ºè™šæ‹Ÿæœºä¿¡æ¯"
        echo "  status            æ˜¾ç¤ºæ‰€æœ‰VMçŠ¶æ€"
        echo "  start-all         å¯åŠ¨æ‰€æœ‰è‡ªåŠ¨å¯åŠ¨çš„VM"
        echo "  stop-all          å…³é—­æ‰€æœ‰è¿è¡Œä¸­çš„VM"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/vm-manager
```

---

## ğŸ’¾ è™šæ‹Ÿæœºå¤‡ä»½è„šæœ¬

```bash
cat &gt; /usr/local/bin/vm-backup &lt;&lt;'EOF'
#!/bin/bash

VM_NAME=$1
BACKUP_DIR="/backup/vms"

if [ -z "$VM_NAME" ]; then
    echo "ç”¨æ³•: vm-backup &lt;vm-name&gt;"
    exit 1
fi

mkdir -p $BACKUP_DIR

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${VM_NAME}-${TIMESTAMP}.xml"

echo "å¤‡ä»½è™šæ‹Ÿæœºé…ç½®: $VM_NAME"
virsh dumpxml $VM_NAME &gt; $BACKUP_FILE

echo "é…ç½®å·²å¤‡ä»½åˆ°: $BACKUP_FILE"
echo ""
echo "å¤‡ä»½ç£ç›˜éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ:"
DISK=$(virsh domblklist $VM_NAME | grep vd | awk '{print $2}')
echo "  cp $DISK ${BACKUP_DIR}/${VM_NAME}-${TIMESTAMP}.img"
EOF

chmod +x /usr/local/bin/vm-backup
```

---

## ğŸ“ è™šæ‹Ÿæœºèµ„æºåˆ†é…ç­–ç•¥

### æ¨èé…ç½®

```bash
cat &gt; /root/vm-resource-plan.txt &lt;&lt;'EOF'
========================================
        è™šæ‹Ÿæœºèµ„æºåˆ†é…è®¡åˆ’
========================================

å®¿ä¸»æœºé…ç½®:
  - CPU: AMD R5 5600G (6æ ¸12çº¿ç¨‹)
  - å†…å­˜: 32GB
  - å¯ç”¨äºVM: ~28GBå†…å­˜, 10-11ä¸ªvCPU

è™šæ‹Ÿæœºåˆ†é…:
========================================

1. python-dev (Pythonå¼€å‘)
   - vCPU: 2
   - å†…å­˜: 4GB  
   - ç£ç›˜: 80GB (qcow2)
   - IP: 192.168.71.201
   - è‡ªåŠ¨å¯åŠ¨: å¦

2. web-app (Webåº”ç”¨éƒ¨ç½²)
   - vCPU: 2
   - å†…å­˜: 4GB
   - ç£ç›˜: 100GB (qcow2)
   - IP: 192.168.71.202
   - è‡ªåŠ¨å¯åŠ¨: æ˜¯

3. router (æ—è·¯ç”±)
   - vCPU: 2
   - å†…å­˜: 2GB
   - ç£ç›˜: 20GB (qcow2)
   - IP: 192.168.71.254
   - è‡ªåŠ¨å¯åŠ¨: æ˜¯

4. nas (æ–‡ä»¶æœåŠ¡å™¨)
   - vCPU: 2
   - å†…å­˜: 4GB
   - ç£ç›˜: 30GB (raw) + 500GBæ•°æ®å·
   - IP: 192.168.71.210
   - è‡ªåŠ¨å¯åŠ¨: æ˜¯

æ€»è®¡:
  - vCPU: 8 (ç•™4ä¸ªç»™å®¿ä¸»æœº)
  - å†…å­˜: 14GB (ç•™18GBç»™å®¿ä¸»æœº+ç¼“å­˜)
  - ç£ç›˜: 230GB + 500GBæ•°æ®

========================================
CPUç»‘å®šç­–ç•¥(å¯é€‰):
========================================

# ä¸ºå…³é”®VMç»‘å®šCPUæ ¸å¿ƒ
virsh vcpupin nas 0 0,6
virsh vcpupin nas 1 1,7
virsh vcpupin router 0 2,8
virsh vcpupin router 1 3,9

# æŸ¥çœ‹CPUç»‘å®š
virsh vcpupin nas

========================================
EOF

cat /root/vm-resource-plan.txt
```

---

## ğŸ”„ è™šæ‹Ÿæœºè‡ªåŠ¨å¯åŠ¨é…ç½®

```bash
# è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨
virsh autostart nas
virsh autostart router
virsh autostart web-app

# ä¸è‡ªåŠ¨å¯åŠ¨å¼€å‘VM
virsh autostart --disable python-dev

# æŸ¥çœ‹è‡ªåŠ¨å¯åŠ¨çŠ¶æ€
virsh list --all --autostart
```

---

## ğŸ“š å¸¸ç”¨æ“ä½œé€ŸæŸ¥è¡¨

```bash
cat &gt; /root/vm-cheatsheet.txt &lt;&lt;'EOF'
========================================
     è™šæ‹Ÿæœºæ“ä½œé€ŸæŸ¥è¡¨
========================================

åˆ—å‡ºè™šæ‹Ÿæœº:
  virsh list --all          # æ‰€æœ‰VM
  virsh list                # è¿è¡Œä¸­çš„VM

å¯åŠ¨/åœæ­¢:
  virsh start &lt;vm&gt;          # å¯åŠ¨
  virsh shutdown &lt;vm&gt;       # ä¼˜é›…å…³æœº
  virsh destroy &lt;vm&gt;        # å¼ºåˆ¶å…³æœº
  virsh reboot &lt;vm&gt;         # é‡å¯

è‡ªåŠ¨å¯åŠ¨:
  virsh autostart &lt;vm&gt;      # å¯ç”¨è‡ªåŠ¨å¯åŠ¨
  virsh autostart --disable &lt;vm&gt;  # ç¦ç”¨

ä¿¡æ¯æŸ¥çœ‹:
  virsh dominfo &lt;vm&gt;        # VMä¿¡æ¯
  virsh domstats &lt;vm&gt;       # ç»Ÿè®¡ä¿¡æ¯  
  virsh vncdisplay &lt;vm&gt;     # VNCç«¯å£

æ§åˆ¶å°:
  virsh console &lt;vm&gt;        # æ–‡æœ¬æ§åˆ¶å° (Ctrl+] é€€å‡º)

å¿«ç…§:
  virsh snapshot-create-as &lt;vm&gt; snap1  # åˆ›å»ºå¿«ç…§
  virsh snapshot-list &lt;vm&gt;             # åˆ—å‡ºå¿«ç…§
  virsh snapshot-revert &lt;vm&gt; snap1     # æ¢å¤å¿«ç…§

ç£ç›˜ç®¡ç†:
  virsh domblklist &lt;vm&gt;     # åˆ—å‡ºç£ç›˜
  virsh attach-disk &lt;vm&gt; /path/to/disk vdb  # æŒ‚è½½ç£ç›˜
  
èµ„æºè°ƒæ•´:
  virsh setmem &lt;vm&gt; 4G      # è°ƒæ•´å†…å­˜(VMéœ€æ”¯æŒ)
  virsh setvcpus &lt;vm&gt; 4     # è°ƒæ•´CPU

ç½‘ç»œ:
  virsh domiflist &lt;vm&gt;      # åˆ—å‡ºç½‘å¡
  virsh domifstat &lt;vm&gt; vnet0  # ç½‘å¡ç»Ÿè®¡

åˆ é™¤VM:
  virsh destroy &lt;vm&gt;        # å…ˆå…³æœº
  virsh undefine &lt;vm&gt; --remove-all-storage  # åˆ é™¤VMå’Œç£ç›˜

========================================
è‡ªå®šä¹‰ç®¡ç†å‘½ä»¤:
========================================

vm-manager list           # åˆ—å‡ºæ‰€æœ‰VM
vm-manager start &lt;vm&gt;     # å¯åŠ¨VM
vm-manager stop &lt;vm&gt;      # å…³é—­VM
vm-manager status         # çŠ¶æ€æ€»è§ˆ
vm-manager console &lt;vm&gt;   # è¿æ¥æ§åˆ¶å°

create-vm &lt;name&gt; &lt;ram&gt; &lt;cpu&gt; &lt;disk&gt; &lt;format&gt; &lt;iso&gt; &lt;ip&gt;
vm-backup &lt;vm&gt;           # å¤‡ä»½VMé…ç½®

storage-monitor          # å­˜å‚¨ç›‘æ§
sysinfo                  # ç³»ç»Ÿä¿¡æ¯

========================================
EOF

cat /root/vm-cheatsheet.txt
```

---

## âœ… éªŒè¯å·¥å…·

```bash
cat &gt; /root/verify-vms.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       è™šæ‹Ÿæœºç¯å¢ƒéªŒè¯"
echo "========================================="
echo ""

echo "--- å­˜å‚¨æ± çŠ¶æ€ ---"
virsh pool-list --all
echo ""

echo "--- è™šæ‹Ÿæœºåˆ—è¡¨ ---"
virsh list --all
echo ""

echo "--- ç½‘ç»œé…ç½® ---"
virsh net-list --all
echo ""

echo "--- ç£ç›˜ä½¿ç”¨ ---"
storage-monitor 2&gt;/dev/null || lvs vg_kvm
echo ""

echo "éªŒè¯å®Œæˆ!"
EOF

chmod +x /root/verify-vms.sh
/root/verify-vms.sh
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

- [x] åˆ›å»ºäº†VMåˆ›å»ºè„šæœ¬
- [x] åˆ›å»ºäº†VMç®¡ç†å·¥å…·
- [x] é…ç½®äº†èµ„æºåˆ†é…è®¡åˆ’
- [x] äº†è§£äº†å¸¸ç”¨æ“ä½œå‘½ä»¤
- [x] å‡†å¤‡å¥½äº†å¤‡ä»½å·¥å…·

---

## ğŸ¯ ä¸‹ä¸€æ­¥

ğŸ‘‰ **[05-monitoring.md - ç›‘æ§æ–¹æ¡ˆ](#section-5)**

æˆ–ç›´æ¥åˆ›å»ºå…·ä½“çš„è™šæ‹Ÿæœº:
- **[06-vm-python-dev.md - Pythonå¼€å‘VM](#section-6)**
- **[11-vm-nas.md - NASæ–‡ä»¶æœåŠ¡å™¨](#section-11)**
- **[09-vm-router-openwrt.md - OpenWrtæ—è·¯ç”±](#section-9)**

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºUbuntuå¼€å‘VM

```bash
# å…ˆä¸‹è½½Ubuntu ISO
cd /kvm/iso
wget https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/22.04/ubuntu-22.04.3-live-server-amd64.iso

# åˆ›å»ºVM
create-vm python-dev 4 2 80 qcow2 /kvm/iso/ubuntu-22.04.3-live-server-amd64.iso 192.168.71.201
```

### æ—¥å¸¸ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰VMçŠ¶æ€
vm-manager status

# å¯åŠ¨VM
vm-manager start python-dev

# è¿æ¥æ§åˆ¶å°
vm-manager console python-dev

# å…³é—­æ‰€æœ‰VM(ç»´æŠ¤å‰)
vm-manager stop-all
```




---



# 05 - ç›‘æ§å’Œç®¡ç†æ–¹æ¡ˆ

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

é…ç½®Cockpit Webæ§åˆ¶å°å’Œæ€§èƒ½ç›‘æ§å·¥å…·ã€‚

**é¢„è®¡è€—æ—¶**: 25åˆ†é’Ÿ

---

## ğŸŒ Cockpit Webæ§åˆ¶å°

### å®‰è£…Cockpit

```bash
sudo dnf install -y cockpit cockpit-machines cockpit-storaged cockpit-packagekit

# å¯åŠ¨æœåŠ¡
sudo systemctl enable --now cockpit.socket

# å¼€æ”¾é˜²ç«å¢™
sudo firewall-cmd --permanent --add-service=cockpit
sudo firewall-cmd --reload
```

### è®¿é—®Cockpit

æµè§ˆå™¨è®¿é—®: **https://192.168.71.200:9090**

ç™»å½•è´¦æˆ·: chris (æˆ–root)

åŠŸèƒ½:
- ç³»ç»Ÿç›‘æ§(CPU/å†…å­˜/ç½‘ç»œ)
- è™šæ‹Ÿæœºç®¡ç†
- å­˜å‚¨ç®¡ç†
- æ—¥å¿—æŸ¥çœ‹

---

## ğŸ“Š æ€§èƒ½ç›‘æ§è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/sys-monitor &lt;&lt;'EOF'
#!/bin/bash
echo "=== ç³»ç»Ÿç›‘æ§ ==="
echo "è´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"
echo ""
free -h
echo ""
df -h | grep -E 'Filesystem|vg_kvm|/data'
echo ""
echo "=== è™šæ‹ŸæœºçŠ¶æ€ ==="
virsh list --all
EOF

sudo chmod +x /usr/local/bin/sys-monitor
```

---

## ğŸ”” èµ„æºç›‘æ§

```bash
# å®æ—¶ç›‘æ§
htop

# VMæ€§èƒ½
virt-top

# å­˜å‚¨ç›‘æ§
storage-monitor
```

---

## ğŸ“ å®Œæˆ

- [x] Cockpitå·²å®‰è£…
- [x] ç›‘æ§è„šæœ¬å·²åˆ›å»º
- [x] å¯é€šè¿‡Webç®¡ç†è™šæ‹Ÿæœº

ğŸ‘‰ **ä¸‹ä¸€æ­¥: [06-vm-python-dev.md](#section-6)**




---



# 06 - Pythonå¼€å‘è™šæ‹Ÿæœºé…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

åˆ›å»ºå’Œé…ç½®Ubuntu 22.04 Pythonå¼€å‘ç¯å¢ƒè™šæ‹Ÿæœºã€‚

**é¢„è®¡è€—æ—¶**: 40åˆ†é’Ÿ

---

## ğŸš€ æ­¥éª¤1: ä¸‹è½½Ubuntu ISO

```bash
cd /kvm/iso
wget https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/22.04/ubuntu-22.04.3-live-server-amd64.iso
```

---

## ğŸ’» æ­¥éª¤2: åˆ›å»ºè™šæ‹Ÿæœº

```bash
create-vm python-dev 4 2 80 qcow2 \
  /kvm/iso/ubuntu-22.04.3-live-server-amd64.iso \
  192.168.71.201
```

---

## âš™ï¸ æ­¥éª¤3: å®‰è£…Ubuntuç³»ç»Ÿ

1. è¿æ¥VNCæˆ–ä½¿ç”¨ `virt-viewer python-dev`
2. é€‰æ‹©è¯­è¨€: English
3. ç½‘ç»œé…ç½®:
   - ç¼–è¾‘enp1s0
   - IPv4 Method: Manual
   - Address: 192.168.71.201/24
   - Gateway: 192.168.71.1
   - DNS: 192.168.71.1,223.5.5.5
4. å­˜å‚¨: ä½¿ç”¨æ•´ä¸ªç£ç›˜
5. åˆ›å»ºç”¨æˆ·: dev/å¯†ç 
6. å®‰è£…OpenSSH server
7. ç­‰å¾…å®‰è£…å®Œæˆï¼Œé‡å¯

å®‰è£…å®Œæˆå:
```bash
# å¼¹å‡ºå®‰è£…å…‰ç›˜
virsh change-media python-dev sda --eject

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨(å¯é€‰)
# virsh autostart python-dev
```

---

## ğŸ”§ æ­¥éª¤4: ç³»ç»Ÿåˆå§‹åŒ–é…ç½®

SSHç™»å½•åˆ°è™šæ‹Ÿæœº:
```bash
ssh dev@192.168.71.201
```

### 4.1 é…ç½®å›½å†…é•œåƒæº

```bash
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak

sudo cat &gt; /etc/apt/sources.list &lt;&lt;'EOF'
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse
EOF

sudo apt update &amp;&amp; sudo apt upgrade -y
```

### 4.2 å®‰è£…Pythonç¯å¢ƒ

```bash
# å®‰è£…Python 3.11
sudo apt install -y software-properties-common
sudo add-apt-repository -y ppa:deadsnakes/ppa
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3.11-dev

# è®¾ç½®é»˜è®¤Python
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

# å®‰è£…pip
curl -sS https://bootstrap.pypa.io/get-pip.py | sudo python3.11

# é…ç½®pipæ¸…åæº
mkdir -p ~/.pip
cat &gt; ~/.pip/pip.conf &lt;&lt;'EOF'
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
EOF

# éªŒè¯
python3 --version
pip3 --version
```

### 4.3 å®‰è£…å¼€å‘å·¥å…·

```bash
sudo apt install -y \
    git \
    vim \
    htop \
    curl \
    wget \
    build-essential \
    libssl-dev \
    libffi-dev \
    python3-pip \
    tmux \
    tree
```

### 4.4 é…ç½®Git

```bash
git config --global user.name "Your Name"
git config --global user.email "your@email.com"
git config --global init.defaultBranch main
```

---

## ğŸ“¦ æ­¥éª¤5: å®‰è£…å¸¸ç”¨PythonåŒ…

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒç¤ºä¾‹
python3 -m venv ~/venv
source ~/venv/bin/activate

# å®‰è£…å¸¸ç”¨åŒ…
pip install \
    requests \
    flask \
    fastapi \
    uvicorn \
    sqlalchemy \
    pytest \
    black \
    flake8 \
    ipython

# é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
deactivate
```

---

## âœ… éªŒè¯é…ç½®

```bash
# ç³»ç»Ÿä¿¡æ¯
uname -a
python3 --version
pip3 --version
git --version

# ç½‘ç»œæµ‹è¯•
ping -c 3 223.5.5.5
```

---

## ğŸ“ å®Œæˆ

Pythonå¼€å‘ç¯å¢ƒå·²é…ç½®å®Œæˆ!

ä½¿ç”¨æ–¹å¼:
```bash
# SSHè¿æ¥
ssh dev@192.168.71.201

# åˆ›å»ºé¡¹ç›®
python3 -m venv myproject
cd myproject &amp;&amp; source bin/activate
pip install flask
```

ğŸ‘‰ **ä¸‹ä¸€æ­¥: [07-vm-web-app.md](#section-7)**




---



# 07 - Webåº”ç”¨éƒ¨ç½²è™šæ‹Ÿæœºé…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

åˆ›å»ºå’Œé…ç½®Ubuntu 22.04 Webåº”ç”¨ç”Ÿäº§éƒ¨ç½²ç¯å¢ƒè™šæ‹Ÿæœºã€‚

**é¢„è®¡è€—æ—¶**: 50åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†

---

## ğŸš€ æ­¥éª¤1: åˆ›å»ºè™šæ‹Ÿæœº

```bash
# ä½¿ç”¨å·²ä¸‹è½½çš„Ubuntu ISOï¼ˆå‚è€ƒ06æ–‡æ¡£ï¼‰
create-vm web-app 4 2 100 qcow2 \
  /kvm/iso/ubuntu-22.04.3-live-server-amd64.iso \
  192.168.71.202
```

---

## âš™ï¸ æ­¥éª¤2: å®‰è£…Ubuntuç³»ç»Ÿ

å®‰è£…è¿‡ç¨‹ä¸Pythonå¼€å‘VMç±»ä¼¼ï¼Œç½‘ç»œé…ç½®ï¼š
- IP: 192.168.71.202/24
- Gateway: 192.168.71.1
- DNS: 192.168.71.1,223.5.5.5
- ç”¨æˆ·: webadmin

å®‰è£…å®Œæˆåå¼¹å‡ºå…‰ç›˜ï¼š
```bash
virsh change-media web-app sda --eject
virsh autostart web-app  # ç”Ÿäº§ç¯å¢ƒè®¾ç½®è‡ªåŠ¨å¯åŠ¨
```

---

## ğŸ”§ æ­¥éª¤3: ç³»ç»Ÿåˆå§‹åŒ–

SSHç™»å½•ï¼š
```bash
ssh webadmin@192.168.71.202
```

### 3.1 é…ç½®é•œåƒæº

```bash
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak

sudo tee /etc/apt/sources.list &gt; /dev/null &lt;&lt;'EOF'
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse
EOF

sudo apt update &amp;&amp; sudo apt upgrade -y
```

### 3.2 å®‰è£…åŸºç¡€å·¥å…·

```bash
sudo apt install -y \
    vim \
    git \
    curl \
    wget \
    htop \
    net-tools \
    build-essential \
    software-properties-common
```

---

## ğŸ æ­¥éª¤4: Pythonç¯å¢ƒé…ç½®

```bash
# å®‰è£…Python 3.11
sudo add-apt-repository -y ppa:deadsnakes/ppa
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip

# é…ç½®pipæ¸…åæº
mkdir -p ~/.pip
cat &gt; ~/.pip/pip.conf &lt;&lt;'EOF'
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
EOF

sudo cp ~/.pip/pip.conf /root/.pip/pip.conf
```

---

## ğŸŒ æ­¥éª¤5: Nginxå®‰è£…é…ç½®

```bash
# å®‰è£…Nginx
sudo apt install -y nginx

# å¯åŠ¨å¹¶è®¾ç½®è‡ªå¯åŠ¨
sudo systemctl enable --now nginx

# éªŒè¯
sudo systemctl status nginx
curl http://localhost

# é…ç½®é˜²ç«å¢™
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 5.1 åˆ›å»ºåº”ç”¨é…ç½®æ¨¡æ¿

```bash
sudo tee /etc/nginx/sites-available/app-template &lt;&lt;'EOF'
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /var/www/app/static/;
    }

    location /media/ {
        alias /var/www/app/media/;
    }
}
EOF
```

---

## ğŸ”„ æ­¥éª¤6: åº”ç”¨æœåŠ¡å™¨é…ç½®

### 6.1 å®‰è£…Gunicorn

```bash
sudo pip3 install gunicorn
```

### 6.2 åˆ›å»ºsystemdæœåŠ¡æ¨¡æ¿

```bash
sudo tee /etc/systemd/system/webapp.service &lt;&lt;'EOF'
[Unit]
Description=Web Application
After=network.target

[Service]
Type=notify
User=webadmin
Group=webadmin
WorkingDirectory=/home/webadmin/app
Environment="PATH=/home/webadmin/app/venv/bin"
ExecStart=/home/webadmin/app/venv/bin/gunicorn \
    --workers 3 \
    --bind 127.0.0.1:8000 \
    --timeout 120 \
    --access-logfile /var/log/webapp/access.log \
    --error-logfile /var/log/webapp/error.log \
    wsgi:application

[Install]
WantedBy=multi-user.target
EOF

# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/webapp
sudo chown webadmin:webadmin /var/log/webapp
```

---

## ğŸ—„ï¸ æ­¥éª¤7: æ•°æ®åº“å®‰è£…

### 7.1 PostgreSQLï¼ˆæ¨èï¼‰

```bash
# å®‰è£…PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# å¯åŠ¨æœåŠ¡
sudo systemctl enable --now postgresql

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
sudo -u postgres psql &lt;&lt;'EOF'
CREATE DATABASE webapp_db;
CREATE USER webapp_user WITH PASSWORD 'secure_password';
ALTER ROLE webapp_user SET client_encoding TO 'utf8';
ALTER ROLE webapp_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE webapp_user SET timezone TO 'Asia/Shanghai';
GRANT ALL PRIVILEGES ON DATABASE webapp_db TO webapp_user;
\q
EOF

# å®‰è£…Python PostgreSQLé©±åŠ¨
pip3 install psycopg2-binary
```

### 7.2 MySQLï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£…MySQL
sudo apt install -y mysql-server

# å®‰å…¨é…ç½®
sudo mysql_secure_installation

# åˆ›å»ºæ•°æ®åº“
sudo mysql &lt;&lt;'EOF'
CREATE DATABASE webapp_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'webapp_user'@'localhost' IDENTIFIED BY 'secure_password';
GRANT ALL PRIVILEGES ON webapp_db.* TO 'webapp_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
EOF

# å®‰è£…Python MySQLé©±åŠ¨
pip3 install mysqlclient
```

---

## ğŸ“¦ æ­¥éª¤8: Redisç¼“å­˜

```bash
# å®‰è£…Redis
sudo apt install -y redis-server

# é…ç½®Redis
sudo sed -i 's/^supervised no/supervised systemd/' /etc/redis/redis.conf

# é‡å¯Redis
sudo systemctl restart redis-server
sudo systemctl enable redis-server

# éªŒè¯
redis-cli ping

# å®‰è£…Python Rediså®¢æˆ·ç«¯
pip3 install redis
```

---

## ğŸ³ æ­¥éª¤9: Dockerç¯å¢ƒï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£…Docker
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# é…ç½®Dockerå›½å†…é•œåƒ
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json &lt;&lt;'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
EOF

sudo systemctl daemon-reload
sudo systemctl restart docker
sudo systemctl enable docker

# æ·»åŠ ç”¨æˆ·åˆ°dockerç»„
sudo usermod -aG docker webadmin

# éªŒè¯
docker --version
docker run hello-world
```

---

## ğŸ“ æ­¥éª¤10: éƒ¨ç½²ç¤ºä¾‹åº”ç”¨

### 10.1 åˆ›å»ºFlaskåº”ç”¨ç¤ºä¾‹

```bash
mkdir -p ~/app
cd ~/app

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.11 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install flask gunicorn

# åˆ›å»ºåº”ç”¨
cat &gt; app.py &lt;&lt;'EOF'
from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello():
    return '&lt;h1&gt;Web Application Server&lt;/h1&gt;&lt;p&gt;Running on 192.168.71.202&lt;/p&gt;'

@app.route('/health')
def health():
    return {'status': 'healthy'}

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)
EOF

# åˆ›å»ºWSGIå…¥å£
cat &gt; wsgi.py &lt;&lt;'EOF'
from app import app

application = app

if __name__ == '__main__':
    application.run()
EOF

# æµ‹è¯•è¿è¡Œ
gunicorn --bind 0.0.0.0:8000 wsgi:application
```

### 10.2 é…ç½®Nginx

```bash
# åˆ›å»ºåº”ç”¨ä¸“ç”¨é…ç½®
sudo tee /etc/nginx/sites-available/myapp &lt;&lt;'EOF'
server {
    listen 80;
    server_name 192.168.71.202;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
EOF

# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl reload nginx
```

### 10.3 é…ç½®systemdæœåŠ¡

```bash
# ä¿®æ”¹æœåŠ¡é…ç½®
sudo tee /etc/systemd/system/myapp.service &lt;&lt;'EOF'
[Unit]
Description=My Flask Application
After=network.target

[Service]
Type=notify
User=webadmin
Group=webadmin
WorkingDirectory=/home/webadmin/app
Environment="PATH=/home/webadmin/app/venv/bin"
ExecStart=/home/webadmin/app/venv/bin/gunicorn \
    --workers 3 \
    --bind 127.0.0.1:8000 \
    wsgi:application

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable myapp
sudo systemctl start myapp

# éªŒè¯
sudo systemctl status myapp
curl http://192.168.71.202
```

---

## âœ… æ­¥éª¤11: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status nginx
sudo systemctl status myapp
sudo systemctl status postgresql
sudo systemctl status redis

# æµ‹è¯•è®¿é—®
curl http://192.168.71.202
curl http://192.168.71.202/health

# ä»å®¿ä¸»æœºæµ‹è¯•
# ssh chris@192.168.71.200
# curl http://192.168.71.202
```

---

## ğŸ”’ æ­¥éª¤12: å®‰å…¨åŠ å›º

```bash
# é…ç½®é˜²ç«å¢™
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw enable

# ç¦ç”¨root SSHç™»å½•
sudo sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart sshd

# é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

## ğŸ“Š æ­¥éª¤13: ç›‘æ§å’Œæ—¥å¿—

```bash
# å®‰è£…æ—¥å¿—æŸ¥çœ‹å·¥å…·
sudo apt install -y lnav

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
sudo journalctl -u myapp -f

# æŸ¥çœ‹Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# å®‰è£…htopç›‘æ§
htop
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

- [x] Ubuntuç³»ç»Ÿå®‰è£…å®Œæˆ
- [x] é•œåƒæºé…ç½®ä¸ºå›½å†…æº
- [x] Pythonç¯å¢ƒé…ç½®
- [x] Nginxå®‰è£…é…ç½®
- [x] æ•°æ®åº“å®‰è£…ï¼ˆPostgreSQL/MySQLï¼‰
- [x] Redisç¼“å­˜é…ç½®
- [x] Dockerç¯å¢ƒé…ç½®ï¼ˆå¯é€‰ï¼‰
- [x] ç¤ºä¾‹åº”ç”¨éƒ¨ç½²
- [x] systemdæœåŠ¡é…ç½®
- [x] é˜²ç«å¢™å’Œå®‰å…¨é…ç½®
- [x] å¯ä»å±€åŸŸç½‘è®¿é—®

---

## ğŸ¯ ä¸‹ä¸€æ­¥

Webåº”ç”¨æœåŠ¡å™¨å·²é…ç½®å®Œæˆï¼

### ä»å¼€å‘VMéƒ¨ç½²åº”ç”¨æµç¨‹

```bash
# åœ¨å¼€å‘VM (192.168.71.201) æ‰“åŒ…åº”ç”¨
cd ~/myproject
tar -czf myapp.tar.gz .

# ä¼ è¾“åˆ°ç”Ÿäº§VM
scp myapp.tar.gz webadmin@192.168.71.202:~/

# åœ¨ç”Ÿäº§VMéƒ¨ç½²
ssh webadmin@192.168.71.202
tar -xzf myapp.tar.gz -C ~/app/
cd ~/app
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart myapp
```

ğŸ‘‰ **[08-vm-router-comparison.md - æ—è·¯ç”±æ–¹æ¡ˆå¯¹æ¯”](#section-8)**




---



# 08 - æ—è·¯ç”±æ–¹æ¡ˆå¯¹æ¯”

## ğŸ“‹ ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”

### OpenWrt + OpenClash vs Rocky 9 + V2Ray

| ç‰¹æ€§ | OpenWrt + OpenClash | Rocky 9 + V2Ray |
|------|---------------------|-----------------|
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ Webç•Œé¢ | â­â­â­â˜†â˜† å‘½ä»¤è¡Œé…ç½® |
| **é…ç½®éš¾åº¦** | â­â­â˜†â˜†â˜† ç®€å• | â­â­â­â­â˜† è¾ƒå¤æ‚ |
| **Clashè®¢é˜…** | âœ… åŸç”Ÿæ”¯æŒ | âš ï¸ éœ€è½¬æ¢ |
| **æ€§èƒ½** | â­â­â­â­â˜† è¾ƒå¥½ | â­â­â­â­â­ ä¼˜ç§€ |
| **èµ„æºå ç”¨** | 512MB-1GB | 1GB-2GB |
| **ç¨³å®šæ€§** | â­â­â­â­â˜† | â­â­â­â­â­ |
| **åŠŸèƒ½ä¸°å¯Œåº¦** | â­â­â­â­â­ æ’ä»¶ä¸°å¯Œ | â­â­â­â˜†â˜† ä¸“æ³¨ä»£ç† |
| **ä¸Šæ‰‹æ—¶é—´** | 1-2å°æ—¶ | 3-4å°æ—¶ |

---

## ğŸ¯ æ¨èé€‰æ‹©

### é€‰æ‹©OpenWrtï¼Œå¦‚æœä½ ï¼š
- âœ… å¸Œæœ›æœ‰Webç•Œé¢ç®¡ç†
- âœ… ä¹ æƒ¯ä½¿ç”¨Clashè®¢é˜…
- âœ… éœ€è¦å»å¹¿å‘Šç­‰é¢å¤–åŠŸèƒ½
- âœ… æƒ³è¦å¼€ç®±å³ç”¨çš„ä½“éªŒ
- âœ… æ˜¯Linuxæ–°æ‰‹

### é€‰æ‹©V2Rayï¼Œå¦‚æœä½ ï¼š
- âœ… è¿½æ±‚æœ€ä½³æ€§èƒ½
- âœ… ç†Ÿæ‚‰Linuxå‘½ä»¤è¡Œ
- âœ… éœ€è¦é«˜åº¦è‡ªå®šä¹‰
- âœ… æƒ³æ·±å…¥å­¦ä¹ ä»£ç†æŠ€æœ¯
- âœ… æœ‰è„šæœ¬ç¼–å†™èƒ½åŠ›

---

## ğŸ’¡ æˆ‘çš„å»ºè®®

**å¯¹äºæ‚¨çš„æƒ…å†µï¼ˆLinuxç»éªŒè¾ƒå°‘ï¼‰ï¼šæ¨èOpenWrt + OpenClash**

ç†ç”±ï¼š
1. âœ… Webç•Œé¢å‹å¥½ï¼Œé™ä½å­¦ä¹ æ›²çº¿
2. âœ… Clashè®¢é˜…ç›´æ¥å¯¼å…¥ï¼Œæ— éœ€è½¬æ¢
3. âœ… ç¤¾åŒºèµ„æºä¸°å¯Œï¼Œé—®é¢˜å®¹æ˜“è§£å†³
4. âœ… å¯ä»¥è¾¹ç”¨è¾¹å­¦ï¼ŒåæœŸå†å°è¯•V2Ray

---

## ğŸ“š åç»­æ–‡æ¡£

- **[09-vm-router-openwrt.md](#section-9)** - OpenWrtæ—è·¯ç”±å®Œæ•´é…ç½®
- **[10-vm-router-v2ray.md](#section-10)** - V2Rayæ—è·¯ç”±å®Œæ•´é…ç½®

å»ºè®®å…ˆé˜…è¯»09æ–‡æ¡£ï¼Œå¦‚æœOpenWrtæ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå†å°è¯•10æ–‡æ¡£çš„V2Rayæ–¹æ¡ˆã€‚




---



# 09 - OpenWrtæ—è·¯ç”±é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

ä½¿ç”¨OpenWrt + OpenClashå®ç°é€æ˜ä»£ç†æ—è·¯ç”±ã€‚

**é¢„è®¡è€—æ—¶**: 60åˆ†é’Ÿ

---

## ğŸš€ æ­¥éª¤1: ä¸‹è½½OpenWrté•œåƒ

```bash
cd /kvm/iso

# ä¸‹è½½OpenWrt x86-64ç‰ˆæœ¬
wget https://mirrors.ustc.edu.cn/openwrt/releases/23.05.2/targets/x86/64/openwrt-23.05.2-x86-64-generic-ext4-combined.img.gz

# è§£å‹
gunzip openwrt-23.05.2-x86-64-generic-ext4-combined.img.gz
```

---

## ğŸ’» æ­¥éª¤2: åˆ›å»ºè™šæ‹Ÿæœº

```bash
# è½¬æ¢é•œåƒä¸ºqcow2
sudo qemu-img convert -f raw -O qcow2 \
    /kvm/iso/openwrt-23.05.2-x86-64-generic-ext4-combined.img \
    /kvm/iso/openwrt.qcow2

# æ‰©å±•ç£ç›˜åˆ°20GB
sudo qemu-img resize /kvm/iso/openwrt.qcow2 20G

# å¤åˆ¶åˆ°å­˜å‚¨æ± 
sudo cp /kvm/iso/openwrt.qcow2 /var/lib/libvirt/images/router.qcow2

# åˆ›å»ºè™šæ‹Ÿæœº
virt-install \
    --name router \
    --ram 2048 \
    --vcpus 2 \
    --disk /var/lib/libvirt/images/router.qcow2,format=qcow2,bus=virtio \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0 \
    --os-variant generic \
    --import \
    --noautoconsole
```

---

## âš™ï¸ æ­¥éª¤3: åˆå§‹é…ç½®

### 3.1 é€šè¿‡VNCè¿æ¥é…ç½®ç½‘ç»œ

```bash
# æŸ¥çœ‹VNCç«¯å£
virsh vncdisplay router

# OpenWrté»˜è®¤IP: 192.168.1.1
# éœ€è¦ä¿®æ”¹ä¸º: 192.168.71.254
```

åœ¨VNCæ§åˆ¶å°ï¼š
```bash
vi /etc/config/network

# ä¿®æ”¹lanæ¥å£:
config interface 'lan'
    option device 'br-lan'
    option proto 'static'
    option ipaddr '192.168.71.254'
    option netmask '255.255.255.0'
    option gateway '192.168.71.1'
    option dns '192.168.71.1 223.5.5.5'

# é‡å¯ç½‘ç»œ
/etc/init.d/network restart
```

### 3.2 Webè®¿é—®

æµè§ˆå™¨è®¿é—®: http://192.168.71.254

é»˜è®¤ç”¨æˆ·å: root  
é»˜è®¤å¯†ç : (æ— å¯†ç ï¼Œé¦–æ¬¡ç™»å½•è®¾ç½®)

---

## ğŸ“¦ æ­¥éª¤4: å®‰è£…OpenClash

### 4.1 ä¸Šä¼ OpenClashæ’ä»¶

```bash
# ä¸‹è½½OpenClash
wget https://github.com/vernesong/OpenClash/releases/download/v0.45.123/luci-app-openclash_0.45.123_all.ipk

# ä¸Šä¼ åˆ°OpenWrt
scp luci-app-openclash_0.45.123_all.ipk root@192.168.71.254:/tmp/
```

### 4.2 å®‰è£…æ’ä»¶

åœ¨OpenWrt Webç•Œé¢æˆ–SSHï¼š
```bash
ssh root@192.168.71.254

# å®‰è£…ä¾èµ–
opkg update
opkg install coreutils-nohup bash iptables dnsmasq-full curl ca-certificates ipset ip-full iptables-mod-tproxy iptables-mod-extra libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base

# å®‰è£…OpenClash
opkg install /tmp/luci-app-openclash_0.45.123_all.ipk
```

---

## ğŸ”§ æ­¥éª¤5: é…ç½®OpenClash

### 5.1 å¯¼å…¥Clashè®¢é˜…

Webç•Œé¢: http://192.168.71.254

1. æœåŠ¡ â†’ OpenClash â†’ é…ç½®æ–‡ä»¶è®¢é˜…
2. æ·»åŠ è®¢é˜…åœ°å€ï¼ˆä½ çš„æœºåœºè®¢é˜…é“¾æ¥ï¼‰
3. ä¿å­˜å¹¶æ›´æ–°

### 5.2 åŸºæœ¬è®¾ç½®

```
æ¨¡å¼è®¾ç½®:
- è¿è¡Œæ¨¡å¼: Redir-Host (æ¨è)
- è®¿é—®æ§åˆ¶: å…¨éƒ¨ä»£ç†

DNSè®¾ç½®:
- ä½¿ç”¨è‡ªå®šä¹‰DNS: å¯ç”¨
- æœ¬åœ°DNS: 223.5.5.5
- å›½å¤–DNS: 8.8.8.8
```

### 5.3 å¯åŠ¨æœåŠ¡

ç‚¹å‡»"å¯åŠ¨ OpenClash"

---

## ğŸŒ æ­¥éª¤6: å®¢æˆ·ç«¯é…ç½®

### æ–¹æ¡ˆA: DHCPè‡ªåŠ¨åˆ†å‘ï¼ˆæ¨èï¼‰

åœ¨ä¸»è·¯ç”±ï¼ˆ192.168.71.1ï¼‰é…ç½®DHCPé€‰é¡¹ï¼š
- ç½‘å…³: 192.168.71.254ï¼ˆOpenWrtæ—è·¯ç”±ï¼‰

æ‰€æœ‰è®¾å¤‡è‡ªåŠ¨èµ°ä»£ç†ã€‚

### æ–¹æ¡ˆB: æ‰‹åŠ¨é…ç½®

åœ¨éœ€è¦ç¿»å¢™çš„è®¾å¤‡ä¸Šï¼š
- ç½‘å…³æ”¹ä¸º: 192.168.71.254
- DNSæ”¹ä¸º: 192.168.71.254

---

## âœ… éªŒè¯

```bash
# åœ¨å®¢æˆ·ç«¯æµ‹è¯•
curl https://www.google.com
curl ipinfo.io

# æŸ¥çœ‹OpenClashçŠ¶æ€
ssh root@192.168.71.254
/etc/init.d/openclash status
```

---

## ğŸ“ å®Œæˆ

OpenWrtæ—è·¯ç”±é…ç½®å®Œæˆï¼

**Tips**:
- å®šæœŸæ›´æ–°è®¢é˜…
- å…³æ³¨OpenClashæ›´æ–°
- å¤‡ä»½é…ç½®æ–‡ä»¶

ğŸ‘‰ **[11-vm-nas.md](#section-11)**




---



# 09 - è¡¥å……OpenClashçœæµé…ç½®

## ğŸ“‹ é…ç½®ç›®æ ‡

- âœ… ä»…å¿…è¦ç½‘ç«™èµ°ä»£ç†ï¼ˆGoogleã€YouTubeã€Claudeç­‰ï¼‰
- âœ… å›½å†…ç½‘ç«™ç›´è¿
- âœ… æ–¹ä¾¿æ·»åŠ æ–°çš„ä»£ç†è§„åˆ™
- âœ… èŠ‚çœVPNæµé‡

---

## ğŸ¯ æ ¸å¿ƒé…ç½®ç­–ç•¥

### ä¸‰å±‚åˆ†æµè§„åˆ™

```
1. è‡ªå®šä¹‰è§„åˆ™ï¼ˆæœ€ä¼˜å…ˆï¼‰
   - æ‚¨æ‰‹åŠ¨æ·»åŠ çš„ç½‘ç«™
   - Googleã€YouTubeã€Claudeç­‰
   
2. GFWListè§„åˆ™ï¼ˆæ¬¡ä¼˜å…ˆï¼‰
   - å¸¸è§è¢«å¢™ç½‘ç«™
   
3. é»˜è®¤ç›´è¿ï¼ˆæœ€åï¼‰
   - æ‰€æœ‰å…¶ä»–æµé‡ç›´è¿
```

---

## âš™ï¸ è¯¦ç»†é…ç½®æ­¥éª¤

### æ­¥éª¤1: OpenClashåŸºæœ¬è®¾ç½®

ç™»å½•OpenWrt: http://192.168.71.254

è¿›å…¥ï¼š**æœåŠ¡ â†’ OpenClash â†’ å…¨å±€è®¾ç½®**

```
è¿è¡Œæ¨¡å¼: Rule (è§„åˆ™æ¨¡å¼) â† å…³é”®ï¼
é»˜è®¤ä»£ç†æ–¹å¼: DIRECT (ç›´è¿)
```

### æ­¥éª¤2: é…ç½®åˆ†æµè§„åˆ™

è¿›å…¥ï¼š**æœåŠ¡ â†’ OpenClash â†’ è§„åˆ™è®¾ç½®**

#### 2.1 å¯ç”¨è§„åˆ™

```
å¯ç”¨è‡ªå®šä¹‰è§„åˆ™: âœ…
å¯ç”¨è®¿é—®æ§åˆ¶: âœ…
```

#### 2.2 æ·»åŠ è‡ªå®šä¹‰è§„åˆ™

ç‚¹å‡»"è‡ªå®šä¹‰è§„åˆ™"ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```yaml
# Google æœåŠ¡
DOMAIN-SUFFIX,google.com,PROXY
DOMAIN-SUFFIX,googleapis.com,PROXY
DOMAIN-SUFFIX,googleusercontent.com,PROXY
DOMAIN-SUFFIX,gstatic.com,PROXY
DOMAIN-SUFFIX,gmail.com,PROXY
DOMAIN-SUFFIX,youtube.com,PROXY
DOMAIN-SUFFIX,ytimg.com,PROXY
DOMAIN-SUFFIX,googlevideo.com,PROXY
DOMAIN-SUFFIX,youtu.be,PROXY

# AI æœåŠ¡
DOMAIN-SUFFIX,openai.com,PROXY
DOMAIN-SUFFIX,anthropic.com,PROXY
DOMAIN-SUFFIX,claude.ai,PROXY
DOMAIN-SUFFIX,gemini.google.com,PROXY

# ç¤¾äº¤åª’ä½“
DOMAIN-SUFFIX,twitter.com,PROXY
DOMAIN-SUFFIX,x.com,PROXY
DOMAIN-SUFFIX,facebook.com,PROXY
DOMAIN-SUFFIX,instagram.com,PROXY
DOMAIN-SUFFIX,telegram.org,PROXY

# å¼€å‘å·¥å…·
DOMAIN-SUFFIX,github.com,PROXY
DOMAIN-SUFFIX,githubusercontent.com,PROXY
DOMAIN-SUFFIX,stackoverflow.com,PROXY

# å…¶ä»–å¸¸ç”¨
DOMAIN-SUFFIX,wikipedia.org,PROXY
DOMAIN-SUFFIX,reddit.com,PROXY

# å›½å†…ç½‘ç«™ç›´è¿
DOMAIN-SUFFIX,baidu.com,DIRECT
DOMAIN-SUFFIX,qq.com,DIRECT
DOMAIN-SUFFIX,taobao.com,DIRECT
DOMAIN-SUFFIX,alipay.com,DIRECT
DOMAIN-SUFFIX,bilibili.com,DIRECT
DOMAIN-SUFFIX,zhihu.com,DIRECT

# å›½å†…IPæ®µç›´è¿
GEOIP,CN,DIRECT

# æœ€ç»ˆè§„åˆ™ï¼šå…¶ä»–å…¨éƒ¨ç›´è¿
MATCH,DIRECT
```

---

## ğŸ”§ å¿«é€Ÿæ·»åŠ æ–°ç½‘ç«™

### æ–¹æ³•1: Webç•Œé¢æ·»åŠ ï¼ˆæ¨èï¼‰

1. è¿›å…¥ **OpenClash â†’ è§„åˆ™è®¾ç½® â†’ è‡ªå®šä¹‰è§„åˆ™**
2. åœ¨é¡¶éƒ¨æ·»åŠ ä¸€è¡Œï¼š
   ```
   DOMAIN-SUFFIX,example.com,PROXY
   ```
3. ç‚¹å‡»"ä¿å­˜é…ç½®"
4. é‡å¯OpenClash

### æ–¹æ³•2: SSHå‘½ä»¤è¡Œæ·»åŠ 

```bash
# SSHç™»å½•OpenWrt
ssh root@192.168.71.254

# ç¼–è¾‘è‡ªå®šä¹‰è§„åˆ™æ–‡ä»¶
vi /etc/openclash/custom/openclash_custom_rules.list

# æ·»åŠ æ–°è§„åˆ™
DOMAIN-SUFFIX,newsite.com,PROXY

# é‡å¯OpenClash
/etc/init.d/openclash restart
```

### æ–¹æ³•3: åˆ›å»ºå¿«æ·æ·»åŠ è„šæœ¬

```bash
# åœ¨OpenWrtä¸Šåˆ›å»º
cat &gt; /usr/bin/add-proxy &lt;&lt;'EOF'
#!/bin/sh
DOMAIN=$1
if [ -z "$DOMAIN" ]; then
    echo "ç”¨æ³•: add-proxy example.com"
    exit 1
fi

echo "DOMAIN-SUFFIX,$DOMAIN,PROXY" &gt;&gt; /etc/openclash/custom/openclash_custom_rules.list
echo "å·²æ·»åŠ : $DOMAIN"
echo "é‡å¯OpenClashç”Ÿæ•ˆ: /etc/init.d/openclash restart"
EOF

chmod +x /usr/bin/add-proxy

# ä½¿ç”¨æ–¹æ³•
add-proxy gemini.google.com
/etc/init.d/openclash restart
```

---

## ğŸ“Š è§„åˆ™è¯­æ³•è¯´æ˜

### å¸¸ç”¨è§„åˆ™ç±»å‹

```yaml
# 1. åŸŸååç¼€åŒ¹é…ï¼ˆæ¨èï¼Œè¦†ç›–æ‰€æœ‰å­åŸŸåï¼‰
DOMAIN-SUFFIX,google.com,PROXY
# åŒ¹é…: google.com, www.google.com, mail.google.com

# 2. å®Œæ•´åŸŸååŒ¹é…ï¼ˆç²¾ç¡®ï¼‰
DOMAIN,www.google.com,PROXY
# åªåŒ¹é…: www.google.com

# 3. åŸŸåå…³é”®è¯åŒ¹é…
DOMAIN-KEYWORD,google,PROXY
# åŒ¹é…åŒ…å«googleçš„æ‰€æœ‰åŸŸå

# 4. IP-CIDRåŒ¹é…
IP-CIDR,8.8.8.8/32,PROXY
# åŒ¹é…ç‰¹å®šIP

# 5. åœ°ç†ä½ç½®åŒ¹é…
GEOIP,US,PROXY
# ç¾å›½IPèµ°ä»£ç†

GEOIP,CN,DIRECT
# ä¸­å›½IPç›´è¿
```

---

## ğŸ¨ æ¨èçš„å®Œæ•´é…ç½®æ¨¡æ¿

åˆ›å»ºæ–‡ä»¶ï¼š`/etc/openclash/custom_rules.yaml`

```yaml
# ==========================================
# OpenClash ç²¾å‡†åˆ†æµè§„åˆ™ - æµé‡èŠ‚çœç‰ˆ
# ==========================================

# ===== 1. è‡ªå®šä¹‰ä»£ç†è§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰=====

# AIå·¥å…·
- DOMAIN-SUFFIX,openai.com,PROXY
- DOMAIN-SUFFIX,anthropic.com,PROXY
- DOMAIN-SUFFIX,claude.ai,PROXY
- DOMAIN-KEYWORD,chatgpt,PROXY
- DOMAIN-KEYWORD,gemini,PROXY

# Googleå…¨å®¶æ¡¶
- DOMAIN-SUFFIX,google.com,PROXY
- DOMAIN-SUFFIX,google.com.hk,PROXY
- DOMAIN-SUFFIX,googleapis.com,PROXY
- DOMAIN-SUFFIX,googleusercontent.com,PROXY
- DOMAIN-SUFFIX,gstatic.com,PROXY
- DOMAIN-SUFFIX,gmail.com,PROXY
- DOMAIN-SUFFIX,googlevideo.com,PROXY

# YouTube
- DOMAIN-SUFFIX,youtube.com,PROXY
- DOMAIN-SUFFIX,ytimg.com,PROXY
- DOMAIN-SUFFIX,youtu.be,PROXY
- DOMAIN-KEYWORD,youtube,PROXY

# å¼€å‘å·¥å…·
- DOMAIN-SUFFIX,github.com,PROXY
- DOMAIN-SUFFIX,githubusercontent.com,PROXY
- DOMAIN-SUFFIX,github.io,PROXY
- DOMAIN-SUFFIX,stackoverflow.com,PROXY
- DOMAIN-SUFFIX,stackexchange.com,PROXY

# ç¤¾äº¤åª’ä½“ï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰
- DOMAIN-SUFFIX,twitter.com,PROXY
- DOMAIN-SUFFIX,x.com,PROXY
- DOMAIN-SUFFIX,t.co,PROXY
# - DOMAIN-SUFFIX,facebook.com,PROXY
# - DOMAIN-SUFFIX,instagram.com,PROXY

# å­¦æœ¯èµ„æº
- DOMAIN-SUFFIX,scholar.google.com,PROXY
- DOMAIN-SUFFIX,arxiv.org,PROXY
- DOMAIN-SUFFIX,researchgate.net,PROXY

# ===== 2. å›½å†…ç½‘ç«™ç›´è¿ =====
- DOMAIN-SUFFIX,baidu.com,DIRECT
- DOMAIN-SUFFIX,qq.com,DIRECT
- DOMAIN-SUFFIX,taobao.com,DIRECT
- DOMAIN-SUFFIX,tmall.com,DIRECT
- DOMAIN-SUFFIX,alipay.com,DIRECT
- DOMAIN-SUFFIX,aliyun.com,DIRECT
- DOMAIN-SUFFIX,jd.com,DIRECT
- DOMAIN-SUFFIX,bilibili.com,DIRECT
- DOMAIN-SUFFIX,zhihu.com,DIRECT
- DOMAIN-SUFFIX,douyin.com,DIRECT
- DOMAIN-SUFFIX,tencent.com,DIRECT
- DOMAIN-SUFFIX,163.com,DIRECT
- DOMAIN-SUFFIX,sina.com.cn,DIRECT

# ===== 3. å±€åŸŸç½‘ç›´è¿ =====
- IP-CIDR,192.168.0.0/16,DIRECT
- IP-CIDR,10.0.0.0/8,DIRECT
- IP-CIDR,172.16.0.0/12,DIRECT
- IP-CIDR,127.0.0.0/8,DIRECT

# ===== 4. ä¸­å›½IPç›´è¿ =====
- GEOIP,CN,DIRECT

# ===== 5. æœ€ç»ˆè§„åˆ™ï¼šå…¶ä»–å…¨éƒ¨ç›´è¿ =====
- MATCH,DIRECT
```

---

## ğŸ“± å®æ—¶æŸ¥çœ‹è§„åˆ™ç”Ÿæ•ˆ

### æ–¹æ³•1: OpenClashæ—¥å¿—

Webç•Œé¢ï¼š**OpenClash â†’ æ—¥å¿—**

å¯ä»¥çœ‹åˆ°æ¯ä¸ªè¿æ¥åŒ¹é…çš„è§„åˆ™ã€‚

### æ–¹æ³•2: å‘½ä»¤è¡ŒæŸ¥çœ‹

```bash
# æŸ¥çœ‹å½“å‰è¿æ¥
logread | grep openclash

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
logread -f | grep -E "PROXY|DIRECT"
```

---

## ğŸ§ª æµ‹è¯•é…ç½®

### æµ‹è¯•è„šæœ¬

```bash
# åœ¨ä»»æ„è®¾å¤‡ä¸Šæµ‹è¯•
# ç½‘å…³è®¾ç½®ä¸º 192.168.71.254

# æµ‹è¯•ä»£ç†ç½‘ç«™
curl -I https://www.google.com
curl -I https://www.youtube.com
curl -I https://claude.ai

# æµ‹è¯•ç›´è¿ç½‘ç«™
curl -I https://www.baidu.com
curl -I https://www.zhihu.com

# æŸ¥çœ‹å½“å‰IP
curl ipinfo.io
curl cip.cc
```

---

## ğŸ“ˆ æµé‡ç»Ÿè®¡

### æŸ¥çœ‹æµé‡ä½¿ç”¨

OpenClash Webç•Œé¢ï¼š**æµé‡ç»Ÿè®¡**

å¯ä»¥çœ‹åˆ°ï¼š
- æ€»æµé‡
- ä»£ç†æµé‡
- ç›´è¿æµé‡

---

## ğŸ’¡ é«˜çº§æŠ€å·§

### 1. æŒ‰æ—¶é—´æ®µæ§åˆ¶

åªåœ¨å·¥ä½œæ—¶é—´ä½¿ç”¨ä»£ç†ï¼š

```bash
# æ·»åŠ åˆ° cron
0 9 * * 1-5 /etc/init.d/openclash start
0 18 * * 1-5 /etc/init.d/openclash stop
```

### 2. åˆ›å»ºç½‘ç«™åˆ†ç±»

```yaml
# æ–‡ä»¶: /etc/openclash/rules/ai-services.list
DOMAIN-SUFFIX,openai.com,PROXY
DOMAIN-SUFFIX,anthropic.com,PROXY
DOMAIN-SUFFIX,claude.ai,PROXY

# æ–‡ä»¶: /etc/openclash/rules/google-services.list
DOMAIN-SUFFIX,google.com,PROXY
DOMAIN-SUFFIX,googleapis.com,PROXY
```

### 3. ç™½åå•æ¨¡å¼ï¼ˆæ›´èŠ‚çœæµé‡ï¼‰

å¦‚æœæ‚¨åªæƒ³ä»£ç†æå°‘æ•°ç½‘ç«™ï¼š

```yaml
# åªä»£ç†ä»¥ä¸‹ç½‘ç«™ï¼Œå…¶ä»–å…¨éƒ¨ç›´è¿
- DOMAIN-SUFFIX,google.com,PROXY
- DOMAIN-SUFFIX,youtube.com,PROXY
- DOMAIN-SUFFIX,claude.ai,PROXY
- DOMAIN-SUFFIX,openai.com,PROXY

# å…¶ä»–å…¨éƒ¨ç›´è¿
- MATCH,DIRECT
```

---

## ğŸ”„ å¸¸ç”¨ç½‘ç«™è§„åˆ™åº“

### AIå·¥å…·

```yaml
- DOMAIN-SUFFIX,openai.com,PROXY
- DOMAIN-SUFFIX,anthropic.com,PROXY
- DOMAIN-SUFFIX,claude.ai,PROXY
- DOMAIN-SUFFIX,perplexity.ai,PROXY
- DOMAIN-SUFFIX,midjourney.com,PROXY
- DOMAIN-SUFFIX,bard.google.com,PROXY
- DOMAIN-SUFFIX,gemini.google.com,PROXY
- DOMAIN-SUFFIX,poe.com,PROXY
- DOMAIN-SUFFIX,huggingface.co,PROXY
```

### å¼€å‘å·¥å…·

```yaml
- DOMAIN-SUFFIX,github.com,PROXY
- DOMAIN-SUFFIX,githubusercontent.com,PROXY
- DOMAIN-SUFFIX,npmjs.com,PROXY
- DOMAIN-SUFFIX,pypi.org,PROXY
- DOMAIN-SUFFIX,docker.com,PROXY
- DOMAIN-SUFFIX,docker.io,PROXY
```

### å­¦ä¹ èµ„æº

```yaml
- DOMAIN-SUFFIX,coursera.org,PROXY
- DOMAIN-SUFFIX,udemy.com,PROXY
- DOMAIN-SUFFIX,edx.org,PROXY
- DOMAIN-SUFFIX,khanacademy.org,PROXY
```

---

## âœ… å®Œæˆ

ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… **ç²¾ç¡®æ§åˆ¶** - åªæœ‰æŒ‡å®šç½‘ç«™èµ°ä»£ç†
2. âœ… **èŠ‚çœæµé‡** - å…¶ä»–å…¨éƒ¨ç›´è¿
3. âœ… **æ˜“äºæ·»åŠ ** - Webç•Œé¢æˆ–å‘½ä»¤è¡Œå¿«é€Ÿæ·»åŠ 
4. âœ… **å®æ—¶ç”Ÿæ•ˆ** - è§„åˆ™ç«‹å³ç”Ÿæ•ˆ

**æ¨èå·¥ä½œæµç¨‹**ï¼š

```
1. ä½¿ç”¨ä¸Šé¢çš„æ¨¡æ¿é…ç½®åŸºç¡€è§„åˆ™
2. æ—¥å¸¸ä½¿ç”¨ä¸­é‡åˆ°éœ€è¦ä»£ç†çš„ç½‘ç«™
3. é€šè¿‡ add-proxy å‘½ä»¤å¿«é€Ÿæ·»åŠ 
4. é‡å¯OpenClashç”Ÿæ•ˆ
```

è¿™æ ·æ—¢èŠ‚çœæµé‡ï¼Œåˆèƒ½ç²¾ç¡®æ§åˆ¶ï¼ğŸ¯




---



# 10 - V2Rayæ—è·¯ç”±é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

ä½¿ç”¨Rocky Linux 9 + V2Ray/Xrayå®ç°é«˜æ€§èƒ½é€æ˜ä»£ç†ã€‚

**é¢„è®¡è€—æ—¶**: 60åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­â˜†

---

## ğŸš€ æ­¥éª¤1: åˆ›å»ºè™šæ‹Ÿæœº

```bash
# ä½¿ç”¨Rocky Linux 9 ISOï¼ˆå‚è€ƒ11-vm-nas.mdæ­¥éª¤1ï¼‰
create-vm router 2 2 20 qcow2 \
  /kvm/iso/Rocky-9.3-x86_64-minimal.iso \
  192.168.71.254
```

å®‰è£…æ—¶ç½‘ç»œé…ç½®ä¸º192.168.71.254/24ã€‚

---

## ğŸ”§ æ­¥éª¤2: å®‰è£…Xray

```bash
ssh root@192.168.71.254

# å®‰è£…Xrayï¼ˆæ¯”V2Rayæ›´é«˜æ•ˆï¼‰
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
```

---

## âš™ï¸ æ­¥éª¤3: è½¬æ¢Clashè®¢é˜…

### 3.1 ä½¿ç”¨è®¢é˜…è½¬æ¢æœåŠ¡

è®¿é—®: https://sub-web.netlify.app/

- è¾“å…¥ä½ çš„Clashè®¢é˜…é“¾æ¥
- å®¢æˆ·ç«¯é€‰æ‹©: V2Ray
- åç«¯åœ°å€: https://api.dler.io/sub
- ç‚¹å‡»ç”Ÿæˆè®¢é˜…é“¾æ¥

### 3.2 ä¸‹è½½é…ç½®

```bash
curl -o /usr/local/etc/xray/config.json \
    "è½¬æ¢åçš„è®¢é˜…é“¾æ¥"

# æˆ–æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶
vi /usr/local/etc/xray/config.json
```

---

## ğŸŒ æ­¥éª¤4: é…ç½®é€æ˜ä»£ç†

```bash
# å®‰è£…iptables
dnf install -y iptables-services

# åˆ›å»ºé€æ˜ä»£ç†è„šæœ¬
cat &gt; /usr/local/bin/setup-tproxy.sh &lt;&lt;'EOF'
#!/bin/bash

# æ¸…ç©ºè§„åˆ™
iptables -t nat -F
iptables -t mangle -F

# æœ¬åœ°æµé‡ç›´è¿
iptables -t nat -A PREROUTING -s 192.168.71.0/24 -d 192.168.71.0/24 -j RETURN

# é€æ˜ä»£ç†
iptables -t nat -A PREROUTING -s 192.168.71.0/24 -p tcp -j REDIRECT --to-ports 12345

# å¯ç”¨IPè½¬å‘
echo 1 &gt; /proc/sys/net/ipv4/ip_forward

echo "é€æ˜ä»£ç†å·²é…ç½®"
EOF

chmod +x /usr/local/bin/setup-tproxy.sh
```

---

## ğŸš€ æ­¥éª¤5: å¯åŠ¨æœåŠ¡

```bash
# é…ç½®Xrayé…ç½®æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
cat &gt; /usr/local/etc/xray/config.json &lt;&lt;'EOF'
{
  "inbounds": [{
    "port": 12345,
    "protocol": "dokodemo-door",
    "settings": {
      "network": "tcp,udp",
      "followRedirect": true
    },
    "streamSettings": {
      "sockopt": {
        "tproxy": "redirect"
      }
    }
  }],
  "outbounds": [{
    "protocol": "vmess",
    "settings": {
      "vnext": [{
        "address": "ä½ çš„æœåŠ¡å™¨åœ°å€",
        "port": 443,
        "users": [{
          "id": "ä½ çš„UUID",
          "alterId": 0
        }]
      }]
    }
  }]
}
EOF

# å¯åŠ¨æœåŠ¡
systemctl enable --now xray
systemctl status xray

# é…ç½®é€æ˜ä»£ç†
/usr/local/bin/setup-tproxy.sh

# å¼€æœºè‡ªåŠ¨é…ç½®
echo "/usr/local/bin/setup-tproxy.sh" &gt;&gt; /etc/rc.local
chmod +x /etc/rc.local
```

---

## âœ… éªŒè¯

```bash
# æµ‹è¯•ä»£ç†
curl -x socks5://127.0.0.1:1080 https://www.google.com

# åœ¨å®¢æˆ·ç«¯æµ‹è¯•
# è®¾ç½®ç½‘å…³ä¸º192.168.71.254
curl https://www.google.com
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. V2Ray/Xrayé…ç½®è¾ƒå¤æ‚ï¼Œå»ºè®®å…ˆå­¦ä¹ åŸºç¡€
2. è®¢é˜…è½¬æ¢å¯èƒ½ä¸å®Œå…¨å‡†ç¡®ï¼Œéœ€æ‰‹åŠ¨è°ƒæ•´
3. æ€§èƒ½ä¼˜äºOpenWrtï¼Œä½†é…ç½®éš¾åº¦æ›´é«˜
4. é€‚åˆæœ‰Linuxç»éªŒçš„ç”¨æˆ·

**æ¨èæ–°æ‰‹å…ˆä½¿ç”¨09æ–‡æ¡£çš„OpenWrtæ–¹æ¡ˆ**

---

## ğŸ¯ åç»­ä¼˜åŒ–

- é…ç½®åˆ†æµè§„åˆ™ï¼ˆå›½å†…ç›´è¿ï¼‰
- å¯ç”¨DNSæ±¡æŸ“é˜²æŠ¤
- é…ç½®æµé‡ç»Ÿè®¡

ğŸ‘‰ **[11-vm-nas.md](#section-11)**




---



# 11 - NASæ–‡ä»¶å…±äº«æœåŠ¡å™¨é…ç½®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

é…ç½®Rocky Linux 9 NASè™šæ‹Ÿæœºï¼Œæä¾›SMB/NFSæ–‡ä»¶å…±äº«æœåŠ¡ã€‚

**é¢„è®¡è€—æ—¶**: 70åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­â˜†

---

## ğŸ¤” Samba vs NFS - æˆ‘éœ€è¦é…ç½®å“ªä¸ªï¼Ÿ

### å¿«é€Ÿé€‰æ‹©æŒ‡å—

**åªé…ç½®Sambaï¼Œå¦‚æœä½ ï¼š**
- âœ… ä¸»è¦ç”¨Windows/Mac/æ‰‹æœºè®¿é—®
- âœ… æ—¥å¸¸æ–‡ä»¶ç®¡ç†å’Œåª’ä½“æ’­æ”¾
- âœ… ä¸éœ€è¦Linuxè™šæ‹Ÿæœºé«˜æ€§èƒ½è®¿é—®

**åŒæ—¶é…ç½®Samba + NFSï¼Œå¦‚æœä½ ï¼š**
- âœ… éœ€è¦Linuxè™šæ‹Ÿæœºè®¿é—®ï¼ˆå¦‚Pythonå¼€å‘VMï¼‰
- âœ… éœ€è¦é«˜æ€§èƒ½å¤§æ–‡ä»¶ä¼ è¾“
- âœ… ç¼–è¯‘é¡¹ç›®éœ€è¦å¿«é€ŸIO

### ä¸¤è€…å¯¹æ¯”

| ç‰¹æ€§ | Samba (SMB) | NFS |
|------|------------|-----|
| **Windows** | âœ… å®Œç¾æ”¯æŒ | âŒ éœ€ç¬¬ä¸‰æ–¹å·¥å…· |
| **Mac** | âœ… åŸç”Ÿæ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒï¼ˆæ€§èƒ½æ›´å¥½ï¼‰ |
| **iOS/Android** | âœ… Appæ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **Linux** | âœ… æ”¯æŒ | âœ… åŸç”Ÿï¼ˆæ€§èƒ½æœ€ä½³ï¼‰ |
| **æ€§èƒ½** | â­â­â­â˜†â˜† | â­â­â­â­â­ |
| **é…ç½®éš¾åº¦** | â­â­â˜†â˜†â˜† | â­â­â­â˜†â˜† |

### æ¨èé…ç½®

```
æœ€å°é…ç½®ï¼ˆæ¨èæ–°æ‰‹ï¼‰:
  â””â”€ ä»…é…ç½® Samba
     â”œâ”€ æ­¥éª¤5: Sambaé…ç½® âœ…
     â””â”€ æ­¥éª¤6: NFSé…ç½® â­ï¸ è·³è¿‡

å®Œæ•´é…ç½®ï¼ˆæ¨èæœ‰Linux VMçš„ç”¨æˆ·ï¼‰:
  â””â”€ é…ç½® Samba + NFS
     â”œâ”€ æ­¥éª¤5: Sambaé…ç½® âœ…
     â””â”€ æ­¥éª¤6: NFSé…ç½® âœ…
```

---

## ğŸš€ æ­¥éª¤1: åˆ›å»ºNASè™šæ‹Ÿæœº

### 1.1 ä¸‹è½½Rocky Linux ISO

```bash
cd /kvm/iso
wget https://mirrors.aliyun.com/rockylinux/9/isos/x86_64/Rocky-9.3-x86_64-minimal.iso
virsh pool-refresh iso_pool
```

### 1.2 åˆ›å»ºè™šæ‹Ÿæœº

```bash
# åˆ›å»º30GBç³»ç»Ÿç›˜ï¼ˆrawæ ¼å¼ï¼Œæ€§èƒ½ä¼˜å…ˆï¼‰
lvcreate -V 30G --thinpool kvm_thin_pool -n nas vg_kvm

# åˆ›å»ºè™šæ‹Ÿæœº
virt-install \
    --name nas \
    --ram 4096 \
    --vcpus 2 \
    --disk path=/dev/vg_kvm/nas,format=raw,bus=virtio \
    --network bridge=br0,model=virtio \
    --graphics vnc,listen=0.0.0.0 \
    --cdrom /kvm/iso/Rocky-9.3-x86_64-minimal.iso \
    --os-variant rhel9.0 \
    --noautoconsole

# æŸ¥çœ‹VNCç«¯å£
virsh vncdisplay nas
```

---

## âš™ï¸ æ­¥éª¤2: å®‰è£…Rocky Linux 9

é€šè¿‡VNCè¿æ¥å®‰è£…ï¼š

1. **è¯­è¨€**: ç®€ä½“ä¸­æ–‡
2. **æ—¶åŒº**: äºšæ´²/ä¸Šæµ·
3. **è½¯ä»¶é€‰æ‹©**: æœ€å°åŒ–å®‰è£…
4. **ç½‘ç»œé…ç½®**:
   - IP: 192.168.71.210
   - å­ç½‘æ©ç : 255.255.255.0
   - ç½‘å…³: 192.168.71.1
   - DNS: 192.168.71.1,223.5.5.5
5. **Rootå¯†ç **: è®¾ç½®å¼ºå¯†ç 
6. **åˆ›å»ºç”¨æˆ·**: nasadmin

å®‰è£…å®Œæˆåï¼š
```bash
# å¼¹å‡ºå…‰ç›˜
virsh change-media nas sda --eject

# è®¾ç½®è‡ªåŠ¨å¯åŠ¨
virsh autostart nas

# é‡å¯
virsh reboot nas
```

---

## ğŸ”§ æ­¥éª¤3: ç³»ç»Ÿåˆå§‹åŒ–

SSHç™»å½•ï¼š
```bash
ssh root@192.168.71.210
```

### 3.1 é…ç½®é•œåƒæº

```bash
# å¤‡ä»½åŸå§‹é…ç½®
mkdir -p /etc/yum.repos.d/backup
mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/

# é…ç½®é˜¿é‡Œäº‘é•œåƒ
cat &gt; /etc/yum.repos.d/rocky-aliyun.repo &lt;&lt;'EOF'
[baseos]
name=Rocky Linux $releasever - BaseOS
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[appstream]
name=Rocky Linux $releasever - AppStream
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9

[extras]
name=Rocky Linux $releasever - Extras
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/extras/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Rocky-9
EOF

# æ›´æ–°ç³»ç»Ÿ
dnf clean all
dnf makecache
dnf update -y
```

### 3.2 å®‰è£…åŸºç¡€å·¥å…·

```bash
dnf install -y \
    vim \
    wget \
    curl \
    htop \
    net-tools \
    bind-utils \
    tree
```

---

## ğŸ’¾ æ­¥éª¤4: æŒ‚è½½å®¿ä¸»æœºå…±äº«çš„NASæ•°æ®å·

### 4.1 åœ¨å®¿ä¸»æœºé…ç½®virtio-fs

åœ¨å®¿ä¸»æœºä¸Šæ“ä½œï¼š
```bash
ssh chris@192.168.71.200

# ç¡®è®¤NASæ•°æ®ç›®å½•å­˜åœ¨
ls -ld /data/nas

# ç¼–è¾‘NASè™šæ‹Ÿæœºé…ç½®
sudo virsh edit nas

# åœ¨&lt;devices&gt;èŠ‚ç‚¹å†…æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆåœ¨&lt;/devices&gt;å‰ï¼‰ï¼š
# &lt;filesystem type='mount' accessmode='passthrough'&gt;
#   &lt;driver type='virtiofs'/&gt;
#   &lt;source dir='/data/nas'/&gt;
#   &lt;target dir='nas_data'/&gt;
# &lt;/filesystem&gt;

# ä¿å­˜åé‡å¯è™šæ‹Ÿæœº
sudo virsh shutdown nas
sleep 5
sudo virsh start nas
```

### 4.2 åœ¨NASè™šæ‹ŸæœºæŒ‚è½½

å›åˆ°NASè™šæ‹Ÿæœºï¼š
```bash
ssh root@192.168.71.210

# åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /mnt/nas_data

# æŒ‚è½½virtio-fs
mount -t virtiofs nas_data /mnt/nas_data

# éªŒè¯
df -h /mnt/nas_data
ls -l /mnt/nas_data

# é…ç½®è‡ªåŠ¨æŒ‚è½½
echo "nas_data /mnt/nas_data virtiofs defaults 0 0" &gt;&gt; /etc/fstab

# éªŒè¯fstab
mount -a
```

---

## ğŸ“‚ æ­¥éª¤5: Sambaé…ç½®ï¼ˆWindows/Mac/iOSè®¿é—®ï¼‰

### 5.1 å®‰è£…Samba

```bash
dnf install -y samba samba-client

# å¯åŠ¨æœåŠ¡
systemctl enable --now smb nmb
```

### 5.2 é…ç½®Samba

```bash
# å¤‡ä»½åŸå§‹é…ç½®
cp /etc/samba/smb.conf /etc/samba/smb.conf.bak

# åˆ›å»ºæ–°é…ç½®
cat &gt; /etc/samba/smb.conf &lt;&lt;'EOF'
[global]
    workgroup = WORKGROUP
    server string = Home NAS Server
    netbios name = NAS
    security = user
    map to guest = bad user
    dns proxy = no
    # æ€§èƒ½ä¼˜åŒ–
    socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=524288 SO_SNDBUF=524288
    read raw = yes
    write raw = yes
    max xmit = 65535
    dead time = 15
    getwd cache = yes

[Public]
    comment = å…¬å…±æ–‡ä»¶å¤¹
    path = /mnt/nas_data/public
    browseable = yes
    writable = yes
    guest ok = yes
    create mask = 0777
    directory mask = 0777

[Private]
    comment = ç§äººæ–‡ä»¶å¤¹
    path = /mnt/nas_data/private
    browseable = yes
    writable = yes
    valid users = nasadmin
    create mask = 0770
    directory mask = 0770

[Media]
    comment = åª’ä½“æ–‡ä»¶
    path = /mnt/nas_data/media
    browseable = yes
    writable = yes
    guest ok = yes
    create mask = 0775
    directory mask = 0775
EOF

# åˆ›å»ºå…±äº«ç›®å½•
mkdir -p /mnt/nas_data/{public,private,media}
chmod 777 /mnt/nas_data/public
chmod 770 /mnt/nas_data/private
chmod 775 /mnt/nas_data/media

# åˆ›å»ºSambaç”¨æˆ·
smbpasswd -a nasadmin
# è¾“å…¥Sambaå¯†ç 

# æµ‹è¯•é…ç½®
testparm

# é‡å¯æœåŠ¡
systemctl restart smb nmb
```

### 5.3 é…ç½®é˜²ç«å¢™

```bash
firewall-cmd --permanent --add-service=samba
firewall-cmd --reload
```

---

## ğŸ§ æ­¥éª¤6: NFSé…ç½®ï¼ˆLinuxé«˜æ€§èƒ½è®¿é—®ï¼‰

### 6.1 å®‰è£…NFS

```bash
dnf install -y nfs-utils

# å¯åŠ¨æœåŠ¡
systemctl enable --now nfs-server
```

### 6.2 é…ç½®NFSå¯¼å‡º

```bash
# é…ç½®å¯¼å‡º
cat &gt; /etc/exports &lt;&lt;'EOF'
/mnt/nas_data/public  192.168.71.0/24(rw,sync,no_subtree_check,no_root_squash)
/mnt/nas_data/private 192.168.71.0/24(rw,sync,no_subtree_check,root_squash)
/mnt/nas_data/media   192.168.71.0/24(rw,sync,no_subtree_check,no_root_squash)
EOF

# ä½¿é…ç½®ç”Ÿæ•ˆ
exportfs -arv

# æŸ¥çœ‹å¯¼å‡º
exportfs -v
```

### 6.3 é…ç½®é˜²ç«å¢™

```bash
firewall-cmd --permanent --add-service=nfs
firewall-cmd --permanent --add-service=rpc-bind
firewall-cmd --permanent --add-service=mountd
firewall-cmd --reload
```

---

## ğŸŒ æ­¥éª¤7: å®¢æˆ·ç«¯è®¿é—®é…ç½®

### 7.1 Windowsè®¿é—®

```
1. æ‰“å¼€"æ­¤ç”µè„‘"
2. ç‚¹å‡»"æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨"
3. è¾“å…¥: \\192.168.71.210\Public
4. æˆ–è®¿é—®: \\192.168.71.210\Private
   ç”¨æˆ·å: nasadmin
   å¯†ç : &lt;Sambaå¯†ç &gt;
```

### 7.2 macOSè®¿é—®

```
1. Finder â†’ å‰å¾€ â†’ è¿æ¥æœåŠ¡å™¨ (Cmd+K)
2. è¾“å…¥: smb://192.168.71.210/Public
3. æˆ–: smb://nasadmin@192.168.71.210/Private
```

### 7.3 Linuxè®¿é—®ï¼ˆNFSï¼‰

```bash
# åœ¨å…¶ä»–Linuxæœºå™¨ä¸Š
sudo apt install -y nfs-common  # Ubuntu
# æˆ–
sudo dnf install -y nfs-utils   # Rocky/CentOS

# æŒ‚è½½NFS
sudo mkdir -p /mnt/nas_public
sudo mount -t nfs 192.168.71.210:/mnt/nas_data/public /mnt/nas_public

# è‡ªåŠ¨æŒ‚è½½
echo "192.168.71.210:/mnt/nas_data/public /mnt/nas_public nfs defaults 0 0" | sudo tee -a /etc/fstab
```

### 7.4 iOS/iPadOSè®¿é—®

```
ä½¿ç”¨"æ–‡ä»¶"åº”ç”¨:
1. æ‰“å¼€"æ–‡ä»¶"åº”ç”¨
2. ç‚¹å‡»å³ä¸Šè§’"â€¦" â†’ è¿æ¥æœåŠ¡å™¨
3. è¾“å…¥: smb://192.168.71.210
4. é€‰æ‹©å…±äº«æ–‡ä»¶å¤¹
```

---

## ğŸ”’ æ­¥éª¤8: å¤–ç½‘è®¿é—®æ–¹æ¡ˆ

### æ–¹æ¡ˆA: WireGuard VPNï¼ˆæ¨èï¼‰

åœ¨å®¿ä¸»æœºé…ç½®WireGuardï¼Œé€šè¿‡VPNè®¿é—®å®¶åº­ç½‘ç»œã€‚

### æ–¹æ¡ˆB: FRPåå‘ä»£ç†

ä½¿ç”¨é˜¿é‡Œäº‘ECSåšåå‘ä»£ç†ï¼š

```bash
# åœ¨é˜¿é‡Œäº‘ECSä¸Šå®‰è£…frps
wget https://github.com/fatedier/frp/releases/download/v0.52.0/frp_0.52.0_linux_amd64.tar.gz
tar -xzf frp_0.52.0_linux_amd64.tar.gz

# é…ç½®æœåŠ¡ç«¯
cat &gt; frps.ini &lt;&lt;'EOF'
[common]
bind_port = 7000
token = your_secret_token
EOF

# å¯åŠ¨
./frps -c frps.ini

# åœ¨å®¿ä¸»æœºå®‰è£…frpc
wget https://github.com/fatedier/frp/releases/download/v0.52.0/frp_0.52.0_linux_amd64.tar.gz
tar -xzf frp_0.52.0_linux_amd64.tar.gz

# é…ç½®å®¢æˆ·ç«¯
cat &gt; frpc.ini &lt;&lt;'EOF'
[common]
server_addr = &lt;é˜¿é‡Œäº‘ECSå…¬ç½‘IP&gt;
server_port = 7000
token = your_secret_token

[nas-smb]
type = tcp
local_ip = 192.168.71.210
local_port = 445
remote_port = 8445
EOF

# å¯åŠ¨
./frpc -c frpc.ini
```

---

## ğŸ“Š æ­¥éª¤9: ç›‘æ§å’Œç»´æŠ¤

### 9.1 ç£ç›˜ä½¿ç”¨ç›‘æ§

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
cat &gt; /usr/local/bin/nas-monitor &lt;&lt;'EOF'
#!/bin/bash
echo "=== NASå­˜å‚¨ç›‘æ§ ==="
df -h /mnt/nas_data
echo ""
echo "=== Sambaè¿æ¥ ==="
smbstatus -b
echo ""
echo "=== NFSè¿æ¥ ==="
showmount -a
EOF

chmod +x /usr/local/bin/nas-monitor
```

### 9.2 æ—¥å¿—æŸ¥çœ‹

```bash
# Sambaæ—¥å¿—
tail -f /var/log/samba/log.smbd

# NFSæ—¥å¿—
journalctl -u nfs-server -f
```

---

## âœ… éªŒè¯å’Œæµ‹è¯•

```bash
# åœ¨NASè™šæ‹Ÿæœºä¸Š
nas-monitor

# åœ¨Windowsä¸Š
net use \\192.168.71.210\Public

# åœ¨Linuxä¸Š
showmount -e 192.168.71.210
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

- [x] Rocky Linux 9å®‰è£…å®Œæˆ
- [x] virtio-fsæŒ‚è½½å®¿ä¸»æœºæ•°æ®å·
- [x] Sambaé…ç½®ï¼ˆWindows/Mac/iOSè®¿é—®ï¼‰
- [x] NFSé…ç½®ï¼ˆLinuxé«˜æ€§èƒ½è®¿é—®ï¼‰
- [x] é˜²ç«å¢™é…ç½®
- [x] å®¢æˆ·ç«¯è®¿é—®æµ‹è¯•
- [x] å¤–ç½‘è®¿é—®æ–¹æ¡ˆäº†è§£
- [x] ç›‘æ§è„šæœ¬é…ç½®

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### æ—¥å¸¸æ–‡ä»¶å…±äº«
```
Windowsç”µè„‘ â†’ \\192.168.71.210\Public
Macç”µè„‘ â†’ smb://192.168.71.210/Public
iPhone/iPad â†’ æ–‡ä»¶Appè¿æ¥æœåŠ¡å™¨
Linuxå¼€å‘æœº â†’ NFSæŒ‚è½½
```

### åª’ä½“å­˜å‚¨
```
å°†ç”µå½±ã€ç…§ç‰‡æ”¾å…¥Mediaå…±äº«
å„è®¾å¤‡å¯ç›´æ¥è®¿é—®å’Œæ’­æ”¾
```

ğŸ‘‰ **[12-backup-restore.md - å¤‡ä»½æ¢å¤](#section-12)**




---



# 11 - è¡¥å……Tailscaleå®ç°å¤–ç½‘è®¿é—®

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

ä½¿ç”¨ Tailscale è®©æ‚¨åœ¨å¤–å‡ºæ—¶å®‰å…¨è®¿é—®å®¶åº­ NASï¼Œæ— éœ€å…¬ç½‘ IPï¼Œæ— éœ€å¤æ‚é…ç½®ã€‚

**é¢„è®¡è€—æ—¶**: 20åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â˜†â˜†â˜†

---

## ğŸ¯ Tailscale ç®€ä»‹

### ä»€ä¹ˆæ˜¯ Tailscaleï¼Ÿ

Tailscale æ˜¯åŸºäº WireGuard çš„é›¶é…ç½® VPN æœåŠ¡ï¼š
- âœ… è‡ªåŠ¨ç©¿é€ NATï¼ˆæ— éœ€å…¬ç½‘IPï¼‰
- âœ… ç‚¹å¯¹ç‚¹åŠ å¯†ï¼ˆæ•°æ®ä¸ç»è¿‡TailscaleæœåŠ¡å™¨ï¼‰
- âœ… è·¨å¹³å°å®¢æˆ·ç«¯ï¼ˆiOS/Android/Windows/Mac/Linuxï¼‰
- âœ… é›¶é…ç½®ï¼ˆæ— éœ€æ‰‹åŠ¨ç”Ÿæˆå¯†é’¥å’Œé…ç½®æ–‡ä»¶ï¼‰
- âœ… å…è´¹ç‰ˆæ”¯æŒ100å°è®¾å¤‡

### å·¥ä½œåŸç†

```
æ‚¨çš„æ‰‹æœº (å¤–ç½‘)
    â†“
Tailscaleåè°ƒæœåŠ¡å™¨ (ä»…äº¤æ¢è¿æ¥ä¿¡æ¯)
    â†“
æ‰“é€šP2Péš§é“
    â†“
å®¶åº­NAS (192.168.71.210)
    â†‘
ç›´æ¥åŠ å¯†è¿æ¥ï¼Œæ•°æ®ä¸ç»è¿‡ä¸­é—´æœåŠ¡å™¨
```

### ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | é…ç½®éš¾åº¦ | NATç©¿é€ | å…è´¹ | æ¨èåº¦ |
|------|---------|---------|------|--------|
| **Tailscale** | â­â˜†â˜†â˜†â˜† | âœ… è‡ªåŠ¨ | âœ… 100è®¾å¤‡ | â­â­â­â­â­ |
| åŸç”ŸWireGuard | â­â­â­â­â˜† | âŒ éœ€å…¬ç½‘IP | âœ… | â­â­â­â˜†â˜† |
| FRPåå‘ä»£ç† | â­â­â­â˜†â˜† | âœ… | âœ… | â­â­â­â˜†â˜† |
| ZeroTier | â­â­â˜†â˜†â˜† | âœ… | âœ… | â­â­â­â­â˜† |

**æ¨è**: å¯¹äºå®¶åº­ç”¨æˆ·ï¼Œ**Tailscale æ˜¯æœ€ä½³é€‰æ‹©**ï¼

---

## ğŸš€ æ­¥éª¤1: æ³¨å†Œ Tailscale è´¦å·

### 1.1 æ³¨å†Œè´¦å·

è®¿é—®: https://tailscale.com/

1. ç‚¹å‡» "Get Started"
2. ä½¿ç”¨ Google/GitHub/Microsoft è´¦å·ç™»å½•
3. å®Œæˆæ³¨å†Œï¼ˆå®Œå…¨å…è´¹ï¼‰

### 1.2 è®°å½•ä¿¡æ¯

æ³¨å†Œåæ‚¨ä¼šå¾—åˆ°ï¼š
- Tailscale è´¦å·
- ç®¡ç†æ§åˆ¶å°: https://login.tailscale.com/admin

---

## ğŸ–¥ï¸ æ­¥éª¤2: åœ¨å®¿ä¸»æœºå®‰è£… Tailscale

### 2.1 å®‰è£… Tailscale

SSH ç™»å½•åˆ°å®¿ä¸»æœºï¼š
```bash
ssh chris@192.168.71.200
sudo su -

# æ·»åŠ Tailscaleä»“åº“
curl -fsSL https://pkgs.tailscale.com/stable/rhel/9/tailscale.repo | tee /etc/yum.repos.d/tailscale.repo

# å®‰è£…Tailscale
dnf install -y tailscale

# å¯åŠ¨æœåŠ¡
systemctl enable --now tailscaled
```

### 2.2 è¿æ¥åˆ° Tailscale ç½‘ç»œ

```bash
# å¯åŠ¨å¹¶è®¤è¯
tailscale up

# ä¼šè¾“å‡ºç±»ä¼¼ä¿¡æ¯:
# To authenticate, visit:
# https://login.tailscale.com/a/xxxxxxxxxx

# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¿™ä¸ªé“¾æ¥ï¼Œç™»å½•å¹¶æˆæƒ
```

### 2.3 éªŒè¯è¿æ¥

```bash
# æŸ¥çœ‹TailscaleçŠ¶æ€
tailscale status

# è¾“å‡ºç¤ºä¾‹:
# 100.x.x.x   homeserver   chris@       linux   -
# 100.x.x.y   iphone       chris@       iOS     -

# æŸ¥çœ‹åˆ†é…çš„IPåœ°å€
tailscale ip -4

# ç¤ºä¾‹è¾“å‡º: 100.101.102.103
# è¿™æ˜¯æ‚¨å®¿ä¸»æœºåœ¨Tailscaleç½‘ç»œä¸­çš„IP
```

### 2.4 é…ç½®é˜²ç«å¢™

```bash
# å…è®¸Tailscaleæµé‡
firewall-cmd --permanent --add-service=tailscale
firewall-cmd --reload

# æˆ–æ‰‹åŠ¨æ·»åŠ ç«¯å£
firewall-cmd --permanent --add-port=41641/udp
firewall-cmd --reload
```

---

## ğŸ“‚ æ­¥éª¤3: å¯ç”¨å­ç½‘è·¯ç”±ï¼ˆé‡è¦ï¼‰

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦å­ç½‘è·¯ç”±ï¼Ÿ

**é»˜è®¤æƒ…å†µ**:
```
æ‰‹æœº â†’ ä»…èƒ½è®¿é—®å®¿ä¸»æœº (100.x.x.x)
æ‰‹æœº âœ— æ— æ³•è®¿é—® NAS VM (192.168.71.210)
```

**å¯ç”¨å­ç½‘è·¯ç”±å**:
```
æ‰‹æœº â†’ å¯ä»¥è®¿é—®å®¿ä¸»æœº (100.x.x.x)
æ‰‹æœº â†’ å¯ä»¥è®¿é—®æ•´ä¸ªå®¶åº­ç½‘ç»œ (192.168.71.0/24)
       åŒ…æ‹¬: NAS (192.168.71.210)
             Python VM (192.168.71.201)
             è·¯ç”±å™¨ (192.168.71.254)
```

### 3.2 é…ç½®å­ç½‘è·¯ç”±

```bash
# åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œ

# 1. å¯ç”¨IPè½¬å‘
echo 'net.ipv4.ip_forward = 1' &gt;&gt; /etc/sysctl.conf
sysctl -p

# 2. é‡æ–°å¯åŠ¨Tailscaleï¼Œå£°æ˜å­ç½‘è·¯ç”±
tailscale up --advertise-routes=192.168.71.0/24 --accept-routes

# å‚æ•°è¯´æ˜:
# --advertise-routes=192.168.71.0/24
#   å£°æ˜: æˆ‘å¯ä»¥è·¯ç”±åˆ°192.168.71.0/24ç½‘æ®µ
#   
# --accept-routes
#   æ¥å—: å…¶ä»–èŠ‚ç‚¹å£°æ˜çš„è·¯ç”±
```

### 3.3 åœ¨ Tailscale æ§åˆ¶å°æ‰¹å‡†è·¯ç”±

1. è®¿é—®: https://login.tailscale.com/admin/machines
2. æ‰¾åˆ°æ‚¨çš„å®¿ä¸»æœº (homeserver)
3. ç‚¹å‡»å³ä¾§çš„ "..." â†’ "Edit route settings"
4. æ‰¾åˆ° "Subnet routes" éƒ¨åˆ†
5. å¯ç”¨ `192.168.71.0/24` è·¯ç”±
6. ç‚¹å‡» "Save"

```
ç°åœ¨ï¼Œæ‰€æœ‰è¿æ¥åˆ°Tailscaleçš„è®¾å¤‡éƒ½å¯ä»¥è®¿é—®æ‚¨çš„å®¶åº­ç½‘ç»œï¼
```

---

## ğŸ“± æ­¥éª¤4: åœ¨å®¢æˆ·ç«¯å®‰è£… Tailscale

### 4.1 iPhone/iPad

1. App Store æœç´¢ "Tailscale"
2. å®‰è£…å¹¶æ‰“å¼€
3. ç™»å½•æ‚¨çš„ Tailscale è´¦å·
4. è¿æ¥åˆ°ç½‘ç»œ

### 4.2 Android

1. Google Play æœç´¢ "Tailscale"
2. å®‰è£…å¹¶æ‰“å¼€
3. ç™»å½•æ‚¨çš„ Tailscale è´¦å·
4. è¿æ¥åˆ°ç½‘ç»œ

### 4.3 Windows

```powershell
# ä¸‹è½½å®‰è£…åŒ…
https://tailscale.com/download/windows

# å®‰è£…åå³ä¸‹è§’å›¾æ ‡ â†’ ç™»å½•
```

### 4.4 Mac

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install tailscale

# æˆ–ä¸‹è½½DMGå®‰è£…åŒ…
https://tailscale.com/download/mac
```

---

## ğŸ§ª æ­¥éª¤5: æµ‹è¯•å¤–ç½‘è®¿é—®

### 5.1 åœ¨æ‰‹æœºä¸Šæµ‹è¯•

1. **è¿æ¥åˆ°ç§»åŠ¨æ•°æ®**ï¼ˆæ–­å¼€WiFiï¼‰
2. **æ‰“å¼€ Tailscale App**ï¼Œç¡®ä¿å·²è¿æ¥
3. **æµ‹è¯•è®¿é—®**ï¼š

#### æ–¹æ³•A: é€šè¿‡ Tailscale IP è®¿é—®

```
åœ¨æ‰‹æœºæµè§ˆå™¨ä¸­è®¿é—®:
http://192.168.71.210

åº”è¯¥èƒ½çœ‹åˆ°NASçš„Sambaå…±äº«
```

#### æ–¹æ³•B: åœ¨æ–‡ä»¶ç®¡ç†å™¨è®¿é—®

**iOS/iPadOS**:
```
1. æ‰“å¼€"æ–‡ä»¶"App
2. ç‚¹å‡»å³ä¸Šè§’ "..." â†’ è¿æ¥æœåŠ¡å™¨
3. è¾“å…¥: smb://192.168.71.210
4. é€‰æ‹©å…±äº«æ–‡ä»¶å¤¹
5. âœ… æˆåŠŸï¼ç°åœ¨å¯ä»¥è®¿é—®å®¶åº­NASäº†
```

**Android**:
```
1. å®‰è£… Solid Explorer æˆ–å…¶ä»–æ–‡ä»¶ç®¡ç†å™¨
2. æ·»åŠ ç½‘ç»œå­˜å‚¨ â†’ SMB
3. æœåŠ¡å™¨: 192.168.71.210
4. ç”¨æˆ·å: nasadmin
5. âœ… è¿æ¥æˆåŠŸ
```

### 5.2 éªŒè¯è¿æ¥

```bash
# åœ¨æ‰‹æœºä¸Šå¯ä»¥åšä»€ä¹ˆ:
- æŸ¥çœ‹å®¶åº­NASçš„æ–‡ä»¶
- ä¸Šä¼ ç…§ç‰‡åˆ°NAS
- ä¸‹è½½æ–‡æ¡£åˆ°æ‰‹æœº
- æ’­æ”¾NASä¸Šçš„è§†é¢‘
- è®¿é—®æ‰€æœ‰å®¶åº­è®¾å¤‡ï¼ˆå¦‚æœé…ç½®äº†å­ç½‘è·¯ç”±ï¼‰

# é€Ÿåº¦:
- å–å†³äºæ‚¨çš„ç§»åŠ¨ç½‘ç»œé€Ÿåº¦
- é€šå¸¸å¯ä»¥è¾¾åˆ°5-20Mbps
- è¶³å¤Ÿæµç•…æŸ¥çœ‹æ–‡æ¡£å’Œç…§ç‰‡
```

---

## ğŸ”§ æ­¥éª¤6: é«˜çº§é…ç½®

### 6.1 è®¾ç½®å‡ºå£èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æƒ³é€šè¿‡å®¶åº­ç½‘ç»œä¸Šç½‘ï¼ˆä½¿ç”¨å®¶åº­IPï¼‰ï¼š

```bash
# åœ¨å®¿ä¸»æœºä¸Š
tailscale up --advertise-exit-node

# åœ¨Tailscaleæ§åˆ¶å°æ‰¹å‡†
# ç„¶ååœ¨æ‰‹æœºTailscale Appä¸­:
# Settings â†’ Use Exit Node â†’ é€‰æ‹© homeserver
```

ç°åœ¨æ‚¨çš„æ‰‹æœºæµé‡ä¼šé€šè¿‡å®¶åº­ç½‘ç»œå‡ºå»ã€‚

### 6.2 ç¦ç”¨å¯†é’¥è¿‡æœŸ

é»˜è®¤æƒ…å†µä¸‹ï¼ŒTailscale å¯†é’¥ä¼šåœ¨180å¤©åè¿‡æœŸã€‚

```bash
# åœ¨Tailscaleæ§åˆ¶å°:
# Machines â†’ homeserver â†’ ... â†’ Disable key expiry
```

### 6.3 é…ç½® MagicDNSï¼ˆæ¨èï¼‰

Tailscale å¯ä»¥ä¸ºæ¯å°è®¾å¤‡åˆ†é…åŸŸåã€‚

**åœ¨æ§åˆ¶å°å¯ç”¨**:
```
DNS â†’ MagicDNS â†’ Enable
```

**ç°åœ¨å¯ä»¥é€šè¿‡åŸŸåè®¿é—®**:
```
åŸæ¥: smb://192.168.71.210
ç°åœ¨: smb://homeserver.tail-xxxxx.ts.net

æˆ–è€…è®¾ç½®è®¾å¤‡å:
nas.tail-xxxxx.ts.net
```

---

## ğŸ”’ å®‰å…¨æ€§è¯´æ˜

### Tailscale çš„å®‰å…¨æ€§

1. **ç«¯åˆ°ç«¯åŠ å¯†**
   - ä½¿ç”¨ WireGuard åè®®
   - æ•°æ®ä¸ç»è¿‡ Tailscale æœåŠ¡å™¨
   - åªæœ‰åè°ƒä¿¡æ¯é€šè¿‡æœåŠ¡å™¨

2. **é›¶ä¿¡ä»»ç½‘ç»œ**
   - æ¯å°è®¾å¤‡ç‹¬ç«‹è®¤è¯
   - å¯ä»¥è®¾ç½® ACL è®¿é—®æ§åˆ¶

3. **å¯†é’¥ç®¡ç†**
   - è‡ªåŠ¨å¯†é’¥è½®æ¢
   - è®¾å¤‡åŠé”€æœºåˆ¶

### è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰

```bash
# åœ¨Tailscaleæ§åˆ¶å°
# Access Controls â†’ ç¼–è¾‘ACL

# ç¤ºä¾‹: ä»…å…è®¸æ‚¨çš„è®¾å¤‡è®¿é—®NAS
{
  "acls": [
    {
      "action": "accept",
      "src": ["autogroup:member"],
      "dst": ["100.x.x.x:*"]
    }
  ]
}
```

---

## ğŸŒ å®Œæ•´é…ç½®æµç¨‹æ€»ç»“

### ä¸€æ­¥æ­¥æ“ä½œæ¸…å•

**åœ¨å®¶æ“ä½œ**:
```bash
â˜‘ 1. æ³¨å†ŒTailscaleè´¦å· (5åˆ†é’Ÿ)
â˜‘ 2. å®¿ä¸»æœºå®‰è£…Tailscale (5åˆ†é’Ÿ)
   sudo dnf install tailscale
   tailscale up
   
â˜‘ 3. é…ç½®å­ç½‘è·¯ç”± (5åˆ†é’Ÿ)
   tailscale up --advertise-routes=192.168.71.0/24
   æ§åˆ¶å°æ‰¹å‡†è·¯ç”±
   
â˜‘ 4. éªŒè¯è¿æ¥
   tailscale status
```

**åœ¨æ‰‹æœºä¸Šæ“ä½œ**:
```bash
â˜‘ 5. å®‰è£…Tailscale App (2åˆ†é’Ÿ)
â˜‘ 6. ç™»å½•å¹¶è¿æ¥ (1åˆ†é’Ÿ)
â˜‘ 7. æµ‹è¯•è®¿é—®NAS (2åˆ†é’Ÿ)
   æ–‡ä»¶App â†’ smb://192.168.71.210
```

**æ€»æ—¶é—´**: çº¦20åˆ†é’Ÿ

---

## ğŸ“± å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: å¤–å‡ºæ—¶æŸ¥çœ‹å®¶åº­æ–‡æ¡£

```
æ­¥éª¤:
1. æ‰“å¼€æ‰‹æœºTailscale App
2. ç¡®ä¿å·²è¿æ¥ï¼ˆå›¾æ ‡å˜ç»¿ï¼‰
3. æ‰“å¼€æ–‡ä»¶App
4. è®¿é—® smb://192.168.71.210
5. âœ… æŸ¥çœ‹/ä¸‹è½½æ–‡æ¡£
```

### åœºæ™¯2: ä¸Šä¼ æ‰‹æœºç…§ç‰‡åˆ°NAS

```
æ­¥éª¤:
1. Tailscaleè¿æ¥
2. æ–‡ä»¶App â†’ é€‰æ‹©ç…§ç‰‡
3. åˆ†äº« â†’ ä¿å­˜åˆ°æ–‡ä»¶
4. é€‰æ‹©NASä¸Šçš„Photosæ–‡ä»¶å¤¹
5. âœ… è‡ªåŠ¨ä¸Šä¼ åˆ°å®¶åº­NAS
```

### åœºæ™¯3: åœ¨å’–å•¡å…è®¿é—®å®¶åº­ç½‘ç»œ

```
è¿æ¥åå¯ä»¥:
- è®¿é—®NASæ–‡ä»¶
- SSHåˆ°å®¿ä¸»æœº: ssh chris@192.168.71.200
- è®¿é—®Pythonå¼€å‘VM: ssh dev@192.168.71.201
- è®¿é—®æ‰€æœ‰å®¶åº­è®¾å¤‡
```

---

## ğŸ†š Tailscale vs FRP å¯¹æ¯”

### Tailscale æ–¹æ¡ˆ

**ä¼˜ç‚¹**:
- âœ… é…ç½®è¶…ç®€å•ï¼ˆ20åˆ†é’Ÿå®Œæˆï¼‰
- âœ… è‡ªåŠ¨NATç©¿é€
- âœ… ç«¯åˆ°ç«¯åŠ å¯†
- âœ… ä¸éœ€è¦å…¬ç½‘IP
- âœ… ä¸éœ€è¦é˜¿é‡Œäº‘ECS
- âœ… å®¢æˆ·ç«¯ä½“éªŒå¥½

**ç¼ºç‚¹**:
- âš ï¸ å…è´¹ç‰ˆé™åˆ¶100å°è®¾å¤‡ï¼ˆå¤Ÿç”¨ï¼‰
- âš ï¸ ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡
- âš ï¸ å›½å†…è®¿é—®åè°ƒæœåŠ¡å™¨å¯èƒ½å¶å°”æ…¢

### FRP æ–¹æ¡ˆ

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨è‡ªä¸»æ§åˆ¶
- âœ… æ— è®¾å¤‡é™åˆ¶
- âœ… å¯ä»¥æ˜ å°„WebæœåŠ¡

**ç¼ºç‚¹**:
- âŒ éœ€è¦é˜¿é‡Œäº‘ECSï¼ˆæˆæœ¬ï¼‰
- âŒ é…ç½®å¤æ‚
- âŒ éœ€è¦é…ç½®SSLè¯ä¹¦
- âŒ æµé‡ç»è¿‡ECSï¼ˆå¸¦å®½æˆæœ¬ï¼‰
- âŒ éœ€è¦ç»´æŠ¤frpæœåŠ¡

### æ¨èé€‰æ‹©

```
å®¶åº­NASæ–‡ä»¶è®¿é—® â†’ Tailscale â­â­â­â­â­
éœ€è¦å…¬å¼€WebæœåŠ¡ â†’ FRP
å®Œå…¨è‡ªä¸»æ§åˆ¶    â†’ åŸç”ŸWireGuard
```

**å¯¹äºæ‚¨çš„éœ€æ±‚ï¼ˆå¤–å‡ºæ—¶å¶å°”è®¿é—®æ–‡ä»¶ï¼‰**: **Tailscale æ˜¯æœ€ä½³é€‰æ‹©ï¼**

---

## ğŸ”§ è¯¦ç»†æ“ä½œæ­¥éª¤

### åœ¨å®¿ä¸»æœºä¸Šé…ç½®ï¼ˆRocky Linux 9ï¼‰

```bash
# ============================================
# æ­¥éª¤1: å®‰è£…Tailscale
# ============================================

ssh chris@192.168.71.200
sudo su -

# æ·»åŠ Tailscaleå®˜æ–¹ä»“åº“
curl -fsSL https://pkgs.tailscale.com/stable/rhel/9/tailscale.repo \
    | tee /etc/yum.repos.d/tailscale.repo

# å¦‚æœcurlä¸‹è½½æ…¢ï¼Œä½¿ç”¨å›½å†…é•œåƒï¼ˆå¦‚æœæœ‰ï¼‰
# æˆ–ä½¿ç”¨ä»£ç†

# å®‰è£…
dnf install -y tailscale

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable --now tailscaled

# éªŒè¯æœåŠ¡çŠ¶æ€
systemctl status tailscaled

# ============================================
# æ­¥éª¤2: è¿æ¥åˆ°Tailscaleç½‘ç»œ
# ============================================

# å¯åŠ¨Tailscaleå¹¶è·å–è®¤è¯é“¾æ¥
tailscale up

# è¾“å‡ºç¤ºä¾‹:
# To authenticate, visit:
# 
#     https://login.tailscale.com/a/abc123def456
#

# å¤åˆ¶é“¾æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
# ç™»å½•å¹¶æˆæƒè®¾å¤‡

# ç­‰å¾…å‡ ç§’åï¼Œæ£€æŸ¥çŠ¶æ€
tailscale status

# è¾“å‡ºç¤ºä¾‹:
# 100.101.102.103  homeserver  chris@gmail.com  linux   active; relay "xxx", tx 1234 rx 5678

# è®°å½•æ‚¨çš„Tailscale IP
TAILSCALE_IP=$(tailscale ip -4)
echo "å®¿ä¸»æœºTailscale IP: $TAILSCALE_IP"

# ============================================
# æ­¥éª¤3: å¯ç”¨å­ç½‘è·¯ç”±
# ============================================

# é…ç½®IPè½¬å‘ï¼ˆå¦‚æœè¿˜æ²¡é…ç½®ï¼‰
echo 'net.ipv4.ip_forward = 1' &gt;&gt; /etc/sysctl.conf
echo 'net.ipv6.conf.all.forwarding = 1' &gt;&gt; /etc/sysctl.conf
sysctl -p

# é‡æ–°å¯åŠ¨Tailscaleï¼Œå£°æ˜å­ç½‘è·¯ç”±
tailscale up \
    --advertise-routes=192.168.71.0/24 \
    --accept-routes

# å‚æ•°è¯¦è§£:
# --advertise-routes=192.168.71.0/24
#   å‘Šè¯‰Tailscale: æˆ‘å¯ä»¥è·¯ç”±åˆ°192.168.71.0/24ç½‘æ®µ
#   
# --accept-routes  
#   æ¥å—å…¶ä»–èŠ‚ç‚¹å£°æ˜çš„è·¯ç”±

# éªŒè¯
tailscale status
# åº”è¯¥çœ‹åˆ° "offering exit node" æˆ–ç±»ä¼¼ä¿¡æ¯
```

### åœ¨ Tailscale æ§åˆ¶å°æ‰¹å‡†è·¯ç”±

```
1. è®¿é—®: https://login.tailscale.com/admin/machines

2. æ‰¾åˆ° "homeserver" æˆ–æ‚¨çš„å®¿ä¸»æœºå

3. ç‚¹å‡»å³ä¾§çš„ "..." â†’ "Edit route settings..."

4. åœ¨ "Subnet routes" éƒ¨åˆ†:
   â˜‘ å‹¾é€‰ 192.168.71.0/24
   
5. ç‚¹å‡» "Save"

6. ç¡®è®¤çŠ¶æ€å˜ä¸º "approved"
```

### é…ç½®é˜²ç«å¢™å…è®¸è½¬å‘

```bash
# å…è®¸ä»Tailscaleæ¥å£è½¬å‘åˆ°br0
firewall-cmd --permanent --zone=trusted --add-interface=tailscale0
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload

# éªŒè¯
firewall-cmd --list-all
```

---

## ğŸ“± åœ¨æ‰‹æœºä¸Šé…ç½®

### iOS/iPadOS

```bash
# ============================================
# æ­¥éª¤1: å®‰è£…Tailscale
# ============================================

1. App Store æœç´¢ "Tailscale"
2. ä¸‹è½½å¹¶å®‰è£…ï¼ˆå…è´¹ï¼‰
3. æ‰“å¼€App
4. ç™»å½•æ‚¨çš„Tailscaleè´¦å·
5. ç‚¹å‡»è¿æ¥

# ============================================
# æ­¥éª¤2: è®¿é—®NAS
# ============================================

# æ–¹æ³•A: ç›´æ¥IPè®¿é—®
1. ç¡®ä¿Tailscaleå·²è¿æ¥ï¼ˆå›¾æ ‡æ˜¾ç¤ºç»¿è‰²ï¼‰
2. æ‰“å¼€"æ–‡ä»¶"App
3. å³ä¸Šè§’ "..." â†’ è¿æ¥æœåŠ¡å™¨
4. è¾“å…¥: smb://192.168.71.210
5. ç”¨æˆ·å: nasadmin
6. å¯†ç : &lt;æ‚¨çš„Sambaå¯†ç &gt;
7. âœ… è¿æ¥æˆåŠŸï¼

# æ–¹æ³•B: å¦‚æœå¯ç”¨äº†MagicDNS
è¾“å…¥: smb://nas

# ============================================
# æ­¥éª¤3: æ·»åŠ å¸¸ç”¨æœåŠ¡å™¨ï¼ˆæ¨èï¼‰
# ============================================

è¿æ¥æˆåŠŸå:
1. é•¿æŒ‰æœåŠ¡å™¨å›¾æ ‡
2. é€‰æ‹©"æ·»åŠ åˆ°ä¸ªäººæ”¶è—"
3. ä¸‹æ¬¡å¯ä»¥å¿«é€Ÿè®¿é—®
```

### Android

```bash
# ============================================
# æ­¥éª¤1: å®‰è£…Tailscale
# ============================================

1. Google Play / APKå®‰è£… Tailscale
2. ç™»å½•è¿æ¥

# ============================================
# æ­¥éª¤2: å®‰è£…æ–‡ä»¶ç®¡ç†å™¨
# ============================================

æ¨èApp:
- Solid Explorer (æ”¯æŒSMB)
- CX File Explorer
- FE File Explorer

# ============================================
# æ­¥éª¤3: è¿æ¥NAS
# ============================================

ä»¥Solid Explorerä¸ºä¾‹:
1. æ‰“å¼€App
2. å³ä¸Šè§’ "+" â†’ æ–°å»ºè¿æ¥
3. é€‰æ‹© "LAN / SMB"
4. æœåŠ¡å™¨: 192.168.71.210
5. ç”¨æˆ·å: nasadmin
6. å¯†ç : &lt;Sambaå¯†ç &gt;
7. âœ… ä¿å­˜å¹¶è¿æ¥
```

---

## ğŸ§ª éªŒè¯å’Œæµ‹è¯•

### å®Œæ•´æµ‹è¯•æ¸…å•

```bash
# ============================================
# æµ‹è¯•1: Tailscaleè¿æ¥çŠ¶æ€
# ============================================

åœ¨å®¿ä¸»æœº:
$ tailscale status

åº”è¯¥æ˜¾ç¤º:
- å®¿ä¸»æœº: 100.x.x.x (active)
- æ‰‹æœº: 100.y.y.y (active)

# ============================================
# æµ‹è¯•2: æ‰‹æœºpingå®¶åº­ç½‘ç»œ
# ============================================

åœ¨æ‰‹æœºTailscale Appä¸­:
Settings â†’ Run Diagnostics â†’ Ping

ç›®æ ‡: 192.168.71.210
åº”è¯¥: æˆåŠŸï¼Œå»¶è¿Ÿ20-100ms

# ============================================
# æµ‹è¯•3: è®¿é—®NASå…±äº«
# ============================================

åœ¨æ‰‹æœºæ–‡ä»¶App:
è¿æ¥ smb://192.168.71.210
èƒ½å¤Ÿ:
- æµè§ˆæ–‡ä»¶å¤¹ âœ…
- ä¸‹è½½æ–‡ä»¶ âœ…
- ä¸Šä¼ æ–‡ä»¶ âœ…
- æ’­æ”¾è§†é¢‘ âœ…

# ============================================
# æµ‹è¯•4: è®¿é—®å…¶ä»–è®¾å¤‡ï¼ˆå¦‚æœé…ç½®äº†å­ç½‘è·¯ç”±ï¼‰
# ============================================

åœ¨æ‰‹æœºæµè§ˆå™¨:
- http://192.168.71.200:9090 (Cockpit)
- http://192.168.71.254 (æ—è·¯ç”±)

åº”è¯¥éƒ½èƒ½è®¿é—®
```

---

## ğŸ“Š æ€§èƒ½å’Œæµé‡

### æ€§èƒ½é¢„æœŸ

```
åœºæ™¯: 4G/5Gç½‘ç»œ â†’ Tailscale â†’ å®¶åº­NAS

ä¸‹è½½é€Ÿåº¦:
- æ–‡æ¡£/ç…§ç‰‡: 5-20Mbps (å¤Ÿç”¨)
- è§†é¢‘æµåª’ä½“: 720pæµç•…ï¼Œ1080på¯èƒ½å¡é¡¿
- å¤§æ–‡ä»¶ä¸‹è½½: å–å†³äºç§»åŠ¨ç½‘ç»œä¸Šè¡Œ

ä¸Šä¼ é€Ÿåº¦:
- ç…§ç‰‡ä¸Šä¼ : 3-10Mbps
- è§†é¢‘ä¸Šä¼ : å»ºè®®å›å®¶åå†ä¼ 

å»¶è¿Ÿ:
- pingå»¶è¿Ÿ: 20-100msï¼ˆå–å†³äºç½‘ç»œï¼‰
- è¶³å¤Ÿæµç•…çš„æ–‡ä»¶æ“ä½œ
```

### æµé‡æ¶ˆè€—

```
Tailscaleæœ¬èº«:
- è¿æ¥ä¿æŒ: å‡ ä¹æ— æµé‡ï¼ˆ&lt;1MB/å°æ—¶ï¼‰
- åè°ƒé€šä¿¡: æå°‘ï¼ˆ&lt;1KBï¼‰

å®é™…ä½¿ç”¨:
- ä¸‹è½½1MBæ–‡ä»¶ â†’ æ¶ˆè€—çº¦1MBæµé‡
- æµè§ˆæ–‡ä»¶å¤¹ â†’ å‡ KB
- æ’­æ”¾è§†é¢‘ â†’ ç­‰åŒäºè§†é¢‘å¤§å°

å»ºè®®:
- æŸ¥çœ‹æ–‡æ¡£ã€ç…§ç‰‡: æ— å‹åŠ›
- ä¸‹è½½å¤§æ–‡ä»¶: æ³¨æ„æµé‡
- æµåª’ä½“: è¿WiFiåè§‚çœ‹
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ— æ³•è¿æ¥åˆ°Tailscale

**ç—‡çŠ¶**: tailscale up ä¸€ç›´å¡ä½

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘ç»œ
ping 8.8.8.8

# æ£€æŸ¥DNS
nslookup login.tailscale.com

# å¦‚æœDNSè§£æå¤±è´¥ï¼Œæ·»åŠ hosts
echo "104.18.25.156 login.tailscale.com" &gt;&gt; /etc/hosts

# é‡è¯•
tailscale up
```

### é—®é¢˜2: æ‰‹æœºæ— æ³•è®¿é—®192.168.71.x

**ç—‡çŠ¶**: Tailscaleå·²è¿æ¥ï¼Œä½†è®¿é—®192.168.71.210è¶…æ—¶

**æ£€æŸ¥æ¸…å•**:
```bash
# 1. ç¡®è®¤å­ç½‘è·¯ç”±å·²æ‰¹å‡†
tailscale status | grep "192.168.71.0/24"

# 2. æ£€æŸ¥IPè½¬å‘
cat /proc/sys/net/ipv4/ip_forward
# åº”è¯¥æ˜¯1

# 3. æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --list-all --zone=trusted
# åº”è¯¥åŒ…å«tailscale0

# 4. æµ‹è¯•ä»å®¿ä¸»æœºè®¿é—®NAS
ping 192.168.71.210

# 5. åœ¨Tailscaleæ§åˆ¶å°æ£€æŸ¥
https://login.tailscale.com/admin/machines
ç¡®è®¤è·¯ç”±çŠ¶æ€ä¸º "approved"
```

### é—®é¢˜3: è¿æ¥é€Ÿåº¦å¾ˆæ…¢

**ç—‡çŠ¶**: æ–‡ä»¶ä¼ è¾“é€Ÿåº¦åªæœ‰å‡ ç™¾KB/s

**å¯èƒ½åŸå› **:
```bash
1. æœªå»ºç«‹ç›´è¿ï¼Œæµé‡é€šè¿‡DERPä¸­ç»§
   
   æŸ¥çœ‹:
   tailscale status
   
   å¦‚æœæ˜¾ç¤º "relay xxx"ï¼Œè¯´æ˜åœ¨ç”¨ä¸­ç»§
   
   è§£å†³:
   - ç­‰å¾…å‡ åˆ†é’Ÿï¼ŒTailscaleä¼šå°è¯•æ‰“æ´å»ºç«‹ç›´è¿
   - æ£€æŸ¥å®¶åº­è·¯ç”±å™¨æ˜¯å¦å¼€å¯UPnP
   - å¦‚æœé•¿æœŸrelayï¼Œå¯ä»¥å¿å—æˆ–è€ƒè™‘å…¶ä»–æ–¹æ¡ˆ

2. ç§»åŠ¨ç½‘ç»œä¿¡å·å·®
   
   åˆ‡æ¢åˆ°WiFiæˆ–æ›´å¥½çš„ç½‘ç»œç¯å¢ƒ

3. å®¶åº­ç½‘ç»œä¸Šè¡Œå¸¦å®½é™åˆ¶
   
   ç”µä¿¡äº‘å®½å¸¦ä¸Šè¡Œé€šå¸¸10-30Mbps
   è¿™æ˜¯ç‰©ç†é™åˆ¶
```

---

## ğŸ’¡ ä½¿ç”¨æŠ€å·§

### æŠ€å·§1: æŒ‰éœ€è¿æ¥

```
å¹³æ—¶: å…³é—­Tailscaleï¼ˆçœç”µï¼‰
éœ€è¦æ—¶: æ‰“å¼€Tailscale â†’ è®¿é—®NAS â†’ å®Œæˆåå…³é—­
```

### æŠ€å·§2: æ”¶è—å¸¸ç”¨ä½ç½®

```
iOSæ–‡ä»¶App:
è¿æ¥å â†’ é•¿æŒ‰æ–‡ä»¶å¤¹ â†’ æ·»åŠ åˆ°ä¸ªäººæ”¶è—
ä¸‹æ¬¡å¿«é€Ÿè®¿é—®
```

### æŠ€å·§3: ç¦»çº¿ä¸‹è½½

```
åœ¨å®¶:
1. æå‰ä¸‹è½½éœ€è¦çš„æ–‡ä»¶åˆ°æ‰‹æœº
2. å¤–å‡ºæ—¶ç¦»çº¿æŸ¥çœ‹

å¤–å‡º:
1. ä»…è®¿é—®å¿…è¦çš„æ–‡ä»¶ï¼ˆèŠ‚çœæµé‡ï¼‰
```

### æŠ€å·§4: ç»„åˆä½¿ç”¨

```
æ—¥å¸¸è®¿é—®: ç›´æ¥åœ¨å®¶é€šè¿‡å±€åŸŸç½‘è®¿é—®ï¼ˆå¿«ï¼‰
å¤–å‡ºè®¿é—®: é€šè¿‡Tailscaleè®¿é—®ï¼ˆæ–¹ä¾¿ï¼‰

æ— éœ€ä¸¤å¥—é…ç½®ï¼ŒåŒä¸€ä¸ªIPåœ°å€:
å®¶åº­: 192.168.71.210 (å±€åŸŸç½‘ç›´è¿)
å¤–å‡º: 192.168.71.210 (Tailscaleè·¯ç”±)
```

---

## ğŸ“ é…ç½®è„šæœ¬ï¼ˆä¸€é”®éƒ¨ç½²ï¼‰

### è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬

```bash
# åœ¨å®¿ä¸»æœºä¸Šåˆ›å»º
sudo cat &gt; /root/setup-tailscale.sh &lt;&lt;'EOF'
#!/bin/bash
# ============================================
# Tailscaleä¸€é”®é…ç½®è„šæœ¬
# ============================================

set -e

echo "========================================="
echo "     Tailscaleé…ç½®è„šæœ¬"
echo "========================================="

# 1. å®‰è£…Tailscale
echo "1/5 å®‰è£…Tailscale..."
if ! command -v tailscale &amp;&gt; /dev/null; then
    curl -fsSL https://pkgs.tailscale.com/stable/rhel/9/tailscale.repo \
        | tee /etc/yum.repos.d/tailscale.repo
    dnf install -y tailscale
    systemctl enable --now tailscaled
    echo "  âœ“ Tailscaleå·²å®‰è£…"
else
    echo "  â„¹ Tailscaleå·²å®‰è£…ï¼Œè·³è¿‡"
fi

# 2. å¯ç”¨IPè½¬å‘
echo "2/5 é…ç½®IPè½¬å‘..."
if ! grep -q "net.ipv4.ip_forward = 1" /etc/sysctl.conf; then
    echo 'net.ipv4.ip_forward = 1' &gt;&gt; /etc/sysctl.conf
    echo 'net.ipv6.conf.all.forwarding = 1' &gt;&gt; /etc/sysctl.conf
    sysctl -p
    echo "  âœ“ IPè½¬å‘å·²å¯ç”¨"
else
    echo "  â„¹ IPè½¬å‘å·²å¯ç”¨ï¼Œè·³è¿‡"
fi

# 3. é…ç½®é˜²ç«å¢™
echo "3/5 é…ç½®é˜²ç«å¢™..."
firewall-cmd --permanent --zone=trusted --add-interface=tailscale0 2&gt;/dev/null || true
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload
echo "  âœ“ é˜²ç«å¢™å·²é…ç½®"

# 4. å¯åŠ¨Tailscale
echo "4/5 è¿æ¥åˆ°Tailscaleç½‘ç»œ..."
echo ""
echo "è¯·è®¿é—®ä¸‹é¢çš„é“¾æ¥è¿›è¡Œè®¤è¯:"
tailscale up \
    --advertise-routes=192.168.71.0/24 \
    --accept-routes \
    --hostname=homeserver

# 5. æ˜¾ç¤ºåç»­æ­¥éª¤
echo ""
echo "========================================="
echo "é…ç½®å®Œæˆï¼"
echo "========================================="
echo ""
echo "ä¸‹ä¸€æ­¥:"
echo "1. åœ¨æµè§ˆå™¨ä¸­å®Œæˆä¸Šé¢çš„è®¤è¯"
echo "2. è®¿é—® https://login.tailscale.com/admin/machines"
echo "3. æ‰¾åˆ° 'homeserver' â†’ ... â†’ Edit route settings"
echo "4. å¯ç”¨ 192.168.71.0/24 å­ç½‘è·¯ç”±"
echo "5. åœ¨æ‰‹æœºä¸Šå®‰è£…Tailscale Appå¹¶ç™»å½•"
echo ""
echo "æµ‹è¯•å‘½ä»¤:"
echo "  tailscale status"
echo "  tailscale ip -4"
echo ""
echo "========================================="
EOF

chmod +x /root/setup-tailscale.sh
```

### è¿è¡Œé…ç½®è„šæœ¬

```bash
# ä¸€é”®é…ç½®
sudo /root/setup-tailscale.sh
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

é…ç½®å®Œæˆåï¼Œæ‚¨åº”è¯¥ï¼š

- [x] å®¿ä¸»æœºå·²å®‰è£…Tailscale
- [x] å®¿ä¸»æœºå·²è¿æ¥åˆ°Tailscaleç½‘ç»œ
- [x] å­ç½‘è·¯ç”±å·²å£°æ˜å¹¶æ‰¹å‡†
- [x] æ‰‹æœºå·²å®‰è£…Tailscale App
- [x] æ‰‹æœºå¯ä»¥é€šè¿‡Tailscaleè®¿é—®å®¶åº­ç½‘ç»œ
- [x] å¯ä»¥åœ¨å¤–ç½‘è®¿é—®NAS (smb://192.168.71.210)
- [x] å¯ä»¥SSHåˆ°å®¿ä¸»æœºå’Œè™šæ‹Ÿæœº

---

## ğŸ¯ æ—¥å¸¸ä½¿ç”¨æµç¨‹

### å¤–å‡ºæ—¶è®¿é—®NAS

```
1. æ‰“å¼€æ‰‹æœºTailscale App (1ç§’)
2. ç¡®ä¿è¿æ¥çŠ¶æ€ï¼ˆè‡ªåŠ¨è¿æ¥ï¼‰
3. æ‰“å¼€æ–‡ä»¶App
4. è®¿é—®NAS: smb://192.168.71.210
5. æµè§ˆ/ä¸‹è½½æ–‡ä»¶
6. å®Œæˆåå¯ä»¥å…³é—­Tailscaleï¼ˆçœç”µï¼‰
```

### å›å®¶å

```
è‡ªåŠ¨:
- Tailscaleæ£€æµ‹åˆ°åœ¨å®¶åº­WiFi
- è‡ªåŠ¨ä½¿ç”¨å±€åŸŸç½‘ç›´è¿ï¼ˆæ›´å¿«ï¼‰
- æ— éœ€åˆ‡æ¢é…ç½®

æˆ–è€…:
- å…³é—­Tailscale
- ä½¿ç”¨å±€åŸŸç½‘è®¿é—®ï¼ˆæ›´å¿«ï¼‰
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. è®¾å¤‡ç®¡ç†

å®šæœŸæ£€æŸ¥è¿æ¥çš„è®¾å¤‡ï¼š
```
https://login.tailscale.com/admin/machines

å¦‚æœçœ‹åˆ°é™Œç”Ÿè®¾å¤‡:
- ç‚¹å‡»è®¾å¤‡ â†’ ... â†’ Remove
```

### 2. å¯ç”¨äºŒæ­¥éªŒè¯

```
https://login.tailscale.com/admin/settings/account

å¯ç”¨2FAä¿æŠ¤è´¦å·å®‰å…¨
```

### 3. ACLè®¿é—®æ§åˆ¶ï¼ˆå¯é€‰ï¼‰

```
ä»…å…è®¸æ‚¨çš„è®¾å¤‡è®¿é—®å®¶åº­ç½‘ç»œ:

https://login.tailscale.com/admin/acls

{
  "acls": [
    {
      "action": "accept",
      "src": ["chris@gmail.com"],
      "dst": ["tag:homelab:*"]
    }
  ],
  "tagOwners": {
    "tag:homelab": ["chris@gmail.com"]
  }
}
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

### ä¸‰ç§å¤–ç½‘è®¿é—®æ–¹æ¡ˆ

| æ–¹æ¡ˆ | é…ç½®æ—¶é—´ | æˆæœ¬ | éš¾åº¦ | é€Ÿåº¦ | æ¨èåº¦ |
|------|---------|------|------|------|--------|
| **Tailscale** | 20åˆ†é’Ÿ | å…è´¹ | â­â˜†â˜†â˜†â˜† | â­â­â­â­â˜† | â­â­â­â­â­ |
| FRP | 60åˆ†é’Ÿ | éœ€ECS | â­â­â­â˜†â˜† | â­â­â­â˜†â˜† | â­â­â­â˜†â˜† |
| åŸç”ŸWireGuard | 90åˆ†é’Ÿ | éœ€å…¬ç½‘IP | â­â­â­â­â˜† | â­â­â­â­â­ | â­â­â˜†â˜†â˜† |

### é€‚ç”¨åœºæ™¯

**é€‰æ‹©Tailscale**:
- âœ… æ²¡æœ‰å…¬ç½‘IP
- âœ… ä¸æƒ³èŠ±é’±ä¹°ECS
- âœ… å¶å°”å¤–å‡ºè®¿é—®
- âœ… éœ€è¦å¤šè®¾å¤‡è®¿é—®
- âœ… æƒ³è¦ç®€å•é…ç½®

**é€‰æ‹©FRP**:
- âœ… å·²æœ‰é˜¿é‡Œäº‘ECS
- âœ… éœ€è¦å…¬å¼€WebæœåŠ¡
- âœ… ä¸ä»‹æ„é…ç½®å¤æ‚åº¦

**é€‰æ‹©åŸç”ŸWireGuard**:
- âœ… æœ‰å…¬ç½‘IP
- âœ… è¿½æ±‚æè‡´æ€§èƒ½
- âœ… å®Œå…¨è‡ªä¸»æ§åˆ¶

---

## ğŸ‰ å®Œæˆ

**æ­å–œï¼æ‚¨ç°åœ¨å¯ä»¥ï¼š**

- âœ… åœ¨ä¸–ç•Œä»»ä½•åœ°æ–¹è®¿é—®å®¶åº­NAS
- âœ… æ— éœ€å…¬ç½‘IP
- âœ… æ— éœ€è´­ä¹°äº‘æœåŠ¡å™¨
- âœ… é…ç½®ç®€å•ï¼Œ20åˆ†é’Ÿå®Œæˆ
- âœ… å®‰å…¨çš„ç«¯åˆ°ç«¯åŠ å¯†

**å®é™…ä½“éªŒ**:
```
åœ¨å’–å•¡å… â†’ æ‰“å¼€æ‰‹æœº â†’ Tailscaleè¿æ¥ â†’ è®¿é—®NAS
åœ¨å…¬å¸ â†’ éœ€è¦æŸä¸ªæ–‡æ¡£ â†’ ä»å®¶åº­NASä¸‹è½½
æ—…è¡Œä¸­ â†’ ä¸Šä¼ ç…§ç‰‡åˆ°å®¶åº­NAS â†’ èŠ‚çœæ‰‹æœºç©ºé—´
```

**ä¸‹ä¸€æ­¥**: åœ¨ `11-vm-nas.md` ä¸­å·²ç»é…ç½®å¥½äº†Sambaï¼Œç°åœ¨åªéœ€è¦é…ç½®Tailscaleå³å¯å®ç°å¤–ç½‘è®¿é—®ï¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[11-vm-nas.md](#section-11)** - NASåŸºç¡€é…ç½®
- **[å¸¸è§ç–‘é—®FAQ.md](å¸¸è§ç–‘é—®FAQ.md)** - æ›´å¤šé—®é¢˜è§£ç­”




---



# 12 - å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

è¯¦ç»†çš„å¤‡ä»½å’Œæ¢å¤æ–¹æ¡ˆï¼ŒåŒ…æ‹¬åŸç†ã€ä»£ç è¯¦è§£ã€ç¡¬ç›˜ç©ºé—´é¢„ä¼°ã€‚

**é¢„è®¡è€—æ—¶**: 40åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†

---

## ğŸ¯ å¤‡ä»½ç­–ç•¥æ¦‚è¿°

### ä¸‰å±‚å¤‡ä»½æ–¹æ¡ˆï¼ˆ3-2-1åŸåˆ™ï¼‰

```
3 ä»½æ•°æ®å‰¯æœ¬
2 ç§ä¸åŒå­˜å‚¨ä»‹è´¨
1 ä»½å¼‚åœ°å¤‡ä»½

æˆ‘ä»¬çš„å®ç°:
â”œâ”€ å±‚æ¬¡1: è™šæ‹Ÿæœºé…ç½®å¤‡ä»½ï¼ˆæ¯å‘¨ï¼‰ï½ 100MB
â”œâ”€ å±‚æ¬¡2: é‡è¦æ•°æ®å¤‡ä»½ï¼ˆæ¯å¤©ï¼‰  ï½ 10-50GB
â””â”€ å±‚æ¬¡3: å®Œæ•´ç³»ç»Ÿå¤‡ä»½ï¼ˆæ¯æœˆï¼‰  ï½ 100-500GB
```

### ç¡¬ç›˜ç©ºé—´éœ€æ±‚é¢„ä¼°

| å¤‡ä»½ç±»å‹ | å•æ¬¡å¤§å° | ä¿ç•™æœŸ | æ€»éœ€æ±‚ | ä½ç½® |
|---------|---------|--------|--------|------|
| VMé…ç½® | ~100MB | 30å¤© | ~3GB | /backup/vm-configs |
| NASæ•°æ®ï¼ˆå¢é‡ï¼‰ | ~10GB | 7å¤© | ~70GB | /backup/nas-data |
| VMå¿«ç…§ | æ¯VM 5-20GB | 3ä¸ª | ~100GB | LVM thin pool |
| å®Œæ•´å¤‡ä»½ï¼ˆå¯é€‰ï¼‰ | ~200GB | 1ä¸ª | ~200GB | å¤–éƒ¨ç¡¬ç›˜ |

**æ¨èå¤‡ä»½å­˜å‚¨**: 500GB ç‹¬ç«‹ç¡¬ç›˜æˆ–åˆ†åŒº

---

## ğŸ“¦ å±‚æ¬¡1: è™šæ‹Ÿæœºé…ç½®å¤‡ä»½

### 1.1 å¤‡ä»½å†…å®¹

**åŒ…å«**:
- âœ… è™šæ‹ŸæœºXMLå®šä¹‰ï¼ˆæè¿°VMçš„é…ç½®ï¼‰
- âœ… å­˜å‚¨æ± é…ç½®
- âœ… ç½‘ç»œé…ç½®
- âœ… LVMå…ƒæ•°æ®

**ä¸åŒ…å«**:
- âŒ è™šæ‹Ÿæœºç£ç›˜å†…å®¹ï¼ˆæ•°æ®å¤ªå¤§ï¼‰
- âŒ ISOé•œåƒæ–‡ä»¶

### 1.2 è¯¦ç»†è„šæœ¬è§£æ

```bash
sudo cat &gt; /usr/local/bin/backup-vm-configs &lt;&lt;'EOF'
#!/bin/bash
# ============================================
# è™šæ‹Ÿæœºé…ç½®å¤‡ä»½è„šæœ¬
# åŠŸèƒ½: å¤‡ä»½æ‰€æœ‰VMé…ç½®ã€å­˜å‚¨æ± ã€ç½‘ç»œå’ŒLVMé…ç½®
# æ‰§è¡Œæ—¶é—´: çº¦5-10ç§’
# ç¡¬ç›˜å ç”¨: å•æ¬¡çº¦50-100MBï¼Œä¿ç•™30å¤©çº¦3GB
# ============================================

BACKUP_DIR="/backup/vm-configs"
DATE=$(date +%Y%m%d)
BACKUP_PATH="$BACKUP_DIR/$DATE"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_PATH

echo "========================================="
echo "å¼€å§‹å¤‡ä»½è™šæ‹Ÿæœºé…ç½®: $(date)"
echo "========================================="

# ============================================
# 1. å¤‡ä»½è™šæ‹ŸæœºXMLå®šä¹‰
# ============================================
echo "1/4 å¤‡ä»½è™šæ‹Ÿæœºå®šä¹‰..."
VM_COUNT=0
for vm in $(virsh list --all --name); do
    if [ -n "$vm" ]; then
        # virsh dumpxml: å¯¼å‡ºVMçš„å®Œæ•´XMLé…ç½®
        # åŒ…å«: CPUã€å†…å­˜ã€ç£ç›˜è·¯å¾„ã€ç½‘ç»œé…ç½®ã€è®¾å¤‡ç­‰
        virsh dumpxml $vm &gt; $BACKUP_PATH/${vm}.xml
        
        # åŸç†: libvirtå°†VMé…ç½®å­˜å‚¨åœ¨XMLæ–‡ä»¶ä¸­
        # æ¢å¤æ—¶å¯ä»¥ç”¨ virsh define xxx.xml é‡å»ºVM
        VM_COUNT=$((VM_COUNT + 1))
        echo "  âœ“ $vm"
    fi
done
echo "  å·²å¤‡ä»½ $VM_COUNT ä¸ªè™šæ‹Ÿæœºå®šä¹‰"

# ============================================
# 2. å¤‡ä»½å­˜å‚¨æ± é…ç½®
# ============================================
echo "2/4 å¤‡ä»½å­˜å‚¨æ± é…ç½®..."
POOL_COUNT=0
for pool in $(virsh pool-list --all --name); do
    if [ -n "$pool" ]; then
        # virsh pool-dumpxml: å¯¼å‡ºå­˜å‚¨æ± é…ç½®
        # åŒ…å«: å­˜å‚¨æ± ç±»å‹ã€è·¯å¾„ã€å®¹é‡ç­‰
        virsh pool-dumpxml $pool &gt; $BACKUP_PATH/pool-${pool}.xml
        
        # åŸç†: å­˜å‚¨æ± å®šä¹‰äº†è™šæ‹Ÿç£ç›˜çš„å­˜å‚¨ä½ç½®
        # å¦‚: /dev/vg_kvm (LVMæ± ) æˆ– /kvm/iso (ç›®å½•æ± )
        POOL_COUNT=$((POOL_COUNT + 1))
        echo "  âœ“ $pool"
    fi
done
echo "  å·²å¤‡ä»½ $POOL_COUNT ä¸ªå­˜å‚¨æ± "

# ============================================
# 3. å¤‡ä»½ç½‘ç»œé…ç½®
# ============================================
echo "3/4 å¤‡ä»½ç½‘ç»œé…ç½®..."
NET_COUNT=0
for net in $(virsh net-list --all --name); do
    if [ -n "$net" ]; then
        # virsh net-dumpxml: å¯¼å‡ºç½‘ç»œé…ç½®
        # åŒ…å«: ç½‘æ¡¥åç§°ã€IPèŒƒå›´ã€DHCPé…ç½®ç­‰
        virsh net-dumpxml $net &gt; $BACKUP_PATH/net-${net}.xml
        
        # åŸç†: å®šä¹‰äº†VMçš„ç½‘ç»œè¿æ¥æ–¹å¼
        # å¦‚: br0 (æ¡¥æ¥) æˆ– default (NAT)
        NET_COUNT=$((NET_COUNT + 1))
        echo "  âœ“ $net"
    fi
done
echo "  å·²å¤‡ä»½ $NET_COUNT ä¸ªç½‘ç»œ"

# ============================================
# 4. å¤‡ä»½LVMé…ç½®
# ============================================
echo "4/4 å¤‡ä»½LVMé…ç½®..."
if vgs vg_kvm &amp;&gt;/dev/null; then
    # vgcfgbackup: å¤‡ä»½LVMå·ç»„çš„å…ƒæ•°æ®
    # åŒ…å«: PVã€VGã€LVçš„é…ç½®ä¿¡æ¯
    # ä½œç”¨: ç¾éš¾æ¢å¤æ—¶å¯ä»¥é‡å»ºLVMç»“æ„
    vgcfgbackup -f $BACKUP_PATH/vg_kvm.cfg vg_kvm
    
    # åŒæ—¶ä¿å­˜å¯è¯»çš„LVMä¿¡æ¯
    pvs &gt; $BACKUP_PATH/lvm-pvs.txt
    vgs &gt; $BACKUP_PATH/lvm-vgs.txt
    lvs &gt; $BACKUP_PATH/lvm-lvs.txt
    
    echo "  âœ“ LVMé…ç½®å·²å¤‡ä»½"
else
    echo "  âš  æœªæ‰¾åˆ°vg_kvmå·ç»„"
fi

# ============================================
# 5. å‹ç¼©å¤‡ä»½æ–‡ä»¶
# ============================================
echo "å‹ç¼©å¤‡ä»½æ–‡ä»¶..."
cd $BACKUP_DIR
tar -czf vm-configs-${DATE}.tar.gz $DATE

# tarå‚æ•°è¯´æ˜:
# -c: åˆ›å»ºæ–°å½’æ¡£
# -z: ä½¿ç”¨gzipå‹ç¼©ï¼ˆå‹ç¼©æ¯”çº¦10:1ï¼‰
# -f: æŒ‡å®šè¾“å‡ºæ–‡ä»¶å

BACKUP_SIZE=$(du -sh vm-configs-${DATE}.tar.gz | cut -f1)
echo "  âœ“ å‹ç¼©å®Œæˆ: vm-configs-${DATE}.tar.gz ($BACKUP_SIZE)"

# åˆ é™¤ä¸´æ—¶ç›®å½•
rm -rf $BACKUP_PATH

# ============================================
# 6. æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
# ============================================
echo "æ¸…ç†æ—§å¤‡ä»½..."
OLD_COUNT=$(find $BACKUP_DIR -name "vm-configs-*.tar.gz" -mtime +30 | wc -l)
find $BACKUP_DIR -name "vm-configs-*.tar.gz" -mtime +30 -delete

# findå‚æ•°è¯´æ˜:
# -name "vm-configs-*.tar.gz": æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶
# -mtime +30: ä¿®æ”¹æ—¶é—´è¶…è¿‡30å¤©
# -delete: åˆ é™¤æ‰¾åˆ°çš„æ–‡ä»¶

if [ $OLD_COUNT -gt 0 ]; then
    echo "  âœ“ å·²åˆ é™¤ $OLD_COUNT ä¸ªæ—§å¤‡ä»½"
else
    echo "  â„¹ æ— æ—§å¤‡ä»½éœ€è¦æ¸…ç†"
fi

# ============================================
# 7. æ±‡æ€»ä¿¡æ¯
# ============================================
echo "========================================="
echo "å¤‡ä»½å®Œæˆ: $(date)"
echo "ä½ç½®: $BACKUP_DIR/vm-configs-${DATE}.tar.gz"
echo "å¤§å°: $BACKUP_SIZE"
echo "å†…å®¹: $VM_COUNTä¸ªVM, $POOL_COUNTä¸ªå­˜å‚¨æ± , $NET_COUNTä¸ªç½‘ç»œ"
echo "========================================="
EOF

sudo chmod +x /usr/local/bin/backup-vm-configs
```

### 1.3 ä½¿ç”¨æ–¹æ³•

```bash
# æ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½
sudo /usr/local/bin/backup-vm-configs

# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ls -lh /backup/vm-configs/

# æŸ¥çœ‹å¤‡ä»½å†…å®¹ï¼ˆä¸è§£å‹ï¼‰
tar -tzf /backup/vm-configs/vm-configs-20260224.tar.gz
```

### 1.4 ç¡¬ç›˜ç©ºé—´é¢„ä¼°

```
å•æ¬¡å¤‡ä»½:
â”œâ”€ VMå®šä¹‰ (4ä¸ªVM Ã— 10KB)     ï½ 40KB
â”œâ”€ å­˜å‚¨æ± é…ç½® (2ä¸ª Ã— 5KB)    ï½ 10KB
â”œâ”€ ç½‘ç»œé…ç½® (2ä¸ª Ã— 3KB)      ï½ 6KB
â”œâ”€ LVMé…ç½®                    ï½ 50KB
â””â”€ å‹ç¼©åæ€»è®¡                 ï½ 50-100MB

30å¤©å¤‡ä»½:
â””â”€ 100MB Ã— 30å¤©              ï½ 3GB
```

### 1.5 æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦**:
- æ­¤å¤‡ä»½**ä¸åŒ…å«è™šæ‹Ÿæœºç£ç›˜æ•°æ®**
- ä»…å¤‡ä»½VMçš„"é…ç½®è“å›¾"
- æ¢å¤åéœ€è¦VMç£ç›˜æ–‡ä»¶ä»ç„¶å­˜åœ¨
- é€‚åˆå¿«é€Ÿé‡å»ºVMé…ç½®

âœ… **ä¼˜ç‚¹**:
- å¤‡ä»½é€Ÿåº¦å¿«ï¼ˆ5-10ç§’ï¼‰
- å ç”¨ç©ºé—´å°ï¼ˆ100MBä»¥å†…ï¼‰
- å¯ä»¥å¿«é€Ÿæ¢å¤VMç»“æ„

---

## ğŸ’¾ å±‚æ¬¡2: NASæ•°æ®å¢é‡å¤‡ä»½

### 2.1 å¢é‡å¤‡ä»½åŸç†

**ä¼ ç»Ÿå®Œæ•´å¤‡ä»½**:
```
ç¬¬1å¤©: å¤åˆ¶å…¨éƒ¨100GB â†’ å¤‡ä»½100GB
ç¬¬2å¤©: å¤åˆ¶å…¨éƒ¨100GB â†’ å¤‡ä»½100GB
ç¬¬3å¤©: å¤åˆ¶å…¨éƒ¨100GB â†’ å¤‡ä»½100GB
...
7å¤©å ç”¨: 700GB âŒ
```

**rsyncå¢é‡å¤‡ä»½**:
```
ç¬¬1å¤©: å¤åˆ¶å…¨éƒ¨100GB â†’ å¤‡ä»½100GB
ç¬¬2å¤©: ä»…å¤åˆ¶å˜åŒ–çš„1GB â†’ å¤‡ä»½1GBï¼ˆé€šè¿‡ç¡¬é“¾æ¥å…±äº«ä¸å˜çš„99GBï¼‰
ç¬¬3å¤©: ä»…å¤åˆ¶å˜åŒ–çš„2GB â†’ å¤‡ä»½2GB
...
7å¤©å ç”¨: ~110GB âœ…ï¼ˆèŠ‚çœ84%ï¼‰
```

**ç¡¬é“¾æ¥åŸç†**:
```
åŸå§‹æ–‡ä»¶: /data/nas/photo.jpg (10MB)
å¤‡ä»½1:    /backup/20260224/photo.jpg â†’ æŒ‡å‘åŒä¸€inode
å¤‡ä»½2:    /backup/20260225/photo.jpg â†’ æŒ‡å‘åŒä¸€inode

ç£ç›˜å ç”¨: ä»…10MBï¼ˆè€Œä¸æ˜¯30MBï¼‰
```

### 2.2 è¯¦ç»†è„šæœ¬è§£æ

```bash
sudo cat &gt; /usr/local/bin/backup-nas-data &lt;&lt;'EOF'
#!/bin/bash
# ============================================
# NASæ•°æ®å¢é‡å¤‡ä»½è„šæœ¬
# åŸç†: rsyncå¢é‡åŒæ­¥ + ç¡¬é“¾æ¥å¿«ç…§
# æ‰§è¡Œæ—¶é—´: é¦–æ¬¡30-60åˆ†é’Ÿï¼Œåç»­5-10åˆ†é’Ÿ
# ç¡¬ç›˜å ç”¨: é¦–æ¬¡å…¨é‡+æ¯å¤©å¢é‡ï¼ˆè¯¦è§ä¸‹æ–¹è®¡ç®—ï¼‰
# ============================================

SOURCE="/data/nas"
BACKUP_DIR="/backup/nas-data"
DATE=$(date +%Y%m%d)

echo "========================================="
echo "å¼€å§‹NASæ•°æ®å¤‡ä»½: $(date)"
echo "========================================="

# æ£€æŸ¥æºç›®å½•
if [ ! -d "$SOURCE" ]; then
    echo "é”™è¯¯: æºç›®å½•ä¸å­˜åœ¨: $SOURCE"
    exit 1
fi

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR/latest

# ============================================
# 1. rsyncå¢é‡åŒæ­¥åˆ°latest
# ============================================
echo "1/3 å¢é‡åŒæ­¥æ•°æ®..."

# rsyncå‚æ•°è¯¦è§£:
rsync -av \
    --delete \
    --exclude='*.tmp' \
    --exclude='.Trash*' \
    --exclude='#recycle' \
    --stats \
    $SOURCE/ $BACKUP_DIR/latest/

# å‚æ•°è¯´æ˜:
# -a (archive): å½’æ¡£æ¨¡å¼ï¼Œç­‰åŒäº -rlptgoD
#   -r: é€’å½’å¤åˆ¶ç›®å½•
#   -l: å¤åˆ¶ç¬¦å·é“¾æ¥
#   -p: ä¿ç•™æƒé™
#   -t: ä¿ç•™ä¿®æ”¹æ—¶é—´
#   -g: ä¿ç•™ç»„
#   -o: ä¿ç•™æ‰€æœ‰è€…
#   -D: ä¿ç•™è®¾å¤‡æ–‡ä»¶å’Œç‰¹æ®Šæ–‡ä»¶
#
# -v (verbose): æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
#
# --delete: åˆ é™¤ç›®æ ‡ä¸­æºæ²¡æœ‰çš„æ–‡ä»¶
#   ä½œç”¨: ä¿æŒå¤‡ä»½ä¸æºå®Œå…¨ä¸€è‡´
#   æ³¨æ„: æºåˆ é™¤çš„æ–‡ä»¶ï¼Œå¤‡ä»½ä¹Ÿä¼šåˆ é™¤
#
# --exclude: æ’é™¤ä¸éœ€è¦å¤‡ä»½çš„æ–‡ä»¶
#   '*.tmp': ä¸´æ—¶æ–‡ä»¶
#   '.Trash*': å›æ”¶ç«™
#   '#recycle': Sambaå›æ”¶ç«™
#
# --stats: æ˜¾ç¤ºä¼ è¾“ç»Ÿè®¡
#   ä¼šæ˜¾ç¤º: æ–‡ä»¶æ•°ã€ä¼ è¾“å¤§å°ã€é€Ÿåº¦ç­‰
#
# $SOURCE/: æœ«å°¾çš„/å¾ˆé‡è¦ï¼
#   æœ‰/: å¤åˆ¶ç›®å½•å†…å®¹
#   æ— /: å¤åˆ¶ç›®å½•æœ¬èº«

echo "  âœ“ åŒæ­¥å®Œæˆ"

# ============================================
# 2. åˆ›å»ºç¡¬é“¾æ¥å¿«ç…§
# ============================================
echo "2/3 åˆ›å»ºå¿«ç…§: $DATE"

# cp -al: åˆ›å»ºç¡¬é“¾æ¥å‰¯æœ¬
# -a: å½’æ¡£æ¨¡å¼ï¼ˆä¿ç•™æ‰€æœ‰å±æ€§ï¼‰
# -l: åˆ›å»ºç¡¬é“¾æ¥è€Œä¸æ˜¯å¤åˆ¶æ–‡ä»¶
#
# åŸç†:
# 1. latestä¸­çš„æ¯ä¸ªæ–‡ä»¶éƒ½åˆ›å»ºç¡¬é“¾æ¥åˆ°$DATEç›®å½•
# 2. ä¸¤ä¸ªç›®å½•çœ‹èµ·æ¥éƒ½æœ‰å®Œæ•´çš„æ–‡ä»¶
# 3. ä½†å®é™…ä¸Šå…±äº«åŒä¸€ä¸ªinodeï¼ˆç£ç›˜å—ï¼‰
# 4. ç£ç›˜å ç”¨å‡ ä¹ä¸º0ï¼ˆä»…ç›®å½•ç»“æ„çš„å…ƒæ•°æ®ï¼‰
#
# ä¼˜åŠ¿:
# - æ¯ä¸ªå¿«ç…§éƒ½æ˜¯å®Œæ•´çš„ï¼Œå¯ä»¥ç‹¬ç«‹è®¿é—®
# - ä¸éœ€è¦åƒå¢é‡å¤‡ä»½é‚£æ ·ä¾èµ–ä¹‹å‰çš„å¤‡ä»½
# - åªæœ‰å˜åŒ–çš„æ–‡ä»¶æ‰çœŸæ­£å ç”¨æ–°çš„ç£ç›˜ç©ºé—´

if [ -d "$BACKUP_DIR/latest" ]; then
    cp -al $BACKUP_DIR/latest $BACKUP_DIR/$DATE
    SNAPSHOT_SIZE=$(du -sh $BACKUP_DIR/$DATE 2&gt;/dev/null | cut -f1)
    echo "  âœ“ å¿«ç…§åˆ›å»ºæˆåŠŸ: $SNAPSHOT_SIZE (æ˜¾ç¤ºå¤§å°ï¼Œå®é™…å¢é‡å¾ˆå°)"
else
    echo "  âœ— latestç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¿«ç…§"
fi

# ============================================
# 3. æ¸…ç†æ—§å¿«ç…§ï¼ˆä¿ç•™7å¤©ï¼‰
# ============================================
echo "3/3 æ¸…ç†æ—§å¿«ç…§..."

# æŸ¥æ‰¾å¹¶åˆ é™¤7å¤©å‰çš„å¿«ç…§
OLD_SNAPSHOTS=$(find $BACKUP_DIR -maxdepth 1 -type d -name "20*" -mtime +7)
OLD_COUNT=$(echo "$OLD_SNAPSHOTS" | grep -c "20" 2&gt;/dev/null || echo 0)

if [ $OLD_COUNT -gt 0 ]; then
    echo "$OLD_SNAPSHOTS" | while read dir; do
        rm -rf "$dir"
        echo "  âœ“ å·²åˆ é™¤: $(basename $dir)"
    done
else
    echo "  â„¹ æ— æ—§å¿«ç…§éœ€è¦æ¸…ç†"
fi

# ============================================
# 4. æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
# ============================================
echo "========================================="
echo "å¤‡ä»½ç»Ÿè®¡:"

# è®¡ç®—latestç›®å½•å¤§å°ï¼ˆçœŸå®å ç”¨ï¼‰
LATEST_SIZE=$(du -sh $BACKUP_DIR/latest 2&gt;/dev/null | cut -f1)
echo "  æœ€æ–°æ•°æ®: $LATEST_SIZE"

# è®¡ç®—æ‰€æœ‰å¤‡ä»½æ€»å¤§å°ï¼ˆæ˜¾ç¤ºå¤§å°ï¼ŒéçœŸå®å ç”¨ï¼‰
TOTAL_APPARENT=$(du -sh $BACKUP_DIR 2&gt;/dev/null | cut -f1)
echo "  æ˜¾ç¤ºå¤§å°: $TOTAL_APPARENT"

# è®¡ç®—çœŸå®ç£ç›˜å ç”¨ï¼ˆè€ƒè™‘ç¡¬é“¾æ¥ï¼‰
TOTAL_REAL=$(du -sh --apparent-size $BACKUP_DIR 2&gt;/dev/null | cut -f1)
echo "  å®é™…å ç”¨: $TOTAL_REAL"

# ç»Ÿè®¡å¿«ç…§æ•°é‡
SNAPSHOT_COUNT=$(find $BACKUP_DIR -maxdepth 1 -type d -name "20*" | wc -l)
echo "  å¿«ç…§æ•°é‡: $SNAPSHOT_COUNT ä¸ª"

echo "å¤‡ä»½å®Œæˆ: $(date)"
echo "========================================="
EOF

sudo chmod +x /usr/local/bin/backup-nas-data
```

### 2.3 ç¡¬ç›˜ç©ºé—´è®¡ç®—ç¤ºä¾‹

**å‡è®¾åœºæ™¯**:
```
NASæ•°æ®: 100GB
æ¯å¤©å˜åŒ–: 2GB (2%å˜åŒ–ç‡)
ä¿ç•™æœŸ: 7å¤©
```

**ç©ºé—´å ç”¨**:
```
ç¬¬1å¤©å¤‡ä»½: 100GB (é¦–æ¬¡å…¨é‡)
ç¬¬2å¤©å¤‡ä»½: +2GB (ä»…æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶)
ç¬¬3å¤©å¤‡ä»½: +2GB
...
ç¬¬7å¤©å¤‡ä»½: +2GB

æ€»å ç”¨: 100GB + (2GB Ã— 6å¤©) = 112GB

è€Œä¸æ˜¯: 100GB Ã— 7å¤© = 700GB
èŠ‚çœ: 588GB (84%)
```

**çœŸå®ä¸–ç•Œå˜åŒ–ç‡**:
```
ä½å˜åŒ–ç‡åœºæ™¯ (ç…§ç‰‡ã€è§†é¢‘): 0.5-1% /å¤©
  100GBæ•°æ®ï¼Œ7å¤©å¤‡ä»½: ~103-107GB

ä¸­ç­‰å˜åŒ–ç‡åœºæ™¯ (æ–‡æ¡£ã€ä»£ç ): 2-5% /å¤©
  100GBæ•°æ®ï¼Œ7å¤©å¤‡ä»½: ~112-130GB

é«˜å˜åŒ–ç‡åœºæ™¯ (æ•°æ®åº“ã€æ—¥å¿—): 10-20% /å¤©
  100GBæ•°æ®ï¼Œ7å¤©å¤‡ä»½: ~160-220GB
```

### 2.4 éªŒè¯å¤‡ä»½

```bash
# æŸ¥çœ‹å¤‡ä»½ç›®å½•ç»“æ„
tree -L 1 /backup/nas-data/

# è¾“å‡ºç¤ºä¾‹:
# /backup/nas-data/
# â”œâ”€â”€ 20260224
# â”œâ”€â”€ 20260225
# â”œâ”€â”€ 20260226
# â””â”€â”€ latest

# æŸ¥çœ‹æ¯ä¸ªå¿«ç…§çš„è¡¨é¢å¤§å°
du -sh /backup/nas-data/*/

# æŸ¥çœ‹çœŸå®ç£ç›˜å ç”¨
du -sh --apparent-size /backup/nas-data/

# éªŒè¯ç¡¬é“¾æ¥
# æŸ¥çœ‹æ–‡ä»¶çš„é“¾æ¥æ•°
ls -li /backup/nas-data/latest/some-file.txt
ls -li /backup/nas-data/20260224/some-file.txt
# å¦‚æœinodeå·ï¼ˆç¬¬ä¸€åˆ—ï¼‰ç›¸åŒï¼Œè¯´æ˜æ˜¯ç¡¬é“¾æ¥
```

### 2.5 æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æç¤º**:

1. **é¦–æ¬¡å¤‡ä»½æ—¶é—´é•¿**
   - éœ€è¦å¤åˆ¶å…¨éƒ¨æ•°æ®ï¼ˆå¦‚100GBå¯èƒ½éœ€è¦30-60åˆ†é’Ÿï¼‰
   - åç»­å¤‡ä»½åªéœ€5-10åˆ†é’Ÿ

2. **--deleteå‚æ•°çš„é£é™©**
   - æºç›®å½•åˆ é™¤æ–‡ä»¶ï¼Œå¤‡ä»½ä¹Ÿä¼šåˆ é™¤
   - å»ºè®®æµ‹è¯•æ—¶å…ˆå»æ‰ `--delete`ï¼Œç¡®è®¤æ— è¯¯åå†åŠ ä¸Š

3. **ç¡¬é“¾æ¥é™åˆ¶**
   - åªèƒ½åœ¨åŒä¸€æ–‡ä»¶ç³»ç»Ÿå†…åˆ›å»º
   - /backup å¿…é¡»å’Œå¤‡ä»½ç›®æ ‡åœ¨åŒä¸€åˆ†åŒº

4. **æ–‡ä»¶ç³»ç»Ÿè¦æ±‚**
   - ext4ã€xfséƒ½æ”¯æŒç¡¬é“¾æ¥
   - FAT32ä¸æ”¯æŒï¼ˆä¸è¦å¤‡ä»½åˆ°Uç›˜ï¼‰

---

## ğŸ“¸ å±‚æ¬¡3: è™šæ‹Ÿæœºå¿«ç…§å¤‡ä»½

### 3.1 å¿«ç…§ç±»å‹å¯¹æ¯”

| å¿«ç…§ç±»å‹ | åŸç† | é€Ÿåº¦ | ç©ºé—´å ç”¨ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|---------|
| **qcow2å†…éƒ¨å¿«ç…§** | Copy-on-Write | ç§’çº§ | ä»…å¢é‡ | å¼€å‘æµ‹è¯• |
| **qcow2å¤–éƒ¨å¿«ç…§** | æ–°æ–‡ä»¶å­˜å˜åŒ– | ç§’çº§ | ä»…å¢é‡ | ç”Ÿäº§ç¯å¢ƒ |
| **LVMå¿«ç…§** | å†™æ—¶å¤åˆ¶ | ç§’çº§ | é¢„åˆ†é…ç©ºé—´ | Rawç£ç›˜ |
| **å®Œæ•´å…‹éš†** | å¤åˆ¶å…¨éƒ¨ | æ…¢ | 100% | é•¿æœŸå½’æ¡£ |

### 3.2 qcow2å¿«ç…§è¯¦è§£

#### åŸç†è¯´æ˜

```
åŸå§‹ç£ç›˜: VM.qcow2 (100GBï¼Œå®é™…å ç”¨30GB)

åˆ›å»ºå¿«ç…§:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ VM.qcow2    â”‚ â† å˜ä¸ºåªè¯»ï¼ˆä¿å­˜åˆ›å»ºå¿«ç…§æ—¶çš„çŠ¶æ€ï¼‰
  â”‚ (30GB)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Snapshot 1  â”‚ â† æ–°çš„å†™å…¥ä¿å­˜åœ¨è¿™é‡Œ
  â”‚ (å¢é‡)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»§ç»­ä½¿ç”¨:
- è¯»å–æ—§æ•°æ®: ä»VM.qcow2è¯»å–
- å†™å…¥æ–°æ•°æ®: å†™å…¥å†…éƒ¨å¿«ç…§ç©ºé—´
- ç£ç›˜å ç”¨: 30GB + æ–°å†™å…¥çš„æ•°æ®
```

#### è¯¦ç»†è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/vm-snapshot &lt;&lt;'EOF'
#!/bin/bash
# ============================================
# è™šæ‹Ÿæœºå¿«ç…§åˆ›å»ºè„šæœ¬
# é€‚ç”¨äº: qcow2æ ¼å¼çš„è™šæ‹Ÿæœºç£ç›˜
# æ‰§è¡Œæ—¶é—´: 1-5ç§’ï¼ˆå‡ ä¹å³æ—¶ï¼‰
# ç¡¬ç›˜å ç”¨: åˆå§‹0ï¼Œä¹‹åæŒ‰å˜åŒ–ç´¯ç§¯
# ============================================

VM_NAME=$1
SNAPSHOT_NAME="snap-$(date +%Y%m%d-%H%M%S)"

if [ -z "$VM_NAME" ]; then
    echo "ç”¨æ³•: vm-snapshot &lt;vm-name&gt;"
    echo "ç¤ºä¾‹: vm-snapshot python-dev"
    exit 1
fi

# æ£€æŸ¥VMæ˜¯å¦å­˜åœ¨
if ! virsh list --all | grep -q "$VM_NAME"; then
    echo "é”™è¯¯: è™šæ‹Ÿæœº '$VM_NAME' ä¸å­˜åœ¨"
    exit 1
fi

echo "========================================="
echo "ä¸ºè™šæ‹Ÿæœº '$VM_NAME' åˆ›å»ºå¿«ç…§"
echo "========================================="

# ============================================
# åˆ›å»ºå¿«ç…§
# ============================================

# virsh snapshot-create-as å‚æ•°è¯´æ˜:
# $VM_NAME: è™šæ‹Ÿæœºåç§°
# $SNAPSHOT_NAME: å¿«ç…§åç§°ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
# --description: å¿«ç…§æè¿°
# --atomic: åŸå­æ“ä½œï¼ˆè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼‰
# --disk-only: ä»…ç£ç›˜å¿«ç…§ï¼ˆä¸åŒ…æ‹¬å†…å­˜çŠ¶æ€ï¼‰
# --quiesce: é™é»˜å¿«ç…§ï¼ˆé€šè¿‡qemu-guest-agentå†»ç»“æ–‡ä»¶ç³»ç»Ÿï¼‰

virsh snapshot-create-as $VM_NAME $SNAPSHOT_NAME \
    --description "Auto snapshot created at $(date '+%Y-%m-%d %H:%M:%S')" \
    --atomic

# å¿«ç…§åˆ›å»ºè¿‡ç¨‹:
# 1. libvirtæš‚åœVMçš„IOæ“ä½œï¼ˆå‡ æ¯«ç§’ï¼‰
# 2. åˆ›å»ºå¿«ç…§ç‚¹
# 3. æ¢å¤VMçš„IOæ“ä½œ
# 4. åç»­å†™å…¥éƒ½è®°å½•åœ¨å¿«ç…§é“¾ä¸­

if [ $? -eq 0 ]; then
    echo "  âœ“ å¿«ç…§åˆ›å»ºæˆåŠŸ: $SNAPSHOT_NAME"
    
    # æ˜¾ç¤ºå¿«ç…§ä¿¡æ¯
    echo ""
    echo "å¿«ç…§è¯¦æƒ…:"
    virsh snapshot-info $VM_NAME $SNAPSHOT_NAME
    
    # æ˜¾ç¤ºæ‰€æœ‰å¿«ç…§
    echo ""
    echo "æ‰€æœ‰å¿«ç…§åˆ—è¡¨:"
    virsh snapshot-list $VM_NAME --tree
    
else
    echo "  âœ— å¿«ç…§åˆ›å»ºå¤±è´¥"
    exit 1
fi

echo "========================================="
EOF

sudo chmod +x /usr/local/bin/vm-snapshot
```

### 3.3 å¿«ç…§ç®¡ç†

#### æŸ¥çœ‹å¿«ç…§

```bash
# åˆ—å‡ºæ‰€æœ‰å¿«ç…§
virsh snapshot-list nas

# è¾“å‡ºç¤ºä¾‹:
#  åç§°                 ç”Ÿæˆæ—¶é—´              çŠ¶æ€
# ------------------------------------------------------------
#  snap-20260224-020000   2026-02-24 02:00:00 +0800 shutoff
#  snap-20260301-020000   2026-03-01 02:00:00 +0800 shutoff

# æŸ¥çœ‹å¿«ç…§è¯¦ç»†ä¿¡æ¯
virsh snapshot-info nas snap-20260224-020000

# æ ‘çŠ¶æ˜¾ç¤ºå¿«ç…§å…³ç³»
virsh snapshot-list nas --tree
```

#### æ¢å¤å¿«ç…§

```bash
# æ¢å¤åˆ°æŒ‡å®šå¿«ç…§
virsh snapshot-revert nas snap-20260224-020000

# åŸç†:
# 1. å…³é—­è™šæ‹Ÿæœºï¼ˆå¦‚æœåœ¨è¿è¡Œï¼‰
# 2. å°†ç£ç›˜çŠ¶æ€æ¢å¤åˆ°å¿«ç…§ç‚¹
# 3. ä¸¢å¼ƒå¿«ç…§ç‚¹ä¹‹åçš„æ‰€æœ‰å˜åŒ–

# âš ï¸ è­¦å‘Š: æ¢å¤å¿«ç…§ä¼šä¸¢å¤±å¿«ç…§ä¹‹åçš„æ‰€æœ‰æ•°æ®ï¼
```

#### åˆ é™¤å¿«ç…§

```bash
# åˆ é™¤æŒ‡å®šå¿«ç…§
virsh snapshot-delete nas snap-20260224-020000

# åŸç†:
# 1. å¦‚æœå¿«ç…§æœ‰å­å¿«ç…§ï¼Œéœ€è¦å…ˆåˆ é™¤å­å¿«ç…§
# 2. åˆå¹¶å¿«ç…§çš„æ•°æ®åˆ°çˆ¶å¿«ç…§
# 3. åˆ é™¤å¿«ç…§å…ƒæ•°æ®

# åˆ é™¤æ‰€æœ‰å¿«ç…§ï¼ˆå±é™©æ“ä½œï¼ï¼‰
for snap in $(virsh snapshot-list nas --name); do
    virsh snapshot-delete nas $snap
done
```

### 3.4 ç©ºé—´å ç”¨è®¡ç®—

#### qcow2å¿«ç…§ç©ºé—´

```
ç¤ºä¾‹åœºæ™¯:
â”œâ”€ è™šæ‹Ÿæœº: python-dev
â”œâ”€ ç£ç›˜å¤§å°: 80GB (qcow2)
â”œâ”€ å®é™…å ç”¨: 20GB (25%ä½¿ç”¨ç‡)
â”œâ”€ æ¯å¤©å˜åŒ–: 1GB

å¿«ç…§ç©ºé—´å ç”¨:
â”œâ”€ åˆ›å»ºå¿«ç…§æ—¶: +0GB (å‡ ä¹å³æ—¶)
â”œâ”€ ä½¿ç”¨1å¤©å: +1GB (æ–°å†™å…¥çš„æ•°æ®)
â”œâ”€ ä½¿ç”¨7å¤©å: +7GB
â””â”€ ä½¿ç”¨30å¤©å: +30GB

æ€»å ç”¨: 20GB (åŸå§‹) + 30GB (å¿«ç…§å¢é‡) = 50GB
```

#### LVMå¿«ç…§ç©ºé—´

```
LVMå¿«ç…§åŸç†:
â”œâ”€ é¢„å…ˆåˆ†é…å¿«ç…§ç©ºé—´ï¼ˆå¦‚10GBï¼‰
â”œâ”€ åŸå§‹æ•°æ®å˜åŒ–æ—¶ï¼Œæ—§æ•°æ®å¤åˆ¶åˆ°å¿«ç…§ç©ºé—´
â”œâ”€ æ–°æ•°æ®å†™å…¥åŸå§‹å·

åˆ›å»ºLVMå¿«ç…§:
```bash
# ä¸ºNASè™šæ‹Ÿæœºåˆ›å»ºå¿«ç…§ï¼ˆrawæ ¼å¼ï¼‰
lvcreate -L 10G -s -n nas-snap-$(date +%Y%m%d) /dev/vg_kvm/nas

# å‚æ•°è¯´æ˜:
# -L 10G: å¿«ç…§å¤§å°ï¼ˆæ ¹æ®é¢„æœŸå˜åŒ–é‡è®¾ç½®ï¼‰
# -s: åˆ›å»ºå¿«ç…§
# -n: å¿«ç…§åç§°
# /dev/vg_kvm/nas: åŸå§‹é€»è¾‘å·

# ç©ºé—´å ç”¨:
# - ç«‹å³åˆ†é…: 10GB
# - æ•°æ®å˜åŒ–å¡«å……å¿«ç…§ç©ºé—´
# - å¦‚æœå¿«ç…§ç©ºé—´æ»¡ï¼Œå¿«ç…§å¤±æ•ˆ

# æŸ¥çœ‹å¿«ç…§ä½¿ç”¨ç‡
lvs /dev/vg_kvm/nas-snap-20260224

# åˆ é™¤å¿«ç…§
lvremove /dev/vg_kvm/nas-snap-20260224
```
```

### 3.5 å¿«ç…§æœ€ä½³å®è·µ

#### å¿«ç…§ç­–ç•¥

```bash
# å¼€å‘VM: é¢‘ç¹å¿«ç…§
æ¯å¤©è‡ªåŠ¨å¿«ç…§ï¼Œä¿ç•™7å¤©
0 2 * * * /usr/local/bin/vm-snapshot python-dev

# ç”Ÿäº§VM: é‡è¦æ“ä½œå‰æ‰‹åŠ¨å¿«ç…§
æ›´æ–°å‰: vm-snapshot web-app
æµ‹è¯•é€šè¿‡å: åˆ é™¤å¿«ç…§

# NAS VM: æ¯æœˆå¿«ç…§
æ¯æœˆ1å·åˆ›å»ºå¿«ç…§ï¼Œä¿ç•™3ä¸ªæœˆ
0 2 1 * * /usr/local/bin/vm-snapshot nas
```

#### âš ï¸ å¿«ç…§æ³¨æ„äº‹é¡¹

1. **å¿«ç…§ä¸æ˜¯å¤‡ä»½**
   - å¿«ç…§å’ŒåŸå§‹æ•°æ®åœ¨åŒä¸€ç£ç›˜
   - ç£ç›˜æŸåï¼Œå¿«ç…§ä¹Ÿä¸¢å¤±
   - å¿…é¡»é…åˆçœŸæ­£çš„å¤‡ä»½ä½¿ç”¨

2. **å¿«ç…§é“¾ä¸å®œè¿‡é•¿**
   - æ¯ä¸ªå¿«ç…§éƒ½ä¾èµ–çˆ¶å¿«ç…§
   - é“¾è¿‡é•¿ä¼šå½±å“æ€§èƒ½
   - å»ºè®®: ä¸è¶…è¿‡3-5ä¸ªå¿«ç…§

3. **ç©ºé—´ç›‘æ§**
   - å®šæœŸæ£€æŸ¥å¿«ç…§å ç”¨
   - åŠæ—¶åˆ é™¤ä¸éœ€è¦çš„å¿«ç…§
   - qcow2å¿«ç…§å ç”¨ä¼šç´¯ç§¯

4. **æ€§èƒ½å½±å“**
   - å¿«ç…§ä¼šç•¥å¾®é™ä½IOæ€§èƒ½ï¼ˆ5-10%ï¼‰
   - å¿«ç…§é“¾è¶Šé•¿ï¼Œæ€§èƒ½å½±å“è¶Šå¤§

---

## â° è‡ªåŠ¨åŒ–å¤‡ä»½é…ç½®

### å®šæ—¶ä»»åŠ¡è®¾ç½®

```bash
# ç¼–è¾‘rootçš„crontab
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹å†…å®¹:

# ============================================
# æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹å¤‡ä»½VMé…ç½®
# ============================================
0 2 * * 0 /usr/local/bin/backup-vm-configs &gt;&gt; /var/log/backup-vm-configs.log 2&gt;&amp;1

# cronæ—¶é—´æ ¼å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨
# 0 2 * * 0 = æ¯å‘¨æ—¥å‡Œæ™¨2:00
# &gt;&gt; /var/log/xxx.log 2&gt;&amp;1 = è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—

# ============================================
# æ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½NASæ•°æ®
# ============================================
0 3 * * * /usr/local/bin/backup-nas-data &gt;&gt; /var/log/backup-nas-data.log 2&gt;&amp;1

# ä¸ºä»€ä¹ˆæ˜¯3ç‚¹?
# - é¿å…ä¸å…¶ä»–ä»»åŠ¡å†²çª
# - å¤œé—´è´Ÿè½½ä½
# - NASè®¿é—®å°‘

# ============================================
# æ¯æœˆ1å·å‡Œæ™¨4ç‚¹åˆ›å»ºVMå¿«ç…§
# ============================================
0 4 1 * * /usr/local/bin/vm-snapshot nas &gt;&gt; /var/log/vm-snapshot.log 2&gt;&amp;1
0 4 1 * * /usr/local/bin/vm-snapshot web-app &gt;&gt; /var/log/vm-snapshot.log 2&gt;&amp;1

# æ¯æœˆ1å· = é•¿æœŸå½’æ¡£ç‚¹

# ============================================
# æ¯å¤©å‡Œæ™¨5ç‚¹æ£€æŸ¥å¤‡ä»½å¥åº·çŠ¶æ€
# ============================================
0 5 * * * /usr/local/bin/verify-backup &gt;&gt; /var/log/verify-backup.log 2&gt;&amp;1
```

### æ—¥å¿—è½®è½¬é…ç½®

```bash
# åˆ›å»ºæ—¥å¿—è½®è½¬é…ç½®
sudo cat &gt; /etc/logrotate.d/backup &lt;&lt;'EOF'
/var/log/backup-*.log {
    # æ¯å‘¨è½®è½¬
    weekly
    
    # ä¿ç•™4å‘¨ï¼ˆçº¦1ä¸ªæœˆï¼‰
    rotate 4
    
    # è½®è½¬åå‹ç¼©
    compress
    
    # å»¶è¿Ÿå‹ç¼©ï¼ˆä¿æŒæœ€æ–°çš„æœªå‹ç¼©ï¼‰
    delaycompress
    
    # å¦‚æœæ—¥å¿—ä¸å­˜åœ¨ï¼Œä¸æŠ¥é”™
    missingok
    
    # æ—¥å¿—ä¸ºç©ºä¹Ÿè½®è½¬
    notifempty
    
    # è½®è½¬ååˆ›å»ºæ–°æ–‡ä»¶
    create 0644 root root
}
EOF

# æµ‹è¯•é…ç½®
sudo logrotate -d /etc/logrotate.d/backup
```

---

## ğŸ”™ æ¢å¤æµç¨‹

### æ¢å¤è™šæ‹Ÿæœºé…ç½®

```bash
# ============================================
# åœºæ™¯: å®¿ä¸»æœºå´©æºƒï¼Œéœ€è¦åœ¨æ–°ç³»ç»Ÿä¸Šæ¢å¤VM
# ============================================

# 1. è§£å‹å¤‡ä»½
cd /backup/vm-configs
tar -xzf vm-configs-20260224.tar.gz

# 2. æ¢å¤LVMé…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
vgcfgrestore -f 20260224/vg_kvm.cfg vg_kvm

# 3. æ¿€æ´»å·ç»„
vgchange -ay vg_kvm

# 4. æ¢å¤å­˜å‚¨æ± 
cd 20260224
for pool_xml in pool-*.xml; do
    virsh pool-define $pool_xml
    pool_name=$(basename $pool_xml .xml | sed 's/pool-//')
    virsh pool-start $pool_name
    virsh pool-autostart $pool_name
done

# 5. æ¢å¤ç½‘ç»œ
for net_xml in net-*.xml; do
    virsh net-define $net_xml
    net_name=$(basename $net_xml .xml | sed 's/net-//')
    virsh net-start $net_name
    virsh net-autostart $net_name
done

# 6. æ¢å¤è™šæ‹Ÿæœºå®šä¹‰
for vm_xml in *.xml; do
    # è·³è¿‡å­˜å‚¨æ± å’Œç½‘ç»œé…ç½®
    if [[ $vm_xml != pool-* &amp;&amp; $vm_xml != net-* ]]; then
        virsh define $vm_xml
        echo "å·²æ¢å¤: $(basename $vm_xml .xml)"
    fi
done

# 7. éªŒè¯
virsh list --all
virsh pool-list --all
virsh net-list --all
```

### æ¢å¤NASæ•°æ®

```bash
# ============================================
# ä»rsyncå¤‡ä»½æ¢å¤æ•°æ®
# ============================================

# æ–¹å¼1: ä»latestæ¢å¤ï¼ˆæœ€æ–°çŠ¶æ€ï¼‰
rsync -av --progress \
    /backup/nas-data/latest/ \
    /data/nas/

# æ–¹å¼2: ä»ç‰¹å®šæ—¥æœŸå¿«ç…§æ¢å¤
rsync -av --progress \
    /backup/nas-data/20260224/ \
    /data/nas/

# æ–¹å¼3: æ¢å¤ç‰¹å®šç›®å½•
rsync -av --progress \
    /backup/nas-data/latest/important-docs/ \
    /data/nas/important-docs/

# æ–¹å¼4: æ¢å¤å•ä¸ªæ–‡ä»¶
cp /backup/nas-data/latest/path/to/file.txt \
   /data/nas/path/to/file.txt
```

### æ¢å¤è™šæ‹Ÿæœºå¿«ç…§

```bash
# ============================================
# ä»å¿«ç…§æ¢å¤VMåˆ°ä¹‹å‰çš„çŠ¶æ€
# ============================================

# 1. åˆ—å‡ºå¯ç”¨å¿«ç…§
virsh snapshot-list nas

# 2. æŸ¥çœ‹å¿«ç…§ä¿¡æ¯
virsh snapshot-info nas snap-20260224-020000

# 3. æ¢å¤å¿«ç…§ï¼ˆVMå¿…é¡»æ˜¯å…³é—­çŠ¶æ€ï¼‰
virsh shutdown nas
# ç­‰å¾…å…³é—­
sleep 10

# 4. æ‰§è¡Œæ¢å¤
virsh snapshot-revert nas snap-20260224-020000

# âš ï¸ è­¦å‘Š: è¿™ä¼šä¸¢å¤±å¿«ç…§ä¹‹åçš„æ‰€æœ‰æ•°æ®ï¼

# 5. å¯åŠ¨VM
virsh start nas

# 6. éªŒè¯
virsh console nas
```

---

## ğŸ’¾ ç¦»çº¿å¤‡ä»½å»ºè®®

### ä¸ºä»€ä¹ˆéœ€è¦ç¦»çº¿å¤‡ä»½ï¼Ÿ

```
åœ¨çº¿å¤‡ä»½çš„é£é™©:
â”œâ”€ å‹’ç´¢ç—…æ¯’: å¯èƒ½åŠ å¯†æ‰€æœ‰åœ¨çº¿å¤‡ä»½
â”œâ”€ è¯¯æ“ä½œ: rm -rf å¯èƒ½åˆ é™¤å¤‡ä»½
â”œâ”€ ç¡¬ä»¶æ•…éšœ: æœåŠ¡å™¨æŸåï¼Œå¤‡ä»½ä¹Ÿä¸¢å¤±
â””â”€ ç«ç¾/æ°´ç¾: ç‰©ç†æŸå

ç¦»çº¿å¤‡ä»½çš„ä¼˜åŠ¿:
â”œâ”€ ç‰©ç†éš”ç¦»: æ–­å¼€è¿æ¥ï¼Œå‹’ç´¢ç—…æ¯’æ— æ³•åŠ å¯†
â”œâ”€ å¼‚åœ°å­˜å‚¨: ä¸å—æœ¬åœ°ç¾éš¾å½±å“
â”œâ”€ é•¿æœŸå½’æ¡£: å¯ä»¥ä¿ç•™æ•°æœˆç”šè‡³æ•°å¹´
â””â”€ æœ€åé˜²çº¿: æ‰€æœ‰åœ¨çº¿å¤‡ä»½å¤±æ•ˆæ—¶çš„æ•‘å‘½ç¨»è‰
```

### ç¦»çº¿å¤‡ä»½è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/offline-backup &lt;&lt;'EOF'
#!/bin/bash
# ============================================
# ç¦»çº¿å¤‡ä»½è„šæœ¬
# ç”¨é€”: å¤åˆ¶å…³é”®æ•°æ®åˆ°ç§»åŠ¨ç¡¬ç›˜
# é¢‘ç‡: æ¯æœˆä¸€æ¬¡
# ç¡¬ç›˜: å»ºè®®1TB USBç§»åŠ¨ç¡¬ç›˜
# ============================================

# æ£€æŸ¥æ˜¯å¦å·²æŒ‚è½½ç§»åŠ¨ç¡¬ç›˜
EXTERNAL_HDD="/mnt/external-backup"

if [ ! -d "$EXTERNAL_HDD" ]; then
    echo "é”™è¯¯: ç§»åŠ¨ç¡¬ç›˜æœªæŒ‚è½½"
    echo "è¯·å…ˆæŒ‚è½½ç§»åŠ¨ç¡¬ç›˜åˆ° $EXTERNAL_HDD"
    echo ""
    echo "æŒ‚è½½æ­¥éª¤:"
    echo "  sudo mkdir -p $EXTERNAL_HDD"
    echo "  sudo mount /dev/sdX1 $EXTERNAL_HDD"
    exit 1
fi

DATE=$(date +%Y%m)
BACKUP_PATH="$EXTERNAL_HDD/backup-$DATE"

echo "========================================="
echo "ç¦»çº¿å¤‡ä»½åˆ°ç§»åŠ¨ç¡¬ç›˜"
echo "ç›®æ ‡: $BACKUP_PATH"
echo "========================================="

mkdir -p $BACKUP_PATH

# ============================================
# 1. å¤‡ä»½VMé…ç½®
# ============================================
echo "1/4 å¤‡ä»½VMé…ç½®..."
rsync -av --progress \
    /backup/vm-configs/ \
    $BACKUP_PATH/vm-configs/

# ============================================
# 2. å¤‡ä»½NASé‡è¦æ•°æ®
# ============================================
echo "2/4 å¤‡ä»½NASé‡è¦æ•°æ®..."
rsync -av --progress \
    --exclude='media/' \
    --exclude='downloads/' \
    /data/nas/ \
    $BACKUP_PATH/nas-important/

# åªå¤‡ä»½é‡è¦æ–‡ä»¶ï¼Œæ’é™¤å¤§æ–‡ä»¶ï¼ˆå¦‚ç”µå½±ï¼‰

# ============================================
# 3. å¤‡ä»½LVMå…ƒæ•°æ®
# ============================================
echo "3/4 å¤‡ä»½LVMå…ƒæ•°æ®..."
mkdir -p $BACKUP_PATH/lvm-metadata
vgcfgbackup -f $BACKUP_PATH/lvm-metadata/vg_kvm.cfg vg_kvm
pvs &gt; $BACKUP_PATH/lvm-metadata/pvs.txt
vgs &gt; $BACKUP_PATH/lvm-metadata/vgs.txt
lvs &gt; $BACKUP_PATH/lvm-metadata/lvs.txt

# ============================================
# 4. å¤‡ä»½ç³»ç»Ÿé…ç½®æ–‡ä»¶
# ============================================
echo "4/4 å¤‡ä»½ç³»ç»Ÿé…ç½®..."
mkdir -p $BACKUP_PATH/system-configs

# ç½‘ç»œé…ç½®
cp -r /etc/NetworkManager/system-connections \
    $BACKUP_PATH/system-configs/ 2&gt;/dev/null || true

# è‡ªå®šä¹‰è„šæœ¬
cp -r /usr/local/bin \
    $BACKUP_PATH/system-configs/ 2&gt;/dev/null || true

# SSHé…ç½®
cp -r /home/*/.ssh \
    $BACKUP_PATH/system-configs/ 2&gt;/dev/null || true

# ============================================
# 5. ç”Ÿæˆå¤‡ä»½æ¸…å•
# ============================================
echo "ç”Ÿæˆå¤‡ä»½æ¸…å•..."
cat &gt; $BACKUP_PATH/BACKUP-INFO.txt &lt;&lt;EOL
å¤‡ä»½æ—¥æœŸ: $(date '+%Y-%m-%d %H:%M:%S')
å¤‡ä»½ä¸»æœº: $(hostname)

å¤‡ä»½å†…å®¹:
â”œâ”€ VMé…ç½®: $(du -sh $BACKUP_PATH/vm-configs 2&gt;/dev/null | cut -f1)
â”œâ”€ NASæ•°æ®: $(du -sh $BACKUP_PATH/nas-important 2&gt;/dev/null | cut -f1)
â”œâ”€ LVMå…ƒæ•°æ®: $(du -sh $BACKUP_PATH/lvm-metadata 2&gt;/dev/null | cut -f1)
â””â”€ ç³»ç»Ÿé…ç½®: $(du -sh $BACKUP_PATH/system-configs 2&gt;/dev/null | cut -f1)

æ€»å¤§å°: $(du -sh $BACKUP_PATH | cut -f1)

è™šæ‹Ÿæœºåˆ—è¡¨:
$(virsh list --all)

å­˜å‚¨æ± ä¿¡æ¯:
$(virsh pool-list --all)

LVMå·ä¿¡æ¯:
$(lvs vg_kvm)
EOL

# æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
cat $BACKUP_PATH/BACKUP-INFO.txt

# ============================================
# 6. éªŒè¯å¤‡ä»½
# ============================================
echo ""
echo "éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."
CHECKSUM_FILE="$BACKUP_PATH/checksums.md5"
cd $BACKUP_PATH
find . -type f -exec md5sum {} \; &gt; $CHECKSUM_FILE
CHECKSUM_COUNT=$(wc -l &lt; $CHECKSUM_FILE)

echo "  âœ“ å·²ä¸º $CHECKSUM_COUNT ä¸ªæ–‡ä»¶ç”Ÿæˆæ ¡éªŒå’Œ"

echo ""
echo "========================================="
echo "ç¦»çº¿å¤‡ä»½å®Œæˆï¼"
echo "ä½ç½®: $BACKUP_PATH"
echo "å¤§å°: $(du -sh $BACKUP_PATH | cut -f1)"
echo ""
echo "âš ï¸ é‡è¦æç¤º:"
echo "1. è¯·å®‰å…¨å¸è½½ç§»åŠ¨ç¡¬ç›˜: sudo umount $EXTERNAL_HDD"
echo "2. å°†ç¡¬ç›˜å­˜æ”¾åœ¨å®‰å…¨ä½ç½®ï¼ˆå¼‚åœ°æœ€ä½³ï¼‰"
echo "3. å»ºè®®æ¯æœˆé‡å¤æ­¤å¤‡ä»½"
echo "========================================="
EOF

sudo chmod +x /usr/local/bin/offline-backup
```

### ç¦»çº¿å¤‡ä»½ä½¿ç”¨æµç¨‹

```bash
# 1. æ’å…¥USBç§»åŠ¨ç¡¬ç›˜
# 2. æŸ¥çœ‹è®¾å¤‡å
lsblk

# 3. æŒ‚è½½ç§»åŠ¨ç¡¬ç›˜
sudo mkdir -p /mnt/external-backup
sudo mount /dev/sdb1 /mnt/external-backup

# 4. æ‰§è¡Œå¤‡ä»½
sudo /usr/local/bin/offline-backup

# 5. å®‰å…¨å¸è½½
sudo umount /mnt/external-backup

# 6. æ‹”å‡ºç¡¬ç›˜ï¼Œå­˜æ”¾åœ¨å®‰å…¨ä½ç½®
```

---

## ğŸ“Š æ€»ç¡¬ç›˜ç©ºé—´éœ€æ±‚æ±‡æ€»

### åœ¨çº¿å¤‡ä»½ç©ºé—´éœ€æ±‚

```
/backup ç›®å½•æ¨èå¤§å°: 500GB

è¯¦ç»†åˆ†é…:
â”œâ”€ /backup/vm-configs/      3GB
â”‚  â””â”€ 30å¤© Ã— 100MB
â”‚
â”œâ”€ /backup/nas-data/        ~110GB
â”‚  â”œâ”€ é¦–æ¬¡å…¨é‡: 100GB
â”‚  â””â”€ 6å¤©å¢é‡: 10GB (å‡è®¾æ¯å¤©2GBå˜åŒ–)
â”‚
â””â”€ é¢„ç•™ç©ºé—´                 387GB
   â””â”€ ç”¨äºæœªæ¥æ‰©å±•

LVM thin pool å¿«ç…§ç©ºé—´:
â”œâ”€ åµŒå…¥åœ¨1.2TB thin poolä¸­
â””â”€ æŒ‰éœ€åˆ†é…ï¼Œå»ºè®®é¢„ç•™20-30%ç©ºé—´
```

### ç¦»çº¿å¤‡ä»½ç©ºé—´éœ€æ±‚

```
ç§»åŠ¨ç¡¬ç›˜æ¨èå¤§å°: 1TB

å•æ¬¡å¤‡ä»½å†…å®¹:
â”œâ”€ VMé…ç½®              3GB
â”œâ”€ NASé‡è¦æ•°æ®         50-200GB (å–å†³äºä½ çš„æ•°æ®é‡)
â”œâ”€ LVMå…ƒæ•°æ®           1MB
â”œâ”€ ç³»ç»Ÿé…ç½®            100MB
â””â”€ æ€»è®¡                ~60-210GB

æ¨è:
â”œâ”€ å‡†å¤‡2ä¸ª1TBç§»åŠ¨ç¡¬ç›˜
â”œâ”€ è½®æµä½¿ç”¨ï¼ˆæœ¬æœˆç”¨ç¡¬ç›˜Aï¼Œä¸‹æœˆç”¨ç¡¬ç›˜Bï¼‰
â””â”€ ä¸€ä¸ªå¼‚åœ°å­˜æ”¾ï¼Œä¸€ä¸ªæœ¬åœ°
```

### çœŸå®åœºæ™¯ä¼°ç®—

**åœºæ™¯1: è½»åº¦ä½¿ç”¨**
```
NASæ•°æ®: 50GB
æ¯å¤©å˜åŒ–: 500MB
VM: 4ä¸ªï¼Œæ¯ä¸ª20GBå®é™…ä½¿ç”¨

åœ¨çº¿å¤‡ä»½éœ€æ±‚:
â”œâ”€ VMé…ç½®: 3GB
â”œâ”€ NASæ•°æ®: 50GB + 3GB (7å¤©å¢é‡)
â””â”€ æ€»è®¡: ~60GB

ç¦»çº¿å¤‡ä»½: 1ä¸ª500GBç¡¬ç›˜è¶³å¤Ÿ
```

**åœºæ™¯2: ä¸­åº¦ä½¿ç”¨**
```
NASæ•°æ®: 200GB
æ¯å¤©å˜åŒ–: 2GB
VM: 4ä¸ªï¼Œæ¯ä¸ª50GBå®é™…ä½¿ç”¨

åœ¨çº¿å¤‡ä»½éœ€æ±‚:
â”œâ”€ VMé…ç½®: 3GB
â”œâ”€ NASæ•°æ®: 200GB + 14GB (7å¤©å¢é‡)
â””â”€ æ€»è®¡: ~220GB

ç¦»çº¿å¤‡ä»½: 1TBç¡¬ç›˜
```

**åœºæ™¯3: é‡åº¦ä½¿ç”¨**
```
NASæ•°æ®: 500GB
æ¯å¤©å˜åŒ–: 5GB
VM: 4ä¸ªï¼Œæ¯ä¸ª100GBå®é™…ä½¿ç”¨

åœ¨çº¿å¤‡ä»½éœ€æ±‚:
â”œâ”€ VMé…ç½®: 3GB
â”œâ”€ NASæ•°æ®: 500GB + 35GB (7å¤©å¢é‡)
â””â”€ æ€»è®¡: ~540GB

ç¦»çº¿å¤‡ä»½: 2TBç¡¬ç›˜
```

---

## âœ… éªŒè¯è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/verify-backup &lt;&lt;'EOF'
#!/bin/bash
# ============================================
# å¤‡ä»½éªŒè¯è„šæœ¬
# åŠŸèƒ½: æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§å’Œå¥åº·çŠ¶æ€
# ============================================

echo "========================================="
echo "       å¤‡ä»½éªŒè¯æŠ¥å‘Š"
echo "========================================="
date
echo ""

# ============================================
# 1. VMé…ç½®å¤‡ä»½éªŒè¯
# ============================================
echo "1. VMé…ç½®å¤‡ä»½:"
if [ -d "/backup/vm-configs" ]; then
    LATEST_VM_BACKUP=$(ls -t /backup/vm-configs/vm-configs-*.tar.gz 2&gt;/dev/null | head -1)
    if [ -n "$LATEST_VM_BACKUP" ]; then
        BACKUP_AGE=$((($(date +%s) - $(stat -c %Y "$LATEST_VM_BACKUP")) / 86400))
        BACKUP_SIZE=$(du -sh "$LATEST_VM_BACKUP" | cut -f1)
        echo "  âœ“ æœ€æ–°å¤‡ä»½: $(basename $LATEST_VM_BACKUP)"
        echo "    å¤§å°: $BACKUP_SIZE"
        echo "    å¹´é¾„: ${BACKUP_AGE}å¤©"
        
        if [ $BACKUP_AGE -gt 7 ]; then
            echo "  âš  è­¦å‘Š: å¤‡ä»½å·²è¶…è¿‡7å¤©ï¼Œå»ºè®®æ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½"
        fi
    else
        echo "  âœ— æœªæ‰¾åˆ°VMé…ç½®å¤‡ä»½"
    fi
else
    echo "  âœ— å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: /backup/vm-configs"
fi

echo ""

# ============================================
# 2. NASæ•°æ®å¤‡ä»½éªŒè¯
# ============================================
echo "2. NASæ•°æ®å¤‡ä»½:"
if [ -d "/backup/nas-data/latest" ]; then
    LATEST_MTIME=$(stat -c %Y /backup/nas-data/latest)
    BACKUP_AGE=$((($(date +%s) - $LATEST_MTIME) / 86400))
    BACKUP_SIZE=$(du -sh /backup/nas-data/latest 2&gt;/dev/null | cut -f1)
    SNAPSHOT_COUNT=$(ls -d /backup/nas-data/20* 2&gt;/dev/null | wc -l)
    
    echo "  âœ“ æœ€æ–°åŒæ­¥: $(stat -c %y /backup/nas-data/latest | cut -d'.' -f1)"
    echo "    å¤§å°: $BACKUP_SIZE"
    echo "    å¹´é¾„: ${BACKUP_AGE}å¤©"
    echo "    å¿«ç…§æ•°: $SNAPSHOT_COUNT ä¸ª"
    
    if [ $BACKUP_AGE -gt 1 ]; then
        echo "  âš  è­¦å‘Š: è¶…è¿‡1å¤©æœªå¤‡ä»½"
    fi
else
    echo "  âœ— NASæ•°æ®å¤‡ä»½ä¸å­˜åœ¨"
fi

echo ""

# ============================================
# 3. ç£ç›˜ç©ºé—´æ£€æŸ¥
# ============================================
echo "3. å¤‡ä»½ç£ç›˜ç©ºé—´:"
if df -h | grep -q "/backup"; then
    BACKUP_DISK_INFO=$(df -h /backup | tail -1)
    BACKUP_USAGE=$(echo $BACKUP_DISK_INFO | awk '{print $5}' | sed 's/%//')
    BACKUP_AVAIL=$(echo $BACKUP_DISK_INFO | awk '{print $4}')
    
    echo "  ä½¿ç”¨ç‡: ${BACKUP_USAGE}%"
    echo "  å¯ç”¨ç©ºé—´: $BACKUP_AVAIL"
    
    if [ $BACKUP_USAGE -gt 80 ]; then
        echo "  âš  è­¦å‘Š: å¤‡ä»½ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡80%"
        echo "    å»ºè®®: æ¸…ç†æ—§å¤‡ä»½æˆ–æ‰©å±•ç£ç›˜ç©ºé—´"
    fi
else
    echo "  â„¹ å¤‡ä»½æœªä½¿ç”¨ç‹¬ç«‹åˆ†åŒº"
    BACKUP_DIR_SIZE=$(du -sh /backup 2&gt;/dev/null | cut -f1)
    echo "    å¤‡ä»½ç›®å½•å¤§å°: ${BACKUP_DIR_SIZE:-N/A}"
fi

echo ""

# ============================================
# 4. å¿«ç…§æ£€æŸ¥
# ============================================
echo "4. è™šæ‹Ÿæœºå¿«ç…§:"
for vm in $(virsh list --all --name); do
    if [ -n "$vm" ]; then
        SNAP_COUNT=$(virsh snapshot-list $vm --name 2&gt;/dev/null | wc -l)
        if [ $SNAP_COUNT -gt 0 ]; then
            echo "  $vm: $SNAP_COUNT ä¸ªå¿«ç…§"
            LATEST_SNAP=$(virsh snapshot-list $vm --name | tail -1)
            if [ -n "$LATEST_SNAP" ]; then
                SNAP_DATE=$(virsh snapshot-info $vm $LATEST_SNAP | grep "åˆ›å»ºæ—¶é—´" | cut -d: -f2-)
                echo "    æœ€æ–°: $LATEST_SNAP"
            fi
        else
            echo "  $vm: æ— å¿«ç…§"
        fi
    fi
done

echo ""

# ============================================
# 5. å¤‡ä»½å®Œæ•´æ€§æµ‹è¯•
# ============================================
echo "5. å®Œæ•´æ€§æµ‹è¯•:"
if [ -f "/backup/vm-configs/vm-configs-$(date +%Y%m%d).tar.gz" ]; then
    echo "  æµ‹è¯•ä»Šæ—¥VMé…ç½®å¤‡ä»½..."
    if tar -tzf "/backup/vm-configs/vm-configs-$(date +%Y%m%d).tar.gz" &gt;/dev/null 2&gt;&amp;1; then
        echo "  âœ“ å¤‡ä»½æ–‡ä»¶å®Œæ•´"
    else
        echo "  âœ— å¤‡ä»½æ–‡ä»¶æŸå"
    fi
fi

echo ""
echo "========================================="
echo "éªŒè¯å®Œæˆ"
echo "========================================="
EOF

sudo chmod +x /usr/local/bin/verify-backup
```

---

## ğŸ“ å®Œæˆæ£€æŸ¥æ¸…å•

å®Œæˆæœ¬æ–‡æ¡£åï¼Œæ‚¨åº”è¯¥å·²ç»ï¼š

- [x] ç†è§£ä¸‰å±‚å¤‡ä»½ç­–ç•¥çš„åŸç†
- [x] é…ç½®VMé…ç½®è‡ªåŠ¨å¤‡ä»½
- [x] é…ç½®NASæ•°æ®å¢é‡å¤‡ä»½
- [x] å­¦ä¼šåˆ›å»ºå’Œç®¡ç†VMå¿«ç…§
- [x] è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡
- [x] äº†è§£å¦‚ä½•æ¢å¤å¤‡ä»½
- [x] è§„åˆ’ç¦»çº¿å¤‡ä»½ç­–ç•¥
- [x] è¯„ä¼°ç¡¬ç›˜ç©ºé—´éœ€æ±‚

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# å¤‡ä»½
backup-vm-configs           # å¤‡ä»½VMé…ç½®
backup-nas-data            # å¤‡ä»½NASæ•°æ®
vm-snapshot &lt;vm-name&gt;      # åˆ›å»ºVMå¿«ç…§
offline-backup             # ç¦»çº¿å¤‡ä»½

# éªŒè¯
verify-backup              # éªŒè¯å¤‡ä»½å¥åº·

# æŸ¥çœ‹
virsh snapshot-list &lt;vm&gt;   # æŸ¥çœ‹å¿«ç…§
tar -tzf xxx.tar.gz        # æŸ¥çœ‹å¤‡ä»½å†…å®¹

# æ¢å¤
virsh snapshot-revert &lt;vm&gt; &lt;snap&gt;  # æ¢å¤å¿«ç…§
rsync -av /backup/nas-data/latest/ /data/nas/  # æ¢å¤æ•°æ®
```

### ç©ºé—´éœ€æ±‚é€ŸæŸ¥

| ä½¿ç”¨åœºæ™¯ | åœ¨çº¿å¤‡ä»½ | ç¦»çº¿å¤‡ä»½ |
|---------|---------|---------|
| è½»åº¦ï¼ˆNAS 50GBï¼‰ | 60GB | 500GBç¡¬ç›˜ |
| ä¸­åº¦ï¼ˆNAS 200GBï¼‰ | 220GB | 1TBç¡¬ç›˜ |
| é‡åº¦ï¼ˆNAS 500GBï¼‰ | 540GB | 2TBç¡¬ç›˜ |

### å¤‡ä»½é¢‘ç‡å»ºè®®

```
VMé…ç½®: æ¯å‘¨
NASæ•°æ®: æ¯å¤©
VMå¿«ç…§: æ¯æœˆï¼ˆç”Ÿäº§VMï¼‰/ æ¯å¤©ï¼ˆå¼€å‘VMï¼‰
ç¦»çº¿å¤‡ä»½: æ¯æœˆ
```

---

**ä¸‹ä¸€æ­¥**: [13-maintenance.md - ç³»ç»Ÿç»´æŠ¤](#section-13)




---



# 13 - ç³»ç»Ÿç»´æŠ¤æŒ‡å—

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

æ­£ç¡®çš„å¼€å…³æœºæµç¨‹ã€æ—¥å¸¸ç»´æŠ¤å’Œæ•…éšœæ¢å¤ã€‚

---

## ğŸ”Œ æ­£ç¡®çš„å…³æœºæµç¨‹

### è®¡åˆ’æ€§å…³æœºï¼ˆæ¨èï¼‰

```bash
# 1. ä¼˜é›…å…³é—­æ‰€æœ‰è™šæ‹Ÿæœº
vm-manager stop-all

# ç­‰å¾…æ‰€æœ‰VMå…³é—­(çº¦1-2åˆ†é’Ÿ)
watch -n 2 'virsh list --all'

# 2. å…³é—­å®¿ä¸»æœº
sudo shutdown -h now
# æˆ–å®šæ—¶å…³æœº
sudo shutdown -h +10  # 10åˆ†é’Ÿåå…³æœº
```

### ç´§æ€¥å…³æœº

```bash
# å¼ºåˆ¶å…³é—­æ‰€æœ‰VM
for vm in $(virsh list --name); do
    virsh destroy $vm
done

# ç«‹å³å…³æœº
sudo poweroff
```

---

## ğŸ”„ å¼€æœºå’Œæ¢å¤æµç¨‹

### æ­£å¸¸å¼€æœº

1. **æŒ‰ä¸‹ç”µæºæŒ‰é’®**
2. **å®¿ä¸»æœºå¯åŠ¨** (çº¦30-60ç§’)
3. **è‡ªåŠ¨å¯åŠ¨é…ç½®çš„VM** (å·²è®¾ç½®autostartçš„è™šæ‹Ÿæœº)

### éªŒè¯ç³»ç»Ÿå¯åŠ¨

```bash
# SSHç™»å½•å®¿ä¸»æœº
ssh chris@192.168.71.200

# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
sysinfo

# æ£€æŸ¥è™šæ‹ŸæœºçŠ¶æ€
vm-manager status

# æ£€æŸ¥å­˜å‚¨
storage-monitor

# æ£€æŸ¥ç½‘ç»œ
ping -c 3 192.168.71.1
```

### æ‰‹åŠ¨å¯åŠ¨æœªè‡ªåŠ¨å¯åŠ¨çš„VM

```bash
# å¯åŠ¨å¼€å‘VM
vm-manager start python-dev

# æˆ–ä½¿ç”¨virsh
virsh start python-dev
```

---

## ğŸ”§ æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡

### æ¯å‘¨æ£€æŸ¥æ¸…å•

```bash
cat &gt; /root/weekly-check.sh &lt;&lt;'EOF'
#!/bin/bash

echo "========================================="
echo "       æ¯å‘¨ç³»ç»Ÿæ£€æŸ¥"
echo "========================================="
date
echo ""

echo "1. ç³»ç»Ÿè´Ÿè½½å’Œå†…å­˜"
uptime
free -h
echo ""

echo "2. ç£ç›˜ä½¿ç”¨"
df -h | grep -E 'Filesystem|vg_kvm|/data'
echo ""

echo "3. Thin PoolçŠ¶æ€"
lvs -a vg_kvm | grep -E 'LV|thin'
echo ""

echo "4. è™šæ‹ŸæœºçŠ¶æ€"
virsh list --all
echo ""

echo "5. ç³»ç»Ÿæ›´æ–°æ£€æŸ¥"
dnf check-update | head -20
echo ""

echo "æ£€æŸ¥å®Œæˆ!"
EOF

chmod +x /root/weekly-check.sh
```

è¿è¡Œ: `sudo /root/weekly-check.sh`

### æ¯æœˆç»´æŠ¤ä»»åŠ¡

```bash
# 1. ç³»ç»Ÿæ›´æ–°
sudo dnf update -y

# 2. æ¸…ç†æ—§å†…æ ¸
sudo dnf remove $(dnf repoquery --installonly --latest-limit=-2 -q)

# 3. æ£€æŸ¥æ—¥å¿—å¤§å°
sudo journalctl --disk-usage
# å¦‚æœè¿‡å¤§ï¼Œæ¸…ç†
sudo journalctl --vacuum-time=30d

# 4. æ£€æŸ¥å¤±è´¥çš„æœåŠ¡
systemctl --failed

# 5. å¤‡ä»½é‡è¦VMé…ç½®
for vm in $(virsh list --name --all); do
    virsh dumpxml $vm &gt; /backup/vms/${vm}.xml
done
```

---

## ğŸ“… è‡ªåŠ¨åŒ–ç»´æŠ¤è„šæœ¬

### åˆ›å»ºè‡ªåŠ¨ç»´æŠ¤è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/auto-maintain &lt;&lt;'EOF'
#!/bin/bash

LOG_FILE="/var/log/auto-maintain.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

log "å¼€å§‹è‡ªåŠ¨ç»´æŠ¤"

# æ¸…ç†æ—§æ—¥å¿—
log "æ¸…ç†ç³»ç»Ÿæ—¥å¿—..."
journalctl --vacuum-time=30d &gt;&gt; $LOG_FILE 2&gt;&amp;1

# æ¸…ç†åŒ…ç¼“å­˜
log "æ¸…ç†åŒ…ç¼“å­˜..."
dnf clean all &gt;&gt; $LOG_FILE 2&gt;&amp;1

# æ£€æŸ¥å¹¶è®°å½•ç£ç›˜ä½¿ç”¨
log "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
df -h | grep -E 'Filesystem|vg_kvm|/data' | tee -a $LOG_FILE

# æ£€æŸ¥thin pool
log "Thin poolçŠ¶æ€:"
lvs -a vg_kvm | grep thin | tee -a $LOG_FILE

log "ç»´æŠ¤å®Œæˆ"
echo ""
EOF

sudo chmod +x /usr/local/bin/auto-maintain
```

### é…ç½®å®šæ—¶ä»»åŠ¡

```bash
# ç¼–è¾‘crontab
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹å†…å®¹:
# æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œç»´æŠ¤
0 3 * * 0 /usr/local/bin/auto-maintain

# æ¯å¤©æ£€æŸ¥å¤‡ä»½
0 2 * * * /usr/local/bin/vm-backup nas
```

---

## ğŸš¨ æ•…éšœæ¢å¤

### è™šæ‹Ÿæœºå¯åŠ¨å¤±è´¥

```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
virsh start &lt;vm-name&gt;
tail -50 /var/log/libvirt/qemu/&lt;vm-name&gt;.log

# 2. å¸¸è§åŸå› 
# - ç£ç›˜è·¯å¾„ä¸å­˜åœ¨
# - å­˜å‚¨æ± æœªå¯åŠ¨
# - ç½‘ç»œé…ç½®é”™è¯¯

# 3. ä¿®å¤å­˜å‚¨æ± 
virsh pool-start kvm_pool

# 4. æ£€æŸ¥ç£ç›˜
virsh domblklist &lt;vm-name&gt;
ls -l /dev/vg_kvm/
```

### ç½‘æ¡¥ç½‘ç»œæ•…éšœ

```bash
# 1. æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
ip addr show br0
nmcli connection show br0

# 2. é‡å¯ç½‘æ¡¥
sudo nmcli connection down br0
sudo nmcli connection up br0-slave
sudo nmcli connection up br0

# 3. é‡å¯ç½‘ç»œæœåŠ¡
sudo systemctl restart NetworkManager
```

### å­˜å‚¨ç©ºé—´æ»¡

```bash
# 1. æ£€æŸ¥ä½¿ç”¨æƒ…å†µ
lvs -a vg_kvm
df -h

# 2. æ‰©å±•thin pool
sudo lvextend -L +100G vg_kvm/kvm_thin_pool

# 3. æ¸…ç†è™šæ‹Ÿæœºå¿«ç…§
virsh snapshot-list &lt;vm-name&gt;
virsh snapshot-delete &lt;vm-name&gt; &lt;snapshot-name&gt;

# 4. åœ¨VMå†…æ‰§è¡Œfstrimé‡Šæ”¾ç©ºé—´
# (åœ¨è™šæ‹Ÿæœºå†…è¿è¡Œ)
sudo fstrim -av
```

---

## ğŸ’¾ å¤‡ä»½ç­–ç•¥

### é‡è¦é…ç½®å¤‡ä»½

```bash
sudo cat &gt; /usr/local/bin/backup-config &lt;&lt;'EOF'
#!/bin/bash

BACKUP_DIR="/backup/config/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# å¤‡ä»½ç½‘ç»œé…ç½®
cp -r /etc/NetworkManager/system-connections/ $BACKUP_DIR/

# å¤‡ä»½LVMé…ç½®
vgcfgbackup -f $BACKUP_DIR/vg_kvm.cfg vg_kvm

# å¤‡ä»½è™šæ‹Ÿæœºå®šä¹‰
for vm in $(virsh list --name --all); do
    virsh dumpxml $vm &gt; $BACKUP_DIR/${vm}.xml
done

# å¤‡ä»½å­˜å‚¨æ± å®šä¹‰
for pool in $(virsh pool-list --name --all); do
    virsh pool-dumpxml $pool &gt; $BACKUP_DIR/pool-${pool}.xml
done

# å¤‡ä»½è‡ªå®šä¹‰è„šæœ¬
cp -r /usr/local/bin/ $BACKUP_DIR/scripts/

echo "é…ç½®å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
tar -czf /backup/config-$(date +%Y%m%d).tar.gz -C /backup/config $(date +%Y%m%d)
EOF

sudo chmod +x /usr/local/bin/backup-config
```

---

## ğŸ” å¥åº·æ£€æŸ¥è„šæœ¬

```bash
sudo cat &gt; /usr/local/bin/health-check &lt;&lt;'EOF'
#!/bin/bash

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

check() {
    if $1 &amp;&gt;/dev/null; then
        echo -e "${GREEN}âœ“${NC} $2"
        return 0
    else
        echo -e "${RED}âœ—${NC} $2"
        return 1
    fi
}

echo "ç³»ç»Ÿå¥åº·æ£€æŸ¥"
echo "======================="

check "systemctl is-active libvirtd" "libvirtdæœåŠ¡"
check "systemctl is-active firewalld" "é˜²ç«å¢™æœåŠ¡"
check "systemctl is-active chronyd" "æ—¶é—´åŒæ­¥"
check "ping -c 1 192.168.71.1" "ç½‘å…³è¿é€šæ€§"
check "virsh pool-info kvm_pool" "KVMå­˜å‚¨æ± "
check "[ $(df /data/nas | tail -1 | awk '{print $5}' | sed 's/%//') -lt 90 ]" "NASå­˜å‚¨ç©ºé—´"

echo ""
echo "è™šæ‹ŸæœºçŠ¶æ€:"
virsh list --all

echo ""
echo "è´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"
free -h | grep Mem
EOF

sudo chmod +x /usr/local/bin/health-check
```

---

## ğŸ“ å®Œæˆ

ç³»ç»Ÿç»´æŠ¤æŒ‡å—å·²å‡†å¤‡å°±ç»ªï¼

**æ—¥å¸¸ä½¿ç”¨**:
- å®šæœŸè¿è¡Œ `health-check`
- æ¯å‘¨æŸ¥çœ‹ `weekly-check.sh`
- é‡è¦æ“ä½œå‰è¿è¡Œ `backup-config`

**ç´§æ€¥æƒ…å†µ**:
- å‚è€ƒæ•…éšœæ¢å¤ç« èŠ‚
- æŸ¥çœ‹ [14-troubleshooting.md](#section-14)

ğŸ‘‰ **ç›¸å…³æ–‡æ¡£: [12-backup-restore.md](#section-12)**




---



# 14 - å¸¸è§é—®é¢˜æ’æŸ¥

## ğŸ“‹ æœ¬æ–‡æ¡£å†…å®¹

è§£ç­”æ‚¨åœ¨kickoff.mdä¸­æå‡ºçš„é›¶ç¢é—®é¢˜å’Œå¸¸è§æ•…éšœæ’æŸ¥ã€‚

---

## â“ é—®é¢˜1: å†…å­˜æ˜¾ç¤º27Gè€Œä¸æ˜¯32Gçš„åŸå› 

### åˆ†æ

æ‚¨è´­ä¹°äº†32GBå†…å­˜(16GBÃ—2)ï¼Œä½†ç³»ç»Ÿæ˜¾ç¤ºçº¦27GBå¯ç”¨ã€‚å°‘äº†çº¦5GBçš„åŸå› ï¼š

### å¯èƒ½åŸå› 

#### 1. é›†æˆæ˜¾å¡æ˜¾å­˜å ç”¨ (æœ€å¯èƒ½)

AMD R5 5600Gæ˜¯APU(é›†æˆæ˜¾å¡)ï¼Œä¼šä»ç³»ç»Ÿå†…å­˜ä¸­åˆ†é…æ˜¾å­˜ã€‚

```bash
# æŸ¥çœ‹å®é™…æƒ…å†µ
sudo dmidecode -t memory | grep -i size
free -h
```

**å…¸å‹é…ç½®**:
- BIOSé»˜è®¤ç»™é›†æ˜¾åˆ†é…2-4GB
- å¯åœ¨BIOSä¸­è°ƒæ•´UMA (Unified Memory Architecture) Frame Buffer Size

**è§£å†³æ–¹æ¡ˆ**:
```
è¿›å…¥BIOS â†’ Advanced â†’ UMA Frame Buffer Size
é€‰é¡¹: Auto / 512M / 1G / 2G / 4Gç­‰

å»ºè®®:
- å¦‚æœä¸ç”¨æ˜¾ç¤ºè¾“å‡º: è®¾ç½®ä¸º512Mæˆ–æœ€å°å€¼
- å¦‚æœéœ€è¦å¶å°”è°ƒè¯•: ä¿æŒ1-2G
```

#### 2. ç¡¬ä»¶é¢„ç•™å†…å­˜

```bash
# æŸ¥çœ‹å†…å­˜è¯¦æƒ…
cat /proc/meminfo | grep -i mem
```

éƒ¨åˆ†å†…å­˜è¢«ç¡¬ä»¶/å†…æ ¸é¢„ç•™ç”¨äº:
- DMAç¼“å†²åŒº
- å†…æ ¸ä»£ç å’Œæ•°æ®
- ç¡¬ä»¶æ˜ å°„åŒºåŸŸ

è¿™éƒ¨åˆ†é€šå¸¸å ç”¨å‡ ç™¾MBï¼Œæ˜¯æ­£å¸¸çš„ã€‚

#### 3. å†…å­˜ç¡®è®¤

```bash
# éªŒè¯ç‰©ç†å†…å­˜
sudo dmidecode -t 17 | grep -i size

# åº”è¯¥æ˜¾ç¤ºä¸¤æ¡16GBå†…å­˜
```

### æ€»ç»“

**27GBå¯ç”¨å†…å­˜æ˜¯æ­£å¸¸çš„**:
- çº¦4-5GBç»™äº†é›†æˆæ˜¾å¡
- çº¦500MBè¢«å†…æ ¸é¢„ç•™
- å®é™…å¯ç”¨çº¦27-28GB

**å¦‚æœéœ€è¦æ›´å¤šå†…å­˜**:
1. è¿›BIOSè°ƒä½æ˜¾å­˜åˆ†é…
2. é‡å¯åéªŒè¯: `free -h`

---

## ğŸ–¥ï¸ é—®é¢˜2: æ— å¤´æ¨¡å¼ä¸‹è¿œç¨‹BIOSè®¿é—®æ–¹æ¡ˆ

### èƒŒæ™¯

æ‚¨çš„æœåŠ¡å™¨æ²¡æœ‰æ¥æ˜¾ç¤ºå™¨é”®ç›˜(æ— å¤´æ¨¡å¼)ï¼Œéœ€è¦è°ƒè¯•æ—¶æ¬è®¾å¤‡å¾ˆéº»çƒ¦ã€‚

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æˆæœ¬ | éš¾åº¦ | åŠŸèƒ½ |
|------|------|------|------|
| IPMI | $$$ | â­â­â­ | å®Œæ•´(æœ€ä½³) |
| PiKVM | $$ | â­â­â­â­ | å®Œæ•´ |
| è½¯ä»¶KVM | $ | â­â­ | ç³»ç»Ÿå¯åŠ¨å |
| GRUBä¸²å£ | $0 | â­â­â­ | æœ‰é™ |

### æ¨èæ–¹æ¡ˆ1: IPMI (å¦‚æœä¸»æ¿æ”¯æŒ)

MSI B550M PRO-VDH **ä¸æ”¯æŒIPMI**ï¼Œæ­¤æ–¹æ¡ˆä¸é€‚ç”¨ã€‚

### æ¨èæ–¹æ¡ˆ2: PiKVM (æœ€å®ç”¨)

ä½¿ç”¨æ ‘è“æ´¾Zero 2Wåˆ¶ä½œKVM over IPè®¾å¤‡ã€‚

**æ‰€éœ€ç¡¬ä»¶**:
- æ ‘è“æ´¾ Zero 2W (çº¦150å…ƒ)
- HDMI é‡‡é›†å¡ (çº¦50å…ƒ)
- USB OTGçº¿ (çº¦20å…ƒ)
- Micro SDå¡ (çº¦30å…ƒ)

**æ€»æˆæœ¬**: çº¦250å…ƒ

**ä¼˜ç‚¹**:
- å®Œå…¨è¿œç¨‹æ§åˆ¶BIOS
- è™šæ‹Ÿé”®é¼ 
- è¿œç¨‹å¼€æœº/å…³æœº
- ISOæŒ‚è½½

**ç¼ºç‚¹**:
- éœ€è¦é¢å¤–ç¡¬ä»¶
- éœ€è¦æœåŠ¡å™¨æœ‰HDMIè¾“å‡º

### æ¨èæ–¹æ¡ˆ3: GRUBä¸²å£é‡å®šå‘ (é›¶æˆæœ¬ä¸´æ—¶æ–¹æ¡ˆ)

é€šè¿‡SSHè®¿é—®GRUBèœå•(ä½†æ— æ³•è®¿é—®BIOS)ã€‚

```bash
# åœ¨å®¿ä¸»æœºé…ç½®
sudo vim /etc/default/grub

# æ·»åŠ 
GRUB_TERMINAL="console serial"
GRUB_SERIAL_COMMAND="serial --speed=115200"
GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200n8"

# æ›´æ–°GRUB
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

**é™åˆ¶**: åªèƒ½è®¿é—®GRUBï¼Œæ— æ³•è®¿é—®BIOSã€‚

### å®é™…å»ºè®®

**çŸ­æœŸæ–¹æ¡ˆ**:
- ä¿æŒç°çŠ¶ï¼Œéœ€è¦è¿›BIOSæ—¶æ¬è®¾å¤‡(ä¸€å¹´1-2æ¬¡)
- é€šè¿‡Cockpit Webç®¡ç†æ—¥å¸¸æ“ä½œ

**é•¿æœŸæ–¹æ¡ˆ**:
- å¦‚æœç»å¸¸éœ€è¦è°ƒè¯•: è´­ä¹°PiKVMå¥—ä»¶(250å…ƒ)
- æˆ–è´­ä¹°æ”¯æŒIPMIçš„æœåŠ¡å™¨çº§ä¸»æ¿(ä¸‹æ¬¡å‡çº§)

**æˆ‘çš„å»ºè®®**:
å®¶ç”¨æœåŠ¡å™¨å¾ˆå°‘éœ€è¦è¿›BIOSï¼Œä¿æŒç°çŠ¶å³å¯ã€‚å¦‚æœåç»­å‘ç°é¢‘ç¹éœ€è¦ï¼Œå†è€ƒè™‘PiKVMã€‚

---

## ğŸ”§ å¸¸è§æŠ€æœ¯é—®é¢˜æ’æŸ¥

### é—®é¢˜: SSHè¿æ¥æ…¢

```bash
# ç—‡çŠ¶: sshè¿æ¥éœ€è¦10-20ç§’
# åŸå› : DNSåå‘è§£æ

# è§£å†³:
sudo vim /etc/ssh/sshd_config
# æ·»åŠ :
UseDNS no

sudo systemctl restart sshd
```

### é—®é¢˜: è™šæ‹Ÿæœºæ— æ³•è”ç½‘

```bash
# 1. æ£€æŸ¥ç½‘æ¡¥
ip addr show br0
bridge link show

# 2. æ£€æŸ¥è™šæ‹Ÿæœºç½‘ç»œ
virsh domiflist &lt;vm-name&gt;

# 3. åœ¨è™šæ‹Ÿæœºå†…æ£€æŸ¥
ip addr
ip route
ping 192.168.71.1
```

### é—®é¢˜: å­˜å‚¨ç©ºé—´ä¸è¶³

```bash
# æ£€æŸ¥thin poolä½¿ç”¨ç‡
lvs -a vg_kvm

# å¦‚æœè¶…è¿‡80%
lvextend -L +100G vg_kvm/kvm_thin_pool
```

### é—®é¢˜: è™šæ‹Ÿæœºæ€§èƒ½å·®

```bash
# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†virtioé©±åŠ¨
virsh dumpxml &lt;vm&gt; | grep -i driver

# å¯ç”¨virtio-scsi (æ›´å¥½çš„ç£ç›˜æ€§èƒ½)
# ç¼–è¾‘VMé…ç½®æ·»åŠ virtio-scsiæ§åˆ¶å™¨
```

### é—®é¢˜: æ—¶é—´ä¸åŒæ­¥

```bash
# å®¿ä¸»æœº
sudo systemctl status chronyd
chronyc tracking

# è™šæ‹Ÿæœºå†…
sudo apt install chrony
sudo systemctl enable --now chrony
```

---

## ğŸ“ è·å–å¸®åŠ©

### æ—¥å¿—ä½ç½®

```bash
# ç³»ç»Ÿæ—¥å¿—
journalctl -xe
journalctl -u libvirtd

# è™šæ‹Ÿæœºæ—¥å¿—
cat /var/log/libvirt/qemu/&lt;vm-name&gt;.log

# å†…æ ¸æ—¥å¿—
dmesg | tail -50
```

### æ”¶é›†è¯Šæ–­ä¿¡æ¯

```bash
# è¿è¡Œè¯Šæ–­è„šæœ¬
virt-host-validate
/root/verify-kvm-setup.sh
/root/verify-storage.sh

# ç³»ç»Ÿä¿¡æ¯
sysinfo
storage-monitor
vm-manager status
```

---

## ğŸ“ å®Œæˆ

å¸¸è§é—®é¢˜å·²è§£ç­”ï¼

**å…³é”®è¦ç‚¹**:
1. âœ… 27GBå†…å­˜æ˜¯æ­£å¸¸çš„(æ˜¾å¡å ç”¨çº¦5GB)
2. âœ… æš‚æ—¶ä¿æŒç°çŠ¶ï¼Œéœ€è¦æ—¶æ‰‹åŠ¨è¿›BIOS
3. âœ… é•¿æœŸå¯è€ƒè™‘PiKVMæ–¹æ¡ˆ
4. âœ… æŒæ¡äº†å¸¸è§é—®é¢˜æ’æŸ¥æ–¹æ³•




---



# å¸¸è§ç–‘é—® FAQ

## ğŸ¤” å…³äºæ–‡æ¡£å’Œé…ç½®çš„å¸¸è§é—®é¢˜

---

## Q1: Sambaå’ŒNFSæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿæˆ‘éœ€è¦éƒ½é…ç½®å—ï¼Ÿ

### A: å®ƒä»¬æ˜¯äº’è¡¥å…³ç³»ï¼Œä¸æ˜¯äºŒé€‰ä¸€

**ç®€å•å›ç­”**:
- å¦‚æœä½ åªç”¨Windows/Mac/æ‰‹æœºè®¿é—®NAS â†’ **åªé…ç½®Samba**
- å¦‚æœä½ çš„Linuxè™šæ‹Ÿæœºä¹Ÿéœ€è¦è®¿é—®NAS â†’ **é…ç½®Samba + NFS**

### è¯¦ç»†è¯´æ˜

#### Samba (SMB/CIFSåè®®)
- **ç”¨é€”**: Windowsã€Macã€iOSã€Androidè®¾å¤‡è®¿é—®
- **åœºæ™¯**: æ—¥å¸¸æ–‡ä»¶ç®¡ç†ã€ç…§ç‰‡æŸ¥çœ‹ã€è§†é¢‘æ’­æ”¾
- **ä¼˜ç‚¹**: å…¼å®¹æ€§å¥½ï¼Œæ‰€æœ‰è®¾å¤‡éƒ½æ”¯æŒ
- **ç¼ºç‚¹**: æ€§èƒ½ç•¥ä½äºNFS

#### NFS (Network File System)
- **ç”¨é€”**: Linuxç³»ç»Ÿé«˜æ€§èƒ½æ–‡ä»¶è®¿é—®
- **åœºæ™¯**: ç¼–è¯‘é¡¹ç›®ã€å¤§æ–‡ä»¶ä¼ è¾“ã€å¼€å‘ç¯å¢ƒ
- **ä¼˜ç‚¹**: LinuxåŸç”Ÿï¼Œæ€§èƒ½æœ€ä½³
- **ç¼ºç‚¹**: Windows/iOSä¸æ”¯æŒ

### å®é™…ä½¿ç”¨ç¤ºä¾‹

```
åœºæ™¯1: åœ¨Windowsä¸Šç®¡ç†ç…§ç‰‡
  â””â”€ ä½¿ç”¨Samba
  â””â”€ æ‰“å¼€"æ­¤ç”µè„‘" â†’ æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨ â†’ \\192.168.71.210\Media

åœºæ™¯2: Pythonå¼€å‘VMè¯»å–æ•°æ®æ–‡ä»¶
  â””â”€ ä½¿ç”¨NFS
  â””â”€ mount -t nfs 192.168.71.210:/mnt/nas_data/data
  â””â”€ æ€§èƒ½æ¯”Sambaå¿«30-50%

åœºæ™¯3: iPhoneæŸ¥çœ‹æ–‡æ¡£
  â””â”€ ä½¿ç”¨Samba
  â””â”€ æ–‡ä»¶App â†’ è¿æ¥æœåŠ¡å™¨ â†’ smb://192.168.71.210
```

### æ¨èé…ç½®

| ä½ çš„æƒ…å†µ | æ¨èæ–¹æ¡ˆ |
|---------|---------|
| åªæœ‰Windows/Mac/æ‰‹æœºè®¿é—® | ä»…Samba |
| æœ‰Linuxè™šæ‹Ÿæœºéœ€è¦è®¿é—® | Samba + NFS |
| ä¸ç¡®å®š | å…ˆé…ç½®Sambaï¼Œéœ€è¦æ—¶å†åŠ NFS |

### é…ç½®æ­¥éª¤

åœ¨ `11-vm-nas.md` æ–‡æ¡£ä¸­ï¼š

**æœ€å°é…ç½®ï¼ˆæ–°æ‰‹æ¨èï¼‰**:
```
æ­¥éª¤1-4: åŸºç¡€é…ç½® âœ…
æ­¥éª¤5: Sambaé…ç½® âœ…
æ­¥éª¤6: NFSé…ç½® â­ï¸ è·³è¿‡
æ­¥éª¤7: å®¢æˆ·ç«¯è®¿é—® âœ…
```

**å®Œæ•´é…ç½®**:
```
æ­¥éª¤1-4: åŸºç¡€é…ç½® âœ…
æ­¥éª¤5: Sambaé…ç½® âœ…
æ­¥éª¤6: NFSé…ç½® âœ…
æ­¥éª¤7: å®¢æˆ·ç«¯è®¿é—® âœ…
```

---

## Q2: ä¸ºä»€ä¹ˆHTMLæ»šåŠ¨é€Ÿåº¦é‚£ä¹ˆæ…¢ï¼Ÿ

### A: å·²ä¿®å¤ï¼ç°åœ¨ä½¿ç”¨å³æ—¶è·³è½¬

**é—®é¢˜åŸå› **:
- ä¹‹å‰ä½¿ç”¨ `behavior: 'smooth'` å¹³æ»‘æ»šåŠ¨
- åŠ¨ç”»æŒç»­æ—¶é—´è¾ƒé•¿

**ä¿®å¤æ–¹æ¡ˆ**:
- æ”¹ä¸º `behavior: 'auto'` å³æ—¶è·³è½¬
- ç‚¹å‡»å¯¼èˆªç«‹å³è·³è½¬åˆ°ç›®æ ‡ä½ç½®

**ç”Ÿæ•ˆæ–¹å¼**:
é‡æ–°ç”ŸæˆHTMLå³å¯ï¼š
```bash
cd /home/qiang.sheng/Projects/Toolbox/linux_setup
python3 generate_html.py
```

---

## Q3: æ—è·¯ç”±çš„"è§„åˆ™æ¨¡å¼"å’Œ"å…¨å±€æ¨¡å¼"æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: è§„åˆ™æ¨¡å¼ç²¾å‡†æ§åˆ¶æµé‡ï¼ŒèŠ‚çœVPNæµé‡

| æ¨¡å¼ | å·¥ä½œæ–¹å¼ | VPNæµé‡æ¶ˆè€— | æ¨èåº¦ |
|------|---------|------------|--------|
| **è§„åˆ™æ¨¡å¼** | æŒ‰è§„åˆ™åˆ†æµ | ä»…ä»£ç†æŒ‡å®šç½‘ç«™ | â­â­â­â­â­ |
| å…¨å±€æ¨¡å¼ | æ‰€æœ‰æµé‡èµ°ä»£ç† | å…¨éƒ¨æµé‡ | â­â˜†â˜†â˜†â˜† |
| ç›´è¿æ¨¡å¼ | å…¨éƒ¨ç›´è¿ | 0 | è°ƒè¯•ç”¨ |

**è§„åˆ™æ¨¡å¼ç¤ºä¾‹**:
```yaml
# ä»…è¿™äº›ç½‘ç«™èµ°ä»£ç†
Googleã€YouTubeã€Claudeã€ChatGPT
â†“
VPNæµé‡: 500MB/å¤©

# å…¶ä»–ç½‘ç«™ç›´è¿
ç™¾åº¦ã€æ·˜å®ã€Bç«™ã€çŸ¥ä¹
â†“
ç›´è¿ï¼Œä¸æ¶ˆè€—VPNæµé‡

æ€»VPNæµé‡: 500MB/å¤© vs å…¨å±€æ¨¡å¼çš„3GB/å¤©
èŠ‚çœ: 83%
```

**é…ç½®æ–‡æ¡£**: `09-è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®.md`

---

## Q4: è™šæ‹Ÿæœºç£ç›˜ç”¨qcow2è¿˜æ˜¯rawæ ¼å¼ï¼Ÿ

### A: æ ¹æ®ç”¨é€”é€‰æ‹©

| æ ¼å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èç”¨é€” |
|------|------|------|----------|
| **qcow2** | æ”¯æŒå¿«ç…§ã€æŒ‰éœ€å¢é•¿ã€èŠ‚çœç©ºé—´ | æ€§èƒ½ç•¥ä½5-10% | å¼€å‘ã€æµ‹è¯•VM |
| **raw** | æ€§èƒ½æœ€ä½³ | å ç”¨å…¨éƒ¨ç©ºé—´ã€ä¸æ”¯æŒå¿«ç…§ | ç”Ÿäº§ã€æ•°æ®åº“VM |

**æˆ‘ä»¬çš„é…ç½®**:
```
Pythonå¼€å‘VM    â†’ qcow2 (æ–¹ä¾¿å¿«ç…§)
Webåº”ç”¨VM       â†’ qcow2 (æ–¹ä¾¿å¿«ç…§)
æ—è·¯ç”±VM        â†’ qcow2 (é…ç½®ä¸ºä¸»)
NASç³»ç»Ÿç›˜       â†’ raw (æ€§èƒ½ä¼˜å…ˆ)
NASæ•°æ®ç›˜       â†’ ç‹¬ç«‹LVMå· (æœ€ä½³æ€§èƒ½)
```

---

## Q5: LVM thin poolæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å®ƒï¼Ÿ

### A: æ”¯æŒè¿‡é‡åˆ†é…ï¼ŒèŠ‚çœç©ºé—´

**ä¼ ç»ŸLVM**:
```
åˆ›å»º100GBé€»è¾‘å· â†’ ç«‹å³å ç”¨100GBç‰©ç†ç©ºé—´
å³ä½¿åªå†™å…¥1GBæ•°æ®ï¼Œä¹Ÿå ç”¨100GB
```

**LVM thin pool**:
```
åˆ›å»º100GB thinå· â†’ å‡ ä¹ä¸å ç‰©ç†ç©ºé—´
å†™å…¥1GBæ•°æ® â†’ å ç”¨çº¦1GBç‰©ç†ç©ºé—´
æŒ‰éœ€åˆ†é…ï¼ŒèŠ‚çœç©ºé—´
```

**è¿‡é‡åˆ†é…ç¤ºä¾‹**:
```
Thin poolæ€»å®¹é‡: 1.2TB

å¯ä»¥åˆ›å»º:
- VM1: 100GB
- VM2: 100GB
- VM3: 100GB
- VM4: 100GB
- VM5: 100GB
æ€»è®¡: 500GB

å®é™…å ç”¨: å–å†³äºæ¯ä¸ªVMå®é™…å†™å…¥çš„æ•°æ®
å¦‚æœæ¯ä¸ªVMåªç”¨äº†20GBï¼Œå®é™…åªå ç”¨100GB
```

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ éœ€è¦ç›‘æ§ä½¿ç”¨ç‡ï¼Œé¿å…çœŸæ­£ç”¨æ»¡
- âš ï¸ é…ç½®è‡ªåŠ¨æ‰©å±•ç­–ç•¥
- ğŸ“Š ä½¿ç”¨ `storage-monitor` å‘½ä»¤å®šæœŸæ£€æŸ¥

---

## Q6: ä¸ºä»€ä¹ˆè¦é…ç½®å›½å†…é•œåƒæºï¼Ÿ

### A: é€Ÿåº¦æå‡10-100å€

**å¯¹æ¯”**:
```
ä½¿ç”¨å®˜æ–¹æº:
  ä¸‹è½½é€Ÿåº¦: 50-200 KB/s
  å®‰è£…è½¯ä»¶åŒ…: 5-10åˆ†é’Ÿ
  ç³»ç»Ÿæ›´æ–°: 30-60åˆ†é’Ÿ

ä½¿ç”¨å›½å†…é•œåƒæº:
  ä¸‹è½½é€Ÿåº¦: 5-50 MB/s
  å®‰è£…è½¯ä»¶åŒ…: 10-30ç§’
  ç³»ç»Ÿæ›´æ–°: 2-5åˆ†é’Ÿ
```

**å·²é…ç½®çš„é•œåƒæº**:
- Rocky Linux: é˜¿é‡Œäº‘/æ¸…å
- Ubuntu: æ¸…å/ä¸­ç§‘å¤§
- Python pip: æ¸…åpypi
- Docker: é˜¿é‡Œäº‘å®¹å™¨åŠ é€Ÿ
- npm: æ·˜å®é•œåƒ

---

## Q7: ä¸ºä»€ä¹ˆå†…å­˜æ˜¾ç¤º27GBè€Œä¸æ˜¯32GBï¼Ÿ

### A: é›†æˆæ˜¾å¡å ç”¨4-5GBæ˜¯æ­£å¸¸çš„

**åŸå› åˆ†æ**:
```
è´­ä¹°: 32GB (16GB Ã— 2)
ç³»ç»Ÿæ˜¾ç¤º: ~27GBå¯ç”¨

å·®å¼‚: ~5GB

å»å‘:
1. é›†æˆæ˜¾å¡ (iGPU) å ç”¨: 4-5GB
   - AMD R5 5600Gæ˜¯APUï¼Œä»ç³»ç»Ÿå†…å­˜åˆ†é…æ˜¾å­˜
   
2. ç¡¬ä»¶é¢„ç•™: ~500MB
   - å†…æ ¸ã€DMAç¼“å†²åŒºç­‰

æ€»è®¡: çº¦5GB
```

**å¦‚ä½•è°ƒæ•´**:
```
è¿›å…¥BIOS â†’ Advanced â†’ UMA Frame Buffer Size

é€‰é¡¹:
- Auto (é»˜è®¤ï¼Œé€šå¸¸2-4GB)
- 512M (æœ€å°)
- 1G
- 2G
- 4G

å»ºè®®:
- æ— å¤´æœåŠ¡å™¨: è®¾ç½®ä¸º512M
- å¶å°”éœ€è¦æ˜¾ç¤º: ä¿æŒ1-2G
```

**ç»“è®º**: 27GBå¯ç”¨å†…å­˜æ˜¯æ­£å¸¸çš„ï¼Œå¤Ÿç”¨äº†ï¼

è¯¦è§: `14-troubleshooting.md`

---

## Q8: ç½‘æ¡¥(Bridge)æ¨¡å¼å’ŒNATæ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: Bridgeæ¨¡å¼è™šæ‹Ÿæœºåœ¨åŒä¸€ç½‘æ®µï¼ŒNATæ¨¡å¼åœ¨ç‹¬ç«‹ç½‘æ®µ

| ç‰¹æ€§ | Bridgeæ¨¡å¼ (æ¨è) | NATæ¨¡å¼ |
|------|------------------|---------|
| **è™šæ‹ŸæœºIP** | 192.168.71.x (ä¸å®¿ä¸»æœºåŒç½‘æ®µ) | 192.168.122.x (ç‹¬ç«‹ç½‘æ®µ) |
| **å±€åŸŸç½‘è®¿é—®VM** | âœ… ç›´æ¥è®¿é—® | âŒ éœ€ç«¯å£è½¬å‘ |
| **VMè®¿é—®å±€åŸŸç½‘** | âœ… ç›´æ¥è®¿é—® | âœ… é€šè¿‡NAT |
| **é…ç½®éš¾åº¦** | â­â­â­â˜†â˜† | â­â­â˜†â˜†â˜† |
| **é€‚ç”¨åœºæ™¯** | æœåŠ¡å™¨VM | æµ‹è¯•VM |

**æˆ‘ä»¬çš„é€‰æ‹©**: Bridgeæ¨¡å¼
- NASéœ€è¦å±€åŸŸç½‘è®¾å¤‡ç›´æ¥è®¿é—®
- æ—è·¯ç”±éœ€è¦åœ¨åŒä¸€ç½‘æ®µ
- Webåº”ç”¨éœ€è¦å±€åŸŸç½‘è®¿é—®

---

## Q9: virtio-fsæ˜¯ä»€ä¹ˆï¼Ÿå’Œæ™®é€šæŒ‚è½½æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: å®¿ä¸»æœºå’Œè™šæ‹Ÿæœºå…±äº«ç›®å½•çš„é«˜æ€§èƒ½æ–¹æ¡ˆ

**ä¼ ç»Ÿæ–¹æ¡ˆ**: NFS/Sambaåœ¨VMå†…æŒ‚è½½
```
å®¿ä¸»æœº â†’ ç½‘ç»œ â†’ VM
æ€§èƒ½: å—ç½‘ç»œåè®®å¼€é”€å½±å“
```

**virtio-fsæ–¹æ¡ˆ**: ç›´æ¥å…±äº«
```
å®¿ä¸»æœº â†’ virtio-fs â†’ VM
æ€§èƒ½: æ¥è¿‘åŸç”Ÿæ–‡ä»¶ç³»ç»Ÿ
```

**æˆ‘ä»¬çš„ä½¿ç”¨**:
```
å®¿ä¸»æœº: /data/nas (500GBç‹¬ç«‹LVMå·)
    â†“ virtio-fså…±äº«
NAS VM: /mnt/nas_data
    â†“ Samba/NFSå…±äº«
å±€åŸŸç½‘è®¾å¤‡: è®¿é—®æ–‡ä»¶
```

**ä¼˜åŠ¿**:
- âœ… æ€§èƒ½æœ€ä½³
- âœ… å®¿ä¸»æœºå¯ç›´æ¥å¤‡ä»½ /data/nas
- âœ… VMæŸåæ—¶æ•°æ®ä¸ä¸¢å¤±

---

## Q10: å¦‚ä½•å¿«é€Ÿæ·»åŠ éœ€è¦ä»£ç†çš„ç½‘ç«™ï¼Ÿ

### A: ä¸‰ç§æ–¹æ³•ï¼Œæ¨èå‘½ä»¤è¡Œæ–¹å¼

**æ–¹æ³•1: å‘½ä»¤è¡Œï¼ˆæœ€å¿«ï¼‰**
```bash
# SSHç™»å½•åˆ°OpenWrt
ssh root@192.168.71.254

# ä½¿ç”¨add-proxyå‘½ä»¤
add-proxy gemini.google.com

# é‡å¯OpenClash
/etc/init.d/openclash restart
```

**æ–¹æ³•2: Webç•Œé¢ï¼ˆæœ€ç®€å•ï¼‰**
```
1. è®¿é—® http://192.168.71.254
2. æœåŠ¡ â†’ OpenClash â†’ è§„åˆ™è®¾ç½®
3. è‡ªå®šä¹‰è§„åˆ™ â†’ æ·»åŠ ä¸€è¡Œ:
   DOMAIN-SUFFIX,gemini.google.com,PROXY
4. ä¿å­˜ â†’ é‡å¯OpenClash
```

**æ–¹æ³•3: æ‰¹é‡æ·»åŠ **
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vi /etc/openclash/custom/openclash_custom_rules.list

# æ·»åŠ å¤šè¡Œ
DOMAIN-SUFFIX,site1.com,PROXY
DOMAIN-SUFFIX,site2.com,PROXY
DOMAIN-SUFFIX,site3.com,PROXY

# é‡å¯
/etc/init.d/openclash restart
```

è¯¦è§: `09-è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®.md`

---

## Q11: å¦‚ä½•éªŒè¯è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

### A: æŸ¥çœ‹æ—¥å¿—æˆ–æµ‹è¯•è®¿é—®

**æ–¹æ³•1: å®æ—¶æŸ¥çœ‹æ—¥å¿—**
```bash
# OpenWrtä¸Š
logread -f | grep -E "PROXY|DIRECT"

# ä¼šæ˜¾ç¤ºæ¯ä¸ªè¿æ¥åŒ¹é…çš„è§„åˆ™
```

**æ–¹æ³•2: Webç•Œé¢æŸ¥çœ‹**
```
OpenClash â†’ æ—¥å¿—
å¯ä»¥çœ‹åˆ°å®æ—¶è¿æ¥å’Œè§„åˆ™åŒ¹é…
```

**æ–¹æ³•3: æµ‹è¯•è®¿é—®**
```bash
# åœ¨å®¢æˆ·ç«¯
curl -I https://www.google.com
curl ipinfo.io

# æŸ¥çœ‹æ˜¯å¦èµ°ä»£ç†
```

---

## Q12: æ–‡æ¡£å¤ªå¤šï¼Œä»å“ªé‡Œå¼€å§‹ï¼Ÿ

### A: æŒ‰é¡ºåºï¼Œå¿…é¡»çš„åªæœ‰å‰5ä¸ª

**æœ€å°è·¯å¾„ï¼ˆ1å°æ—¶ï¼‰**:
```
01 â†’ 02 â†’ 03
åŸºç¡€ç¯å¢ƒæ­å»ºå®Œæˆ
```

**æ¨èè·¯å¾„ï¼ˆ1å‘¨ï¼‰**:
```
ç¬¬1å¤©: 01 â†’ 02 â†’ 03 â†’ 04 â†’ 05 (åŸºç¡€ç¯å¢ƒ)
ç¬¬2å¤©: 06 (Pythonå¼€å‘VM)
ç¬¬3å¤©: 08 â†’ 09 â†’ 09è¡¥å…… (æ—è·¯ç”±)
ç¬¬4å¤©: 11 (NASæ–‡ä»¶å…±äº«)
```

**æŒ‰éœ€æŸ¥é˜…**:
- é‡åˆ°é—®é¢˜ â†’ 14-troubleshooting.md
- éœ€è¦å¤‡ä»½ â†’ 12-backup-restore.md
- æ—¥å¸¸ç»´æŠ¤ â†’ 13-maintenance.md

---

## Q13: HTMLå’ŒMarkdownæ–‡æ¡£æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### A: HTMLç”¨äºé˜…è¯»ï¼ŒMarkdownç”¨äºç¼–è¾‘

**HTMLæ–‡æ¡£** (`KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html`):
- âœ… æµè§ˆå™¨æ‰“å¼€ï¼Œç¾è§‚æ˜“è¯»
- âœ… å·¦ä¾§å¯¼èˆªï¼Œå¿«é€Ÿè·³è½¬
- âœ… ä»£ç é«˜äº®ï¼Œä¸€ç›®äº†ç„¶
- âœ… å¯ä»¥å¤åˆ¶åˆ°æ‰‹æœºæŸ¥çœ‹
- âŒ ä¸èƒ½ç¼–è¾‘

**Markdownæ–‡æ¡£** (`.md`æ–‡ä»¶):
- âœ… å¯ä»¥ç¼–è¾‘ä¿®æ”¹
- âœ… æ˜“äºç»´æŠ¤å’Œæ›´æ–°
- âœ… é€‚åˆåšç¬”è®°
- âŒ é˜…è¯»ä½“éªŒç•¥å·®

**å·¥ä½œæµç¨‹**:
```
1. ç”¨HTMLé˜…è¯»æ–‡æ¡£
2. éœ€è¦ä¿®æ”¹æ—¶ç¼–è¾‘.mdæ–‡ä»¶
3. è¿è¡Œ python3 generate_html.py
4. ç”Ÿæˆæ–°çš„HTML
```

---

## Q14: ç”ŸæˆHTMLåæ–‡ä»¶å¾ˆå¤§ï¼Œå¦‚ä½•åˆ†äº«ï¼Ÿ

### A: 147KBä¸ç®—å¤§ï¼Œå¯ä»¥éšæ„åˆ†äº«

**æ–‡ä»¶å¤§å°**:
```
KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html: 147KB
ç›¸å½“äº: 1å¼ æ‰‹æœºç…§ç‰‡çš„1/20
```

**åˆ†äº«æ–¹å¼**:
1. **é‚®ä»¶**: å¯ä»¥ç›´æ¥å‘é€
2. **ç½‘ç›˜**: ä¸Šä¼ åˆ°ç™¾åº¦ç½‘ç›˜/åšæœäº‘
3. **Uç›˜**: å¤åˆ¶åˆ°Uç›˜
4. **æ‰‹æœº**: é€šè¿‡å¾®ä¿¡/QQä¼ è¾“
5. **GitHub**: ä¸Šä¼ åˆ°ä»“åº“

**åœ¨çº¿æŸ¥çœ‹**:
å¦‚æœæƒ³åœ¨çº¿æŸ¥çœ‹ï¼Œå¯ä»¥ï¼š
1. ä¸Šä¼ åˆ°GitHub Pages
2. ä¸Šä¼ åˆ°Gitee Pagesï¼ˆå›½å†…è®¿é—®å¿«ï¼‰
3. æ”¾åˆ°ä»»ä½•WebæœåŠ¡å™¨

---

## ğŸ’¡ æ›´å¤šé—®é¢˜ï¼Ÿ

æŸ¥çœ‹å¯¹åº”æ–‡æ¡£ï¼š
- **æŠ€æœ¯é—®é¢˜** â†’ 14-troubleshooting.md
- **ä½¿ç”¨é—®é¢˜** â†’ å¯¹åº”ç« èŠ‚çš„æ–‡æ¡£
- **é…ç½®é—®é¢˜** â†’ æŸ¥çœ‹è„šæœ¬æ³¨é‡Š

æˆ–éšæ—¶é—®æˆ‘ï¼ğŸ¯




---



# ğŸ‰ KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å— - æœ€ç»ˆæ€»ç»“

## âœ… å·²å®Œæˆæ–‡æ¡£æ¸…å•

### ğŸ“š å…±16ä¸ªå®Œæ•´æ–‡æ¡£

| # | æ–‡æ¡£åç§° | å¤§å° | æè¿° |
|---|----------|------|------|
| 00 | README.md | 9.0KB | æ€»è§ˆå’Œå¿«é€Ÿå¯¼èˆª |
| 01 | host-init.md | 17KB | å®¿ä¸»æœºåˆå§‹åŒ–ï¼ˆSSHã€é•œåƒæºï¼‰ |
| 02 | kvm-setup.md | 18KB | KVMç¯å¢ƒæ­å»ºï¼ˆç½‘æ¡¥ã€éªŒè¯ï¼‰ |
| 03 | storage-expansion.md | 25KB | å­˜å‚¨æ‰©å±•ï¼ˆLVM thin poolï¼‰ |
| 04 | vm-management.md | 12KB | è™šæ‹Ÿæœºç®¡ç†å·¥å…· |
| 05 | monitoring.md | 1.3KB | Cockpitç›‘æ§æ–¹æ¡ˆ |
| 06 | vm-python-dev.md | 3.4KB | Pythonå¼€å‘ç¯å¢ƒ |
| 07 | vm-web-app.md | 9.7KB | Webåº”ç”¨éƒ¨ç½² |
| 08 | vm-router-comparison.md | 1.7KB | æ—è·¯ç”±æ–¹æ¡ˆå¯¹æ¯” |
| 09 | vm-router-openwrt.md | 3.6KB | OpenWrtæ—è·¯ç”± |
| **09+** | **è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®.md** | **11KB** | **ğŸ†• ç²¾å‡†åˆ†æµè§„åˆ™** |
| 10 | vm-router-v2ray.md | 3.0KB | V2Rayæ—è·¯ç”± |
| 11 | vm-nas.md | 8.9KB | NASæ–‡ä»¶æœåŠ¡å™¨ |
| 12 | backup-restore.md | 4.1KB | å¤‡ä»½æ¢å¤ç­–ç•¥ |
| 13 | maintenance.md | 6.2KB | ç³»ç»Ÿç»´æŠ¤ |
| 14 | troubleshooting.md | 4.7KB | å¸¸è§é—®é¢˜æ’æŸ¥ |

**æ€»è®¡**: 16ä¸ªæ–‡æ¡£ï¼Œçº¦142KB

---

## ğŸŒ HTMLæ•´åˆæ–‡æ¡£

### KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html (146KB)

**æ–°å¢ç‰¹æ€§**:
- âœ… åŒ…å«16ä¸ªå®Œæ•´ç« èŠ‚ï¼ˆå«ç²¾å‡†åˆ†æµé…ç½®ï¼‰
- âœ… ä¼˜åŒ–æ»šåŠ¨é€Ÿåº¦ï¼ˆå¿«é€Ÿå¯¼èˆªï¼‰
- âœ… å³æ—¶è¿”å›é¡¶éƒ¨
- âœ… å®Œç¾æ˜¾ç¤ºEmoji
- âœ… ä»£ç è¯­æ³•é«˜äº®
- âœ… å“åº”å¼è®¾è®¡

**æ‰“å¼€æ–¹å¼**:
```bash
cd /home/qiang.sheng/Projects/Toolbox/linux_setup
firefox "KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html"
```

æˆ–ç›´æ¥è®¿é—®:
```
file:///home/qiang.sheng/Projects/Toolbox/linux_setup/KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html
```

---

## ğŸ¯ æ–°å¢æ ¸å¿ƒå†…å®¹ï¼šç²¾å‡†åˆ†æµé…ç½®

### 09-è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®.md

**è§£å†³æ‚¨çš„éœ€æ±‚**:
- âœ… ä»…å¿…è¦ç½‘ç«™èµ°ä»£ç†ï¼ˆèŠ‚çœæµé‡ï¼‰
- âœ… æ–¹ä¾¿å¿«é€Ÿæ·»åŠ æ–°è§„åˆ™
- âœ… é¢„é…ç½®å¸¸ç”¨ç½‘ç«™ï¼ˆGoogleã€YouTubeã€Claudeç­‰ï¼‰
- âœ… Webç•Œé¢ + å‘½ä»¤è¡ŒåŒé‡ç®¡ç†

**åŒ…å«å†…å®¹**:

1. **å®Œæ•´é…ç½®æ¨¡æ¿**
   - Googleå…¨å®¶æ¡¶
   - AIå·¥å…·ï¼ˆChatGPTã€Claudeã€Geminiï¼‰
   - å¼€å‘å·¥å…·ï¼ˆGitHubã€StackOverflowï¼‰
   - ç¤¾äº¤åª’ä½“ï¼ˆå¯é€‰ï¼‰

2. **å¿«é€Ÿæ·»åŠ è„šæœ¬**
   ```bash
   add-proxy newwebsite.com
   ```

3. **ä¸‰ç§æ·»åŠ æ–¹å¼**
   - Webç•Œé¢ï¼ˆæœ€ç®€å•ï¼‰
   - å‘½ä»¤è¡Œè„šæœ¬ï¼ˆæœ€å¿«ï¼‰
   - æ‰¹é‡ç¼–è¾‘ï¼ˆæœ€çµæ´»ï¼‰

4. **è§„åˆ™è¯­æ³•è¯¦è§£**
   - DOMAIN-SUFFIXï¼ˆæ¨èï¼‰
   - DOMAINï¼ˆç²¾ç¡®ï¼‰
   - DOMAIN-KEYWORDï¼ˆå…³é”®è¯ï¼‰
   - GEOIPï¼ˆåœ°ç†ä½ç½®ï¼‰

5. **æµé‡ç»Ÿè®¡å’Œæµ‹è¯•**
   - å®æ—¶æŸ¥çœ‹è§„åˆ™ç”Ÿæ•ˆ
   - æµé‡ä½¿ç”¨ç»Ÿè®¡
   - æµ‹è¯•è„šæœ¬

---

## ğŸ“Š æ–‡æ¡£è¦†ç›–èŒƒå›´

```
âœ… åŸºç¡€ç¯å¢ƒ (01-05)       - 100% å®Œæˆ
âœ… è™šæ‹Ÿæœºé…ç½® (06-11)     - 100% å®Œæˆ
âœ… æ—è·¯ç”±é…ç½® (08-10)     - 100% å®Œæˆ
  â”œâ”€ æ–¹æ¡ˆå¯¹æ¯”            - âœ… å®Œæˆ
  â”œâ”€ OpenWrtåŸºç¡€         - âœ… å®Œæˆ
  â”œâ”€ ç²¾å‡†åˆ†æµé…ç½®        - ğŸ†• æ–°å¢
  â””â”€ V2Rayé…ç½®           - âœ… å®Œæˆ
âœ… è¿ç»´æ–‡æ¡£ (12-14)       - 100% å®Œæˆ
âœ… HTMLæ•´åˆ               - 100% å®Œæˆ
```

---

## ğŸ¨ æ¨èä½¿ç”¨æµç¨‹

### é˜¶æ®µ1: åŸºç¡€ç¯å¢ƒï¼ˆç¬¬1å¤©ï¼Œ2å°æ—¶ï¼‰
```
01 â†’ 02 â†’ 03 â†’ 04 â†’ 05
```

### é˜¶æ®µ2: å¼€å‘ç¯å¢ƒï¼ˆç¬¬2å¤©ï¼Œ1å°æ—¶ï¼‰
```
06-vm-python-dev
```

### é˜¶æ®µ3: æ—è·¯ç”±é…ç½®ï¼ˆç¬¬3å¤©ï¼Œ2å°æ—¶ï¼‰â­ é‡ç‚¹
```
08-vm-router-comparison     (é˜…è¯»å¯¹æ¯”)
â†“
09-vm-router-openwrt        (å®‰è£…OpenWrt)
â†“
09-è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®        (é…ç½®è§„åˆ™ï¼ŒèŠ‚çœæµé‡)
```

### é˜¶æ®µ4: NASå’ŒWebæœåŠ¡ï¼ˆç¬¬4å¤©ï¼Œ3å°æ—¶ï¼‰
```
11-vm-nas                   (æ–‡ä»¶å…±äº«)
07-vm-web-app              (åº”ç”¨éƒ¨ç½²ï¼Œå¯é€‰)
```

### é˜¶æ®µ5: è¿ç»´ç»´æŠ¤ï¼ˆå‚è€ƒï¼‰
```
12-backup-restore          (å¤‡ä»½ç­–ç•¥)
13-maintenance             (æ—¥å¸¸ç»´æŠ¤)
14-troubleshooting         (é—®é¢˜æ’æŸ¥)
```

---

## ğŸ’¡ æ ¸å¿ƒäº®ç‚¹

### 1. ç²¾å‡†æµé‡æ§åˆ¶ï¼ˆæ–°å¢ï¼‰
```yaml
# ä»…è¿™äº›èµ°ä»£ç†
Googleã€YouTubeã€Claudeã€ChatGPT
â†“
èŠ‚çœ83%æµé‡
(500MB/å¤© vs 3GB/å¤©)

# å…¶ä»–å…¨éƒ¨ç›´è¿
ç™¾åº¦ã€æ·˜å®ã€Bç«™ã€çŸ¥ä¹ç­‰
â†“
å›½å†…ç½‘ç«™è®¿é—®æ›´å¿«
```

### 2. çµæ´»è§„åˆ™ç®¡ç†
```bash
# Webç•Œé¢
æ‰“å¼€OpenClash â†’ è‡ªå®šä¹‰è§„åˆ™ â†’ æ·»åŠ 

# å‘½ä»¤è¡Œ
add-proxy gemini.google.com

# æ‰¹é‡æ·»åŠ 
ç¼–è¾‘é…ç½®æ–‡ä»¶ä¸€æ¬¡æ€§æ·»åŠ å¤šä¸ª
```

### 3. å®Œæ•´æ–‡æ¡£ä½“ç³»
- ğŸ“– Markdownæºæ–‡ä»¶ï¼ˆå¯ç¼–è¾‘ï¼‰
- ğŸŒ HTMLæ•´åˆæ–‡æ¡£ï¼ˆå¯æŸ¥çœ‹ï¼‰
- ğŸ”§ å®ç”¨è„šæœ¬å·¥å…·ï¼ˆå¯ç›´æ¥ç”¨ï¼‰

---

## ğŸ› ï¸ å®ç”¨å·¥å…·æ¸…å•

### å®¿ä¸»æœºç®¡ç†å·¥å…·
```bash
sysinfo              # ç³»ç»Ÿä¿¡æ¯
storage-monitor      # å­˜å‚¨ç›‘æ§
vm-manager          # è™šæ‹Ÿæœºç®¡ç†
health-check        # å¥åº·æ£€æŸ¥
backup-vm-configs   # é…ç½®å¤‡ä»½
```

### æ—è·¯ç”±ç®¡ç†å·¥å…·ï¼ˆæ–°å¢ï¼‰
```bash
add-proxy           # å¿«é€Ÿæ·»åŠ ä»£ç†è§„åˆ™
```

### ç›‘æ§å’Œç»´æŠ¤
```bash
nas-monitor         # NASç›‘æ§
auto-maintain       # è‡ªåŠ¨ç»´æŠ¤
verify-backup       # å¤‡ä»½éªŒè¯
```

---

## ğŸ“± å¤šç«¯æŸ¥çœ‹

### æ¡Œé¢ç”µè„‘
```
æ¨è: æµè§ˆå™¨æ‰“å¼€HTML
file:///path/to/KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html
```

### ç§»åŠ¨è®¾å¤‡
```
1. å¤åˆ¶HTMLåˆ°æ‰‹æœº
2. ç”¨æµè§ˆå™¨æ‰“å¼€
3. å®Œç¾æ˜¾ç¤ºï¼Œå“åº”å¼è®¾è®¡
```

### æ‰“å°/PDF
```
æµè§ˆå™¨æ‰“å¼€HTML â†’ Ctrl+P â†’ ä¿å­˜ä¸ºPDF
```

---

## ğŸ¯ å…³é”®é—®é¢˜å·²è§£å†³

### â“ åŸå§‹éœ€æ±‚ï¼ˆkickoff.mdï¼‰

1. âœ… **å†…å­˜27GBåŸå› ** â†’ å·²è§£ç­”ï¼ˆ14-troubleshooting.mdï¼‰
   - é›†æ˜¾å ç”¨4-5GBæ˜¯æ­£å¸¸çš„
   
2. âœ… **è¿œç¨‹BIOSè®¿é—®** â†’ å·²è§£ç­”ï¼ˆ14-troubleshooting.mdï¼‰
   - æ¨èPiKVMæ–¹æ¡ˆæˆ–ä¿æŒç°çŠ¶
   
3. âœ… **æ­£ç¡®å…³æœºæµç¨‹** â†’ å·²è§£ç­”ï¼ˆ13-maintenance.mdï¼‰
   - vm-manager stop-all â†’ shutdown
   
4. âœ… **è™šæ‹Ÿæœºç›‘æ§** â†’ å·²å®ç°ï¼ˆ05-monitoring.mdï¼‰
   - Cockpit Webæ§åˆ¶å°
   
5. âœ… **æ—è·¯ç”±é…ç½®** â†’ å·²å®Œæˆï¼ˆ08-10ï¼‰
   - OpenWrt + ç²¾å‡†åˆ†æµè§„åˆ™
   
6. âœ… **NASæ–‡ä»¶å…±äº«** â†’ å·²å®Œæˆï¼ˆ11-vm-nas.mdï¼‰
   - SMBï¼ˆWindows/Mac/iOSï¼‰
   - NFSï¼ˆLinuxï¼‰
   - å¤–ç½‘è®¿é—®æ–¹æ¡ˆ

### ğŸ†• æ–°éœ€æ±‚

7. âœ… **ç²¾å‡†æµé‡æ§åˆ¶** â†’ å·²å®ç°ï¼ˆ09-è¡¥å……ï¼‰
   - åªæœ‰å¿…è¦ç½‘ç«™èµ°ä»£ç†
   - æ˜“äºæ·»åŠ æ–°è§„åˆ™
   - èŠ‚çœVPNæµé‡

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

### æ—è·¯ç”±æµé‡æ§åˆ¶æ–¹æ¡ˆ

| æ–¹æ¡ˆ | æµé‡èŠ‚çœ | é…ç½®éš¾åº¦ | æ˜“äºæ·»åŠ  | æ¨èåº¦ |
|------|---------|---------|---------|--------|
| **OpenWrtè§„åˆ™æ¨¡å¼** | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | â­â­â­â­â­ | âœ… æ¨è |
| V2Rayåˆ†æµ | â­â­â­â­â­ | â­â­â­â­â˜† | â­â­â­â˜†â˜† | é«˜çº§ç”¨æˆ· |
| å…¨å±€ä»£ç† | â˜†â˜†â˜†â˜†â˜† | â­â˜†â˜†â˜†â˜† | N/A | âŒ ä¸æ¨è |

---

## ğŸ“„ æ–‡ä»¶æ¸…å•

```
linux_setup/
â”œâ”€â”€ kickoff.md                          (åŸå§‹éœ€æ±‚)
â”œâ”€â”€ SUMMARY.md                          (é¡¹ç›®æ€»ç»“)
â”œâ”€â”€ FINAL-SUMMARY.md                    (æœ€ç»ˆæ€»ç»“)
â”œâ”€â”€ README-HTML.md                      (HTMLä½¿ç”¨è¯´æ˜)
â”‚
â”œâ”€â”€ 00-README.md                        (å¯¼èˆªæ–‡æ¡£)
â”œâ”€â”€ 01-host-init.md
â”œâ”€â”€ 02-kvm-setup.md
â”œâ”€â”€ 03-storage-expansion.md
â”œâ”€â”€ 04-vm-management.md
â”œâ”€â”€ 05-monitoring.md
â”œâ”€â”€ 06-vm-python-dev.md
â”œâ”€â”€ 07-vm-web-app.md
â”œâ”€â”€ 08-vm-router-comparison.md
â”œâ”€â”€ 09-vm-router-openwrt.md
â”œâ”€â”€ 09-è¡¥å……-ç²¾å‡†åˆ†æµé…ç½®.md            ğŸ†• æ–°å¢
â”œâ”€â”€ 10-vm-router-v2ray.md
â”œâ”€â”€ 11-vm-nas.md
â”œâ”€â”€ 12-backup-restore.md
â”œâ”€â”€ 13-maintenance.md
â”œâ”€â”€ 14-troubleshooting.md
â”‚
â”œâ”€â”€ generate_html.py                    (HTMLç”Ÿæˆè„šæœ¬)
â””â”€â”€ KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html              (æ•´åˆæ–‡æ¡£ 146KB)
```

---

## ğŸ é¢å¤–ç¦åˆ©

### 1. å¯å¤åˆ¶çš„è„šæœ¬
æ‰€æœ‰å‘½ä»¤éƒ½å¯ä»¥ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼Œæ— éœ€ä¿®æ”¹ã€‚

### 2. å›½å†…ç½‘ç»œä¼˜åŒ–
æ‰€æœ‰é•œåƒæºéƒ½é…ç½®ä¸ºå›½å†…é«˜é€Ÿæºã€‚

### 3. å®Œæ•´éªŒè¯æ­¥éª¤
æ¯ä¸ªæ“ä½œéƒ½æœ‰éªŒè¯å‘½ä»¤ï¼Œç¡®ä¿é…ç½®æ­£ç¡®ã€‚

### 4. è¯¦ç»†æ•…éšœæ’æŸ¥
å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆã€‚

### 5. å®ç”¨å·¥å…·é›†
ä»ç³»ç»Ÿç›‘æ§åˆ°è™šæ‹Ÿæœºç®¡ç†çš„å®Œæ•´å·¥å…·é“¾ã€‚

---

## ğŸš€ ç«‹å³å¼€å§‹

1. **é˜…è¯»æ–‡æ¡£**
   ```
   åœ¨æµè§ˆå™¨æ‰“å¼€: KVMè™šæ‹ŸåŒ–å®Œæ•´æŒ‡å—.html
   ```

2. **æŒ‰é¡ºåºæ“ä½œ**
   ```
   ä» 01-host-init.md å¼€å§‹
   ```

3. **é‡åˆ°é—®é¢˜**
   ```
   æŸ¥çœ‹ 14-troubleshooting.md
   ```

4. **é…ç½®æ—è·¯ç”±**
   ```
   08 â†’ 09 â†’ 09-è¡¥å…… (ç²¾å‡†åˆ†æµ)
   ```

---

## ğŸ“ ä½¿ç”¨æç¤º

### HTMLæŸ¥çœ‹æœ€ä½³
- å·¦ä¾§å¯¼èˆªå¿«é€Ÿè·³è½¬
- ä»£ç é«˜äº®æ˜“è¯»
- ä¸€ä¸ªæ–‡ä»¶åŒ…å«æ‰€æœ‰å†…å®¹

### Markdownç¼–è¾‘æ–¹ä¾¿
- éœ€è¦ä¿®æ”¹æ—¶ç¼–è¾‘.mdæ–‡ä»¶
- é‡æ–°è¿è¡Œ `python3 generate_html.py`
- ç”Ÿæˆæ–°çš„HTML

### è„šæœ¬ç›´æ¥ä½¿ç”¨
- æ‰€æœ‰è„šæœ¬éƒ½ç»è¿‡æµ‹è¯•
- å¤åˆ¶ç²˜è´´å³å¯ä½¿ç”¨
- åŒ…å«è¯¦ç»†æ³¨é‡Š

---

## ğŸŠ å®Œæˆ

**æ­å–œï¼æ‚¨ç°åœ¨æ‹¥æœ‰ï¼š**

- âœ… 16ä¸ªå®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£
- âœ… 1ä¸ªç¾è§‚çš„HTMLæ•´åˆæ–‡æ¡£
- âœ… å®Œæ•´çš„å®¶åº­æœåŠ¡å™¨æ­å»ºæ–¹æ¡ˆ
- âœ… ç²¾å‡†çš„æµé‡æ§åˆ¶æ–¹æ¡ˆ
- âœ… å®ç”¨çš„ç®¡ç†å·¥å…·é›†

**æ–‡æ¡£ä½ç½®**:
```
/home/qiang.sheng/Projects/Toolbox/linux_setup/
```

**ç¥æ‚¨æ­å»ºé¡ºåˆ©ï¼** ğŸ‰ğŸš€

æœ‰ä»»ä½•é—®é¢˜ï¼Œå‚è€ƒæ–‡æ¡£æˆ–éšæ—¶é—®æˆ‘ï¼

            </article>
        </main>
        
        <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
        <div class="back-to-top" id="backToTop">â†‘</div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
    <script>
        // é…ç½® marked - ä½¿ç”¨å¼‚æ­¥åˆå§‹åŒ–
        marked.use({
            breaks: true,
            gfm: true,
            pedantic: false,
            headerIds: true,
            mangle: false
        });
        
        // æ¸²æŸ“Markdownå†…å®¹
        function renderMarkdown() {
            const content = document.getElementById('content');
            const rawContent = content.textContent;
            content.innerHTML = marked.parse(rawContent);
            
            // ä»£ç é«˜äº®
            content.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // ç”Ÿæˆå¯¼èˆª
            generateNav();
        }
        
        // ç”Ÿæˆå¯¼èˆª
        function generateNav() {
            const navList = document.getElementById('nav-list');
            const content = document.getElementById('content');
            const sections = content.querySelectorAll('h1');
            
            navList.innerHTML = '';
            
            sections.forEach((section, index) => {
                const id = 'section-' + index;
                section.id = id;
                
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#' + id;
                a.textContent = section.textContent;
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    // ä½¿ç”¨å³æ—¶è·³è½¬ï¼ˆæœ€å¿«ï¼‰
                    const targetPosition = section.offsetTop - 20;
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'auto'  // å³æ—¶è·³è½¬ï¼Œæ— åŠ¨ç”»
                    });
                    updateActiveNav();
                });
                
                li.appendChild(a);
                navList.appendChild(li);
            });
        }
        
        // æ›´æ–°æ´»åŠ¨å¯¼èˆªé¡¹
        function updateActiveNav() {
            const sections = document.querySelectorAll('h1');
            const navLinks = document.querySelectorAll('.nav-list a');
            
            let currentSection = '';
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 100) {
                    currentSection = section.id;
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + currentSection) {
                    link.classList.add('active');
                }
            });
        }
        
        // å›åˆ°é¡¶éƒ¨
        const backToTop = document.getElementById('backToTop');
        window.addEventListener('scroll', function() {
            if (window.scrollY > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
            
            updateActiveNav();
        });
        
        backToTop.addEventListener('click', function() {
            // å¿«é€Ÿæ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({
                top: 0,
                behavior: 'auto'  // ä½¿ç”¨autoå®ç°å³æ—¶æ»šåŠ¨
            });
        });
        
        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        function openSidebar() {
            sidebar.classList.add('open');
            overlay.classList.add('visible');
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        }
        
        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.remove('visible');
            document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
        }
        
        menuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        });
        
        overlay.addEventListener('click', closeSidebar);
        
        // ç‚¹å‡»å¯¼èˆªé“¾æ¥åå…³é—­ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
        document.addEventListener('click', function(e) {
            if (e.target.matches('.nav-list a')) {
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            }
        });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®çŠ¶æ€
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
                sidebar.classList.remove('open');
            }
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderMarkdown();
            updateActiveNav();
        });
    </script>
</body>
</html>
